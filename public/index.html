<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AÅŸkÄ±mÄ±zÄ±n MÃ¼zesi ðŸ’• - Multiplayer</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=Crimson+Text:ital@0;1&display=swap" rel="stylesheet">
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/libs/fflate.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/FBXLoader.js"></script>

  <style>
    /* Mevcut CSS stillerin aynen korunuyor */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Playfair Display', serif; overflow: hidden; background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 50%, #ffecd2 100%); }
    #menu-screen { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: linear-gradient(135deg, rgba(255, 105, 180, 0.95), rgba(255, 182, 193, 0.95)); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; color: white; text-align: center; }
    .btn { padding: 15px 30px; font-size: 1.2rem; border: none; border-radius: 30px; cursor: pointer; transition: all 0.3s; margin: 10px; font-weight: bold; }
    #create-room-btn { background: white; color: #ff69b4; }
    #join-room-btn { background: transparent; border: 2px solid white; color: white; }
    #character-selection { display: none; margin-top: 30px; }
    .char-card { display: inline-block; padding: 20px; border: 3px solid transparent; border-radius: 15px; cursor: pointer; transition: 0.3s; }
    .char-card.selected { border-color: white; background: rgba(255,255,255,0.2); }
    #game-ui { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 100; pointer-events: none; color: white; text-shadow: 1px 1px 4px rgba(0,0,0,0.5); font-size: 1.2rem; }
  </style>
</head>
<body>

  <div id="menu-screen">
    <h1>AÅŸkÄ±mÄ±zÄ±n MÃ¼zesi ðŸ’•</h1>
    <p>Sadece ikimize Ã¶zel bir yolculuk...</p>
    
    <div id="initial-buttons">
      <button id="create-room-btn" class="btn">MÃ¼zeyi Kur (Host)</button>
      <button id="join-room-btn" class="btn">MÃ¼zeye KatÄ±l (Misafir)</button>
    </div>

    <div id="join-input" style="display:none; margin-top:20px;">
      <input type="text" id="room-code-input" placeholder="Oda Kodunu Girin" style="padding:10px; border-radius:5px; border:none; width:200px; text-transform:uppercase;">
      <button id="join-submit-btn" class="btn" style="background:white; color:#ff69b4; padding:10px 20px;">KatÄ±l</button>
    </div>

    <div id="character-selection">
      <h3>Karakterini SeÃ§</h3>
      <div class="char-card" id="select-batuhan" onclick="selectCharacter('batuhan')">
        <div style="font-size: 3rem;">ðŸ‘¦</div>
        <p>Batuhan</p>
      </div>
      <div class="char-card" id="select-merve" onclick="selectCharacter('merve')">
        <div style="font-size: 3rem;">ðŸ‘§</div>
        <p>Merve</p>
      </div>
      <br>
      <button id="start-game-btn" class="btn" style="background:#ff1493; color:white; display:none;">MÃ¼zeye Gir âœ¨</button>
    </div>
  </div>

  <div id="game-ui" style="display:none;">
    Oda Kodu: <span id="display-room-code">-</span> | <span id="status-msg">Partner bekleniyor...</span>
  </div>

  <script>
    let scene, camera, renderer, socket;
    let playerGroup, partnerGroup;
    let selectedCharacter = null;
    let isHost = false;
    let roomCode = null;
    let keys = {};

    // Animasyon DeÄŸiÅŸkenleri
    let playerMixer, partnerMixer;
    let playerAction, partnerAction;
    const clock = new THREE.Clock();

    function initThreeJS() {
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0xfad0c4);
      scene.fog = new THREE.Fog(0xfad0c4, 5, 30);

      camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.shadowMap.enabled = true;
      document.body.appendChild(renderer.domElement);

      // IÅŸÄ±klandÄ±rma
      const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
      scene.add(ambientLight);
      const sunLight = new THREE.DirectionalLight(0xffffff, 0.8);
      sunLight.position.set(5, 10, 5);
      sunLight.castShadow = true;
      scene.add(sunLight);

      // Zemin
      const floorGeo = new THREE.PlaneGeometry(100, 100);
      const floorMat = new THREE.MeshStandardMaterial({ color: 0xffffff });
      const floor = new THREE.Mesh(floorGeo, floorMat);
      floor.rotation.x = -Math.PI / 2;
      floor.receiveShadow = true;
      scene.add(floor);

      createCharacters();
      animate();
    }

    // FBX YÃ¼kleme YardÄ±mcÄ± Fonksiyonu (Merve Ä°Ã§in)
    function loadMerveModel(group, isLocalPlayer) {
      const loader = new THREE.FBXLoader();
      loader.load('Walk.fbx', (fbx) => {
        fbx.scale.set(0.008, 0.008, 0.008); 
        fbx.position.y = 0;
        fbx.traverse(child => {
          if (child.isMesh) {
            child.castShadow = true;
            child.receiveShadow = true;
          }
        });
        group.add(fbx);

        // Animasyon AyarlarÄ±
        const mixer = new THREE.AnimationMixer(fbx);
        if (fbx.animations.length > 0) {
          const action = mixer.clipAction(fbx.animations[0]);
          if (isLocalPlayer) {
            playerMixer = mixer;
            playerAction = action;
          } else {
            partnerMixer = mixer;
            partnerAction = action;
          }
        }
      });
    }

    // Batuhan (Geometrik) OluÅŸturma
    function createBatuhan(group) {
      const body = new THREE.Mesh(new THREE.CylinderGeometry(0.2, 0.2, 1, 12), new THREE.MeshStandardMaterial({color: 0x3333ff}));
      body.position.y = 0.5;
      const head = new THREE.Mesh(new THREE.SphereGeometry(0.25, 16, 16), new THREE.MeshStandardMaterial({color: 0xfdbcb4}));
      head.position.y = 1.3;
      group.add(body, head);
    }

    function createCharacters() {
      playerGroup = new THREE.Group();
      partnerGroup = new THREE.Group();
      scene.add(playerGroup);
      scene.add(partnerGroup);

      const playerIsBatuhan = (selectedCharacter === 'batuhan');

      // Yerel Oyuncu
      if (playerIsBatuhan) createBatuhan(playerGroup);
      else loadMerveModel(playerGroup, true);

      // Partner
      if (!playerIsBatuhan) createBatuhan(partnerGroup);
      else loadMerveModel(partnerGroup, false);
      
      partnerGroup.visible = false; 
    }

    function animate() {
      requestAnimationFrame(animate);
      const delta = clock.getDelta();

      if (playerMixer) playerMixer.update(delta);
      if (partnerMixer) partnerMixer.update(delta);

      handleMovement();

      // YÃ¼rÃ¼me Animasyon KontrolÃ¼
      const isMoving = (keys['w'] || keys['s'] || keys['a'] || keys['d']);
      if (playerAction) {
        if (isMoving) { if (!playerAction.isRunning()) playerAction.play(); }
        else { playerAction.stop(); }
      }

      renderer.render(scene, camera);
    }

    function handleMovement() {
      if (!playerGroup) return;
      const speed = 0.1;
      if (keys['w']) playerGroup.translateZ(-speed);
      if (keys['s']) playerGroup.translateZ(speed);
      if (keys['a']) playerGroup.rotation.y += 0.05;
      if (keys['d']) playerGroup.rotation.y -= 0.05;

      // Kamera takibi
      const relativeCameraOffset = new THREE.Vector3(0, 2, 5);
      const cameraOffset = relativeCameraOffset.applyMatrix4(playerGroup.matrixWorld);
      camera.position.lerp(cameraOffset, 0.1);
      camera.lookAt(playerGroup.position);

      // Soket Ã¼zerinden konumu gÃ¶nder
      if (socket && roomCode) {
        socket.emit('update_position', {
          position: playerGroup.position,
          rotation: playerGroup.rotation.y,
          isMoving: isMoving // Animasyon durumu iÃ§in partner'a bilgi
        });
      }
    }

    // --- SOCKET VE MENU MANTIÄžI ---
    // (AÅŸaÄŸÄ±daki kÄ±sÄ±m orijinal dosyanÄ±zdaki socket.io mantÄ±ÄŸÄ±yla aynÄ±dÄ±r)
    
    socket = io();

    function selectCharacter(char) {
      selectedCharacter = char;
      document.getElementById('select-batuhan').classList.toggle('selected', char === 'batuhan');
      document.getElementById('select-merve').classList.toggle('selected', char === 'merve');
      document.getElementById('start-game-btn').style.display = 'block';
    }

    document.getElementById('create-room-btn').onclick = () => {
      document.getElementById('initial-buttons').style.display = 'none';
      document.getElementById('character-selection').style.display = 'block';
      isHost = true;
    };

    document.getElementById('join-room-btn').onclick = () => {
      document.getElementById('initial-buttons').style.display = 'none';
      document.getElementById('join-input').style.display = 'block';
    };

    document.getElementById('join-submit-btn').onclick = () => {
      roomCode = document.getElementById('room-code-input').value.toUpperCase();
      document.getElementById('join-input').style.display = 'none';
      document.getElementById('character-selection').style.display = 'block';
      isHost = false;
    };

    document.getElementById('start-game-btn').onclick = () => {
      document.getElementById('menu-screen').style.display = 'none';
      document.getElementById('game-ui').style.display = 'block';
      
      initThreeJS();
      
      if (isHost) {
        socket.emit('create_room');
      } else {
        socket.emit('join_room', { roomCode });
      }
    };

    socket.on('room_created', (data) => {
      roomCode = data.roomCode;
      document.getElementById('display-room-code').innerText = roomCode;
    });

    socket.on('partner_joined', () => {
      document.getElementById('status-msg').innerText = "AÅŸkÄ±n burada â¤ï¸";
      partnerGroup.visible = true;
    });

    socket.on('partner_moved', (data) => {
      partnerGroup.position.copy(data.position);
      partnerGroup.rotation.y = data.rotation;
      // Partner animasyon kontrolÃ¼
      if (partnerAction) {
        if (data.isMoving) { if (!partnerAction.isRunning()) partnerAction.play(); }
        else { partnerAction.stop(); }
      }
    });

    window.addEventListener('keydown', (e) => keys[e.key.toLowerCase()] = true);
    window.addEventListener('keyup', (e) => keys[e.key.toLowerCase()] = false);
    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });

  </script>
</body>
</html>