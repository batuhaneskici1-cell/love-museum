<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AÅŸkÄ±mÄ±zÄ±n MÃ¼zesi ğŸ’• - Multiplayer</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=Crimson+Text:ital@0;1&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fflate@0.7.4/umd/index.js"></script>
  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/js/loaders/FBXLoader.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Playfair Display', serif;
      overflow: hidden;
      background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 50%, #ffecd2 100%);
    }

    #menu-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: linear-gradient(135deg, rgba(255, 105, 180, 0.95), rgba(255, 182, 193, 0.95));
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      backdrop-filter: blur(10px);
    }

    #menu-screen.hidden {
      display: none;
    }

    .menu-title {
      font-size: 72px;
      font-weight: 900;
      color: white;
      text-shadow: 4px 4px 20px rgba(0, 0, 0, 0.3);
      margin-bottom: 20px;
      animation: float 3s ease-in-out infinite;
    }

    .menu-subtitle {
      font-size: 28px;
      color: rgba(255, 255, 255, 0.9);
      margin-bottom: 60px;
      font-style: italic;
    }

    .menu-buttons {
      display: flex;
      gap: 30px;
      margin-bottom: 40px;
    }

    .menu-btn {
      padding: 20px 50px;
      font-size: 24px;
      font-family: 'Playfair Display', serif;
      font-weight: 700;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }

    .menu-btn:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
    }

    .btn-create {
      background: linear-gradient(135deg, #ff1493, #ff69b4);
      color: white;
    }

    .btn-join {
      background: white;
      color: #ff1493;
    }

    .room-input-container {
      display: none;
      margin-top: 20px;
    }

    .room-input-container.active {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
    }

    .room-code-input {
      padding: 15px 30px;
      font-size: 32px;
      font-family: 'Courier New', monospace;
      font-weight: bold;
      text-align: center;
      border: 4px solid white;
      border-radius: 15px;
      background: rgba(255, 255, 255, 0.9);
      color: #ff1493;
      letter-spacing: 5px;
      text-transform: uppercase;
      width: 300px;
    }

    .room-code-display {
      background: white;
      padding: 30px 50px;
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }

    .room-code-display h3 {
      color: #ff1493;
      font-size: 24px;
      margin-bottom: 15px;
    }

    .room-code {
      font-size: 56px;
      font-family: 'Courier New', monospace;
      font-weight: bold;
      color: #ff1493;
      letter-spacing: 8px;
      margin-bottom: 15px;
    }

    .waiting-text {
      font-size: 18px;
      color: #666;
      font-style: italic;
    }

    .error-message {
      background: rgba(255, 50, 50, 0.9);
      color: white;
      padding: 15px 30px;
      border-radius: 10px;
      font-size: 18px;
      margin-top: 20px;
      display: none;
    }

    .error-message.show {
      display: block;
      animation: shake 0.5s;
    }

    #game-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      display: none;
    }

    #game-container.active {
      display: block;
    }

    .hud {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(135deg, rgba(255, 105, 180, 0.95), rgba(255, 182, 193, 0.95));
      padding: 20px 40px;
      border-radius: 20px;
      text-align: center;
      color: white;
      box-shadow: 0 10px 30px rgba(255, 105, 180, 0.4);
      backdrop-filter: blur(10px);
      z-index: 100;
    }

    .hud h1 {
      margin: 0 0 10px 0;
      font-size: 36px;
      font-weight: bold;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
    }

    .hud p {
      margin: 0;
      font-size: 18px;
      opacity: 0.9;
    }

    .speed-hud {
      position: fixed;
      top: 20px;
      left: 20px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 15px 20px;
      border-radius: 10px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.6;
      z-index: 100;
      min-width: 280px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
    }
    
    .speed-hud.hidden {
      display: none;
    }
    
    .speed-hud h4 {
      margin: 0 0 10px 0;
      color: #ff69b4;
      font-size: 14px;
      border-bottom: 1px solid rgba(255, 105, 180, 0.3);
      padding-bottom: 5px;
    }
    
    .speed-hud .speed-value {
      color: #4af;
      font-weight: bold;
    }

    .controls {
      position: absolute;
      bottom: 30px;
      left: 30px;
      background: rgba(255, 255, 255, 0.95);
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
      max-width: 300px;
      z-index: 100;
    }

    .controls h3 {
      margin: 0 0 15px 0;
      color: #ff1493;
      font-size: 20px;
    }

    .controls p {
      margin: 5px 0;
      color: #333;
      font-size: 14px;
    }

    .message-indicator {
      position: absolute;
      bottom: 30px;
      right: 30px;
      background: rgba(255, 105, 180, 0.95);
      padding: 15px 25px;
      border-radius: 15px;
      color: white;
      font-size: 18px;
      font-weight: bold;
      box-shadow: 0 5px 20px rgba(255, 105, 180, 0.5);
      display: none;
      z-index: 100;
    }

    .message-indicator.show {
      display: block;
      animation: pulse 2s infinite;
    }

    .message-popup {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      cursor: pointer;
    }

    .message-popup.show {
      display: flex;
      animation: fadeIn 0.3s ease-out;
    }

    .message-content {
      background: linear-gradient(135deg, #ff69b4, #ffb6c1);
      padding: 50px;
      border-radius: 30px;
      max-width: 600px;
      text-align: center;
      box-shadow: 0 20px 60px rgba(255, 105, 180, 0.6);
    }

    .message-content .icon {
      font-size: 60px;
      margin-bottom: 20px;
    }

    .message-content p {
      font-size: 28px;
      color: white;
      margin: 0;
      line-height: 1.6;
      font-style: italic;
    }

    .message-content .close-hint {
      font-size: 16px;
      color: rgba(255, 255, 255, 0.8);
      margin-top: 30px;
    }

    .photo-popup {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      cursor: pointer;
    }

    .photo-popup.show {
      display: flex;
    }

    .photo-content {
      background: white;
      padding: 30px;
      border-radius: 20px;
      max-width: 80vw;
      max-height: 80vh;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
    }

    .photo-frame {
      width: 600px;
      height: 400px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 10px;
      font-size: 24px;
      color: white;
      font-weight: bold;
      flex-direction: column;
    }

    .photo-frame .hint {
      font-size: 14px;
      margin-top: 10px;
      opacity: 0.8;
    }

    .partner-status {
      position: absolute;
      top: 120px;
      right: 30px;
      background: rgba(255, 255, 255, 0.95);
      padding: 15px 25px;
      border-radius: 15px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
      z-index: 100;
    }

    .partner-status h4 {
      margin: 0 0 10px 0;
      color: #ff1493;
      font-size: 16px;
    }

    .partner-status .status {
      color: #666;
      font-size: 14px;
    }

    .partner-status .connected {
      color: #00cc00;
    }

    .partner-status .waiting {
      color: #ff9900;
    }

    .character-card:hover > div {
      transform: scale(1.05);
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-20px); }
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-10px); }
      75% { transform: translateX(10px); }
    }
  </style>
</head>
<body>
  <!-- Menu Screen -->
  <div id="menu-screen">
    <h1 class="menu-title">ğŸ’• AÅŸkÄ±mÄ±zÄ±n MÃ¼zesi ğŸ’•</h1>
    
    <div class="menu-buttons">
      <button class="menu-btn btn-create" id="create-room-btn">Oda OluÅŸtur</button>
      <button class="menu-btn btn-join" id="join-room-btn">Odaya KatÄ±l</button>
    </div>

    <div id="join-input" class="room-input-container">
      <input type="text" class="room-code-input" id="room-code-input" placeholder="ODA KODU" maxlength="6">
      <button class="menu-btn btn-create" id="join-submit-btn">KatÄ±l</button>
    </div>

    <div id="room-display" class="room-input-container">
      <div class="room-code-display">
        <h3>Oda Kodun:</h3>
        <div class="room-code" id="room-code-text"></div>
        <p class="waiting-text">Sevgilinin katÄ±lmasÄ±nÄ± bekliyorsun... ğŸ’–</p>
      </div>
    </div>

    <div id="error-msg" class="error-message"></div>
  </div>

  <!-- Character Selection Screen -->
  <div id="character-screen" style="display: none;">
    <h1 class="menu-title">Karakterini SeÃ§ ğŸ‘¥</h1>
    
    <div style="display: flex; gap: 50px; justify-content: center; align-items: center; margin-top: 50px;">
      <!-- Batuhan Character -->
      <div class="character-card" id="select-batuhan">
        <div style="width: 200px; height: 300px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.3s;">
          <div style="font-size: 100px; margin-bottom: 20px;">ğŸ§‘</div>
          <h2 style="color: white; font-size: 36px; margin: 0;">Batuhan</h2>
          <p style="color: rgba(255,255,255,0.8); font-size: 18px; margin-top: 10px;">Siyah SaÃ§</p>
        </div>
      </div>

      <!-- Merve Character -->
      <div class="character-card" id="select-merve">
        <div style="width: 200px; height: 300px; background: linear-gradient(135deg, #ff6b9d 0%, #c44569 100%); border-radius: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.3s;">
          <div style="font-size: 100px; margin-bottom: 20px;">ğŸ‘§</div>
          <h2 style="color: white; font-size: 36px; margin: 0;">Merve</h2>
          <p style="color: rgba(255,255,255,0.8); font-size: 18px; margin-top: 10px;">Kahverengi SaÃ§</p>
        </div>
      </div>
    </div>

    <p style="color: white; font-size: 20px; margin-top: 50px; text-align: center;">
      Karakterini seÃ§ ve mÃ¼zeye gir! ğŸ’•
    </p>
  </div>

  <!-- Game Container -->
  <div id="game-container">
    <div class="hud">
      <h1>AÅŸkÄ±mÄ±zÄ±n MÃ¼zesi â¤ï¸</h1>
      <p>Mutlu Sevgililer GÃ¼nÃ¼, CanÄ±m! ğŸ’•</p>
    </div>

    <!-- Speed Adjustment HUD -->
    <div id="speed-hud" class="speed-hud hidden">
      <h4>âš™ï¸ HIZ AYARLARI</h4>
      <div>ğŸ¬ Walk Anim: <span class="speed-value" id="walk-anim-speed">0.70</span></div>
      <div>ğŸš¶ Walk Hareket: <span class="speed-value" id="walk-move-speed">0.010</span></div>
      <div>ğŸƒ Run Anim: <span class="speed-value" id="run-anim-speed">1.30</span></div>
      <div>ğŸƒ Run Hareket: <span class="speed-value" id="run-move-speed">0.025</span></div>
      <div style="margin-top: 8px; font-size: 11px; opacity: 0.7;">
        1/2 Walk Anim | 3/4 Run Anim<br>
        5/6 Walk Hareket | 7/8 Run Hareket
      </div>
    </div>

    <div class="controls">
      <h3>Kontroller ğŸ®</h3>
      <p><strong>W A S D</strong> - Hareket Et</p>
      <p><strong>SHIFT</strong> - KoÅŸ ğŸƒâ€â™€ï¸</p>
      <p><strong>Fare</strong> - Kamera DÃ¶ndÃ¼r (Ekrana tÄ±kla)</p>
      <p><strong>SPACE</strong> - ZÄ±pla</p>
      <p><strong>Q</strong> - Dans AÃ§/Kapat ğŸ’ƒ</p>
      <p><strong>E</strong> - MesajÄ± Oku / KapÄ±ya Gir</p>
      <p><strong>M</strong> - MÃ¼zik AÃ§/Kapat ğŸµ</p>
      <p><strong>TÄ±kla</strong> - FotoÄŸrafa YakÄ±ndan Bak</p>
      <p><strong>ESC</strong> - Fareyi Serbest BÄ±rak</p>
      <hr style="margin: 10px 0; border-color: rgba(255,105,180,0.3);">
      <p style="font-size: 12px; opacity: 0.8;"><strong>HIZ AYARLAMA:</strong></p>
      <p style="font-size: 11px;">0 - HUD AÃ§/Kapat ğŸ‘ï¸</p>
      <p style="font-size: 11px;">1/2 - YÃ¼rÃ¼me Anim â©âª</p>
      <p style="font-size: 11px;">3/4 - KoÅŸma Anim â©âª</p>
      <p style="font-size: 11px;">5/6 - YÃ¼rÃ¼me HÄ±z â©âª</p>
      <p style="font-size: 11px;">7/8 - KoÅŸma HÄ±z â©âª</p>
    </div>

    <!-- Background Music -->
    <audio id="background-music" loop>
      <source src="music/piano.mp3" type="audio/mpeg">
    </audio>

    <div class="partner-status">
      <h4>Partner Durumu:</h4>
      <p class="status waiting" id="partner-status">Bekleniyor...</p>
    </div>

    <div class="message-indicator" id="message-indicator">
      ğŸ’Œ E tuÅŸuna bas ve mesajÄ± oku!
    </div>

    <div class="message-popup" id="message-popup">
      <div class="message-content">
        <div class="icon">ğŸ’•</div>
        <p id="message-text"></p>
        <p class="close-hint">(Kapatmak iÃ§in tÄ±kla)</p>
      </div>
    </div>

    <div class="photo-popup" id="photo-popup">
      <div class="photo-content">
        <div class="photo-frame" id="photo-frame">
          <div>ğŸ“· FotoÄŸraf #<span id="photo-number"></span></div>
          <div class="hint">(Kendi fotoÄŸrafÄ±nÄ± buraya ekleyebilirsin)</div>
        </div>
        <p style="text-align: center; margin-top: 20px; color: #666; font-size: 14px;">
          Kapatmak iÃ§in tÄ±kla
        </p>
      </div>
    </div>

    <!-- Password Popup for Museum Door -->
    <div id="password-popup" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.8); z-index: 2000; align-items: center; justify-content: center;">
      <div style="background: linear-gradient(135deg, #ff69b4, #ffb6c1); padding: 50px; border-radius: 30px; max-width: 600px; text-align: center; box-shadow: 0 20px 60px rgba(255, 105, 180, 0.6);">
        <div style="font-size: 60px; margin-bottom: 20px;">ğŸ”</div>
        <h2 style="color: white; font-size: 32px; margin: 0 0 30px 0;">MÃ¼ze GiriÅŸi</h2>
        <p style="color: white; font-size: 24px; margin-bottom: 30px;">KocanÄ±n adÄ± ne?</p>
        <input type="text" id="password-input" placeholder="Cevap..." style="padding: 15px 30px; font-size: 24px; border: 3px solid white; border-radius: 15px; width: 80%; text-align: center; margin-bottom: 20px;" onkeypress="if(event.key==='Enter') checkPassword()">
        <div style="display: flex; gap: 20px; justify-content: center; margin-top: 20px;">
          <button onclick="checkPassword()" style="padding: 15px 40px; font-size: 20px; background: white; color: #ff1493; border: none; border-radius: 50px; cursor: pointer; font-weight: bold;">GiriÅŸ Yap</button>
          <button onclick="closePasswordPopup()" style="padding: 15px 40px; font-size: 20px; background: rgba(255,255,255,0.3); color: white; border: none; border-radius: 50px; cursor: pointer; font-weight: bold;">Ä°ptal</button>
        </div>
        <p id="password-error" style="color: #ffeeee; margin-top: 20px; font-size: 18px; display: none;"></p>
      </div>
    </div>
  </div>

  <script>
    // Socket.io connection
    const socket = io();
    
    let scene, camera, renderer;
    let playerGroup, partnerGroup;
    let mixer, partnerMixer;
    let clock = new THREE.Clock();
    let keys = {};
    let mouseX = 0;
    let mouseY = 0;
    let yaw = 0;
    let pitch = 0.3; // Kamera aÃ§Ä±sÄ± (yukarÄ±/aÅŸaÄŸÄ±)
    let isHost = false;
    let roomCode = '';
    let partnerConnected = false;
    let photoFrames = [];
    let messages = [];
    let nearMessage = null;
    let selectedCharacter = null;
    let pendingAction = null; // 'create' or 'join'

    let moveSpeed = 0.1; // YÃ¼rÃ¼me hÄ±zÄ±

    // Socket events
    socket.on('room_created', (data) => {
      roomCode = data.roomCode;
      isHost = data.isHost;
      document.getElementById('room-code-text').textContent = roomCode;
      document.getElementById('room-display').classList.add('active');
    });

    socket.on('room_joined', (data) => {
      roomCode = data.roomCode;
      isHost = data.isHost;
      partnerConnected = true; // KatÄ±lan kiÅŸi de partner'Ä± gÃ¶rebilmeli!
      
      document.getElementById('menu-screen').classList.add('hidden');
      document.getElementById('character-screen').style.display = 'flex';
      document.getElementById('character-screen').style.flexDirection = 'column';
      document.getElementById('character-screen').style.alignItems = 'center';
      document.getElementById('character-screen').style.justifyContent = 'center';
      document.getElementById('character-screen').style.position = 'fixed';
      document.getElementById('character-screen').style.top = '0';
      document.getElementById('character-screen').style.left = '0';
      document.getElementById('character-screen').style.width = '100vw';
      document.getElementById('character-screen').style.height = '100vh';
      document.getElementById('character-screen').style.background = 'linear-gradient(135deg, rgba(255, 105, 180, 0.95), rgba(255, 182, 193, 0.95))';
      document.getElementById('character-screen').style.zIndex = '1000';
    });

    socket.on('partner_joined', () => {
      partnerConnected = true;
      document.getElementById('partner-status').textContent = 'BaÄŸlandÄ±! ğŸ’š';
      document.getElementById('partner-status').classList.remove('waiting');
      document.getElementById('partner-status').classList.add('connected');
      
      // Make partner visible immediately
      if (partnerGroup) {
        partnerGroup.visible = true;
      }
      
      // If we're waiting, show character selection
      if (!selectedCharacter) {
        document.getElementById('menu-screen').classList.add('hidden');
        document.getElementById('character-screen').style.display = 'flex';
        document.getElementById('character-screen').style.flexDirection = 'column';
        document.getElementById('character-screen').style.alignItems = 'center';
        document.getElementById('character-screen').style.justifyContent = 'center';
        document.getElementById('character-screen').style.position = 'fixed';
        document.getElementById('character-screen').style.top = '0';
        document.getElementById('character-screen').style.left = '0';
        document.getElementById('character-screen').style.width = '100vw';
        document.getElementById('character-screen').style.height = '100vh';
        document.getElementById('character-screen').style.background = 'linear-gradient(135deg, rgba(255, 105, 180, 0.95), rgba(255, 182, 193, 0.95))';
        document.getElementById('character-screen').style.zIndex = '1000';
      }
    });

    socket.on('partner_moved', (data) => {
      if (partnerGroup) {
        partnerGroup.position.set(data.position.x, data.position.y, data.position.z);
        partnerGroup.rotation.y = data.rotation;
        
        // Make sure partner is visible
        if (!partnerGroup.visible && partnerConnected) {
          partnerGroup.visible = true;
        }
      }
    });

    socket.on('partner_disconnected', () => {
      partnerConnected = false;
      document.getElementById('partner-status').textContent = 'AyrÄ±ldÄ± ğŸ’”';
      document.getElementById('partner-status').classList.remove('connected');
      document.getElementById('partner-status').classList.add('waiting');
      if (partnerGroup) {
        partnerGroup.visible = false;
      }
    });

    socket.on('error', (data) => {
      showError(data.message);
    });

    // Menu functions
    function createRoom() {
      console.log('ğŸ  Oda oluÅŸturuluyor...');
      pendingAction = 'create';
      socket.emit('create_room');
    }

    function showJoinInput() {
      console.log('ğŸšª KatÄ±lma ekranÄ± aÃ§Ä±lÄ±yor...');
      document.getElementById('join-input').classList.add('active');
      document.getElementById('room-code-input').focus();
    }

    function joinRoom() {
      const code = document.getElementById('room-code-input').value.toUpperCase();
      console.log('ğŸ”‘ Odaya katÄ±lmaya Ã§alÄ±ÅŸÄ±yor:', code);
      if (code.length === 6) {
        pendingAction = 'join';
        socket.emit('join_room', code);
      } else {
        showError('GeÃ§ersiz oda kodu!');
      }
    }

    function selectCharacter(character) {
      console.log('ğŸ‘¤ Karakter seÃ§ildi:', character);
      selectedCharacter = character;
      startGame();
    }

    function showError(message) {
      const errorEl = document.getElementById('error-msg');
      errorEl.textContent = message;
      errorEl.classList.add('show');
      setTimeout(() => {
        errorEl.classList.remove('show');
      }, 3000);
    }

    function checkPassword() {
      const input = document.getElementById('password-input').value.toLowerCase().trim();
      const errorEl = document.getElementById('password-error');
      
      if (input === 'batuhan') {
        // DoÄŸru ÅŸifre!
        closePasswordPopup();
        enterMuseum();
      } else {
        // YanlÄ±ÅŸ ÅŸifre
        errorEl.textContent = 'âŒ YanlÄ±ÅŸ cevap! Tekrar dene.';
        errorEl.style.display = 'block';
        document.getElementById('password-input').value = '';
        setTimeout(() => {
          errorEl.style.display = 'none';
        }, 2000);
      }
    }

    function closePasswordPopup() {
      document.getElementById('password-popup').style.display = 'none';
      document.getElementById('password-input').value = '';
      document.getElementById('password-error').style.display = 'none';
    }

    // Global fonksiyonlar - HTML onclick iÃ§in
    window.checkPassword = checkPassword;
    window.closePasswordPopup = closePasswordPopup;

    function enterMuseum() {
      window.insideMuseum = true;
      window.museumDoor.userData.locked = false;
      
      // MÃ¼ze iÃ§ini gÃ¶ster
      window.museumInterior.visible = true;
      
      // Karakteri mÃ¼zenin iÃ§ine Ä±ÅŸÄ±nla
      playerGroup.position.set(0, 0, 15);
      
      // KamerayÄ± ayarla
      camera.position.set(0, 2, 18);
      
      // DÄ±ÅŸ ortamÄ± gizle (performans iÃ§in)
      scene.background = new THREE.Color(0xffe6f0);
      scene.fog = new THREE.Fog(0xffe6f0, 1, 50);
      
      console.log('MÃ¼zeye hoÅŸ geldiniz!');
    }

    function startGame() {
      if (!selectedCharacter) return;
      
      document.getElementById('menu-screen').classList.add('hidden');
      document.getElementById('character-screen').style.display = 'none';
      document.getElementById('game-container').classList.add('active');
      
      // HÄ±z HUD'Ä±nÄ± gÃ¶ster (Merve iÃ§in)
      if (selectedCharacter === 'merve') {
        document.getElementById('speed-hud').classList.remove('hidden');
      }
      
      initThreeJS();
      
      // MÃ¼ziÄŸi baÅŸlatmayÄ± dene (kullanÄ±cÄ± etkileÅŸimi sonrasÄ±)
      setTimeout(() => {
        const music = document.getElementById('background-music');
        music.volume = 0.3; // Ses seviyesi %30
        music.play().catch(e => {
          console.log('MÃ¼zik baÅŸlatÄ±lamadÄ±. M tuÅŸuna basarak baÅŸlatabilirsiniz.');
        });
      }, 500);
    }

    // Three.js setup
    function initThreeJS() {
      const container = document.getElementById('game-container');
      
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0x87CEEB); // Mavi gÃ¶kyÃ¼zÃ¼
      scene.fog = new THREE.Fog(0x87CEEB, 50, 200);

      camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
      camera.position.set(0, 2, 15); // DÄ±ÅŸarÄ±da baÅŸla

      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.shadowMap.enabled = true;
      renderer.shadowMap.type = THREE.PCFSoftShadowMap;
      container.appendChild(renderer.domElement);

      // Lighting - GÃœNEÅ IÅIÄI (daha yumuÅŸak)
      const ambientLight = new THREE.AmbientLight(0xffffff, 0.6); // Biraz daha parlak
      scene.add(ambientLight);

      const sunLight = new THREE.DirectionalLight(0xffffff, 1.0); // Daha az yoÄŸun, beyaz Ä±ÅŸÄ±k
      sunLight.position.set(30, 50, 30);
      sunLight.castShadow = true;
      sunLight.shadow.mapSize.width = 4096;
      sunLight.shadow.mapSize.height = 4096;
      sunLight.shadow.camera.left = -60;
      sunLight.shadow.camera.right = 60;
      sunLight.shadow.camera.top = 60;
      sunLight.shadow.camera.bottom = -60;
      sunLight.shadow.camera.far = 200;
      scene.add(sunLight);

      // YEÅÄ°L Ã‡Ä°MEN ZEMIN
      const groundGeo = new THREE.PlaneGeometry(200, 200);
      const groundMat = new THREE.MeshStandardMaterial({ 
        color: 0x5a8f3a,
        roughness: 0.9
      });
      const ground = new THREE.Mesh(groundGeo, groundMat);
      ground.rotation.x = -Math.PI / 2;
      ground.receiveShadow = true;
      scene.add(ground);

      // AÄAÃ‡LAR - Daha fazla
      for (let i = 0; i < 40; i++) {
        const trunkHeight = 2 + Math.random() * 2;
        const trunk = new THREE.Mesh(
          new THREE.CylinderGeometry(0.3, 0.4, trunkHeight, 8),
          new THREE.MeshStandardMaterial({ color: 0x4a3520 })
        );
        
        const leavesSize = 1.2 + Math.random() * 1;
        const leaves = new THREE.Mesh(
          new THREE.SphereGeometry(leavesSize, 8, 8),
          new THREE.MeshStandardMaterial({ color: 0x2d5016 })
        );
        
        // Rastgele pozisyon ama mÃ¼ze alanÄ±ndan uzak
        let x = Math.random() * 120 - 60;
        let z = Math.random() * 120 - 60;
        
        // MÃ¼ze Ã§evresinden uzak tut
        if (Math.abs(x) < 25 && z > -35 && z < 10) {
          x += x > 0 ? 30 : -30;
        }
        
        trunk.position.set(x, trunkHeight / 2, z);
        leaves.position.set(x, trunkHeight + leavesSize * 0.8, z);
        
        trunk.castShadow = true;
        trunk.receiveShadow = true;
        leaves.castShadow = true;
        
        scene.add(trunk);
        scene.add(leaves);
      }

      // Ã‡Ä°MEN KÃœMELERÄ° - Zemine detay
      for (let i = 0; i < 200; i++) {
        const grassClump = new THREE.Group();
        
        // BirkaÃ§ Ã§imen yapraÄŸÄ±
        for (let j = 0; j < 5; j++) {
          const blade = new THREE.Mesh(
            new THREE.ConeGeometry(0.02, 0.15 + Math.random() * 0.1, 3),
            new THREE.MeshStandardMaterial({ 
              color: new THREE.Color().setHSL(0.25 + Math.random() * 0.1, 0.6, 0.3),
              flatShading: true
            })
          );
          blade.position.set(
            (Math.random() - 0.5) * 0.1,
            0.08,
            (Math.random() - 0.5) * 0.1
          );
          blade.rotation.z = (Math.random() - 0.5) * 0.3;
          grassClump.add(blade);
        }
        
        let x = Math.random() * 100 - 50;
        let z = Math.random() * 100 - 50;
        
        if (Math.abs(x) < 20 && z > -30 && z < 5) {
          x += x > 0 ? 25 : -25;
        }
        
        grassClump.position.set(x, 0, z);
        scene.add(grassClump);
      }

      // UZAK DAÄLAR - Ufuk Ã§izgisi
      for (let i = 0; i < 8; i++) {
        const mountainHeight = 15 + Math.random() * 10;
        const mountain = new THREE.Mesh(
          new THREE.ConeGeometry(15 + Math.random() * 10, mountainHeight, 4),
          new THREE.MeshStandardMaterial({ 
            color: 0x5a6c57,
            flatShading: true
          })
        );
        
        const angle = (i / 8) * Math.PI * 2;
        const distance = 120;
        
        mountain.position.set(
          Math.cos(angle) * distance,
          mountainHeight / 2 - 2,
          Math.sin(angle) * distance
        );
        mountain.rotation.y = Math.random() * Math.PI * 2;
        mountain.receiveShadow = true;
        
        scene.add(mountain);
        
        // Kar tepesi
        const snow = new THREE.Mesh(
          new THREE.ConeGeometry(8, 6, 4),
          new THREE.MeshStandardMaterial({ color: 0xffffff })
        );
        snow.position.copy(mountain.position);
        snow.position.y += mountainHeight / 2;
        scene.add(snow);
      }

      // KAYALAR - Etrafta serpiÅŸtirilmiÅŸ
      for (let i = 0; i < 30; i++) {
        const rockSize = 0.3 + Math.random() * 0.5;
        const rock = new THREE.Mesh(
          new THREE.DodecahedronGeometry(rockSize, 0),
          new THREE.MeshStandardMaterial({ 
            color: 0x808080,
            flatShading: true
          })
        );
        
        let x = Math.random() * 90 - 45;
        let z = Math.random() * 90 - 45;
        
        if (Math.abs(x) < 20 && z > -30 && z < 5) {
          x += x > 0 ? 25 : -25;
        }
        
        rock.position.set(x, rockSize / 2, z);
        rock.rotation.set(
          Math.random() * Math.PI,
          Math.random() * Math.PI,
          Math.random() * Math.PI
        );
        rock.castShadow = true;
        rock.receiveShadow = true;
        scene.add(rock);
      }

      // BULUTLAR
      for (let i = 0; i < 12; i++) {
        const cloud = new THREE.Group();
        for (let j = 0; j < 4; j++) {
          const sphere = new THREE.Mesh(
            new THREE.SphereGeometry(Math.random() * 1.5 + 1, 8, 8),
            new THREE.MeshBasicMaterial({ 
              color: 0xffffff, 
              transparent: true, 
              opacity: 0.7 
            })
          );
          sphere.position.set(
            Math.random() * 5 - 2.5, 
            Math.random() * 1.5, 
            Math.random() * 3 - 1.5
          );
          cloud.add(sphere);
        }
        cloud.position.set(
          Math.random() * 150 - 75,
          30 + Math.random() * 20,
          Math.random() * 150 - 75
        );
        scene.add(cloud);
      }

      // NEHÄ°R - MÃ¼zenin saÄŸ tarafÄ±nda
      const riverCurve = new THREE.QuadraticBezierCurve3(
        new THREE.Vector3(35, 0.02, -60),
        new THREE.Vector3(40, 0.02, 0),
        new THREE.Vector3(35, 0.02, 60)
      );
      const riverPoints = riverCurve.getPoints(50);
      const riverShape = new THREE.Shape();
      
      riverPoints.forEach((point, i) => {
        const width = 6 + Math.sin(i * 0.2) * 1;
        if (i === 0) {
          riverShape.moveTo(point.x - width/2, point.z);
        } else {
          riverShape.lineTo(point.x - width/2, point.z);
        }
      });
      
      for (let i = riverPoints.length - 1; i >= 0; i--) {
        const point = riverPoints[i];
        const width = 6 + Math.sin(i * 0.2) * 1;
        riverShape.lineTo(point.x + width/2, point.z);
      }
      
      const riverGeo = new THREE.ShapeGeometry(riverShape);
      const riverMat = new THREE.MeshStandardMaterial({ 
        color: 0x4a90e2,
        transparent: true,
        opacity: 0.7,
        metalness: 0.3,
        roughness: 0.2
      });
      const river = new THREE.Mesh(riverGeo, riverMat);
      river.rotation.x = -Math.PI / 2;
      river.position.y = 0.02;
      river.receiveShadow = true;
      scene.add(river);

      // KÃ–PRÃœ - Nehir Ã¼zerinde
      const bridgeGeo = new THREE.BoxGeometry(8, 0.3, 3);
      const bridgeMat = new THREE.MeshStandardMaterial({ color: 0x8B4513 });
      const bridge = new THREE.Mesh(bridgeGeo, bridgeMat);
      bridge.position.set(40, 0.3, 0);
      bridge.castShadow = true;
      bridge.receiveShadow = true;
      scene.add(bridge);

      // KÃ¶prÃ¼ë‚œê°„larÄ±
      for (let side of [-1.5, 1.5]) {
        for (let i = 0; i < 5; i++) {
          const post = new THREE.Mesh(
            new THREE.BoxGeometry(0.1, 0.8, 0.1),
            bridgeMat
          );
          post.position.set(40 + (i - 2) * 1.8, 0.7, side);
          post.castShadow = true;
          scene.add(post);
        }
      }

      // UÃ‡AN KELEBEKLER
      window.butterflies = [];
      for (let i = 0; i < 10; i++) {
        const butterflyGroup = new THREE.Group();
        
        // Kanatlar
        const wingGeo = new THREE.CircleGeometry(0.15, 6);
        const wingMat = new THREE.MeshBasicMaterial({ 
          color: new THREE.Color().setHSL(Math.random(), 0.7, 0.6),
          side: THREE.DoubleSide
        });
        
        const leftWing = new THREE.Mesh(wingGeo, wingMat);
        leftWing.position.x = -0.1;
        butterflyGroup.add(leftWing);
        
        const rightWing = new THREE.Mesh(wingGeo, wingMat);
        rightWing.position.x = 0.1;
        butterflyGroup.add(rightWing);
        
        butterflyGroup.position.set(
          Math.random() * 60 - 30,
          1 + Math.random() * 3,
          Math.random() * 60 - 30
        );
        
        butterflyGroup.userData = {
          speed: 0.02 + Math.random() * 0.03,
          wingSpeed: 5 + Math.random() * 5,
          path: Math.random() * Math.PI * 2
        };
        
        scene.add(butterflyGroup);
        window.butterflies.push(butterflyGroup);
      }

      // UÃ‡AN KUÅLAR
      window.birds = [];
      for (let i = 0; i < 8; i++) {
        const birdGroup = new THREE.Group();
        
        // Basit kuÅŸ ÅŸekli (V ÅŸeklinde)
        const birdGeo = new THREE.ConeGeometry(0.1, 0.3, 4);
        const birdMat = new THREE.MeshBasicMaterial({ color: 0x333333 });
        const body = new THREE.Mesh(birdGeo, birdMat);
        body.rotation.x = Math.PI / 2;
        birdGroup.add(body);
        
        birdGroup.position.set(
          Math.random() * 100 - 50,
          10 + Math.random() * 15,
          Math.random() * 100 - 50
        );
        
        birdGroup.userData = {
          speed: 0.05 + Math.random() * 0.05,
          angle: Math.random() * Math.PI * 2,
          radius: 30 + Math.random() * 20
        };
        
        scene.add(birdGroup);
        window.birds.push(birdGroup);
      }

      // Ã‡Ä°Ã‡EKLER - Ã‡ok daha fazla! 100 Ã§iÃ§ek
      for (let i = 0; i < 100; i++) {
        const flowerGroup = new THREE.Group();
        
        // Ã‡iÃ§ek taÃ§ yapraklarÄ±
        const petalCount = 5 + Math.floor(Math.random() * 3);
        const petalColor = new THREE.Color().setHSL(Math.random(), 0.8, 0.6);
        
        for (let j = 0; j < petalCount; j++) {
          const petal = new THREE.Mesh(
            new THREE.CircleGeometry(0.15, 8),
            new THREE.MeshBasicMaterial({ color: petalColor, side: THREE.DoubleSide })
          );
          const angle = (j / petalCount) * Math.PI * 2;
          petal.position.set(Math.cos(angle) * 0.15, 0, Math.sin(angle) * 0.15);
          petal.rotation.x = -Math.PI / 2;
          flowerGroup.add(petal);
        }
        
        // Ã‡iÃ§ek merkezi
        const center = new THREE.Mesh(
          new THREE.CircleGeometry(0.08, 8),
          new THREE.MeshBasicMaterial({ color: 0xffeb3b, side: THREE.DoubleSide })
        );
        center.rotation.x = -Math.PI / 2;
        center.position.y = 0.01;
        flowerGroup.add(center);
        
        // Rastgele pozisyon ama yoldan uzak
        let x = Math.random() * 80 - 40;
        let z = Math.random() * 80 - 40;
        
        if (Math.abs(x) < 20 && z > -30 && z < 5) {
          x += x > 0 ? 25 : -25;
        }
        
        flowerGroup.position.set(x, 0.05, z);
        scene.add(flowerGroup);
      }

      // MÃœZE BÄ°NASI - GÃœZELLEÅTÄ°RÄ°LMÄ°Å
      const museumGroup = new THREE.Group();
      
      // Ana duvarlar - daha detaylÄ±
      const wallMat = new THREE.MeshStandardMaterial({ 
        color: 0xf5f0e8, 
        roughness: 0.6
      });
      const mainWalls = new THREE.Mesh(
        new THREE.BoxGeometry(28, 7, 38),
        wallMat
      );
      mainWalls.position.y = 3.5;
      mainWalls.castShadow = true;
      mainWalls.receiveShadow = true;
      museumGroup.add(mainWalls);

      // PENCERELER - 6 tane
      const windowMat = new THREE.MeshBasicMaterial({ 
        color: 0x87ceeb,
        transparent: true,
        opacity: 0.7
      });
      
      // Sol taraf pencereleri
      for (let i = 0; i < 3; i++) {
        const window1 = new THREE.Mesh(
          new THREE.BoxGeometry(2, 2.5, 0.1),
          windowMat
        );
        window1.position.set(-14.1, 4, -12 + i * 10);
        museumGroup.add(window1);
        
        // Pencere Ã§erÃ§evesi
        const frame = new THREE.Mesh(
          new THREE.BoxGeometry(2.2, 2.7, 0.15),
          new THREE.MeshStandardMaterial({ color: 0x8B4513 })
        );
        frame.position.copy(window1.position);
        frame.position.x -= 0.02;
        museumGroup.add(frame);
      }
      
      // SaÄŸ taraf pencereleri
      for (let i = 0; i < 3; i++) {
        const window2 = new THREE.Mesh(
          new THREE.BoxGeometry(2, 2.5, 0.1),
          windowMat
        );
        window2.position.set(14.1, 4, -12 + i * 10);
        museumGroup.add(window2);
        
        const frame = new THREE.Mesh(
          new THREE.BoxGeometry(2.2, 2.7, 0.15),
          new THREE.MeshStandardMaterial({ color: 0x8B4513 })
        );
        frame.position.copy(window2.position);
        frame.position.x += 0.02;
        museumGroup.add(frame);
      }

      // SÃœTUNLAR - GiriÅŸ Ã¶nÃ¼nde
      for (let side of [-2.5, 2.5]) {
        const column = new THREE.Mesh(
          new THREE.CylinderGeometry(0.4, 0.5, 6, 12),
          new THREE.MeshStandardMaterial({ color: 0xf5f0e8 })
        );
        column.position.set(side, 3, 19);
        column.castShadow = true;
        museumGroup.add(column);
        
        // SÃ¼tun baÅŸlÄ±ÄŸÄ±
        const capital = new THREE.Mesh(
          new THREE.BoxGeometry(0.8, 0.4, 0.8),
          new THREE.MeshStandardMaterial({ color: 0xe8dcc8 })
        );
        capital.position.set(side, 6.2, 19);
        museumGroup.add(capital);
      }

      // Ã‡atÄ± - daha gÃ¶rkemli
      const roofMat = new THREE.MeshStandardMaterial({ color: 0x8b4513 });
      const roof = new THREE.Mesh(
        new THREE.ConeGeometry(20, 3, 4),
        roofMat
      );
      roof.position.y = 8.5;
      roof.rotation.y = Math.PI / 4;
      roof.castShadow = true;
      museumGroup.add(roof);
      
      // Ã‡atÄ± sÃ¼slemesi - tepe
      const roofTop = new THREE.Mesh(
        new THREE.SphereGeometry(0.5, 8, 8),
        new THREE.MeshStandardMaterial({ color: 0xffd700, metalness: 0.8 })
      );
      roofTop.position.y = 10;
      museumGroup.add(roofTop);

      // KapÄ± Ã§erÃ§evesi - daha sÃ¼slÃ¼
      const doorFrameGeo = new THREE.BoxGeometry(3.4, 4.4, 0.4);
      const doorFrameMat = new THREE.MeshStandardMaterial({ color: 0x5c4033 });
      const doorFrame = new THREE.Mesh(doorFrameGeo, doorFrameMat);
      doorFrame.position.set(0, 2.1, 19.15);
      museumGroup.add(doorFrame);
      
      // KapÄ± Ã¼stÃ¼ sÃ¼sleme
      const archTop = new THREE.Mesh(
        new THREE.TorusGeometry(1.7, 0.15, 8, 16, Math.PI),
        doorFrameMat
      );
      archTop.position.set(0, 4.3, 19.15);
      archTop.rotation.x = Math.PI / 2;
      museumGroup.add(archTop);

      // KAPI (KapalÄ± ve Kilitli) - daha detaylÄ±
      const doorGeo = new THREE.BoxGeometry(3, 4, 0.2);
      const doorMat = new THREE.MeshStandardMaterial({ color: 0x3d2817 });
      const door = new THREE.Mesh(doorGeo, doorMat);
      door.position.set(0, 2, 19.2);
      door.castShadow = true;
      door.userData = { type: 'museum_door', locked: true };
      museumGroup.add(door);
      window.museumDoor = door;
      
      // KapÄ± sÃ¼slemeleri - Ã§izgiler
      for (let y of [1, 2, 3]) {
        const line = new THREE.Mesh(
          new THREE.BoxGeometry(2.6, 0.05, 0.05),
          new THREE.MeshStandardMaterial({ color: 0x2a1a0a })
        );
        line.position.set(0, y, 19.25);
        museumGroup.add(line);
      }

      // KapÄ± kolu - daha belirgin
      const handleGeo = new THREE.TorusGeometry(0.08, 0.03, 8, 16);
      const handleMat = new THREE.MeshStandardMaterial({ 
        color: 0xffd700, 
        metalness: 0.9,
        roughness: 0.1
      });
      const handle = new THREE.Mesh(handleGeo, handleMat);
      handle.position.set(1, 2, 19.3);
      handle.rotation.y = Math.PI / 2;
      museumGroup.add(handle);

      // KIRMIZI HALI - daha uzun
      const carpetGeo = new THREE.PlaneGeometry(4, 10);
      const carpetMat = new THREE.MeshStandardMaterial({ color: 0x8b0000 });
      const carpet = new THREE.Mesh(carpetGeo, carpetMat);
      carpet.rotation.x = -Math.PI / 2;
      carpet.position.set(0, 0.01, 24);
      carpet.receiveShadow = true;
      museumGroup.add(carpet);
      
      // HalÄ± kenarlarÄ± - altÄ±n
      for (let side of [-2, 2]) {
        const border = new THREE.Mesh(
          new THREE.BoxGeometry(0.1, 0.05, 10),
          new THREE.MeshStandardMaterial({ color: 0xffd700 })
        );
        border.position.set(side, 0.02, 24);
        museumGroup.add(border);
      }

      // Tabela - daha bÃ¼yÃ¼k
      const signCanvas = document.createElement('canvas');
      signCanvas.width = 1024;
      signCanvas.height = 256;
      const signCtx = signCanvas.getContext('2d');
      
      // Tabela arkaplan - degrade
      const gradient = signCtx.createLinearGradient(0, 0, 1024, 0);
      gradient.addColorStop(0, '#8B4513');
      gradient.addColorStop(0.5, '#A0522D');
      gradient.addColorStop(1, '#8B4513');
      signCtx.fillStyle = gradient;
      signCtx.fillRect(0, 0, 1024, 256);
      
      // AltÄ±n Ã§erÃ§eve
      signCtx.strokeStyle = '#FFD700';
      signCtx.lineWidth = 10;
      signCtx.strokeRect(10, 10, 1004, 236);
      
      signCtx.fillStyle = '#FFD700';
      signCtx.font = 'bold 80px Arial';
      signCtx.textAlign = 'center';
      signCtx.fillText('ğŸ’• AÅŸkÄ±mÄ±zÄ±n MÃ¼zesi ğŸ’•', 512, 150);
      
      const signTexture = new THREE.CanvasTexture(signCanvas);
      const signGeo = new THREE.PlaneGeometry(12, 3);
      const signMat = new THREE.MeshBasicMaterial({ map: signTexture });
      const sign = new THREE.Mesh(signGeo, signMat);
      sign.position.set(0, 6.8, 19.3);
      museumGroup.add(sign);
      
      // Tabela altÄ±na sÃ¼sleme
      const decoration = new THREE.Mesh(
        new THREE.BoxGeometry(12.5, 0.3, 0.3),
        new THREE.MeshStandardMaterial({ color: 0xffd700 })
      );
      decoration.position.set(0, 5.2, 19.3);
      museumGroup.add(decoration);

      scene.add(museumGroup);
      window.museumGroup = museumGroup;

      // MÃœZENÄ°N Ä°Ã‡Ä° (BaÅŸlangÄ±Ã§ta gÃ¶rÃ¼nmez, kapÄ± aÃ§Ä±ldÄ±ÄŸÄ±nda aktif)
      window.insideMuseum = false;
      window.museumInterior = new THREE.Group();
      window.museumInterior.visible = false;

      // Walls
      const wallMaterial = new THREE.MeshStandardMaterial({
        color: 0xfff0f5,
        roughness: 0.8
      });

      // MÃœZENÄ°N Ä°Ã‡Ä° - Duvarlar (gÃ¶rÃ¼nmez baÅŸlar)
      const interiorFloor = new THREE.Mesh(
        new THREE.PlaneGeometry(26, 36),
        new THREE.MeshStandardMaterial({ color: 0xf5e6e8, roughness: 0.3 })
      );
      interiorFloor.rotation.x = -Math.PI / 2;
      interiorFloor.receiveShadow = true;
      interiorFloor.position.y = 0.01;
      window.museumInterior.add(interiorFloor);

      const leftWall = new THREE.Mesh(new THREE.BoxGeometry(0.3, 6, 36), wallMaterial);
      leftWall.position.set(-13, 3, 0);
      leftWall.receiveShadow = true;
      leftWall.castShadow = true;
      window.museumInterior.add(leftWall);

      const rightWall = new THREE.Mesh(new THREE.BoxGeometry(0.3, 6, 36), wallMaterial);
      rightWall.position.set(13, 3, 0);
      rightWall.receiveShadow = true;
      rightWall.castShadow = true;
      window.museumInterior.add(rightWall);

      const backWall = new THREE.Mesh(new THREE.BoxGeometry(26, 6, 0.3), wallMaterial);
      backWall.position.set(0, 3, -18);
      backWall.receiveShadow = true;
      window.museumInterior.add(backWall);

      const interiorCeiling = new THREE.Mesh(
        new THREE.PlaneGeometry(26, 36),
        wallMaterial
      );
      interiorCeiling.rotation.x = Math.PI / 2;
      interiorCeiling.position.y = 6;
      interiorCeiling.receiveShadow = true;
      window.museumInterior.add(interiorCeiling);

      // Ä°Ã§ aydÄ±nlatma (BEYAZ IÅIK - renkleri bozmaz)
      const interiorAmbient = new THREE.AmbientLight(0xffffff, 0.7); // Beyaz
      window.museumInterior.add(interiorAmbient);

      const interiorSpot1 = new THREE.SpotLight(0xffffff, 0.8, 20, Math.PI / 6); // Beyaz
      interiorSpot1.position.set(-8, 5, 0);
      interiorSpot1.castShadow = true;
      window.museumInterior.add(interiorSpot1);

      const interiorSpot2 = new THREE.SpotLight(0xffffff, 0.8, 20, Math.PI / 6); // Beyaz
      interiorSpot2.position.set(8, 5, 0);
      interiorSpot2.castShadow = true;
      window.museumInterior.add(interiorSpot2);

      scene.add(window.museumInterior);

      // Photo frames
      createPhotoFrames();

      // Hidden messages
      createMessages();

      // Floating hearts
      createFloatingHearts();

      // Characters
      createCharacters();

      // Controls
      setupControls();

      // Start animation
      animate();
    }

    function createPhotoFrames() {
      const framePositions = [
        // Left wall
        { x: -14.5, y: 2.5, z: -15, rot: [0, Math.PI / 2, 0] },
        { x: -14.5, y: 2.5, z: -10, rot: [0, Math.PI / 2, 0] },
        { x: -14.5, y: 2.5, z: -5, rot: [0, Math.PI / 2, 0] },
        { x: -14.5, y: 2.5, z: 0, rot: [0, Math.PI / 2, 0] },
        { x: -14.5, y: 2.5, z: 5, rot: [0, Math.PI / 2, 0] },
        { x: -14.5, y: 4, z: -12, rot: [0, Math.PI / 2, 0] },
        { x: -14.5, y: 4, z: -7, rot: [0, Math.PI / 2, 0] },
        { x: -14.5, y: 4, z: -2, rot: [0, Math.PI / 2, 0] },
        { x: -14.5, y: 4, z: 3, rot: [0, Math.PI / 2, 0] },
        { x: -14.5, y: 4, z: 8, rot: [0, Math.PI / 2, 0] },
        // Right wall
        { x: 14.5, y: 2.5, z: -15, rot: [0, -Math.PI / 2, 0] },
        { x: 14.5, y: 2.5, z: -10, rot: [0, -Math.PI / 2, 0] },
        { x: 14.5, y: 2.5, z: -5, rot: [0, -Math.PI / 2, 0] },
        { x: 14.5, y: 2.5, z: 0, rot: [0, -Math.PI / 2, 0] },
        { x: 14.5, y: 2.5, z: 5, rot: [0, -Math.PI / 2, 0] },
        { x: 14.5, y: 4, z: -12, rot: [0, -Math.PI / 2, 0] },
        { x: 14.5, y: 4, z: -7, rot: [0, -Math.PI / 2, 0] },
        { x: 14.5, y: 4, z: -2, rot: [0, -Math.PI / 2, 0] },
        { x: 14.5, y: 4, z: 3, rot: [0, -Math.PI / 2, 0] },
        { x: 14.5, y: 4, z: 8, rot: [0, -Math.PI / 2, 0] }
      ];

      framePositions.forEach((pos, index) => {
        // Frame
        const frameGeo = new THREE.BoxGeometry(1.2, 1.6, 0.1);
        const frameMat = new THREE.MeshStandardMaterial({
          color: 0x8b4513,
          roughness: 0.5,
          metalness: 0.3
        });
        const frame = new THREE.Mesh(frameGeo, frameMat);
        frame.position.set(pos.x, pos.y, pos.z);
        frame.rotation.set(...pos.rot);
        frame.castShadow = true;
        scene.add(frame);

        // Photo
        const photoGeo = new THREE.PlaneGeometry(1, 1.4);
        const photoMat = new THREE.MeshStandardMaterial({
          color: new THREE.Color().setHSL(Math.random(), 0.5, 0.7),
          emissive: new THREE.Color().setHSL(Math.random(), 0.3, 0.2)
        });
        const photo = new THREE.Mesh(photoGeo, photoMat);
        photo.position.set(
          pos.x + (pos.rot[1] === Math.PI / 2 ? -0.06 : pos.rot[1] === -Math.PI / 2 ? 0.06 : 0),
          pos.y,
          pos.z
        );
        photo.rotation.set(...pos.rot);
        photo.userData = { type: 'photo', index: index + 1 };
        scene.add(photo);
        photoFrames.push(photo);

        // Heart above frame
        const heartShape = new THREE.Shape();
        const x = 0, y = 0;
        heartShape.moveTo(x, y);
        heartShape.bezierCurveTo(x, y - 0.1, x - 0.1, x - 0.15, x - 0.15, y - 0.15);
        heartShape.bezierCurveTo(x - 0.2, y - 0.15, x - 0.2, y - 0.05, x - 0.2, y);
        heartShape.bezierCurveTo(x - 0.2, y + 0.05, x - 0.15, y + 0.1, x, y + 0.2);
        heartShape.bezierCurveTo(x + 0.15, y + 0.1, x + 0.2, y + 0.05, x + 0.2, y);
        heartShape.bezierCurveTo(x + 0.2, y - 0.05, x + 0.2, y - 0.15, x + 0.15, y - 0.15);
        heartShape.bezierCurveTo(x + 0.1, y - 0.15, x, y - 0.1, x, y);

        const heartGeo = new THREE.ShapeGeometry(heartShape);
        const heartMat = new THREE.MeshStandardMaterial({
          color: 0xff1493,
          emissive: 0xff69b4,
          emissiveIntensity: 0.5
        });
        const heart = new THREE.Mesh(heartGeo, heartMat);
        heart.position.set(pos.x, pos.y + 1, pos.z);
        heart.rotation.set(...pos.rot);
        scene.add(heart);
      });
    }

    function createMessages() {
      const messageData = [
        { x: -10, z: -15, text: "Seninle geÃ§irdiÄŸim her an, hayatÄ±mÄ±n en gÃ¼zel anÄ± â¤ï¸" },
        { x: 10, z: -10, text: "Ä°lk buluÅŸmamÄ±zÄ± hatÄ±rlÄ±yor musun? Kalbim hÃ¢lÃ¢ aynÄ± hÄ±zla atÄ±yor ğŸ’•" },
        { x: -5, z: -5, text: "GÃ¼lÃ¼ÅŸÃ¼n benim en sevdiÄŸim ses ğŸŒ¹" },
        { x: 5, z: 0, text: "Seninle her gÃ¼n Sevgililer GÃ¼nÃ¼ ğŸ’" },
        { x: 0, z: 5, text: "Seni seviyorum, bugÃ¼n ve her zaman ğŸ’–" }
      ];

      messageData.forEach((msgData, index) => {
        const envelopeGeo = new THREE.BoxGeometry(0.3, 0.2, 0.15);
        const envelopeMat = new THREE.MeshStandardMaterial({
          color: 0xffb6c1,
          emissive: 0xff69b4,
          emissiveIntensity: 0.3
        });
        const envelope = new THREE.Mesh(envelopeGeo, envelopeMat);
        envelope.position.set(msgData.x, 0.15, msgData.z);
        envelope.castShadow = true;
        envelope.userData = { 
          type: 'message', 
          text: msgData.text, 
          index,
          baseY: 0.15
        };
        scene.add(envelope);
        messages.push(envelope);
      });
    }

    function createFloatingHearts() {
      for (let i = 0; i < 15; i++) {
        const heartShape = new THREE.Shape();
        const x = 0, y = 0;
        heartShape.moveTo(x, y);
        heartShape.bezierCurveTo(x, y - 0.05, x - 0.05, y - 0.08, x - 0.08, y - 0.08);
        heartShape.bezierCurveTo(x - 0.1, y - 0.08, x - 0.1, y - 0.03, x - 0.1, y);
        heartShape.bezierCurveTo(x - 0.1, y + 0.03, x - 0.08, y + 0.05, x, y + 0.1);
        heartShape.bezierCurveTo(x + 0.08, y + 0.05, x + 0.1, y + 0.03, x + 0.1, y);
        heartShape.bezierCurveTo(x + 0.1, y - 0.03, x + 0.1, y - 0.08, x + 0.08, y - 0.08);
        heartShape.bezierCurveTo(x + 0.05, y - 0.08, x, y - 0.05, x, y);

        const heartGeo = new THREE.ShapeGeometry(heartShape);
        const heartMat = new THREE.MeshStandardMaterial({
          color: 0xff1493,
          emissive: 0xff69b4,
          emissiveIntensity: 0.8,
          transparent: true,
          opacity: 0.6
        });
        const heart = new THREE.Mesh(heartGeo, heartMat);
        heart.position.set(
          Math.random() * 20 - 10,
          Math.random() * 5 + 1,
          Math.random() * 30 - 15
        );
        heart.rotation.y = Math.random() * Math.PI;
        heart.userData = { floatOffset: Math.random() * Math.PI * 2 };
        scene.add(heart);
      }
    }


    // FBX KARAKTER YÃœKLEME - TÃœM ANÄ°MASYONLARLA
    function loadFBXCharacter(parentGroup, isPlayer) {
      const loader = new THREE.FBXLoader();
      
      // Ä°lk olarak yÃ¼rÃ¼me animasyonlu karakteri yÃ¼kle
      loader.load('/mWalk.fbx', 
        function(fbxModel) {
          console.log('âœ… mWalk.fbx yÃ¼klendi!');
          fbxModel.scale.set(0.01, 0.01, 0.01);
          fbxModel.position.y = 0;
          
          fbxModel.traverse((child) => {
            if (child.isMesh) {
              child.castShadow = true;
              child.receiveShadow = true;
              
              // Debug: Materyal bilgilerini gÃ¶ster
              if (child.material) {
                console.log('ğŸ“¦ Mesh:', child.name, 'Materyal:', child.material.type, 'Renk:', child.material.color);
              }
              
              // ORÄ°JÄ°NAL MATERYALLERÄ° KORU! (Ten rengi, kÄ±yafet vs.)
              // HiÃ§bir renk deÄŸiÅŸikliÄŸi yapma!
            }
            
            // Root bone'u bul ve kilitle
            if (child.isBone && (child.name.toLowerCase().includes('hips') || 
                                  child.name.toLowerCase().includes('root') ||
                                  child.parent === fbxModel)) {
              console.log('ğŸ¦´ Root bone bulundu:', child.name);
              child.userData.isRootBone = true;
            }
          });
          
          // Animation mixer oluÅŸtur
          const animMixer = new THREE.AnimationMixer(fbxModel);
          
          // ROOT MOTION'I DEVRE DIÅI BIRAK
          // FBX iÃ§indeki hareket offset'ini yok say
          fbxModel.position.set(0, 0, 0);
          
          // YÃœRÃœME animasyonunu sakla
          let walkAction, runAction, danceAction, idleAction;
          if (fbxModel.animations && fbxModel.animations.length > 0) {
            // ROOT MOTION TRACK'Ä°NÄ° KALDIR!
            const walkClip = fbxModel.animations[0];
            walkClip.tracks = walkClip.tracks.filter(track => {
              // Position track'lerini filtrele (sadece rotation ve scale kalsÄ±n)
              return !track.name.includes('.position');
            });
            
            walkAction = animMixer.clipAction(walkClip);
            walkAction.setLoop(THREE.LoopRepeat); // SÃ¼rekli tekrarla
            console.log('ğŸ¬ Walk animasyonu - Root motion temizlendi');
          }
          
          // Mixer'Ä± global deÄŸiÅŸkene ata
          if (isPlayer) {
            mixer = animMixer;
            playerGroup.userData.walkAction = walkAction;
          } else {
            partnerMixer = animMixer;
            partnerGroup.userData.walkAction = walkAction;
          }
          
          // KOÅMA animasyonunu yÃ¼kle
          loader.load('/mRun.fbx',
            function(runFbx) {
              console.log('âœ… mRun.fbx yÃ¼klendi!');
              if (runFbx.animations && runFbx.animations.length > 0) {
                // ROOT MOTION TRACK'Ä°NÄ° KALDIR!
                const runClip = runFbx.animations[0];
                runClip.tracks = runClip.tracks.filter(track => {
                  return !track.name.includes('.position');
                });
                
                runAction = animMixer.clipAction(runClip);
                runAction.setLoop(THREE.LoopRepeat);
                console.log('ğŸƒ Run animasyonu - Root motion temizlendi');
                
                if (isPlayer) {
                  playerGroup.userData.runAction = runAction;
                } else {
                  partnerGroup.userData.runAction = runAction;
                }
              }
            },
            undefined,
            function(error) {
              console.error('âŒ mRun.fbx YÃœKLEME HATASI!', error);
              alert('âŒ HATA: mRun.fbx dosyasÄ± bulunamadÄ±!\n\nDosya: public/mRun.fbx');
            }
          );
          
          // DANS animasyonunu yÃ¼kle
          loader.load('/mDance.fbx',
            function(danceFbx) {
              console.log('âœ… mDance.fbx yÃ¼klendi!');
              if (danceFbx.animations && danceFbx.animations.length > 0) {
                // ROOT MOTION TRACK'Ä°NÄ° KALDIR!
                const danceClip = danceFbx.animations[0];
                danceClip.tracks = danceClip.tracks.filter(track => {
                  return !track.name.includes('.position');
                });
                
                danceAction = animMixer.clipAction(danceClip);
                danceAction.setLoop(THREE.LoopRepeat);
                console.log('ğŸ’ƒ Dance animasyonu - Root motion temizlendi');
                
                if (isPlayer) {
                  playerGroup.userData.danceAction = danceAction;
                } else {
                  partnerGroup.userData.danceAction = danceAction;
                }
              }
            },
            undefined,
            function(error) {
              console.error('âŒ mDance.fbx YÃœKLEME HATASI!', error);
              alert('âŒ HATA: mDance.fbx dosyasÄ± bulunamadÄ±!\n\nDosya: public/mDance.fbx');
            }
          );
          
          // IDLE animasyonunu yÃ¼kle (OPSÄ°YONEL)
          loader.load('/mIdle.fbx',
            function(idleFbx) {
              console.log('âœ… mIdle.fbx yÃ¼klendi!');
              if (idleFbx.animations && idleFbx.animations.length > 0) {
                // ROOT MOTION TRACK'Ä°NÄ° KALDIR!
                const idleClip = idleFbx.animations[0];
                idleClip.tracks = idleClip.tracks.filter(track => {
                  return !track.name.includes('.position');
                });
                
                idleAction = animMixer.clipAction(idleClip);
                idleAction.setLoop(THREE.LoopRepeat);
                idleAction.play(); // Direkt baÅŸlat, fade yok!
                idleAction.setEffectiveWeight(1); // Full weight
                console.log('ğŸ§˜ Idle animasyonu - Root motion temizlendi');
                
                currentAnimation = 'idle'; // BaÅŸlangÄ±Ã§ animasyonu idle
                if (isPlayer) {
                  playerGroup.userData.idleAction = idleAction;
                } else {
                  partnerGroup.userData.idleAction = idleAction;
                }
              }
              
              // BaÅŸlangÄ±Ã§ deÄŸerlerini gÃ¶ster
              console.log('âš™ï¸ BAÅLANGIÃ‡ HIZ AYARLARI:');
              console.log('ğŸ¬ Walk anim:', walkAnimSpeed, '| Hareket:', walkMoveSpeed);
              console.log('ğŸƒ Run anim:', runAnimSpeed, '| Hareket:', runMoveSpeed);
              console.log('ğŸ’¡ 1-8 tuÅŸlarÄ±yla ayarlayabilirsin!');
              
              // DÄ°ÄER ANÄ°MASYONLARI HAZIRLA AMA BAÅLATMA!
              // Sadece enabled = false yap, sonra gerektiÄŸinde enabled = true yapacaÄŸÄ±z
              if (walkAction) {
                walkAction.enabled = false;
                console.log('ğŸš¶ Walk hazÄ±rda bekliyor');
              }
              if (runAction) {
                runAction.enabled = false;
                console.log('ğŸƒ Run hazÄ±rda bekliyor');
              }
              if (danceAction) {
                danceAction.enabled = false;
                console.log('ğŸ’ƒ Dance hazÄ±rda bekliyor');
              }
              // Idle zaten Ã§alÄ±ÅŸÄ±yor - dokunma!
            },
            undefined,
            function(error) {
              console.warn('âš ï¸ mIdle.fbx bulunamadÄ± (opsiyonel)');
              console.log('ğŸ’¡ Idle animasyonu olmadan da Ã§alÄ±ÅŸabilir');
            }
          );
          
          // Ä°sim etiketi
          const canvas = document.createElement('canvas');
          canvas.width = 256;
          canvas.height = 64;
          const ctx = canvas.getContext('2d');
          ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
          ctx.fillRect(0, 0, 256, 64);
          ctx.fillStyle = '#ff1493';
          ctx.font = 'bold 32px Arial';
          ctx.textAlign = 'center';
          ctx.fillText('Merve', 128, 42);
          
          const nameTexture = new THREE.CanvasTexture(canvas);
          const nameSprite = new THREE.Sprite(new THREE.SpriteMaterial({ map: nameTexture }));
          nameSprite.position.y = 2;
          nameSprite.scale.set(0.8, 0.2, 1);
          fbxModel.add(nameSprite);
          
          parentGroup.add(fbxModel);
          parentGroup.userData.fbxModel = fbxModel;
        },
        function(xhr) {
          console.log((xhr.loaded / xhr.total * 100) + '% yÃ¼klendi');
        },
        function(error) {
          console.error('âŒ mWalk.fbx YÃœKLEME HATASI!');
          console.error('Hata:', error);
          console.error('âš ï¸ KONTROL ET:');
          console.error('  1. Dosya public/mWalk.fbx konumunda mÄ±?');
          console.error('  2. Dosya adÄ± tam olarak "mWalk.fbx" mi? (kÃ¼Ã§Ã¼k m, bÃ¼yÃ¼k W)');
          console.error('  3. Sunucu Ã§alÄ±ÅŸÄ±yor mu? (npm start)');
          alert('âŒ HATA: mWalk.fbx dosyasÄ± bulunamadÄ±!\n\nDosyanÄ±n public/ klasÃ¶rÃ¼nde olduÄŸundan emin olun.\nDosya adÄ±: mWalk.fbx');
        }
      );
    }

    function createCharacters() {
      // Determine which character is which
      const playerIsBatuhan = selectedCharacter === 'batuhan';
      
      // Player character
      playerGroup = new THREE.Group();
      
      // MERVE Ä°SE FBX YÃœKLE
      if (!playerIsBatuhan) {
        loadFBXCharacter(playerGroup, true);
      }
      // BATUHAN Ä°SE GEOMETRÄ°K KARAKTER
      else {
      
      // BACAKLAR - Animasyon iÃ§in ayrÄ± sakla
      const legGeo = new THREE.CylinderGeometry(0.08, 0.08, 0.6, 8);
      const legMat = new THREE.MeshStandardMaterial({ 
        color: playerIsBatuhan ? 0x2c5f9e : 0xffc0cb
      });
      const leftLeg = new THREE.Mesh(legGeo, legMat);
      leftLeg.position.set(-0.12, 0.3, 0);
      leftLeg.castShadow = true;
      playerGroup.add(leftLeg);
      playerGroup.leftLeg = leftLeg; // Animasyon iÃ§in
      
      const rightLeg = new THREE.Mesh(legGeo, legMat);
      rightLeg.position.set(0.12, 0.3, 0);
      rightLeg.castShadow = true;
      playerGroup.add(rightLeg);
      playerGroup.rightLeg = rightLeg; // Animasyon iÃ§in

      // GÃ–VDE
      const bodyGeo = new THREE.CylinderGeometry(0.2, 0.25, 0.6, 8);
      const bodyMat = new THREE.MeshStandardMaterial({ 
        color: playerIsBatuhan ? 0x4a90e2 : 0xff69b4
      });
      const body = new THREE.Mesh(bodyGeo, bodyMat);
      body.position.y = 0.9;
      body.castShadow = true;
      playerGroup.add(body);

      // ETEK (Sadece kÄ±z karakter iÃ§in) - Daha YUKARI - kollar gÃ¶rÃ¼nsÃ¼n
      if (!playerIsBatuhan) {
        const skirtGeo = new THREE.CylinderGeometry(0.28, 0.38, 0.3, 12);
        const skirtMat = new THREE.MeshStandardMaterial({ 
          color: 0xff69b4,
          side: THREE.DoubleSide
        });
        const skirt = new THREE.Mesh(skirtGeo, skirtMat);
        skirt.position.y = 0.65; // Daha yukarÄ±
        skirt.castShadow = true;
        playerGroup.add(skirt);
        playerGroup.skirt = skirt; // Dans animasyonu iÃ§in
      }

      // KOLLAR - DAHA GERÃ‡EKÃ‡Ä° VE YAPIÅIK (EteÄŸin ÃœZERÄ°NDE render edilsin)
      const armGeo = new THREE.CylinderGeometry(0.05, 0.05, 0.5, 8);
      const armMat = new THREE.MeshStandardMaterial({ color: 0xfdbcb4 });
      
      // Sol kol - omuzdan baÅŸlasÄ±n
      const leftArmPivot = new THREE.Group();
      const leftArm = new THREE.Mesh(armGeo, armMat);
      leftArm.position.y = -0.25; // Pivot noktasÄ±ndan aÅŸaÄŸÄ±
      leftArm.castShadow = true;
      leftArmPivot.add(leftArm);
      leftArmPivot.position.set(-0.22, 1.05, 0); // Omuz pozisyonu
      playerGroup.add(leftArmPivot);
      playerGroup.leftArm = leftArmPivot;
      
      // SaÄŸ kol - omuzdan baÅŸlasÄ±n
      const rightArmPivot = new THREE.Group();
      const rightArm = new THREE.Mesh(armGeo, armMat);
      rightArm.position.y = -0.25; // Pivot noktasÄ±ndan aÅŸaÄŸÄ±
      rightArm.castShadow = true;
      rightArmPivot.add(rightArm);
      rightArmPivot.position.set(0.22, 1.05, 0); // Omuz pozisyonu
      playerGroup.add(rightArmPivot);
      playerGroup.rightArm = rightArmPivot;

      // BOYUN
      const neckGeo = new THREE.CylinderGeometry(0.08, 0.08, 0.12, 8);
      const neckMat = new THREE.MeshStandardMaterial({ color: 0xfdbcb4 });
      const neck = new THREE.Mesh(neckGeo, neckMat);
      neck.position.y = 1.26;
      neck.castShadow = true;
      playerGroup.add(neck);

      // KAFA
      const headGeo = new THREE.SphereGeometry(0.2, 16, 16);
      const headMat = new THREE.MeshStandardMaterial({ color: 0xfdbcb4 });
      const head = new THREE.Mesh(headGeo, headMat);
      head.position.y = 1.42;
      head.castShadow = true;
      playerGroup.add(head);

      // SAÃ‡ - KÄ±z iÃ§in uzun saÃ§
      const hairGeo = new THREE.SphereGeometry(0.21, 16, 16);
      const hairMat = new THREE.MeshStandardMaterial({ 
        color: playerIsBatuhan ? 0x1a1a1a : 0x6b4423
      });
      const hair = new THREE.Mesh(hairGeo, hairMat);
      hair.position.y = 1.5;
      hair.scale.set(1.05, 1.1, 1.05);
      hair.castShadow = true;
      playerGroup.add(hair);

      // KIZ Ä°Ã‡Ä°N UZUN SAÃ‡ (Ponytail)
      if (!playerIsBatuhan) {
        const ponytailGeo = new THREE.SphereGeometry(0.12, 12, 12);
        // Arka saÃ§ (ponytail)
        const ponytail = new THREE.Mesh(ponytailGeo, hairMat);
        ponytail.position.set(0, 1.35, -0.18);
        ponytail.scale.set(0.8, 1.4, 0.8);
        ponytail.castShadow = true;
        playerGroup.add(ponytail);
        
        // SaÃ§ uÃ§larÄ±
        const ponytailEnd = new THREE.Mesh(ponytailGeo, hairMat);
        ponytailEnd.position.set(0, 1.1, -0.2);
        ponytailEnd.scale.set(0.6, 1.2, 0.6);
        ponytailEnd.castShadow = true;
        playerGroup.add(ponytailEnd);
      }

      // GÃ–ZLER - DAHA BÃœYÃœK VE TATLI
      const eyeWhiteGeo = new THREE.CircleGeometry(0.06, 16);
      const eyeWhiteMat = new THREE.MeshBasicMaterial({ color: 0xffffff, side: THREE.DoubleSide });
      
      const leftEyeWhite = new THREE.Mesh(eyeWhiteGeo, eyeWhiteMat);
      leftEyeWhite.position.set(-0.08, 1.46, 0.195);
      leftEyeWhite.rotation.y = -0.1;
      playerGroup.add(leftEyeWhite);
      
      const rightEyeWhite = new THREE.Mesh(eyeWhiteGeo, eyeWhiteMat);
      rightEyeWhite.position.set(0.08, 1.46, 0.195);
      rightEyeWhite.rotation.y = 0.1;
      playerGroup.add(rightEyeWhite);
      
      // GÃ¶z bebekleri - parlak
      const pupilGeo = new THREE.CircleGeometry(0.025, 12);
      const pupilMat = new THREE.MeshBasicMaterial({ color: 0x2c3e50 });
      
      const leftPupil = new THREE.Mesh(pupilGeo, pupilMat);
      leftPupil.position.set(-0.08, 1.46, 0.196);
      leftPupil.rotation.y = -0.1;
      playerGroup.add(leftPupil);
      
      const rightPupil = new THREE.Mesh(pupilGeo, pupilMat);
      rightPupil.position.set(0.08, 1.46, 0.196);
      rightPupil.rotation.y = 0.1;
      playerGroup.add(rightPupil);
      
      // IÅŸÄ±ltÄ± - gÃ¶zlere canlÄ±lÄ±k
      const shineGeo = new THREE.CircleGeometry(0.01, 8);
      const shineMat = new THREE.MeshBasicMaterial({ color: 0xffffff });
      
      const leftShine = new THREE.Mesh(shineGeo, shineMat);
      leftShine.position.set(-0.075, 1.47, 0.197);
      leftShine.rotation.y = -0.1;
      playerGroup.add(leftShine);
      
      const rightShine = new THREE.Mesh(shineGeo, shineMat);
      rightShine.position.set(0.085, 1.47, 0.197);
      rightShine.rotation.y = 0.1;
      playerGroup.add(rightShine);

      // GÃœLÃœMSEME - Daha bÃ¼yÃ¼k ve sevimli
      const smileCurve = new THREE.EllipseCurve(
        0, 0,
        0.1, 0.06,
        Math.PI * 0.9, Math.PI * 2.1,
        false,
        0
      );
      const smilePoints = smileCurve.getPoints(30);
      const smileGeometry = new THREE.BufferGeometry().setFromPoints(smilePoints);
      const smileMaterial = new THREE.LineBasicMaterial({ color: 0xff69b4, linewidth: 3 });
      const smile = new THREE.Line(smileGeometry, smileMaterial);
      smile.position.set(0, 1.35, 0.19);
      smile.rotation.x = Math.PI / 2;
      playerGroup.add(smile);
      
      // Yanaklar - allÄ±k
      const cheekGeo = new THREE.CircleGeometry(0.04, 12);
      const cheekMat = new THREE.MeshBasicMaterial({ 
        color: 0xffb6c1, 
        transparent: true, 
        opacity: 0.6,
        side: THREE.DoubleSide
      });
      
      const leftCheek = new THREE.Mesh(cheekGeo, cheekMat);
      leftCheek.position.set(-0.13, 1.38, 0.18);
      leftCheek.rotation.y = -0.3;
      playerGroup.add(leftCheek);
      
      const rightCheek = new THREE.Mesh(cheekGeo, cheekMat);
      rightCheek.position.set(0.13, 1.38, 0.18);
      rightCheek.rotation.y = 0.3;
      playerGroup.add(rightCheek);

      // ETEK (Sadece kÄ±z karakter iÃ§in)
      if (!playerIsBatuhan) {
        const skirtGeo = new THREE.CylinderGeometry(0.35, 0.45, 0.4, 12);
        const skirtMat = new THREE.MeshStandardMaterial({ 
          color: 0xff69b4,
          side: THREE.DoubleSide
        });
        const skirt = new THREE.Mesh(skirtGeo, skirtMat);
        skirt.position.y = 0.7;
        skirt.castShadow = true;
        playerGroup.add(skirt);
        playerGroup.skirt = skirt; // Dans animasyonu iÃ§in
      }

      // AYAKKABILAR
      const shoeGeo = new THREE.BoxGeometry(0.12, 0.08, 0.2);
      const shoeMat = new THREE.MeshStandardMaterial({ color: 0x333333 });
      const leftShoe = new THREE.Mesh(shoeGeo, shoeMat);
      leftShoe.position.set(-0.12, 0.04, 0.05);
      leftShoe.castShadow = true;
      playerGroup.add(leftShoe);
      
      const rightShoe = new THREE.Mesh(shoeGeo, shoeMat);
      rightShoe.position.set(0.12, 0.04, 0.05);
      rightShoe.castShadow = true;
      playerGroup.add(rightShoe);

      // Ä°SÄ°M ETÄ°KETÄ°
      const canvas = document.createElement('canvas');
      canvas.width = 256;
      canvas.height = 64;
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
      ctx.fillRect(0, 0, 256, 64);
      ctx.fillStyle = '#ff1493';
      ctx.font = 'bold 32px Arial';
      ctx.textAlign = 'center';
      ctx.fillText(playerIsBatuhan ? 'Batuhan' : 'Merve', 128, 42);
      
      const nameTexture = new THREE.CanvasTexture(canvas);
      const nameMat = new THREE.SpriteMaterial({ map: nameTexture });
      const nameSprite = new THREE.Sprite(nameMat);
      nameSprite.position.y = 1.8;
      nameSprite.scale.set(0.8, 0.2, 1);
      playerGroup.add(nameSprite);
      } // Batuhan if bloÄŸu sonu

      playerGroup.position.set(0, 0, 30); // DIÅARIDA BAÅLA
      scene.add(playerGroup);

      // PARTNER CHARACTER
      partnerGroup = new THREE.Group();
      const partnerIsBatuhan = !playerIsBatuhan;
      
      // PARTNER MERVE Ä°SE FBX YÃœKLE
      if (!partnerIsBatuhan) {
        loadFBXCharacter(partnerGroup, false);
      }
      // PARTNER BATUHAN Ä°SE GEOMETRÄ°K
      else {
      
      // GEOMETRÄ°LERÄ° TANIMLA
      const legGeo = new THREE.CylinderGeometry(0.08, 0.08, 0.6, 8);
      const bodyGeo = new THREE.CylinderGeometry(0.2, 0.25, 0.6, 8);
      const armGeo = new THREE.CylinderGeometry(0.05, 0.05, 0.5, 8);
      const neckGeo = new THREE.CylinderGeometry(0.08, 0.08, 0.12, 8);
      const headGeo = new THREE.SphereGeometry(0.2, 16, 16);
      const hairGeo = new THREE.SphereGeometry(0.21, 16, 16);
      const eyeWhiteGeo = new THREE.CircleGeometry(0.06, 16);
      const pupilGeo = new THREE.CircleGeometry(0.025, 12);
      const shineGeo = new THREE.CircleGeometry(0.01, 8);
      const cheekGeo = new THREE.CircleGeometry(0.04, 12);
      const shoeGeo = new THREE.BoxGeometry(0.12, 0.08, 0.2);
      
      // MATERYALLERÄ° TANIMLA
      const armMat = new THREE.MeshStandardMaterial({ color: 0xfdbcb4 });
      const neckMat = new THREE.MeshStandardMaterial({ color: 0xfdbcb4 });
      const headMat = new THREE.MeshStandardMaterial({ color: 0xfdbcb4 });
      const eyeWhiteMat = new THREE.MeshBasicMaterial({ color: 0xffffff, side: THREE.DoubleSide });
      const pupilMat = new THREE.MeshBasicMaterial({ color: 0x2c3e50 });
      const shineMat = new THREE.MeshBasicMaterial({ color: 0xffffff });
      const cheekMat = new THREE.MeshBasicMaterial({ 
        color: 0xffb6c1, 
        transparent: true, 
        opacity: 0.6,
        side: THREE.DoubleSide
      });
      const shoeMat = new THREE.MeshStandardMaterial({ color: 0x333333 });
      
      // GÃœLÃœMSEME GEOMETRÄ°SÄ°
      const smileCurve = new THREE.EllipseCurve(
        0, 0,
        0.1, 0.06,
        Math.PI * 0.9, Math.PI * 2.1,
        false,
        0
      );
      const smilePoints = smileCurve.getPoints(30);
      const smileGeometry = new THREE.BufferGeometry().setFromPoints(smilePoints);
      const smileMaterial = new THREE.LineBasicMaterial({ color: 0xff69b4, linewidth: 3 });
      
      // Partner Bacaklar
      const pLegMat = new THREE.MeshStandardMaterial({ 
        color: partnerIsBatuhan ? 0x2c5f9e : 0xffc0cb
      });
      const pLeftLeg = new THREE.Mesh(legGeo, pLegMat);
      pLeftLeg.position.set(-0.12, 0.3, 0);
      pLeftLeg.castShadow = true;
      partnerGroup.add(pLeftLeg);
      
      const pRightLeg = new THREE.Mesh(legGeo, pLegMat);
      pRightLeg.position.set(0.12, 0.3, 0);
      pRightLeg.castShadow = true;
      partnerGroup.add(pRightLeg);

      // Partner GÃ¶vde
      const pBodyMat = new THREE.MeshStandardMaterial({ 
        color: partnerIsBatuhan ? 0x4a90e2 : 0xff69b4
      });
      const pBody = new THREE.Mesh(bodyGeo, pBodyMat);
      pBody.position.y = 0.9;
      pBody.castShadow = true;
      partnerGroup.add(pBody);

      // Partner ETEK (Sadece kÄ±z karakter iÃ§in) - Daha YUKARI
      if (!partnerIsBatuhan) {
        const pSkirtGeo = new THREE.CylinderGeometry(0.28, 0.38, 0.3, 12);
        const pSkirtMat = new THREE.MeshStandardMaterial({ 
          color: 0xff69b4,
          side: THREE.DoubleSide
        });
        const pSkirt = new THREE.Mesh(pSkirtGeo, pSkirtMat);
        pSkirt.position.y = 0.65;
        pSkirt.castShadow = true;
        partnerGroup.add(pSkirt);
      }

      // Partner Kollar - GERÃ‡EKÃ‡Ä° (EteÄŸin Ã¼zerinde)
      const pLeftArmPivot = new THREE.Group();
      const pLeftArm = new THREE.Mesh(armGeo, armMat);
      pLeftArm.position.y = -0.25;
      pLeftArm.castShadow = true;
      pLeftArmPivot.add(pLeftArm);
      pLeftArmPivot.position.set(-0.22, 1.05, 0);
      partnerGroup.add(pLeftArmPivot);
      
      const pRightArmPivot = new THREE.Group();
      const pRightArm = new THREE.Mesh(armGeo, armMat);
      pRightArm.position.y = -0.25;
      pRightArm.castShadow = true;
      pRightArmPivot.add(pRightArm);
      pRightArmPivot.position.set(0.22, 1.05, 0);
      partnerGroup.add(pRightArmPivot);

      // Partner Boyun
      const pNeck = new THREE.Mesh(neckGeo, neckMat);
      pNeck.position.y = 1.26;
      pNeck.castShadow = true;
      partnerGroup.add(pNeck);

      // Partner Kafa
      const pHead = new THREE.Mesh(headGeo, headMat);
      pHead.position.y = 1.42;
      pHead.castShadow = true;
      partnerGroup.add(pHead);

      // Partner SaÃ§
      const pHairMat = new THREE.MeshStandardMaterial({ 
        color: partnerIsBatuhan ? 0x1a1a1a : 0x6b4423
      });
      const pHair = new THREE.Mesh(hairGeo, pHairMat);
      pHair.position.y = 1.5;
      pHair.scale.set(1.05, 1.1, 1.05);
      pHair.castShadow = true;
      partnerGroup.add(pHair);

      // Partner KÄ±z SaÃ§Ä±
      if (!partnerIsBatuhan) {
        const partnerPonytailGeo = new THREE.SphereGeometry(0.12, 12, 12);
        const pPonytail = new THREE.Mesh(partnerPonytailGeo, pHairMat);
        pPonytail.position.set(0, 1.35, -0.18);
        pPonytail.scale.set(0.8, 1.4, 0.8);
        pPonytail.castShadow = true;
        partnerGroup.add(pPonytail);
        
        const pPonytailEnd = new THREE.Mesh(partnerPonytailGeo, pHairMat);
        pPonytailEnd.position.set(0, 1.1, -0.2);
        pPonytailEnd.scale.set(0.6, 1.2, 0.6);
        pPonytailEnd.castShadow = true;
        partnerGroup.add(pPonytailEnd);
      }

      // Partner GÃ¶zler - TATLI
      const pLeftEyeWhite = new THREE.Mesh(eyeWhiteGeo, eyeWhiteMat);
      pLeftEyeWhite.position.set(-0.08, 1.46, 0.195);
      pLeftEyeWhite.rotation.y = -0.1;
      partnerGroup.add(pLeftEyeWhite);
      
      const pRightEyeWhite = new THREE.Mesh(eyeWhiteGeo, eyeWhiteMat);
      pRightEyeWhite.position.set(0.08, 1.46, 0.195);
      pRightEyeWhite.rotation.y = 0.1;
      partnerGroup.add(pRightEyeWhite);
      
      const pLeftPupil = new THREE.Mesh(pupilGeo, pupilMat);
      pLeftPupil.position.set(-0.08, 1.46, 0.196);
      pLeftPupil.rotation.y = -0.1;
      partnerGroup.add(pLeftPupil);
      
      const pRightPupil = new THREE.Mesh(pupilGeo, pupilMat);
      pRightPupil.position.set(0.08, 1.46, 0.196);
      pRightPupil.rotation.y = 0.1;
      partnerGroup.add(pRightPupil);
      
      const pLeftShine = new THREE.Mesh(shineGeo, shineMat);
      pLeftShine.position.set(-0.075, 1.47, 0.197);
      pLeftShine.rotation.y = -0.1;
      partnerGroup.add(pLeftShine);
      
      const pRightShine = new THREE.Mesh(shineGeo, shineMat);
      pRightShine.position.set(0.085, 1.47, 0.197);
      pRightShine.rotation.y = 0.1;
      partnerGroup.add(pRightShine);

      // Partner GÃ¼lÃ¼mseme
      const pSmile = new THREE.Line(smileGeometry, smileMaterial);
      pSmile.position.set(0, 1.35, 0.19);
      pSmile.rotation.x = Math.PI / 2;
      partnerGroup.add(pSmile);
      
      const pLeftCheek = new THREE.Mesh(cheekGeo, cheekMat);
      pLeftCheek.position.set(-0.13, 1.38, 0.18);
      pLeftCheek.rotation.y = -0.3;
      partnerGroup.add(pLeftCheek);
      
      const pRightCheek = new THREE.Mesh(cheekGeo, cheekMat);
      pRightCheek.position.set(0.13, 1.38, 0.18);
      pRightCheek.rotation.y = 0.3;
      partnerGroup.add(pRightCheek);

      // Partner ETEK (Sadece kÄ±z karakter iÃ§in)
      if (!partnerIsBatuhan) {
        const pSkirtGeo = new THREE.CylinderGeometry(0.35, 0.45, 0.4, 12);
        const pSkirtMat = new THREE.MeshStandardMaterial({ 
          color: 0xff69b4,
          side: THREE.DoubleSide
        });
        const pSkirt = new THREE.Mesh(pSkirtGeo, pSkirtMat);
        pSkirt.position.y = 0.7;
        pSkirt.castShadow = true;
        partnerGroup.add(pSkirt);
      }

      // Partner AyakkabÄ±lar
      const pLeftShoe = new THREE.Mesh(shoeGeo, shoeMat);
      pLeftShoe.position.set(-0.12, 0.04, 0.05);
      pLeftShoe.castShadow = true;
      partnerGroup.add(pLeftShoe);
      
      const pRightShoe = new THREE.Mesh(shoeGeo, shoeMat);
      pRightShoe.position.set(0.12, 0.04, 0.05);
      pRightShoe.castShadow = true;
      partnerGroup.add(pRightShoe);

      // Partner Ä°sim
      const pCanvas = document.createElement('canvas');
      pCanvas.width = 256;
      pCanvas.height = 64;
      const pCtx = pCanvas.getContext('2d');
      pCtx.fillStyle = 'rgba(255, 255, 255, 0.9)';
      pCtx.fillRect(0, 0, 256, 64);
      pCtx.fillStyle = '#ff1493';
      pCtx.font = 'bold 32px Arial';
      pCtx.textAlign = 'center';
      pCtx.fillText(partnerIsBatuhan ? 'Batuhan' : 'Merve', 128, 42);
      
      const pNameTexture = new THREE.CanvasTexture(pCanvas);
      const pNameMat = new THREE.SpriteMaterial({ map: pNameTexture });
      const pNameSprite = new THREE.Sprite(pNameMat);
      pNameSprite.position.y = 1.8;
      pNameSprite.scale.set(0.8, 0.2, 1);
      partnerGroup.add(pNameSprite);
      } // Partner Batuhan if bloÄŸu sonu

      partnerGroup.position.set(3, 0, 30); // DIÅARIDA BAÅLA
      partnerGroup.visible = partnerConnected;
      scene.add(partnerGroup);
    }

    function setupControls() {
      window.addEventListener('keydown', (e) => {
        keys[e.key.toLowerCase()] = true;
      });

      window.addEventListener('keyup', (e) => {
        keys[e.key.toLowerCase()] = false;
      });

      window.addEventListener('mousemove', (e) => {
        if (document.pointerLockElement === renderer.domElement) {
          yaw -= e.movementX * 0.002;
          pitch -= e.movementY * 0.002;
          
          // Limit pitch
          pitch = Math.max(-Math.PI / 3, Math.min(Math.PI / 3, pitch));
        } else {
          mouseX = (e.clientX / window.innerWidth) * 2 - 1;
          mouseY = (e.clientY / window.innerHeight) * 2 - 1;
          yaw = -mouseX * Math.PI * 0.5;
          pitch = -mouseY * 0.3;
        }
      });

      // Pointer lock for better camera control
      renderer.domElement.addEventListener('click', () => {
        renderer.domElement.requestPointerLock();
      });

      document.addEventListener('pointerlockchange', () => {
        if (!document.pointerLockElement) {
          // Pointer lock exited
        }
      });

      window.addEventListener('click', (e) => {
        const mouse = new THREE.Vector2();
        mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
        mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;

        const raycaster = new THREE.Raycaster();
        raycaster.setFromCamera(mouse, camera);
        const intersects = raycaster.intersectObjects(photoFrames);

        if (intersects.length > 0) {
          const photo = intersects[0].object;
          showPhoto(photo.userData.index);
        }

        // Close popups
        if (e.target.classList.contains('message-popup') || e.target.classList.contains('photo-popup')) {
          document.getElementById('message-popup').classList.remove('show');
          document.getElementById('photo-popup').classList.remove('show');
        }
      });

      window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      });
    }

    function showPhoto(index) {
      const colors = ['#ff69b4', '#ffb6c1', '#ffc0cb', '#ff1493', '#db7093'];
      const color1 = colors[index % colors.length];
      const color2 = colors[(index + 1) % colors.length];
      
      const photoFrame = document.getElementById('photo-frame');
      photoFrame.style.background = `linear-gradient(135deg, ${color1}, ${color2})`;
      
      document.getElementById('photo-number').textContent = index;
      document.getElementById('photo-popup').classList.add('show');
    }

    let time = 0;
    let walkCycle = 0;
    let currentAnimation = null; // Åu an oynatÄ±lan animasyon
    let isDancingToggle = false; // Dans toggle durumu
    let lastQKeyState = false; // Q tuÅŸunun Ã¶nceki durumu
    
    // ANÄ°MASYON HIZ AYARLARI (Ayarlanabilir!)
    // ANÄ°MASYON HIZ AYARLARI (Deneysel olarak ayarlandÄ±)
    let walkAnimSpeed = 0.7;   // YÃ¼rÃ¼me animasyon hÄ±zÄ± (yavaÅŸ)
    let runAnimSpeed = 1.3;    // KoÅŸma animasyon hÄ±zÄ± (hÄ±zlÄ±)
    let walkMoveSpeed = 0.010; // YÃ¼rÃ¼me hareket hÄ±zÄ± (%65 YAVAÅLATILDI!)
    let runMoveSpeed = 0.025;  // KoÅŸma hareket hÄ±zÄ± (%65 YAVAÅLATILDI!)
    let lastSpeedAdjust = 0;   // Son ayarlama zamanÄ±
    
    function animate() {
      requestAnimationFrame(animate);
      time += 16;
      walkCycle += 0.1;

      // FBX ANÄ°MASYON GÃœNCELLEMESÄ°
      const delta = clock.getDelta();
      if (mixer) mixer.update(delta);
      if (partnerMixer) partnerMixer.update(delta);
      
      // ROOT MOTION TAMAMEN DEVRE DIÅI - FBX model'i her zaman 0,0,0'da
      if (playerGroup.userData.fbxModel) {
        const fbxModel = playerGroup.userData.fbxModel;
        fbxModel.position.set(0, 0, 0);
        fbxModel.rotation.y = 0;
        
        // Root bone'u da sÄ±fÄ±rla (Hips genelde)
        fbxModel.traverse((child) => {
          if (child.userData.isRootBone) {
            const originalPos = child.userData.originalPosition;
            if (!originalPos) {
              child.userData.originalPosition = child.position.clone();
            } else {
              child.position.copy(originalPos);
            }
          }
        });
      }
      if (partnerGroup && partnerGroup.userData.fbxModel) {
        const fbxModel = partnerGroup.userData.fbxModel;
        fbxModel.position.set(0, 0, 0);
        fbxModel.rotation.y = 0;
        
        fbxModel.traverse((child) => {
          if (child.userData.isRootBone) {
            const originalPos = child.userData.originalPosition;
            if (!originalPos) {
              child.userData.originalPosition = child.position.clone();
            } else {
              child.position.copy(originalPos);
            }
          }
        });
      }

      // RUNTIME HIZ AYARLAMA (1-8 tuÅŸlarÄ±) - COOLDOWN Ä°LE
      const currentTime = Date.now();
      
      // 0 tuÅŸu ile HUD toggle
      if (keys['0'] && currentTime - lastSpeedAdjust > 300) {
        const hud = document.getElementById('speed-hud');
        hud.classList.toggle('hidden');
        lastSpeedAdjust = currentTime;
      }
      
      if (currentTime - lastSpeedAdjust > 100) { // 100ms cooldown
        let adjusted = false;
        if (keys['1']) { walkAnimSpeed += 0.02; adjusted = true; }
        if (keys['2']) { walkAnimSpeed -= 0.02; adjusted = true; }
        if (keys['3']) { runAnimSpeed += 0.02; adjusted = true; }
        if (keys['4']) { runAnimSpeed -= 0.02; adjusted = true; }
        if (keys['5']) { walkMoveSpeed += 0.002; adjusted = true; }
        if (keys['6']) { walkMoveSpeed -= 0.002; adjusted = true; }
        if (keys['7']) { runMoveSpeed += 0.003; adjusted = true; }
        if (keys['8']) { runMoveSpeed -= 0.003; adjusted = true; }
        
        if (adjusted) {
          lastSpeedAdjust = currentTime;
          
          // HUD'Ä± gÃ¼ncelle
          document.getElementById('walk-anim-speed').textContent = walkAnimSpeed.toFixed(2);
          document.getElementById('walk-move-speed').textContent = walkMoveSpeed.toFixed(3);
          document.getElementById('run-anim-speed').textContent = runAnimSpeed.toFixed(2);
          document.getElementById('run-move-speed').textContent = runMoveSpeed.toFixed(3);
          
          console.log('âš™ï¸ AYARLAR:');
          console.log('  ğŸ¬ Walk Anim:', walkAnimSpeed.toFixed(2), '| Hareket:', walkMoveSpeed.toFixed(3));
          console.log('  ğŸƒ Run Anim:', runAnimSpeed.toFixed(2), '| Hareket:', runMoveSpeed.toFixed(3));
        }
      }
      
      // Player movement - KAMERA YÃ–NÃœNE GÃ–RE
      const isMoving = keys['w'] || keys['s'] || keys['a'] || keys['d'];
      const isRunning = keys['shift']; // SHIFT = KOÅMA
      
      // Q TUÅU TOGGLE SÄ°STEMÄ°
      const qKeyPressed = keys['q'];
      if (qKeyPressed && !lastQKeyState) {
        // Q tuÅŸuna basÄ±ldÄ± (Ã¶nceden basÄ±lÄ± deÄŸildi)
        isDancingToggle = !isDancingToggle; // Toggle
        console.log('ğŸ’ƒ Dans toggle:', isDancingToggle);
      }
      lastQKeyState = qKeyPressed;
      
      // FBX ANÄ°MASYON KONTROLÃœ (Merve karakteri iÃ§in)
      if (playerGroup.userData.walkAction && playerGroup.userData.runAction && playerGroup.userData.danceAction) {
        const walkAction = playerGroup.userData.walkAction;
        const runAction = playerGroup.userData.runAction;
        const danceAction = playerGroup.userData.danceAction;
        const idleAction = playerGroup.userData.idleAction; // Opsiyonel
        
        // TÃ¼m animasyonlar yÃ¼klendiyse devam et
        if (walkAction && runAction && danceAction) {
        
        // Mevcut oynatÄ±lan animasyonun hÄ±zÄ±nÄ± gÃ¼ncelle (runtime ayarlar iÃ§in)
        if (walkAction && walkAction.enabled && walkAction.isRunning()) {
          walkAction.setEffectiveTimeScale(walkAnimSpeed);
        }
        if (runAction && runAction.enabled && runAction.isRunning()) {
          runAction.setEffectiveTimeScale(runAnimSpeed);
        }
        
        // Hangi animasyon oynatÄ±lmalÄ±?
        let targetAnimation = null;
        
        if (isDancingToggle) {
          targetAnimation = 'dance';
        } else if (isMoving && isRunning) {
          targetAnimation = 'run';
        } else if (isMoving) {
          targetAnimation = 'walk';
        } else if (idleAction) {
          targetAnimation = 'idle';
        }
        
        // EN BASÄ°T SÄ°STEM - Sadece play/pause, stop YOK!
        if (currentAnimation !== targetAnimation && targetAnimation) {
          console.log('ğŸ¬ GeÃ§iÅŸ:', currentAnimation, 'â†’', targetAnimation);
          
          // TÃ¼m animasyonlarÄ±n weight'ini 0 yap (gizle)
          if (walkAction) walkAction.setEffectiveWeight(0);
          if (runAction) runAction.setEffectiveWeight(0);
          if (danceAction) danceAction.setEffectiveWeight(0);
          if (idleAction) idleAction.setEffectiveWeight(0);
          
          // Hedef animasyonu gÃ¶ster
          if (targetAnimation === 'walk' && walkAction) {
            if (!walkAction.isRunning()) {
              walkAction.time = 0.3;
              walkAction.setEffectiveTimeScale(walkAnimSpeed);
              walkAction.play();
            }
            walkAction.setEffectiveWeight(1);
            console.log('âœ… Walk weight=1');
          } else if (targetAnimation === 'run' && runAction) {
            if (!runAction.isRunning()) {
              runAction.time = 0.2;
              runAction.setEffectiveTimeScale(runAnimSpeed);
              runAction.play();
            }
            runAction.setEffectiveWeight(1);
            console.log('âœ… Run weight=1');
          } else if (targetAnimation === 'dance' && danceAction) {
            if (!danceAction.isRunning()) {
              danceAction.time = 0;
              danceAction.play();
            }
            danceAction.setEffectiveWeight(1);
            console.log('âœ… Dance weight=1');
          } else if (targetAnimation === 'idle' && idleAction) {
            if (!idleAction.isRunning()) {
              idleAction.time = 0.2;
              idleAction.play();
            }
            idleAction.setEffectiveWeight(1);
            console.log('âœ… Idle weight=1');
          }
          
          currentAnimation = targetAnimation;
        }
        } // Animasyonlar yÃ¼klÃ¼ kontrolÃ¼ sonu
      }
      
      if (isMoving) {
        // HAREKET HIZI (Ayarlanabilir deÄŸerler)
        const currentSpeed = isRunning ? runMoveSpeed : walkMoveSpeed;
        
        // Kamera yÃ¶nÃ¼ne gÃ¶re hareket
        const forward = new THREE.Vector3();
        camera.getWorldDirection(forward);
        forward.y = 0;
        forward.normalize();
        
        const right = new THREE.Vector3();
        right.crossVectors(forward, new THREE.Vector3(0, 1, 0));
        
        if (keys['w']) {
          playerGroup.position.x += forward.x * currentSpeed;
          playerGroup.position.z += forward.z * currentSpeed;
        }
        if (keys['s']) {
          playerGroup.position.x -= forward.x * currentSpeed;
          playerGroup.position.z -= forward.z * currentSpeed;
        }
        if (keys['a']) {
          playerGroup.position.x -= right.x * currentSpeed;
          playerGroup.position.z -= right.z * currentSpeed;
        }
        if (keys['d']) {
          playerGroup.position.x += right.x * currentSpeed;
          playerGroup.position.z += right.z * currentSpeed;
        }
        
        // Karakter hareket yÃ¶nÃ¼ne dÃ¶nsÃ¼n
        const moveAngle = Math.atan2(forward.x, forward.z);
        playerGroup.rotation.y = moveAngle;
      }
      
      // ZIPLAMA
      if (keys[' '] && playerGroup.userData.onGround) {
        playerGroup.userData.velocityY = 0.15;
        playerGroup.userData.onGround = false;
      }
      
      // MÃœZÄ°K KONTROL (M tuÅŸu)
      if (keys['m'] && !window.musicToggleCooldown) {
        const music = document.getElementById('background-music');
        if (music.paused) {
          music.play().catch(e => console.log('MÃ¼zik Ã§alÄ±namadÄ±:', e));
          console.log('ğŸµ MÃ¼zik baÅŸlatÄ±ldÄ±');
        } else {
          music.pause();
          console.log('ğŸ”‡ MÃ¼zik durduruldu');
        }
        window.musicToggleCooldown = true;
        setTimeout(() => {
          window.musicToggleCooldown = false;
        }, 500);
      }
      
      // YerÃ§ekimi
      if (!playerGroup.userData.velocityY) playerGroup.userData.velocityY = 0;
      if (!playerGroup.userData.onGround) {
        playerGroup.userData.velocityY -= 0.008;
        playerGroup.position.y += playerGroup.userData.velocityY;
        
        if (playerGroup.position.y <= 0) {
          playerGroup.position.y = 0;
          playerGroup.userData.velocityY = 0;
          playerGroup.userData.onGround = true;
        }
      } else {
        playerGroup.userData.onGround = true;
      }

      // Boundaries - DÄ±ÅŸ ortam iÃ§in geniÅŸ
      if (!window.insideMuseum) {
        playerGroup.position.x = Math.max(-50, Math.min(50, playerGroup.position.x));
        playerGroup.position.z = Math.max(-50, Math.min(50, playerGroup.position.z));
      } else {
        // MÃ¼ze iÃ§i
        playerGroup.position.x = Math.max(-12, Math.min(12, playerGroup.position.x));
        playerGroup.position.z = Math.max(-17, Math.min(17, playerGroup.position.z));
      }

      // GEOMETRÄ°K KARAKTER ANÄ°MASYONLARI (Sadece Batuhan iÃ§in)
      // FBX karakterlerde (Merve) bu animasyonlar kullanÄ±lmaz
      if (playerGroup.leftArm && playerGroup.rightArm && !playerGroup.userData.fbxModel) {
        // Bu Batuhan (geometrik karakter)
        if (isMoving) {
          // YÃœRÃœME ANÄ°MASYONU
          playerGroup.leftArm.rotation.x = Math.sin(walkCycle) * 0.5;
          playerGroup.leftArm.rotation.z = 0;
          playerGroup.rightArm.rotation.x = Math.sin(walkCycle + Math.PI) * 0.5;
          playerGroup.rightArm.rotation.z = 0;
          
          // BACAK ANÄ°MASYONU
          if (playerGroup.leftLeg && playerGroup.rightLeg) {
            playerGroup.leftLeg.rotation.x = Math.sin(walkCycle) * 0.4;
            playerGroup.rightLeg.rotation.x = Math.sin(walkCycle + Math.PI) * 0.4;
          }
        } else {
          // DurduÄŸunda normal pozisyon
          playerGroup.leftArm.rotation.x = 0;
          playerGroup.leftArm.rotation.y = 0;
          playerGroup.leftArm.rotation.z = 0;
          playerGroup.rightArm.rotation.x = 0;
          playerGroup.rightArm.rotation.y = 0;
          playerGroup.rightArm.rotation.z = 0;
          
          if (playerGroup.leftLeg && playerGroup.rightLeg) {
            playerGroup.leftLeg.rotation.x = 0;
            playerGroup.rightLeg.rotation.x = 0;
          }
        }
      }

      // Third-person camera - SABÄ°T TAKÄ°P
      const cameraDistance = 4.5;
      const cameraHeight = 2.5;
      
      camera.position.x = playerGroup.position.x - Math.sin(yaw) * cameraDistance * Math.cos(pitch);
      camera.position.y = playerGroup.position.y + cameraHeight + Math.sin(pitch) * 2;
      camera.position.z = playerGroup.position.z - Math.cos(yaw) * cameraDistance * Math.cos(pitch);
      
      // Camera look at player
      camera.lookAt(playerGroup.position.x, playerGroup.position.y + 0.8, playerGroup.position.z);

      // Send position to server
      socket.emit('update_position', {
        position: {
          x: playerGroup.position.x,
          y: playerGroup.position.y,
          z: playerGroup.position.z
        },
        rotation: playerGroup.rotation.y
      });

      // Animate messages
      messages.forEach((msg, i) => {
        msg.position.y = msg.userData.baseY + Math.sin(time * 0.002 + i) * 0.1;
        msg.rotation.y += 0.01;
      });

      // Check near message
      nearMessage = null;
      messages.forEach((msg) => {
        const dist = playerGroup.position.distanceTo(msg.position);
        if (dist < 1.5) nearMessage = msg.userData;
      });

      // KAPI ETKÄ°LEÅÄ°MÄ°
      let nearDoor = false;
      if (window.museumDoor && !window.insideMuseum) {
        const doorPos = new THREE.Vector3(0, 0, 19);
        const distToDoor = playerGroup.position.distanceTo(doorPos);
        
        if (distToDoor < 3) {
          nearDoor = true;
          if (keys['e']) {
            // Pointer lock'u kapat
            if (document.pointerLockElement) {
              document.exitPointerLock();
            }
            
            document.getElementById('password-popup').style.display = 'flex';
            setTimeout(() => {
              document.getElementById('password-input').focus();
            }, 100);
          }
        }
      }

      if (nearMessage) {
        document.getElementById('message-indicator').classList.add('show');
        if (keys['e']) {
          document.getElementById('message-text').textContent = nearMessage.text;
          document.getElementById('message-popup').classList.add('show');
        }
      } else if (nearDoor) {
        document.getElementById('message-indicator').textContent = 'ğŸ” E tuÅŸuna bas - MÃ¼zeye Gir';
        document.getElementById('message-indicator').classList.add('show');
      } else {
        document.getElementById('message-indicator').classList.remove('show');
        document.getElementById('message-indicator').textContent = 'ğŸ’Œ E tuÅŸuna bas ve mesajÄ± oku!';
      }

      // Animate floating hearts
      scene.children.forEach((child) => {
        if (child.userData.floatOffset !== undefined) {
          child.position.y += Math.sin(time * 0.001 + child.userData.floatOffset) * 0.002;
          child.rotation.y += 0.01;
        }
      });

      // KELEBEK ANÄ°MASYONLARI
      if (window.butterflies) {
        window.butterflies.forEach((butterfly, i) => {
          const data = butterfly.userData;
          data.path += data.speed;
          
          // SinÃ¼s dalgasÄ± ile uÃ§
          butterfly.position.x += Math.cos(data.path) * 0.05;
          butterfly.position.z += Math.sin(data.path) * 0.05;
          butterfly.position.y = 1.5 + Math.sin(data.path * 3) * 0.5;
          
          // Kanat Ã§Ä±rpma
          if (butterfly.children[0] && butterfly.children[1]) {
            const wingAngle = Math.sin(time * data.wingSpeed * 0.001) * 0.5;
            butterfly.children[0].rotation.y = -wingAngle;
            butterfly.children[1].rotation.y = wingAngle;
          }
          
          // YÃ¶nlendir
          butterfly.rotation.y = data.path;
          
          // SÄ±nÄ±rlar iÃ§inde tut
          if (Math.abs(butterfly.position.x) > 50) butterfly.position.x *= -0.9;
          if (Math.abs(butterfly.position.z) > 50) butterfly.position.z *= -0.9;
        });
      }

      // KUÅ ANÄ°MASYONLARI
      if (window.birds) {
        window.birds.forEach((bird) => {
          const data = bird.userData;
          data.angle += data.speed * 0.01;
          
          // Dairesel uÃ§uÅŸ
          bird.position.x = Math.cos(data.angle) * data.radius;
          bird.position.z = Math.sin(data.angle) * data.radius;
          bird.position.y = 15 + Math.sin(data.angle * 3) * 3;
          
          // YÃ¶nlendir
          bird.rotation.y = data.angle + Math.PI / 2;
        });
      }

      renderer.render(scene, camera);
    }

    // Event Listeners - DOM yÃ¼klendikten sonra
    document.addEventListener('DOMContentLoaded', () => {
      console.log('âœ… DOM yÃ¼klendi, event listener\'lar ekleniyor...');
      
      // Menu butonlarÄ±
      const createBtn = document.getElementById('create-room-btn');
      const joinBtn = document.getElementById('join-room-btn');
      const submitBtn = document.getElementById('join-submit-btn');
      
      if (createBtn) {
        createBtn.addEventListener('click', createRoom);
        console.log('âœ… Create button listener eklendi');
      }
      
      if (joinBtn) {
        joinBtn.addEventListener('click', showJoinInput);
        console.log('âœ… Join button listener eklendi');
      }
      
      if (submitBtn) {
        submitBtn.addEventListener('click', joinRoom);
        console.log('âœ… Submit button listener eklendi');
      }
      
      // Enter tuÅŸu ile oda kodunu gÃ¶nder
      const roomInput = document.getElementById('room-code-input');
      if (roomInput) {
        roomInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') joinRoom();
        });
      }
      
      // Karakter seÃ§imi
      const batuhanBtn = document.getElementById('select-batuhan');
      const merveBtn = document.getElementById('select-merve');
      
      if (batuhanBtn) {
        batuhanBtn.addEventListener('click', () => selectCharacter('batuhan'));
        console.log('âœ… Batuhan button listener eklendi');
      }
      
      if (merveBtn) {
        merveBtn.addEventListener('click', () => selectCharacter('merve'));
        console.log('âœ… Merve button listener eklendi');
      }
    });
  </script>
</body>
</html>
