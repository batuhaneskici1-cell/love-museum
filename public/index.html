<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AÅŸkÄ±mÄ±zÄ±n MÃ¼zesi ğŸ’• - Multiplayer</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=Crimson+Text:ital@0;1&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
  
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/libs/fflate.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/FBXLoader.js"></script>

  <style>
    /* Orijinal CSS stillerinin tamamÄ± korunmuÅŸtur */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Playfair Display', serif; overflow: hidden; background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 50%, #ffecd2 100%); }
    #menu-screen { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: linear-gradient(135deg, rgba(255, 105, 180, 0.95), rgba(255, 182, 193, 0.95)); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; color: white; text-align: center; padding: 20px; }
    .btn { padding: 15px 30px; font-size: 1.2rem; border: none; border-radius: 30px; cursor: pointer; transition: all 0.3s; margin: 10px; font-family: 'Playfair Display', serif; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
    #create-room-btn { background: white; color: #ff69b4; }
    #create-room-btn:hover { transform: scale(1.05); box-shadow: 0 6px 20px rgba(0,0,0,0.3); }
    #join-room-btn { background: transparent; border: 2px solid white; color: white; }
    #join-room-btn:hover { background: rgba(255,255,255,0.1); }
    #character-selection { display: none; margin-top: 30px; animation: fadeIn 0.5s; }
    .char-card { display: inline-block; padding: 20px; margin: 10px; border: 3px solid transparent; border-radius: 15px; cursor: pointer; transition: all 0.3s; background: rgba(255,255,255,0.1); }
    .char-card:hover { transform: translateY(-5px); background: rgba(255,255,255,0.2); }
    .char-card.selected { border-color: white; background: rgba(255,255,255,0.3); box-shadow: 0 0 20px rgba(255,255,255,0.5); }
    #game-ui { position: fixed; top: 20px; left: 20px; color: white; z-index: 100; pointer-events: none; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body>

  <div id="menu-screen">
    <h1>AÅŸkÄ±mÄ±zÄ±n MÃ¼zesi ğŸ’•</h1>
    <p>Sadece ikimize Ã¶zel bir yolculuk...</p>
    
    <div id="initial-buttons">
      <button id="create-room-btn" class="btn">MÃ¼zeyi Kur (Host)</button>
      <button id="join-room-btn" class="btn">MÃ¼zeye KatÄ±l (Misafir)</button>
    </div>

    <div id="join-input" style="display:none; margin-top:20px;">
      <input type="text" id="room-code-input" placeholder="Oda Kodunu Girin" style="padding:12px 20px; border-radius:25px; border:none; outline:none; font-size:1.1rem; text-align:center; text-transform:uppercase;">
      <button id="join-submit-btn" class="btn" style="background:white; color:#ff69b4; padding:10px 25px;">GiriÅŸ Yap</button>
    </div>

    <div id="character-selection">
      <h2>Karakterini SeÃ§</h2>
      <div class="char-card" id="select-batuhan">
        <div style="font-size: 4rem; margin-bottom:10px;">ğŸ‘¦</div>
        <p style="font-weight:bold; font-size:1.2rem;">Batuhan</p>
      </div>
      <div class="char-card" id="select-merve">
        <div style="font-size: 4rem; margin-bottom:10px;">ğŸ‘§</div>
        <p style="font-weight:bold; font-size:1.2rem;">Merve</p>
      </div>
      <br>
      <button id="start-game-btn" class="btn" style="background:#ff1493; color:white; display:none; margin-top:20px;">MÃ¼zeyi AÃ§ âœ¨</button>
    </div>
  </div>

  <div id="game-ui" style="display:none;">
    <div style="background:rgba(0,0,0,0.3); padding:15px; border-radius:15px; backdrop-filter:blur(5px);">
      Oda Kodu: <span id="display-room-code" style="font-weight:bold; color:#fff;">-</span><br>
      Durum: <span id="status-msg">SevdiÄŸin bekleniyor... â¤ï¸</span>
    </div>
  </div>

  <script>
    let scene, camera, renderer, socket, playerGroup, partnerGroup;
    let selectedCharacter = null;
    let isHost = false;
    let roomCode = null;
    let keys = {};
    
    // Animasyon DeÄŸiÅŸkenleri
    let playerMixer, partnerMixer;
    const clock = new THREE.Clock();

    function initThreeJS() {
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0xfad0c4);
      scene.fog = new THREE.Fog(0xfad0c4, 5, 30);

      camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.shadowMap.enabled = true;
      document.body.appendChild(renderer.domElement);

      const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
      scene.add(ambientLight);
      const sunLight = new THREE.DirectionalLight(0xffffff, 0.8);
      sunLight.position.set(5, 10, 5);
      sunLight.castShadow = true;
      scene.add(sunLight);

      const floorGeo = new THREE.PlaneGeometry(100, 100);
      const floorMat = new THREE.MeshStandardMaterial({ color: 0xffffff });
      const floor = new THREE.Mesh(floorGeo, floorMat);
      floor.rotation.x = -Math.PI / 2;
      floor.receiveShadow = true;
      scene.add(floor);

      createCharacters();
      animate();
    }

    function createCharacters() {
      playerGroup = new THREE.Group();
      partnerGroup = new THREE.Group();
      scene.add(playerGroup);
      scene.add(partnerGroup);

      const loader = new THREE.FBXLoader();

      // Merve YÃ¼kleme Fonksiyonu
      const loadMerveFBX = (targetGroup, isLocal) => {
        loader.load('Walk.fbx', (fbx) => {
          fbx.scale.set(0.008, 0.008, 0.008);
          fbx.traverse(c => { if(c.isMesh) { c.castShadow = true; c.receiveShadow = true; }});
          targetGroup.add(fbx);
          
          const mixer = new THREE.AnimationMixer(fbx);
          if (fbx.animations.length > 0) {
            mixer.clipAction(fbx.animations[0]).play();
            if(isLocal) playerMixer = mixer; else partnerMixer = mixer;
          }
        });
      };

      // Batuhan Ã‡izim Fonksiyonu (Senin Orijinal Ã‡izimin)
      const drawBatuhanOriginal = (targetGroup) => {
        const body = new THREE.Mesh(new THREE.CylinderGeometry(0.2, 0.2, 1, 12), new THREE.MeshStandardMaterial({color: 0x3333ff}));
        body.position.y = 0.5;
        const head = new THREE.Mesh(new THREE.SphereGeometry(0.25, 16, 16), new THREE.MeshStandardMaterial({color: 0xfdbcb4}));
        head.position.y = 1.3;
        targetGroup.add(body, head);
      };

      // SeÃ§ime gÃ¶re Karakterleri Ata
      if (selectedCharacter === 'merve') {
        loadMerveFBX(playerGroup, true);
        drawBatuhanOriginal(partnerGroup);
      } else {
        drawBatuhanOriginal(playerGroup);
        loadMerveFBX(partnerGroup, false);
      }

      partnerGroup.visible = false;
    }

    function animate() {
      requestAnimationFrame(animate);
      const delta = clock.getDelta();
      if (playerMixer) playerMixer.update(delta);
      if (partnerMixer) partnerMixer.update(delta);
      
      handleMovement();
      renderer.render(scene, camera);
    }

    function handleMovement() {
      if (!playerGroup) return;
      const speed = 0.1;
      if (keys['w']) playerGroup.translateZ(-speed);
      if (keys['s']) playerGroup.translateZ(speed);
      if (keys['a']) playerGroup.rotation.y += 0.05;
      if (keys['d']) playerGroup.rotation.y -= 0.05;

      const relativeOffset = new THREE.Vector3(0, 2, 5);
      const cameraOffset = relativeOffset.applyMatrix4(playerGroup.matrixWorld);
      camera.position.lerp(cameraOffset, 0.1);
      camera.lookAt(playerGroup.position);

      if (socket && roomCode) {
        socket.emit('update_position', {
          position: playerGroup.position,
          rotation: playerGroup.rotation.y
        });
      }
    }

    // --- MENÃœ VE SOCKET Ä°ÅLEMLERÄ° (Orijinal haliyle) ---
    socket = io();

    function selectCharacter(char) {
      selectedCharacter = char;
      document.getElementById('select-batuhan').classList.toggle('selected', char === 'batuhan');
      document.getElementById('select-merve').classList.toggle('selected', char === 'merve');
      document.getElementById('start-game-btn').style.display = 'block';
    }

    document.getElementById('create-room-btn').addEventListener('click', () => {
      document.getElementById('initial-buttons').style.display = 'none';
      document.getElementById('character-selection').style.display = 'block';
      isHost = true;
    });

    document.getElementById('join-room-btn').addEventListener('click', () => {
      document.getElementById('initial-buttons').style.display = 'none';
      document.getElementById('join-input').style.display = 'block';
    });

    document.getElementById('join-submit-btn').addEventListener('click', () => {
      roomCode = document.getElementById('room-code-input').value.toUpperCase();
      if(roomCode) {
        document.getElementById('join-input').style.display = 'none';
        document.getElementById('character-selection').style.display = 'block';
        isHost = false;
      }
    });

    document.getElementById('start-game-btn').addEventListener('click', () => {
      document.getElementById('menu-screen').style.display = 'none';
      document.getElementById('game-ui').style.display = 'block';
      initThreeJS();
      if (isHost) socket.emit('create_room');
      else socket.emit('join_room', { roomCode });
    });

    socket.on('room_created', (data) => {
      roomCode = data.roomCode;
      document.getElementById('display-room-code').innerText = roomCode;
    });

    socket.on('partner_joined', () => {
      document.getElementById('status-msg').innerText = "AÅŸkÄ±n burada â¤ï¸";
      partnerGroup.visible = true;
    });

    socket.on('partner_moved', (data) => {
      partnerGroup.position.copy(data.position);
      partnerGroup.rotation.y = data.rotation;
    });

    window.addEventListener('keydown', (e) => keys[e.key.toLowerCase()] = true);
    window.addEventListener('keyup', (e) => keys[e.key.toLowerCase()] = false);
    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });

    document.getElementById('select-batuhan').addEventListener('click', () => selectCharacter('batuhan'));
    document.getElementById('select-merve').addEventListener('click', () => selectCharacter('merve'));

  </script>
</body>
</html>