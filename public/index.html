<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AÅŸkÄ±mÄ±zÄ±n MÃ¼zesi ğŸ’• - Multiplayer</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=Crimson+Text:ital@0;1&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fflate@0.7.4/umd/index.js"></script>
  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/js/loaders/FBXLoader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Playfair Display', serif;
      overflow: hidden;
      background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 50%, #ffecd2 100%);
    }

    #menu-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: linear-gradient(135deg, rgba(255, 105, 180, 0.95), rgba(255, 182, 193, 0.95));
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      backdrop-filter: blur(10px);
    }

    #menu-screen.hidden {
      display: none;
    }

    .menu-title {
      font-size: 72px;
      font-weight: 900;
      color: white;
      text-shadow: 4px 4px 20px rgba(0, 0, 0, 0.3);
      margin-bottom: 20px;
      animation: float 3s ease-in-out infinite;
    }

    .menu-subtitle {
      font-size: 28px;
      color: rgba(255, 255, 255, 0.9);
      margin-bottom: 60px;
      font-style: italic;
    }

    .menu-buttons {
      display: flex;
      gap: 30px;
      margin-bottom: 40px;
    }

    .menu-btn {
      padding: 20px 50px;
      font-size: 24px;
      font-family: 'Playfair Display', serif;
      font-weight: 700;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }

    .menu-btn:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
    }

    .btn-create {
      background: linear-gradient(135deg, #ff1493, #ff69b4);
      color: white;
    }

    .btn-join {
      background: white;
      color: #ff1493;
    }

    .room-input-container {
      display: none;
      margin-top: 20px;
    }

    .room-input-container.active {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
    }

    .room-code-input {
      padding: 15px 30px;
      font-size: 32px;
      font-family: 'Courier New', monospace;
      font-weight: bold;
      text-align: center;
      border: 4px solid white;
      border-radius: 15px;
      background: rgba(255, 255, 255, 0.9);
      color: #ff1493;
      letter-spacing: 5px;
      text-transform: uppercase;
      width: 300px;
    }

    .room-code-display {
      background: white;
      padding: 30px 50px;
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }

    .room-code-display h3 {
      color: #ff1493;
      font-size: 24px;
      margin-bottom: 15px;
    }

    .room-code {
      font-size: 56px;
      font-family: 'Courier New', monospace;
      font-weight: bold;
      color: #ff1493;
      letter-spacing: 8px;
      margin-bottom: 15px;
    }

    .waiting-text {
      font-size: 18px;
      color: #666;
      font-style: italic;
    }

    .error-message {
      background: rgba(255, 50, 50, 0.9);
      color: white;
      padding: 15px 30px;
      border-radius: 10px;
      font-size: 18px;
      margin-top: 20px;
      display: none;
    }

    .error-message.show {
      display: block;
      animation: shake 0.5s;
    }

    #game-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      display: none;
    }

    #game-container.active {
      display: block;
    }

    .hud {
      position: absolute;
      top: 16px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 105, 180, 0.82);
      padding: 8px 22px;
      border-radius: 30px;
      text-align: center;
      color: white;
      box-shadow: 0 4px 15px rgba(255, 105, 180, 0.35);
      backdrop-filter: blur(8px);
      z-index: 100;
      white-space: nowrap;
    }

    .hud h1 {
      margin: 0;
      font-size: 16px;
      font-weight: 700;
      letter-spacing: 0.5px;
    }

    .hud p {
      margin: 0;
      font-size: 11px;
      opacity: 0.9;
    }

    .controls {
      position: absolute;
      bottom: 20px;
      left: 20px;
      background: rgba(0, 0, 0, 0.55);
      padding: 10px 14px;
      border-radius: 12px;
      max-width: 190px;
      z-index: 100;
      backdrop-filter: blur(6px);
    }

    .controls h3 {
      margin: 0 0 6px 0;
      color: #ff9ec8;
      font-size: 12px;
      letter-spacing: 0.5px;
    }

    .controls p {
      margin: 2px 0;
      color: rgba(255,255,255,0.85);
      font-size: 11px;
      font-family: monospace;
    }

    .message-indicator {
      position: absolute;
      bottom: 30px;
      right: 30px;
      background: rgba(255, 105, 180, 0.95);
      padding: 15px 25px;
      border-radius: 15px;
      color: white;
      font-size: 18px;
      font-weight: bold;
      box-shadow: 0 5px 20px rgba(255, 105, 180, 0.5);
      display: none;
      z-index: 100;
    }

    .message-indicator.show {
      display: block;
      animation: pulse 2s infinite;
    }

    .message-popup {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      cursor: pointer;
    }

    .message-popup.show {
      display: flex;
      animation: fadeIn 0.3s ease-out;
    }

    .message-content {
      background: linear-gradient(135deg, #ff69b4, #ffb6c1);
      padding: 50px;
      border-radius: 30px;
      max-width: 600px;
      text-align: center;
      box-shadow: 0 20px 60px rgba(255, 105, 180, 0.6);
    }

    .message-content .icon {
      font-size: 60px;
      margin-bottom: 20px;
    }

    .message-content p {
      font-size: 28px;
      color: white;
      margin: 0;
      line-height: 1.6;
      font-style: italic;
    }

    .message-content .close-hint {
      font-size: 16px;
      color: rgba(255, 255, 255, 0.8);
      margin-top: 30px;
    }

    .photo-popup {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      cursor: pointer;
    }

    .photo-popup.show {
      display: flex;
    }

    .photo-content {
      background: white;
      padding: 30px;
      border-radius: 20px;
      max-width: 80vw;
      max-height: 80vh;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
    }

    .photo-frame {
      width: 600px;
      height: 400px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 10px;
      font-size: 24px;
      color: white;
      font-weight: bold;
      flex-direction: column;
    }

    .photo-frame .hint {
      font-size: 14px;
      margin-top: 10px;
      opacity: 0.8;
    }

    .partner-status {
      position: absolute;
      top: 120px;
      right: 30px;
      background: rgba(255, 255, 255, 0.95);
      padding: 15px 25px;
      border-radius: 15px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
      z-index: 100;
    }

    .partner-status h4 {
      margin: 0 0 10px 0;
      color: #ff1493;
      font-size: 16px;
    }

    .partner-status .status {
      color: #666;
      font-size: 14px;
    }

    .partner-status .connected {
      color: #00cc00;
    }

    .partner-status .waiting {
      color: #ff9900;
    }

    .character-card:hover > div {
      transform: scale(1.05);
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-20px); }
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-10px); }
      75% { transform: translateX(10px); }
    }
  </style>
</head>
<body>
  <!-- YÃœKLEME EKRANI - ROMANTÄ°K -->
  <div id="loading-screen" style="
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 50%, #ffc3a0 100%);
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    font-family: 'Arial', sans-serif;
    color: white;
    overflow: hidden;
  ">
    <!-- Kalpler animasyonu -->
    <div style="position: absolute; width: 100%; height: 100%; overflow: hidden; opacity: 0.3;">
      <div class="heart" style="position: absolute; left: 10%; animation: float 6s infinite; animation-delay: 0s;">ğŸ’•</div>
      <div class="heart" style="position: absolute; left: 20%; animation: float 7s infinite; animation-delay: 1s;">â¤ï¸</div>
      <div class="heart" style="position: absolute; left: 30%; animation: float 5s infinite; animation-delay: 2s;">ğŸ’–</div>
      <div class="heart" style="position: absolute; left: 40%; animation: float 8s infinite; animation-delay: 0.5s;">ğŸ’—</div>
      <div class="heart" style="position: absolute; left: 50%; animation: float 6s infinite; animation-delay: 1.5s;">ğŸ’“</div>
      <div class="heart" style="position: absolute; left: 60%; animation: float 7s infinite; animation-delay: 2.5s;">ğŸ’</div>
      <div class="heart" style="position: absolute; left: 70%; animation: float 5s infinite; animation-delay: 3s;">ğŸ’</div>
      <div class="heart" style="position: absolute; left: 80%; animation: float 6s infinite; animation-delay: 1s;">ğŸ’Ÿ</div>
      <div class="heart" style="position: absolute; left: 90%; animation: float 7s infinite; animation-delay: 2s;">â£ï¸</div>
    </div>
    
    <!-- Ana iÃ§erik -->
    <div style="position: relative; z-index: 1; text-align: center;">
      <h1 style="
        font-size: 48px;
        margin-bottom: 30px;
        text-shadow: 2px 2px 10px rgba(0,0,0,0.2);
        animation: pulse 2s infinite;
      ">ğŸ’• AÅŸkÄ±mÄ±zÄ±n MÃ¼zesi ğŸ’•</h1>
      
      <div id="loading-messages" style="
        font-size: 24px;
        margin: 40px 0;
        min-height: 80px;
        text-shadow: 1px 1px 5px rgba(0,0,0,0.2);
        animation: fadeIn 1s;
      ">
        Seni dÃ¼ÅŸÃ¼nÃ¼yorum... ğŸ’­
      </div>
      
      <!-- YÃ¼kleme barÄ± -->
      <div style="
        width: 400px;
        height: 30px;
        background: rgba(255,255,255,0.3);
        border-radius: 15px;
        overflow: hidden;
        margin: 30px auto;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      ">
        <div id="loading-bar" style="
          width: 0%;
          height: 100%;
          background: linear-gradient(90deg, #ff6b9d, #fec5bb);
          border-radius: 15px;
          transition: width 0.3s;
          box-shadow: 0 0 20px rgba(255,107,157,0.5);
        "></div>
      </div>
      
      <div id="loading-percentage" style="
        font-size: 20px;
        margin-top: 15px;
        font-weight: bold;
      ">0%</div>
      
      <!-- YÃ¼klenen ÅŸeyler - GÄ°ZLÄ° -->
      <div id="loading-items" style="display:none;"></div>
    </div>
    
    <style>
      @keyframes float {
        0%, 100% { transform: translateY(100vh) scale(1); opacity: 0; }
        10% { opacity: 1; }
        90% { opacity: 1; }
        100% { transform: translateY(-100px) scale(1.5); opacity: 0; }
      }
      
      @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
      }
      
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
      }
      
      .heart {
        font-size: 40px;
      }
    </style>
  </div>
  
  <!-- Menu Screen -->
  <!-- Menu Screen - GÃœZELLEÅTÄ°RÄ°LMÄ°Å -->
  <div id="menu-screen" style="
    position: fixed;
    width: 100vw;
    height: 100vh;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    overflow: hidden;
  ">
    <!-- UÃ§an kalpler arka plan -->
    <div style="position: absolute; width: 100%; height: 100%; overflow: hidden; opacity: 0.15;">
      <div class="heart-bg" style="position: absolute; left: 5%; animation: floatSlow 15s infinite; animation-delay: 0s;">ğŸ’•</div>
      <div class="heart-bg" style="position: absolute; left: 15%; animation: floatSlow 18s infinite; animation-delay: 3s;">â¤ï¸</div>
      <div class="heart-bg" style="position: absolute; left: 25%; animation: floatSlow 20s infinite; animation-delay: 6s;">ğŸ’–</div>
      <div class="heart-bg" style="position: absolute; left: 35%; animation: floatSlow 17s infinite; animation-delay: 2s;">ğŸ’—</div>
      <div class="heart-bg" style="position: absolute; left: 45%; animation: floatSlow 19s infinite; animation-delay: 5s;">ğŸ’“</div>
      <div class="heart-bg" style="position: absolute; left: 55%; animation: floatSlow 16s infinite; animation-delay: 8s;">ğŸ’</div>
      <div class="heart-bg" style="position: absolute; left: 65%; animation: floatSlow 21s infinite; animation-delay: 4s;">ğŸ’</div>
      <div class="heart-bg" style="position: absolute; left: 75%; animation: floatSlow 18s infinite; animation-delay: 7s;">ğŸ’Ÿ</div>
      <div class="heart-bg" style="position: absolute; left: 85%; animation: floatSlow 22s infinite; animation-delay: 1s;">â£ï¸</div>
      <div class="heart-bg" style="position: absolute; left: 95%; animation: floatSlow 19s infinite; animation-delay: 9s;">ğŸ’˜</div>
    </div>
    
    <style>
      @keyframes floatSlow {
        0% { transform: translateY(100vh) scale(0.8) rotate(0deg); opacity: 0; }
        5% { opacity: 1; }
        95% { opacity: 1; }
        100% { transform: translateY(-20vh) scale(1.5) rotate(360deg); opacity: 0; }
      }
      
      .heart-bg {
        font-size: 60px;
      }
      
      @keyframes glow {
        0%, 100% { box-shadow: 0 0 20px rgba(255, 255, 255, 0.5), 0 0 40px rgba(255, 105, 180, 0.3); }
        50% { box-shadow: 0 0 40px rgba(255, 255, 255, 0.8), 0 0 80px rgba(255, 105, 180, 0.5); }
      }
      
      @keyframes titlePulse {
        0%, 100% { transform: scale(1); text-shadow: 0 0 20px rgba(255,255,255,0.5); }
        50% { transform: scale(1.05); text-shadow: 0 0 40px rgba(255,255,255,0.8); }
      }
    </style>
    
    <!-- Ana iÃ§erik -->
    <div style="position: relative; z-index: 1; text-align: center; background: rgba(255,255,255,0.1); padding: 60px 80px; border-radius: 30px; backdrop-filter: blur(10px); box-shadow: 0 8px 32px rgba(0,0,0,0.2);">
      <h1 style="
        font-size: 64px;
        margin-bottom: 20px;
        color: white;
        text-shadow: 2px 2px 20px rgba(0,0,0,0.3);
        animation: titlePulse 3s infinite;
        font-family: 'Arial Black', sans-serif;
        letter-spacing: 2px;
      ">ğŸ’• AÅŸkÄ±mÄ±zÄ±n MÃ¼zesi ğŸ’•</h1>
      
      <p style="color: rgba(255,255,255,0.95); font-size: 22px; margin-bottom: 50px; text-shadow: 1px 1px 10px rgba(0,0,0,0.2);">
        Sevgililer GÃ¼nÃ¼'mÃ¼ze Ã–zel ğŸ’–
      </p>
    
      <div style="display: flex; gap: 30px; justify-content: center; margin-bottom: 30px;">
        <button id="create-room-btn" style="
          padding: 20px 50px;
          font-size: 24px;
          background: linear-gradient(135deg, #ff6b9d, #c44569);
          color: white;
          border: none;
          border-radius: 50px;
          cursor: pointer;
          transition: all 0.3s;
          font-weight: bold;
          box-shadow: 0 10px 30px rgba(255, 107, 157, 0.4);
          animation: glow 2s infinite;
        " onmouseover="this.style.transform='scale(1.1) translateY(-5px)'" onmouseout="this.style.transform='scale(1)'">
          ğŸ  Oda OluÅŸtur
        </button>
        <button id="join-room-btn" style="
          padding: 20px 50px;
          font-size: 24px;
          background: linear-gradient(135deg, #667eea, #764ba2);
          color: white;
          border: none;
          border-radius: 50px;
          cursor: pointer;
          transition: all 0.3s;
          font-weight: bold;
          box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        " onmouseover="this.style.transform='scale(1.1) translateY(-5px)'" onmouseout="this.style.transform='scale(1)'">
          ğŸšª Odaya KatÄ±l
        </button>
      </div>

      <div id="join-input" style="display: none; margin-top: 30px;">
        <input type="text" id="room-code-input" placeholder="ODA KODU GÄ°R" maxlength="6" style="
          padding: 20px 30px;
          font-size: 28px;
          border: none;
          border-radius: 50px;
          text-align: center;
          background: rgba(255,255,255,0.95);
          color: #667eea;
          font-weight: bold;
          letter-spacing: 8px;
          box-shadow: 0 5px 20px rgba(0,0,0,0.2);
          width: 300px;
          margin-bottom: 20px;
        ">
        <br>
        <button id="join-submit-btn" style="
          padding: 15px 60px;
          font-size: 22px;
          background: linear-gradient(135deg, #667eea, #764ba2);
          color: white;
          border: none;
          border-radius: 50px;
          cursor: pointer;
          transition: all 0.3s;
          font-weight: bold;
          box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        " onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
          âœ¨ KatÄ±l
        </button>
      </div>

      <div id="room-display" style="display: none; margin-top: 30px;">
        <h3 style="color: white; font-size: 28px; margin-bottom: 15px; text-shadow: 1px 1px 10px rgba(0,0,0,0.2);">
          ğŸ‰ Oda Kodun:
        </h3>
        <div id="room-code-text" style="
          font-size: 48px;
          font-weight: bold;
          color: #FFD700;
          background: rgba(0,0,0,0.3);
          padding: 20px 40px;
          border-radius: 20px;
          letter-spacing: 12px;
          text-shadow: 2px 2px 15px rgba(0,0,0,0.5);
          box-shadow: 0 5px 25px rgba(255, 215, 0, 0.3);
          margin-bottom: 20px;
        "></div>
        <p style="color: rgba(255,255,255,0.95); font-size: 20px; text-shadow: 1px 1px 10px rgba(0,0,0,0.2); animation: titlePulse 2s infinite;">
          ğŸ’– Sevgilinin katÄ±lmasÄ±nÄ± bekliyorsun... ğŸ’–
        </p>
      </div>

      <div id="error-msg" style="
        margin-top: 20px;
        padding: 15px 30px;
        background: rgba(255, 59, 48, 0.9);
        color: white;
        border-radius: 15px;
        font-size: 18px;
        display: none;
        box-shadow: 0 5px 20px rgba(255, 59, 48, 0.4);
      "></div>
    </div>
  </div>

  <!-- Character Selection Screen - GÃœZELLEÅTÄ°RÄ°LMÄ°Å -->
  <div id="character-screen" style="
    position: fixed;
    width: 100vw;
    height: 100vh;
    background: linear-gradient(135deg, #a8edea 0%, #fed6e3 50%, #ffd1ff 100%);
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    overflow: hidden;
  ">
    <!-- YÄ±ldÄ±zlar arka plan -->
    <div style="position: absolute; width: 100%; height: 100%; overflow: hidden; opacity: 0.2;">
      <div style="position: absolute; left: 10%; top: 10%; font-size: 40px; animation: twinkle 3s infinite;">â­</div>
      <div style="position: absolute; left: 80%; top: 15%; font-size: 30px; animation: twinkle 4s infinite; animation-delay: 1s;">âœ¨</div>
      <div style="position: absolute; left: 20%; top: 80%; font-size: 35px; animation: twinkle 3.5s infinite; animation-delay: 2s;">ğŸŒŸ</div>
      <div style="position: absolute; left: 70%; top: 75%; font-size: 25px; animation: twinkle 5s infinite; animation-delay: 0.5s;">ğŸ’«</div>
      <div style="position: absolute; left: 50%; top: 5%; font-size: 45px; animation: twinkle 4.5s infinite; animation-delay: 1.5s;">â­</div>
      <div style="position: absolute; left: 90%; top: 50%; font-size: 30px; animation: twinkle 3s infinite; animation-delay: 2.5s;">âœ¨</div>
    </div>
    
    <style>
      @keyframes twinkle {
        0%, 100% { opacity: 0.3; transform: scale(1); }
        50% { opacity: 1; transform: scale(1.3); }
      }
      
      @keyframes float3d {
        0%, 100% { transform: translateY(0px) rotateY(0deg); }
        50% { transform: translateY(-20px) rotateY(10deg); }
      }
      
      .character-card {
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        cursor: pointer;
      }
      
      .character-card:hover {
        transform: scale(1.15) translateY(-15px) rotateY(5deg);
        filter: brightness(1.2);
      }
      
      .character-card:active {
        transform: scale(1.05);
      }
    </style>
    
    <!-- Ana iÃ§erik -->
    <div style="position: relative; z-index: 1; text-align: center;">
      <h1 style="
        font-size: 56px;
        margin-bottom: 30px;
        color: white;
        text-shadow: 3px 3px 20px rgba(0,0,0,0.3);
        animation: titlePulse 2.5s infinite;
        font-family: 'Arial Black', sans-serif;
      ">âœ¨ Karakterini SeÃ§ âœ¨</h1>
      
      <p style="color: rgba(255,255,255,0.95); font-size: 24px; margin-bottom: 60px; text-shadow: 1px 1px 10px rgba(0,0,0,0.2);">
        Kim olarak aÅŸk mÃ¼zemizi keÅŸfedeceksin? ğŸ’•
      </p>
    
      <div style="display: flex; gap: 80px; justify-content: center; align-items: center;">
        <!-- Batuhan Character -->
        <div class="character-card" id="select-batuhan">
          <div style="
            width: 280px;
            height: 380px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 20px 60px rgba(102, 126, 234, 0.5);
            border: 5px solid rgba(255,255,255,0.3);
            position: relative;
            overflow: hidden;
            animation: float3d 4s ease-in-out infinite;
          ">
            <!-- Parlama efekti -->
            <div style="
              position: absolute;
              top: -50%;
              left: -50%;
              width: 200%;
              height: 200%;
              background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
              animation: shine 3s infinite;
            "></div>
            
            <div style="font-size: 140px; margin-bottom: 20px; filter: drop-shadow(0 10px 20px rgba(0,0,0,0.3)); animation: float3d 3s ease-in-out infinite;">ğŸ§‘</div>
            <h2 style="color: white; font-size: 42px; margin: 0; text-shadow: 2px 2px 15px rgba(0,0,0,0.4); font-family: 'Arial Black', sans-serif;">Batuhan</h2>
            <p style="color: rgba(255,255,255,0.9); font-size: 20px; margin-top: 15px; text-shadow: 1px 1px 10px rgba(0,0,0,0.3);">ğŸ–¤ Siyah SaÃ§</p>
            <div style="margin-top: 20px; background: rgba(255,255,255,0.2); padding: 10px 25px; border-radius: 20px;">
              <span style="color: white; font-size: 16px;">ğŸ‘” Erkek Karakteri</span>
            </div>
          </div>
        </div>

        <!-- Merve Character -->
        <div class="character-card" id="select-merve">
          <div style="
            width: 280px;
            height: 380px;
            background: linear-gradient(135deg, #ff6b9d 0%, #c44569 100%);
            border-radius: 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 20px 60px rgba(255, 107, 157, 0.5);
            border: 5px solid rgba(255,255,255,0.3);
            position: relative;
            overflow: hidden;
            animation: float3d 4s ease-in-out infinite;
            animation-delay: 0.5s;
          ">
            <!-- Parlama efekti -->
            <div style="
              position: absolute;
              top: -50%;
              left: -50%;
              width: 200%;
              height: 200%;
              background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
              animation: shine 3s infinite;
              animation-delay: 0.5s;
            "></div>
            
            <div style="font-size: 140px; margin-bottom: 20px; filter: drop-shadow(0 10px 20px rgba(0,0,0,0.3)); animation: float3d 3s ease-in-out infinite; animation-delay: 0.5s;">ğŸ‘§</div>
            <h2 style="color: white; font-size: 42px; margin: 0; text-shadow: 2px 2px 15px rgba(0,0,0,0.4); font-family: 'Arial Black', sans-serif;">Merve</h2>
            <p style="color: rgba(255,255,255,0.9); font-size: 20px; margin-top: 15px; text-shadow: 1px 1px 10px rgba(0,0,0,0.3);">ğŸ¤ Kahverengi SaÃ§</p>
            <div style="margin-top: 20px; background: rgba(255,255,255,0.2); padding: 10px 25px; border-radius: 20px;">
              <span style="color: white; font-size: 16px;">ğŸ‘— KadÄ±n Karakteri</span>
            </div>
          </div>
        </div>
      </div>

      <p style="
        color: white;
        font-size: 22px;
        margin-top: 70px;
        text-align: center;
        text-shadow: 2px 2px 15px rgba(0,0,0,0.3);
        background: rgba(255,255,255,0.15);
        padding: 20px 40px;
        border-radius: 25px;
        backdrop-filter: blur(10px);
        display: inline-block;
      ">
        ğŸ’ Karakterini seÃ§ ve birlikte aÅŸk mÃ¼zemizi keÅŸfedelim! ğŸ’
      </p>
    </div>
    
    <style>
      @keyframes shine {
        0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
        100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
      }
    </style>
  </div>

  <!-- Game Container -->
  <div id="game-container">
    <div class="hud">
      <h1>AÅŸkÄ±mÄ±zÄ±n MÃ¼zesi â¤ï¸</h1>
      <p>Mutlu Sevgililer GÃ¼nÃ¼, CanÄ±m! ğŸ’•</p>
    </div>

    <!-- Speed Adjustment HUD -->
    <div class="controls">
      <h3>Kontroller ğŸ®</h3>
      <p><strong>W A S D</strong> - Hareket Et</p>
      <p><strong>SHIFT</strong> - KoÅŸ ğŸƒâ€â™€ï¸</p>
      <p><strong>Fare</strong> - Kamera DÃ¶ndÃ¼r (Ekrana tÄ±kla)</p>
      <p><strong>SPACE</strong> - ZÄ±pla</p>
      <p><strong>Q</strong> - Dans SeÃ§ ğŸ’ƒ</p>
      <p><strong>E</strong> - MesajÄ± Oku / KapÄ±ya Gir</p>
      <p><strong>M</strong> - MÃ¼zik AÃ§/Kapat ğŸµ</p>
      <p><strong>TÄ±kla</strong> - FotoÄŸrafa YakÄ±ndan Bak</p>
      <p><strong>ESC</strong> - Fareyi Serbest BÄ±rak</p>
    </div>

    <!-- Background Music -->
    <audio id="background-music" loop>
      <source src="music/piano.mp3" type="audio/mpeg">
    </audio>

    <div class="partner-status">
      <h4>Partner Durumu:</h4>
      <p class="status waiting" id="partner-status">Bekleniyor...</p>
    </div>

    <div class="message-indicator" id="message-indicator">
      ğŸ’Œ E tuÅŸuna bas ve mesajÄ± oku!
    </div>

    <div class="message-popup" id="message-popup">
      <div class="message-content">
        <div class="icon">ğŸ’•</div>
        <p id="message-text"></p>
        <p class="close-hint">(Kapatmak iÃ§in tÄ±kla)</p>
      </div>
    </div>

    <div class="photo-popup" id="photo-popup">
      <div class="photo-content">
        <div class="photo-frame" id="photo-frame">
          <div>ğŸ“· FotoÄŸraf #<span id="photo-number"></span></div>
          <div class="hint">(Kendi fotoÄŸrafÄ±nÄ± buraya ekleyebilirsin)</div>
        </div>
        <p style="text-align: center; margin-top: 20px; color: #666; font-size: 14px;">
          Kapatmak iÃ§in tÄ±kla
        </p>
      </div>
    </div>

    <!-- Password Popup for Museum Door -->
    <div id="password-popup" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.8); z-index: 2000; align-items: center; justify-content: center;">
      <div style="background: linear-gradient(135deg, #ff69b4, #ffb6c1); padding: 50px; border-radius: 30px; max-width: 600px; text-align: center; box-shadow: 0 20px 60px rgba(255, 105, 180, 0.6);">
        <div style="font-size: 60px; margin-bottom: 20px;">ğŸ”</div>
        <h2 style="color: white; font-size: 32px; margin: 0 0 30px 0;">MÃ¼ze GiriÅŸi</h2>
        <p style="color: white; font-size: 24px; margin-bottom: 30px;">KocanÄ±n adÄ± ne?</p>
        <input type="text" id="password-input" placeholder="Cevap..." style="padding: 15px 30px; font-size: 24px; border: 3px solid white; border-radius: 15px; width: 80%; text-align: center; margin-bottom: 20px;" onkeypress="if(event.key==='Enter') checkPassword()">
        <div style="display: flex; gap: 20px; justify-content: center; margin-top: 20px;">
          <button onclick="checkPassword()" style="padding: 15px 40px; font-size: 20px; background: white; color: #ff1493; border: none; border-radius: 50px; cursor: pointer; font-weight: bold;">GiriÅŸ Yap</button>
          <button onclick="closePasswordPopup()" style="padding: 15px 40px; font-size: 20px; background: rgba(255,255,255,0.3); color: white; border: none; border-radius: 50px; cursor: pointer; font-weight: bold;">Ä°ptal</button>
        </div>
        <p id="password-error" style="color: #ffeeee; margin-top: 20px; font-size: 18px; display: none;"></p>
      </div>
    </div>

    <!-- DANS SEÃ‡Ä°M MENÃœSÃœ -->
    <div id="dance-menu" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.8); z-index: 2000; align-items: center; justify-content: center;">
      <div style="background: linear-gradient(135deg, rgba(255, 105, 180, 0.98), rgba(255, 182, 193, 0.98)); padding: 40px; border-radius: 25px; box-shadow: 0 10px 40px rgba(0,0,0,0.4); backdrop-filter: blur(10px);">
        <h2 style="color: white; text-align: center; margin-bottom: 25px; font-size: 36px; text-shadow: 2px 2px 4px rgba(0,0,0,0.2);">ğŸ’ƒ Dans SeÃ§ ğŸ•º</h2>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
          <button onclick="selectDance(1)" style="padding: 25px; font-size: 22px; background: white; border: 3px solid #ff69b4; border-radius: 15px; cursor: pointer; transition: all 0.3s; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.2);" onmouseover="this.style.background='#ff69b4'; this.style.color='white'; this.style.transform='scale(1.05)';" onmouseout="this.style.background='white'; this.style.color='black'; this.style.transform='scale(1)';">
            ğŸµ Dans 1
          </button>
          <button onclick="selectDance(2)" style="padding: 25px; font-size: 22px; background: white; border: 3px solid #ff69b4; border-radius: 15px; cursor: pointer; transition: all 0.3s; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.2);" onmouseover="this.style.background='#ff69b4'; this.style.color='white'; this.style.transform='scale(1.05)';" onmouseout="this.style.background='white'; this.style.color='black'; this.style.transform='scale(1)';">
            ğŸ’ƒ Dans 2
          </button>
          <button onclick="selectDance(3)" style="padding: 25px; font-size: 22px; background: white; border: 3px solid #ff69b4; border-radius: 15px; cursor: pointer; transition: all 0.3s; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.2);" onmouseover="this.style.background='#ff69b4'; this.style.color='white'; this.style.transform='scale(1.05)';" onmouseout="this.style.background='white'; this.style.color='black'; this.style.transform='scale(1)';">
            ğŸ•º Dans 3
          </button>
          <button onclick="selectDance(4)" style="padding: 25px; font-size: 22px; background: white; border: 3px solid #ff69b4; border-radius: 15px; cursor: pointer; transition: all 0.3s; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.2);" onmouseover="this.style.background='#ff69b4'; this.style.color='white'; this.style.transform='scale(1.05)';" onmouseout="this.style.background='white'; this.style.color='black'; this.style.transform='scale(1)';">
            ğŸ‰ Dans 4
          </button>
        </div>
        <button onclick="closeDanceMenu()" style="padding: 18px; width: 100%; font-size: 20px; background: rgba(255,255,255,0.3); border: 2px solid white; border-radius: 12px; color: white; cursor: pointer; font-weight: bold; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.5)';" onmouseout="this.style.background='rgba(255,255,255,0.3)';">
          âŒ Ä°ptal
        </button>
      </div>
    </div>
  </div>

  <script>
    // YÃœKLEME EKRANI KONTROLCÃœSÃœ
    const loadingManager = {
      total: 0,
      loaded: 0,
      messages: [
        "Kalbine baÄŸlanÄ±lÄ±yorâ€¦ LÃ¼tfen bekleyin ğŸ’˜",
        "Birlikte sonsuz level'a geÃ§iliyorâ€¦",
        "SarÄ±lma DLC'si yÃ¼kleniyorâ€¦",
        "Sana aÅŸÄ±rÄ± dÃ¼ÅŸme hatasÄ± algÄ±landÄ±! (Ã§Ã¶zÃ¼m aranmÄ±yor)",
        "AÅŸk XP'si kazanÄ±lÄ±yorâ€¦",
        "KÄ±skanma modu kapatÄ±ldÄ±. (belki ğŸ˜)",
        "GÃ¼lÃ¼ÅŸÃ¼n sisteme entegre edildi âœ”",
        "Seni sevmek varsayÄ±lan ayar olarak seÃ§ildi âœ”",
        "Sevgi barÄ± fullendi â¤ï¸",
        "Seni gÃ¶rÃ¼nce sistem Ä±sÄ±nÄ±yorâ€¦",
        "Sana bakÄ±nca utangaÃ§lÄ±k modu aÃ§Ä±lÄ±yorâ€¦",
        "Kalp Ã§arpÄ±ntÄ±sÄ± gÃ¼ncellemesi indiriliyorâ€¦"
      ],
      currentMessageIndex: 0,
      
      init() {
        this.updateMessage();
        setInterval(() => this.updateMessage(), 4000); // Her 4 saniyede bir mesaj deÄŸiÅŸtir
      },
      
      updateMessage() {
        const msgElement = document.getElementById('loading-messages');
        if (msgElement) {
          msgElement.style.animation = 'none';
          setTimeout(() => {
            msgElement.textContent = this.messages[this.currentMessageIndex];
            msgElement.style.animation = 'fadeIn 1s';
            this.currentMessageIndex = (this.currentMessageIndex + 1) % this.messages.length;
          }, 50);
        }
      },
      
      addItem(name) {
        this.total++;
        const itemsElement = document.getElementById('loading-items');
        if (itemsElement) {
          const item = document.createElement('div');
          item.id = `loading-item-${this.total}`;
          item.textContent = `â³ ${name}...`;
          item.style.opacity = '0';
          item.style.transition = 'opacity 0.5s';
          itemsElement.appendChild(item);
          setTimeout(() => item.style.opacity = '1', 10);
        }
      },
      
      completeItem(name) {
        this.loaded++;
        const percentage = Math.round((this.loaded / this.total) * 100);
        // GerÃ§ek yÃ¼kleme sahte ilerlemeden bÃ¼yÃ¼kse gÃ¼ncelle
        const displayPercent = Math.max(percentage, Math.round(this._fakeProgress || 0));
        
        // Update bar
        const bar = document.getElementById('loading-bar');
        if (bar) bar.style.width = displayPercent + '%';
        
        // Update percentage
        const perc = document.getElementById('loading-percentage');
        if (perc) perc.textContent = displayPercent + '%';
        
        // Mark item complete
        const itemsElement = document.getElementById('loading-items');
        if (itemsElement) {
          const items = itemsElement.children;
          for (let item of items) {
            if (item.textContent.includes(name)) {
              item.textContent = `âœ… ${name}`;
              item.style.color = '#4ade80';
            }
          }
        }
        
        // TÃ¼mÃ¼ yÃ¼klendiyse ekranÄ± kapat
        if (this.loaded >= this.total && this.total > 0) {
          if (this._fakeInterval) clearInterval(this._fakeInterval);
          setTimeout(() => this.hide(), 500);
        }
      },
      
      show() {
        const screen = document.getElementById('loading-screen');
        if (screen) {
          screen.style.display = 'flex';
          screen.style.opacity = '1';
        }
        
        // Sahte Ã¶n ilerleme: 0% â†’ 40% (dosyalar yÃ¼klenene kadar oyalar)
        this._fakeProgress = 0;
        this._fakeInterval = setInterval(() => {
          if (this._fakeProgress < 40) {
            this._fakeProgress += 0.15; // Ã‡ok yavaÅŸ ilerle
            const realPercent = this.total > 0 ? Math.round((this.loaded / this.total) * 100) : 0;
            if (realPercent < this._fakeProgress) {
              const bar = document.getElementById('loading-bar');
              if (bar) bar.style.width = this._fakeProgress + '%';
              const perc = document.getElementById('loading-percentage');
              if (perc) perc.textContent = Math.round(this._fakeProgress) + '%';
            }
          } else {
            clearInterval(this._fakeInterval);
          }
        }, 120); // 120ms Ã— ~267 adÄ±m = ~32 saniyede %40'a ulaÅŸÄ±r
      },
      
      hide() {
        const screen = document.getElementById('loading-screen');
        if (screen) {
          screen.style.transition = 'opacity 1s';
          screen.style.opacity = '0';
          setTimeout(() => {
            screen.style.display = 'none';
          }, 1000);
        }
      }
    };
    
    // YÃ¼kleme ekranÄ±nÄ± baÅŸlat
    loadingManager.init();
    
    // Socket.io connection
    const socket = io();
    
    let scene, camera, renderer;
    let playerGroup, partnerGroup;
    let mixer, partnerMixer;
    let clock = new THREE.Clock();
    let keys = {};
    let mouseX = 0;
    let mouseY = 0;
    let yaw = 0;
    let pitch = 0.3; // Kamera aÃ§Ä±sÄ± (yukarÄ±/aÅŸaÄŸÄ±)
    let isHost = false;
    let roomCode = '';
    let partnerConnected = false;
    let photoFrames = [];
    let messages = [];
    let nearMessage = null;
    let selectedCharacter = null;
    let pendingAction = null; // 'create' or 'join'
    let selectedDance = 0; // 0 = dans yok, 1-4 = dans numarasÄ±
    let currentDanceAction = null; // Åu an Ã§alan dans animasyonu

    let moveSpeed = 0.1; // YÃ¼rÃ¼me hÄ±zÄ±

    // Socket events
    socket.on('room_created', (data) => {
      roomCode = data.roomCode;
      isHost = data.isHost;
      document.getElementById('room-code-text').textContent = roomCode;
      document.getElementById('room-display').style.display = 'block';
    });

    socket.on('room_joined', (data) => {
      roomCode = data.roomCode;
      isHost = data.isHost;
      partnerConnected = true;
      
      // Partner status gÃ¼ncelle (misafir odaya girince host zaten orada)
      const statusEl = document.getElementById('partner-status');
      if (statusEl) {
        statusEl.textContent = 'BaÄŸlandÄ± ğŸ’‘';
        statusEl.classList.remove('waiting');
        statusEl.classList.add('connected');
      }
      
      // Menu ekranÄ±nÄ± gizle, karakter seÃ§im ekranÄ±nÄ± gÃ¶ster
      document.getElementById('menu-screen').style.display = 'none';
      document.getElementById('character-screen').style.display = 'flex';
    });

    socket.on('partner_joined', () => {
      partnerConnected = true;
      console.log('ğŸ’‘ Partner katÄ±ldÄ±!');
      
      // Partner status gÃ¼ncelle
      const statusEl = document.getElementById('partner-status');
      if (statusEl) {
        statusEl.textContent = 'BaÄŸlandÄ± ğŸ’‘';
        statusEl.classList.remove('waiting');
        statusEl.classList.add('connected');
      }
      
      // Make partner visible immediately
      if (partnerGroup) {
        partnerGroup.visible = true;
      }
      
      // If we're waiting, show character selection
      if (!selectedCharacter) {
        document.getElementById('menu-screen').style.display = 'none';
        document.getElementById('character-screen').style.display = 'flex';
      }
    });

    socket.on('partner_moved', (data) => {
      if (partnerGroup) {
        partnerGroup.position.set(data.position.x, data.position.y, data.position.z);
        partnerGroup.rotation.y = data.rotation;
        
        // ANÄ°MASYON SENKRONÄ°ZASYONU
        if (data.animation && partnerGroup.userData) {
          const partnerWalk = partnerGroup.userData.walkAction;
          const partnerRun = partnerGroup.userData.runAction;
          const partnerIdle = partnerGroup.userData.idleAction;
          const partnerDance1 = partnerGroup.userData.danceAction1;
          const partnerDance2 = partnerGroup.userData.danceAction2;
          const partnerDance3 = partnerGroup.userData.danceAction3;
          const partnerDance4 = partnerGroup.userData.danceAction4;
          
          // TÃ¼m animasyonlarÄ± gizle
          if (partnerWalk) partnerWalk.setEffectiveWeight(0);
          if (partnerRun) partnerRun.setEffectiveWeight(0);
          if (partnerIdle) partnerIdle.setEffectiveWeight(0);
          if (partnerDance1) partnerDance1.setEffectiveWeight(0);
          if (partnerDance2) partnerDance2.setEffectiveWeight(0);
          if (partnerDance3) partnerDance3.setEffectiveWeight(0);
          if (partnerDance4) partnerDance4.setEffectiveWeight(0);
          
          // Ä°lgili animasyonu gÃ¶ster
          if (data.animation === 'walk' && partnerWalk) {
            partnerWalk.setEffectiveWeight(1);
          } else if (data.animation === 'run' && partnerRun) {
            partnerRun.setEffectiveWeight(1);
          } else if (data.animation === 'idle' && partnerIdle) {
            partnerIdle.setEffectiveWeight(1);
          } else if (data.animation === 'dance1' && partnerDance1) {
            partnerDance1.setEffectiveWeight(1);
          } else if (data.animation === 'dance2' && partnerDance2) {
            partnerDance2.setEffectiveWeight(1);
          } else if (data.animation === 'dance3' && partnerDance3) {
            partnerDance3.setEffectiveWeight(1);
          } else if (data.animation === 'dance4' && partnerDance4) {
            partnerDance4.setEffectiveWeight(1);
          }
          
          // Partner dans ediyorsa hem fbxModel hem partnerGroup Y'sini sÄ±fÄ±rla
          if (data.animation && data.animation.startsWith('dance')) {
            const partnerFbx = partnerGroup.userData.fbxModel;
            if (partnerFbx) partnerFbx.position.y = partnerFbx.userData.yOffset || 0;
            partnerGroup.position.y = 0;
          }
        }
        
        // Make sure partner is visible
        if (!partnerGroup.visible && partnerConnected) {
          partnerGroup.visible = true;
        }
      }
    });

    socket.on('partner_disconnected', () => {
      partnerConnected = false;
      document.getElementById('partner-status').textContent = 'AyrÄ±ldÄ± ğŸ’”';
      document.getElementById('partner-status').classList.remove('connected');
      document.getElementById('partner-status').classList.add('waiting');
      if (partnerGroup) {
        partnerGroup.visible = false;
      }
    });

    socket.on('error', (data) => {
      showError(data.message);
    });

    // Menu functions
    function createRoom() {
      console.log('ğŸ  Oda oluÅŸturuluyor...');
      pendingAction = 'create';
      socket.emit('create_room');
    }

    function showJoinInput() {
      console.log('ğŸšª KatÄ±lma ekranÄ± aÃ§Ä±lÄ±yor...');
      document.getElementById('join-input').style.display = 'block';
      document.getElementById('room-code-input').focus();
    }

    function joinRoom() {
      const code = document.getElementById('room-code-input').value.toUpperCase();
      console.log('ğŸ”‘ Odaya katÄ±lmaya Ã§alÄ±ÅŸÄ±yor:', code);
      if (code.length === 6) {
        pendingAction = 'join';
        socket.emit('join_room', code);
      } else {
        showError('GeÃ§ersiz oda kodu!');
      }
    }

    function selectCharacter(character) {
      console.log('ğŸ‘¤ Karakter seÃ§ildi:', character);
      selectedCharacter = character;
      startGame();
    }

    function showError(message) {
      const errorEl = document.getElementById('error-msg');
      errorEl.textContent = message;
      errorEl.style.display = 'block';
      setTimeout(() => {
        errorEl.style.display = 'none';
      }, 3000);
    }

    function checkPassword() {
      const input = document.getElementById('password-input').value.toLowerCase().trim();
      const errorEl = document.getElementById('password-error');
      
      if (input === 'batuhan') {
        // DoÄŸru ÅŸifre!
        closePasswordPopup();
        enterMuseum();
      } else {
        // YanlÄ±ÅŸ ÅŸifre
        errorEl.textContent = 'âŒ YanlÄ±ÅŸ cevap! Tekrar dene.';
        errorEl.style.display = 'block';
        document.getElementById('password-input').value = '';
        setTimeout(() => {
          errorEl.style.display = 'none';
        }, 2000);
      }
    }

    function closePasswordPopup() {
      document.getElementById('password-popup').style.display = 'none';
      document.getElementById('password-input').value = '';
      document.getElementById('password-error').style.display = 'none';
    }

    // Global fonksiyonlar - HTML onclick iÃ§in
    window.checkPassword = checkPassword;
    window.closePasswordPopup = closePasswordPopup;
    
    // DANS SEÃ‡Ä°M FONKSÄ°YONLARI
    window.selectDance = function(danceNumber) {
      selectedDance = danceNumber;
      document.getElementById('dance-menu').style.display = 'none';
      console.log('ğŸ’ƒ Dans seÃ§ildi:', danceNumber);
      
      // Pointer lock'u geri al
      if (document.pointerLockElement === null && renderer && renderer.domElement) {
        renderer.domElement.requestPointerLock();
      }
    };
    
    window.closeDanceMenu = function() {
      selectedDance = 0; // Dans kapalÄ±
      document.getElementById('dance-menu').style.display = 'none';
      console.log('âŒ Dans iptal edildi');
      
      // Pointer lock'u geri al
      if (document.pointerLockElement === null && renderer && renderer.domElement) {
        renderer.domElement.requestPointerLock();
      }
    };

    function enterMuseum() {
      window.insideMuseum = true;
      window.museumDoor.userData.locked = false;
      
      // MÃ¼ze iÃ§ini gÃ¶ster
      window.museumInterior.visible = true;
      
      // Karakteri mÃ¼zenin iÃ§ine Ä±ÅŸÄ±nla
      playerGroup.position.set(0, 0, 15);
      
      // KamerayÄ± ayarla
      camera.position.set(0, 2, 18);
      
      // DÄ±ÅŸ ortamÄ± gizle (performans iÃ§in)
      scene.background = new THREE.Color(0xffe6f0);
      scene.fog = new THREE.Fog(0xffe6f0, 1, 50);
      
      console.log('MÃ¼zeye hoÅŸ geldiniz!');
    }

    function startGame() {
      if (!selectedCharacter) return;
      
      // MenÃ¼ ve karakter ekranlarÄ±nÄ± gizle
      document.getElementById('menu-screen').style.display = 'none';
      document.getElementById('character-screen').style.display = 'none';
      
      // YÃœKLEME EKRANINI GÃ–STER
      loadingManager.show();
      
      // KÄ±sa bir sÃ¼re sonra yÃ¼klemeyi baÅŸlat (ekran gÃ¶rÃ¼nsÃ¼n diye)
      setTimeout(() => {
        const gameContainer = document.getElementById('game-container');
        gameContainer.style.display = 'block';
        initThreeJS();
      }, 100);
      
      // MÃ¼ziÄŸi baÅŸlatmayÄ± dene (kullanÄ±cÄ± etkileÅŸimi sonrasÄ±)
      setTimeout(() => {
        const music = document.getElementById('background-music');
        music.volume = 0.3; // Ses seviyesi %30
        music.play().catch(e => {
          console.log('MÃ¼zik baÅŸlatÄ±lamadÄ±. M tuÅŸuna basarak baÅŸlatabilirsiniz.');
        });
      }, 500);
    }

    // Three.js setup
    function initThreeJS() {
      const container = document.getElementById('game-container');
      
      scene = new THREE.Scene();
      
      // GÃœZEL SKYBOX - Gradient gÃ¶kyÃ¼zÃ¼
      const skyGeo = new THREE.SphereGeometry(500, 32, 15);
      const skyMat = new THREE.ShaderMaterial({
        uniforms: {
          topColor: { value: new THREE.Color(0x0077ff) },
          bottomColor: { value: new THREE.Color(0xffffff) },
          offset: { value: 33 },
          exponent: { value: 0.6 }
        },
        vertexShader: `
          varying vec3 vWorldPosition;
          void main() {
            vec4 worldPosition = modelMatrix * vec4(position, 1.0);
            vWorldPosition = worldPosition.xyz;
            gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
          }
        `,
        fragmentShader: `
          uniform vec3 topColor;
          uniform vec3 bottomColor;
          uniform float offset;
          uniform float exponent;
          varying vec3 vWorldPosition;
          void main() {
            float h = normalize(vWorldPosition + offset).y;
            gl_FragColor = vec4(mix(bottomColor, topColor, max(pow(max(h, 0.0), exponent), 0.0)), 1.0);
          }
        `,
        side: THREE.BackSide
      });
      const sky = new THREE.Mesh(skyGeo, skyMat);
      scene.add(sky);
      
      scene.fog = new THREE.Fog(0x87CEEB, 50, 200);

      camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
      camera.position.set(0, 2, 15); // DÄ±ÅŸarÄ±da baÅŸla

      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.shadowMap.enabled = true;
      renderer.shadowMap.type = THREE.PCFSoftShadowMap;
      container.appendChild(renderer.domElement);

      // Lighting - GÃœNEÅ IÅIÄI (daha yumuÅŸak)
      const ambientLight = new THREE.AmbientLight(0xffffff, 0.6); // Biraz daha parlak
      scene.add(ambientLight);

      const sunLight = new THREE.DirectionalLight(0xffffff, 1.0); // Daha az yoÄŸun, beyaz Ä±ÅŸÄ±k
      sunLight.position.set(30, 50, 30);
      sunLight.castShadow = true;
      sunLight.shadow.mapSize.width = 4096;
      sunLight.shadow.mapSize.height = 4096;
      sunLight.shadow.camera.left = -60;
      sunLight.shadow.camera.right = 60;
      sunLight.shadow.camera.top = 60;
      sunLight.shadow.camera.bottom = -60;
      sunLight.shadow.camera.far = 200;
      scene.add(sunLight);

      // YEÅÄ°L Ã‡Ä°MEN ZEMIN
      const groundGeo = new THREE.PlaneGeometry(200, 200);
      const groundMat = new THREE.MeshStandardMaterial({ 
        color: 0x5a8f3a,
        roughness: 0.9
      });
      const ground = new THREE.Mesh(groundGeo, groundMat);
      ground.rotation.x = -Math.PI / 2;
      ground.receiveShadow = true;
      scene.add(ground);

      // AÄAÃ‡LAR - Daha fazla
      for (let i = 0; i < 40; i++) {
        const trunkHeight = 2 + Math.random() * 2;
        const trunk = new THREE.Mesh(
          new THREE.CylinderGeometry(0.3, 0.4, trunkHeight, 8),
          new THREE.MeshStandardMaterial({ color: 0x4a3520 })
        );
        
        const leavesSize = 1.2 + Math.random() * 1;
        const leaves = new THREE.Mesh(
          new THREE.SphereGeometry(leavesSize, 8, 8),
          new THREE.MeshStandardMaterial({ color: 0x2d5016 })
        );
        
        // Rastgele pozisyon ama mÃ¼ze alanÄ±ndan uzak
        let x = Math.random() * 120 - 60;
        let z = Math.random() * 120 - 60;
        
        // MÃ¼ze Ã§evresinden uzak tut
        if (Math.abs(x) < 25 && z > -35 && z < 10) {
          x += x > 0 ? 30 : -30;
        }
        
        trunk.position.set(x, trunkHeight / 2, z);
        leaves.position.set(x, trunkHeight + leavesSize * 0.8, z);
        
        trunk.castShadow = true;
        trunk.receiveShadow = true;
        leaves.castShadow = true;
        
        scene.add(trunk);
        scene.add(leaves);
      }

      // Ã‡Ä°MEN KÃœMELERÄ° - Zemine detay
      for (let i = 0; i < 200; i++) {
        const grassClump = new THREE.Group();
        
        // BirkaÃ§ Ã§imen yapraÄŸÄ±
        for (let j = 0; j < 5; j++) {
          const blade = new THREE.Mesh(
            new THREE.ConeGeometry(0.02, 0.15 + Math.random() * 0.1, 3),
            new THREE.MeshStandardMaterial({ 
              color: new THREE.Color().setHSL(0.25 + Math.random() * 0.1, 0.6, 0.3),
              flatShading: true
            })
          );
          blade.position.set(
            (Math.random() - 0.5) * 0.1,
            0.08,
            (Math.random() - 0.5) * 0.1
          );
          blade.rotation.z = (Math.random() - 0.5) * 0.3;
          grassClump.add(blade);
        }
        
        let x = Math.random() * 100 - 50;
        let z = Math.random() * 100 - 50;
        
        if (Math.abs(x) < 20 && z > -30 && z < 5) {
          x += x > 0 ? 25 : -25;
        }
        
        grassClump.position.set(x, 0, z);
        scene.add(grassClump);
      }

      // UZAK DAÄLAR - Ufuk Ã§izgisi
      for (let i = 0; i < 8; i++) {
        const mountainHeight = 15 + Math.random() * 10;
        const mountain = new THREE.Mesh(
          new THREE.ConeGeometry(15 + Math.random() * 10, mountainHeight, 4),
          new THREE.MeshStandardMaterial({ 
            color: 0x5a6c57,
            flatShading: true
          })
        );
        
        const angle = (i / 8) * Math.PI * 2;
        const distance = 120;
        
        mountain.position.set(
          Math.cos(angle) * distance,
          mountainHeight / 2 - 2,
          Math.sin(angle) * distance
        );
        mountain.rotation.y = Math.random() * Math.PI * 2;
        mountain.receiveShadow = true;
        
        scene.add(mountain);
        
        // Kar tepesi
        const snow = new THREE.Mesh(
          new THREE.ConeGeometry(8, 6, 4),
          new THREE.MeshStandardMaterial({ color: 0xffffff })
        );
        snow.position.copy(mountain.position);
        snow.position.y += mountainHeight / 2;
        scene.add(snow);
      }

      // KAYALAR - Etrafta serpiÅŸtirilmiÅŸ
      for (let i = 0; i < 30; i++) {
        const rockSize = 0.3 + Math.random() * 0.5;
        const rock = new THREE.Mesh(
          new THREE.DodecahedronGeometry(rockSize, 0),
          new THREE.MeshStandardMaterial({ 
            color: 0x808080,
            flatShading: true
          })
        );
        
        let x = Math.random() * 90 - 45;
        let z = Math.random() * 90 - 45;
        
        if (Math.abs(x) < 20 && z > -30 && z < 5) {
          x += x > 0 ? 25 : -25;
        }
        
        rock.position.set(x, rockSize / 2, z);
        rock.rotation.set(
          Math.random() * Math.PI,
          Math.random() * Math.PI,
          Math.random() * Math.PI
        );
        rock.castShadow = true;
        rock.receiveShadow = true;
        scene.add(rock);
      }

      // BULUTLAR
      for (let i = 0; i < 12; i++) {
        const cloud = new THREE.Group();
        for (let j = 0; j < 4; j++) {
          const sphere = new THREE.Mesh(
            new THREE.SphereGeometry(Math.random() * 1.5 + 1, 8, 8),
            new THREE.MeshBasicMaterial({ 
              color: 0xffffff, 
              transparent: true, 
              opacity: 0.7 
            })
          );
          sphere.position.set(
            Math.random() * 5 - 2.5, 
            Math.random() * 1.5, 
            Math.random() * 3 - 1.5
          );
          cloud.add(sphere);
        }
        cloud.position.set(
          Math.random() * 150 - 75,
          30 + Math.random() * 20,
          Math.random() * 150 - 75
        );
        scene.add(cloud);
      }

      // ========================================
      // ğŸ¨ MODELS KLASÃ–RÃœNDEKÄ° TÃœM MODELLER OTOMATÄ°K YÃœKLEME
      // ========================================
      
      if (typeof THREE.GLTFLoader !== 'undefined') {
        const gltfLoader = new THREE.GLTFLoader();
        
        // Model listesi - models klasÃ¶rÃ¼ne koyduÄŸun her ÅŸey
        const treeModels = ['tree', 'tree1', 'tree2', 'tree3', 'oak', 'pine', 'palm'];
        const flowerModels = ['flower', 'flower1', 'flower2', 'flower3', 'rose', 'tulip'];
        const rockModels = ['rock', 'rock1', 'rock2', 'rock3', 'stone', 'boulder'];
        const grassModels = ['grass', 'grass1', 'grass2', 'bush', 'shrub'];
        const propModels = ['bench', 'lamp', 'fountain', 'fence', 'sign'];
        
        let loadedModels = {
          trees: [],
          flowers: [],
          rocks: [],
          grass: [],
          props: []
        };
        
        // AÄAÃ‡LAR - Her birini dene
        treeModels.forEach(name => {
          gltfLoader.load(`/models/${name}.glb`,
            function(gltf) {
              console.log(`âœ… ${name}.glb yÃ¼klendi!`);
              loadedModels.trees.push(gltf.scene);
              
              // 5-10 aÄŸaÃ§ yerleÅŸtir
              const count = 5 + Math.floor(Math.random() * 5);
              for (let i = 0; i < count; i++) {
                const tree = gltf.scene.clone();
                
                let x = Math.random() * 80 - 40;
                let z = Math.random() * 80 - 40;
                if (Math.abs(x) < 22 && z > -30 && z < 10) {
                  x += x > 0 ? 28 : -28;
                }
                
                tree.position.set(x, 0, z);
                tree.scale.setScalar(1 + Math.random() * 1.5);
                tree.rotation.y = Math.random() * Math.PI * 2;
                
                tree.traverse((child) => {
                  if (child.isMesh) {
                    child.castShadow = true;
                    child.receiveShadow = true;
                  }
                });
                
                scene.add(tree);
              }
            },
            undefined,
            function(error) {
              // Hata verme, sadece yok de
            }
          );
        });
        
        // Ã‡Ä°Ã‡EKLER
        flowerModels.forEach(name => {
          gltfLoader.load(`/models/${name}.glb`,
            function(gltf) {
              console.log(`âœ… ${name}.glb yÃ¼klendi!`);
              loadedModels.flowers.push(gltf.scene);
              
              // 15-20 Ã§iÃ§ek
              const count = 15 + Math.floor(Math.random() * 5);
              for (let i = 0; i < count; i++) {
                const flower = gltf.scene.clone();
                
                let x = Math.random() * 70 - 35;
                let z = Math.random() * 70 - 35;
                if (Math.abs(x) < 20 && z > -28 && z < 10) {
                  x += x > 0 ? 25 : -25;
                }
                
                flower.position.set(x, 0, z);
                flower.scale.setScalar(0.3 + Math.random() * 0.5);
                flower.rotation.y = Math.random() * Math.PI * 2;
                
                flower.traverse((child) => {
                  if (child.isMesh) child.castShadow = true;
                });
                
                scene.add(flower);
              }
            },
            undefined,
            function(error) {}
          );
        });
        
        // KAYALAR
        rockModels.forEach(name => {
          gltfLoader.load(`/models/${name}.glb`,
            function(gltf) {
              console.log(`âœ… ${name}.glb yÃ¼klendi!`);
              loadedModels.rocks.push(gltf.scene);
              
              // 8-12 kaya
              const count = 8 + Math.floor(Math.random() * 4);
              for (let i = 0; i < count; i++) {
                const rock = gltf.scene.clone();
                
                let x = Math.random() * 80 - 40;
                let z = Math.random() * 80 - 40;
                if (Math.abs(x) < 20 && z > -30 && z < 10) {
                  x += x > 0 ? 25 : -25;
                }
                
                rock.position.set(x, 0, z);
                rock.scale.setScalar(0.5 + Math.random() * 1);
                rock.rotation.set(
                  Math.random() * 0.5,
                  Math.random() * Math.PI * 2,
                  Math.random() * 0.5
                );
                
                rock.traverse((child) => {
                  if (child.isMesh) {
                    child.castShadow = true;
                    child.receiveShadow = true;
                  }
                });
                
                scene.add(rock);
              }
            },
            undefined,
            function(error) {}
          );
        });
        
        // Ã‡Ä°MEN/Ã‡ALÄ±
        grassModels.forEach(name => {
          gltfLoader.load(`/models/${name}.glb`,
            function(gltf) {
              console.log(`âœ… ${name}.glb yÃ¼klendi!`);
              loadedModels.grass.push(gltf.scene);
              
              // 20-30 Ã§imen
              const count = 20 + Math.floor(Math.random() * 10);
              for (let i = 0; i < count; i++) {
                const grass = gltf.scene.clone();
                
                let x = Math.random() * 60 - 30;
                let z = Math.random() * 60 - 30;
                if (Math.abs(x) < 18 && z > -25 && z < 8) {
                  x += x > 0 ? 22 : -22;
                }
                
                grass.position.set(x, 0, z);
                grass.scale.setScalar(0.4 + Math.random() * 0.4);
                grass.rotation.y = Math.random() * Math.PI * 2;
                
                grass.traverse((child) => {
                  if (child.isMesh) child.castShadow = true;
                });
                
                scene.add(grass);
              }
            },
            undefined,
            function(error) {}
          );
        });
        
        // PROPLAR (Bank, Lamba, vb)
        propModels.forEach(name => {
          gltfLoader.load(`/models/${name}.glb`,
            function(gltf) {
              console.log(`âœ… ${name}.glb yÃ¼klendi!`);
              loadedModels.props.push(gltf.scene);
              
              // Prop'a gÃ¶re yerleÅŸtir
              if (name.includes('bench')) {
                // 2 bank mÃ¼ze Ã¶nÃ¼ne
                const bench1 = gltf.scene.clone();
                bench1.position.set(-6, 0, 26);
                bench1.rotation.y = Math.PI;
                bench1.scale.setScalar(1.2);
                scene.add(bench1);
                
                const bench2 = gltf.scene.clone();
                bench2.position.set(6, 0, 26);
                bench2.rotation.y = Math.PI;
                bench2.scale.setScalar(1.2);
                scene.add(bench2);
              } else if (name.includes('lamp')) {
                // 4 lamba mÃ¼ze Ã§evresine
                const positions = [{x:-10, z:23}, {x:10, z:23}, {x:-10, z:18}, {x:10, z:18}];
                positions.forEach(pos => {
                  const lamp = gltf.scene.clone();
                  lamp.position.set(pos.x, 0, pos.z);
                  lamp.scale.setScalar(1.5);
                  scene.add(lamp);
                });
              } else {
                // DiÄŸerleri rastgele
                for (let i = 0; i < 3; i++) {
                  const prop = gltf.scene.clone();
                  let x = Math.random() * 60 - 30;
                  let z = Math.random() * 60 - 30;
                  if (Math.abs(x) < 20 && z > -28 && z < 12) {
                    x += x > 0 ? 25 : -25;
                  }
                  prop.position.set(x, 0, z);
                  prop.rotation.y = Math.random() * Math.PI * 2;
                  scene.add(prop);
                }
              }
            },
            undefined,
            function(error) {}
          );
        });
        
        console.log('ğŸ¨ Model yÃ¼kleyici aktif! TÃ¼m .glb dosyalarÄ± otomatik yÃ¼kleniyor...');
        
        // 3 saniye sonra Ã¶zet ver
        setTimeout(() => {
          let total = Object.values(loadedModels).reduce((sum, arr) => sum + arr.length, 0);
          console.log(`âœ… TOPLAM ${total} farklÄ± model yÃ¼klendi!`);
          console.log('ğŸŒ³ AÄŸaÃ§lar:', loadedModels.trees.length);
          console.log('ğŸŒ¸ Ã‡iÃ§ekler:', loadedModels.flowers.length);
          console.log('ğŸª¨ Kayalar:', loadedModels.rocks.length);
          console.log('ğŸŒ¿ Ã‡imen/Ã‡alÄ±:', loadedModels.grass.length);
          console.log('ğŸª‘ Proplar:', loadedModels.props.length);
        }, 3000);
        
      } else {
        console.warn('âš ï¸ GLTFLoader bulunamadÄ±!');
      }
      
      // ========================================

      // NEHÄ°R - MÃ¼zenin saÄŸ tarafÄ±nda
      const riverCurve = new THREE.QuadraticBezierCurve3(
        new THREE.Vector3(35, 0.02, -60),
        new THREE.Vector3(40, 0.02, 0),
        new THREE.Vector3(35, 0.02, 60)
      );
      const riverPoints = riverCurve.getPoints(50);
      const riverShape = new THREE.Shape();
      
      riverPoints.forEach((point, i) => {
        const width = 6 + Math.sin(i * 0.2) * 1;
        if (i === 0) {
          riverShape.moveTo(point.x - width/2, point.z);
        } else {
          riverShape.lineTo(point.x - width/2, point.z);
        }
      });
      
      for (let i = riverPoints.length - 1; i >= 0; i--) {
        const point = riverPoints[i];
        const width = 6 + Math.sin(i * 0.2) * 1;
        riverShape.lineTo(point.x + width/2, point.z);
      }
      
      const riverGeo = new THREE.ShapeGeometry(riverShape);
      const riverMat = new THREE.MeshStandardMaterial({ 
        color: 0x4a90e2,
        transparent: true,
        opacity: 0.7,
        metalness: 0.3,
        roughness: 0.2
      });
      const river = new THREE.Mesh(riverGeo, riverMat);
      river.rotation.x = -Math.PI / 2;
      river.position.y = 0.02;
      river.receiveShadow = true;
      scene.add(river);

      // KÃ–PRÃœ - Nehir Ã¼zerinde
      const bridgeGeo = new THREE.BoxGeometry(8, 0.3, 3);
      const bridgeMat = new THREE.MeshStandardMaterial({ color: 0x8B4513 });
      const bridge = new THREE.Mesh(bridgeGeo, bridgeMat);
      bridge.position.set(40, 0.3, 0);
      bridge.castShadow = true;
      bridge.receiveShadow = true;
      scene.add(bridge);

      // KÃ¶prÃ¼ë‚œê°„larÄ±
      for (let side of [-1.5, 1.5]) {
        for (let i = 0; i < 5; i++) {
          const post = new THREE.Mesh(
            new THREE.BoxGeometry(0.1, 0.8, 0.1),
            bridgeMat
          );
          post.position.set(40 + (i - 2) * 1.8, 0.7, side);
          post.castShadow = true;
          scene.add(post);
        }
      }

      // UÃ‡AN KELEBEKLER
      window.butterflies = [];
      for (let i = 0; i < 10; i++) {
        const butterflyGroup = new THREE.Group();
        
        // Kanatlar
        const wingGeo = new THREE.CircleGeometry(0.15, 6);
        const wingMat = new THREE.MeshBasicMaterial({ 
          color: new THREE.Color().setHSL(Math.random(), 0.7, 0.6),
          side: THREE.DoubleSide
        });
        
        const leftWing = new THREE.Mesh(wingGeo, wingMat);
        leftWing.position.x = -0.1;
        butterflyGroup.add(leftWing);
        
        const rightWing = new THREE.Mesh(wingGeo, wingMat);
        rightWing.position.x = 0.1;
        butterflyGroup.add(rightWing);
        
        butterflyGroup.position.set(
          Math.random() * 60 - 30,
          1 + Math.random() * 3,
          Math.random() * 60 - 30
        );
        
        butterflyGroup.userData = {
          speed: 0.02 + Math.random() * 0.03,
          wingSpeed: 5 + Math.random() * 5,
          path: Math.random() * Math.PI * 2
        };
        
        scene.add(butterflyGroup);
        window.butterflies.push(butterflyGroup);
      }

      // UÃ‡AN KUÅLAR
      window.birds = [];
      for (let i = 0; i < 8; i++) {
        const birdGroup = new THREE.Group();
        
        // Basit kuÅŸ ÅŸekli (V ÅŸeklinde)
        const birdGeo = new THREE.ConeGeometry(0.1, 0.3, 4);
        const birdMat = new THREE.MeshBasicMaterial({ color: 0x333333 });
        const body = new THREE.Mesh(birdGeo, birdMat);
        body.rotation.x = Math.PI / 2;
        birdGroup.add(body);
        
        birdGroup.position.set(
          Math.random() * 100 - 50,
          10 + Math.random() * 15,
          Math.random() * 100 - 50
        );
        
        birdGroup.userData = {
          speed: 0.05 + Math.random() * 0.05,
          angle: Math.random() * Math.PI * 2,
          radius: 30 + Math.random() * 20
        };
        
        scene.add(birdGroup);
        window.birds.push(birdGroup);
      }

      // Ã‡Ä°Ã‡EKLER - Ã‡ok daha fazla! 100 Ã§iÃ§ek
      for (let i = 0; i < 100; i++) {
        const flowerGroup = new THREE.Group();
        
        // Ã‡iÃ§ek taÃ§ yapraklarÄ±
        const petalCount = 5 + Math.floor(Math.random() * 3);
        const petalColor = new THREE.Color().setHSL(Math.random(), 0.8, 0.6);
        
        for (let j = 0; j < petalCount; j++) {
          const petal = new THREE.Mesh(
            new THREE.CircleGeometry(0.15, 8),
            new THREE.MeshBasicMaterial({ color: petalColor, side: THREE.DoubleSide })
          );
          const angle = (j / petalCount) * Math.PI * 2;
          petal.position.set(Math.cos(angle) * 0.15, 0, Math.sin(angle) * 0.15);
          petal.rotation.x = -Math.PI / 2;
          flowerGroup.add(petal);
        }
        
        // Ã‡iÃ§ek merkezi
        const center = new THREE.Mesh(
          new THREE.CircleGeometry(0.08, 8),
          new THREE.MeshBasicMaterial({ color: 0xffeb3b, side: THREE.DoubleSide })
        );
        center.rotation.x = -Math.PI / 2;
        center.position.y = 0.01;
        flowerGroup.add(center);
        
        // Rastgele pozisyon ama yoldan uzak
        let x = Math.random() * 80 - 40;
        let z = Math.random() * 80 - 40;
        
        if (Math.abs(x) < 20 && z > -30 && z < 5) {
          x += x > 0 ? 25 : -25;
        }
        
        flowerGroup.position.set(x, 0.05, z);
        scene.add(flowerGroup);
      }

      // MÃœZE BÄ°NASI - GÃœZELLEÅTÄ°RÄ°LMÄ°Å
      const museumGroup = new THREE.Group();
      
      // Ana duvarlar - daha detaylÄ±
      const wallMat = new THREE.MeshStandardMaterial({ 
        color: 0xf5f0e8, 
        roughness: 0.6
      });
      const mainWalls = new THREE.Mesh(
        new THREE.BoxGeometry(28, 7, 38),
        wallMat
      );
      mainWalls.position.y = 3.5;
      mainWalls.castShadow = true;
      mainWalls.receiveShadow = true;
      museumGroup.add(mainWalls);

      // PENCERELER - 6 tane
      const windowMat = new THREE.MeshBasicMaterial({ 
        color: 0x87ceeb,
        transparent: true,
        opacity: 0.7
      });
      
      // Sol taraf pencereleri
      for (let i = 0; i < 3; i++) {
        const window1 = new THREE.Mesh(
          new THREE.BoxGeometry(2, 2.5, 0.1),
          windowMat
        );
        window1.position.set(-14.1, 4, -12 + i * 10);
        museumGroup.add(window1);
        
        // Pencere Ã§erÃ§evesi
        const frame = new THREE.Mesh(
          new THREE.BoxGeometry(2.2, 2.7, 0.15),
          new THREE.MeshStandardMaterial({ color: 0x8B4513 })
        );
        frame.position.copy(window1.position);
        frame.position.x -= 0.02;
        museumGroup.add(frame);
      }
      
      // SaÄŸ taraf pencereleri
      for (let i = 0; i < 3; i++) {
        const window2 = new THREE.Mesh(
          new THREE.BoxGeometry(2, 2.5, 0.1),
          windowMat
        );
        window2.position.set(14.1, 4, -12 + i * 10);
        museumGroup.add(window2);
        
        const frame = new THREE.Mesh(
          new THREE.BoxGeometry(2.2, 2.7, 0.15),
          new THREE.MeshStandardMaterial({ color: 0x8B4513 })
        );
        frame.position.copy(window2.position);
        frame.position.x += 0.02;
        museumGroup.add(frame);
      }

      // SÃœTUNLAR - GiriÅŸ Ã¶nÃ¼nde
      for (let side of [-2.5, 2.5]) {
        const column = new THREE.Mesh(
          new THREE.CylinderGeometry(0.4, 0.5, 6, 12),
          new THREE.MeshStandardMaterial({ color: 0xf5f0e8 })
        );
        column.position.set(side, 3, 19);
        column.castShadow = true;
        museumGroup.add(column);
        
        // SÃ¼tun baÅŸlÄ±ÄŸÄ±
        const capital = new THREE.Mesh(
          new THREE.BoxGeometry(0.8, 0.4, 0.8),
          new THREE.MeshStandardMaterial({ color: 0xe8dcc8 })
        );
        capital.position.set(side, 6.2, 19);
        museumGroup.add(capital);
      }

      // Ã‡atÄ± - daha gÃ¶rkemli
      const roofMat = new THREE.MeshStandardMaterial({ color: 0x8b4513 });
      const roof = new THREE.Mesh(
        new THREE.ConeGeometry(20, 3, 4),
        roofMat
      );
      roof.position.y = 8.5;
      roof.rotation.y = Math.PI / 4;
      roof.castShadow = true;
      museumGroup.add(roof);
      
      // Ã‡atÄ± sÃ¼slemesi - tepe
      const roofTop = new THREE.Mesh(
        new THREE.SphereGeometry(0.5, 8, 8),
        new THREE.MeshStandardMaterial({ color: 0xffd700, metalness: 0.8 })
      );
      roofTop.position.y = 10;
      museumGroup.add(roofTop);

      // KapÄ± Ã§erÃ§evesi - daha sÃ¼slÃ¼
      const doorFrameGeo = new THREE.BoxGeometry(3.4, 4.4, 0.4);
      const doorFrameMat = new THREE.MeshStandardMaterial({ color: 0x5c4033 });
      const doorFrame = new THREE.Mesh(doorFrameGeo, doorFrameMat);
      doorFrame.position.set(0, 2.1, 19.15);
      museumGroup.add(doorFrame);
      
      // KapÄ± Ã¼stÃ¼ sÃ¼sleme
      const archTop = new THREE.Mesh(
        new THREE.TorusGeometry(1.7, 0.15, 8, 16, Math.PI),
        doorFrameMat
      );
      archTop.position.set(0, 4.3, 19.15);
      archTop.rotation.x = Math.PI / 2;
      museumGroup.add(archTop);

      // KAPI (KapalÄ± ve Kilitli) - daha detaylÄ±
      const doorGeo = new THREE.BoxGeometry(3, 4, 0.2);
      const doorMat = new THREE.MeshStandardMaterial({ color: 0x3d2817 });
      const door = new THREE.Mesh(doorGeo, doorMat);
      door.position.set(0, 2, 19.2);
      door.castShadow = true;
      door.userData = { type: 'museum_door', locked: true };
      museumGroup.add(door);
      window.museumDoor = door;
      
      // KapÄ± sÃ¼slemeleri - Ã§izgiler
      for (let y of [1, 2, 3]) {
        const line = new THREE.Mesh(
          new THREE.BoxGeometry(2.6, 0.05, 0.05),
          new THREE.MeshStandardMaterial({ color: 0x2a1a0a })
        );
        line.position.set(0, y, 19.25);
        museumGroup.add(line);
      }

      // KapÄ± kolu - daha belirgin
      const handleGeo = new THREE.TorusGeometry(0.08, 0.03, 8, 16);
      const handleMat = new THREE.MeshStandardMaterial({ 
        color: 0xffd700, 
        metalness: 0.9,
        roughness: 0.1
      });
      const handle = new THREE.Mesh(handleGeo, handleMat);
      handle.position.set(1, 2, 19.3);
      handle.rotation.y = Math.PI / 2;
      museumGroup.add(handle);

      // KIRMIZI HALI - daha uzun
      const carpetGeo = new THREE.PlaneGeometry(4, 10);
      const carpetMat = new THREE.MeshStandardMaterial({ color: 0x8b0000 });
      const carpet = new THREE.Mesh(carpetGeo, carpetMat);
      carpet.rotation.x = -Math.PI / 2;
      carpet.position.set(0, 0.01, 24);
      carpet.receiveShadow = true;
      museumGroup.add(carpet);
      
      // HalÄ± kenarlarÄ± - altÄ±n
      for (let side of [-2, 2]) {
        const border = new THREE.Mesh(
          new THREE.BoxGeometry(0.1, 0.05, 10),
          new THREE.MeshStandardMaterial({ color: 0xffd700 })
        );
        border.position.set(side, 0.02, 24);
        museumGroup.add(border);
      }

      // Tabela - daha bÃ¼yÃ¼k
      const signCanvas = document.createElement('canvas');
      signCanvas.width = 1024;
      signCanvas.height = 256;
      const signCtx = signCanvas.getContext('2d');
      
      // Tabela arkaplan - degrade
      const gradient = signCtx.createLinearGradient(0, 0, 1024, 0);
      gradient.addColorStop(0, '#8B4513');
      gradient.addColorStop(0.5, '#A0522D');
      gradient.addColorStop(1, '#8B4513');
      signCtx.fillStyle = gradient;
      signCtx.fillRect(0, 0, 1024, 256);
      
      // AltÄ±n Ã§erÃ§eve
      signCtx.strokeStyle = '#FFD700';
      signCtx.lineWidth = 10;
      signCtx.strokeRect(10, 10, 1004, 236);
      
      signCtx.fillStyle = '#FFD700';
      signCtx.font = 'bold 80px Arial';
      signCtx.textAlign = 'center';
      signCtx.fillText('ğŸ’• AÅŸkÄ±mÄ±zÄ±n MÃ¼zesi ğŸ’•', 512, 150);
      
      const signTexture = new THREE.CanvasTexture(signCanvas);
      const signGeo = new THREE.PlaneGeometry(12, 3);
      const signMat = new THREE.MeshBasicMaterial({ map: signTexture });
      const sign = new THREE.Mesh(signGeo, signMat);
      sign.position.set(0, 6.8, 19.3);
      museumGroup.add(sign);
      
      // Tabela altÄ±na sÃ¼sleme
      const decoration = new THREE.Mesh(
        new THREE.BoxGeometry(12.5, 0.3, 0.3),
        new THREE.MeshStandardMaterial({ color: 0xffd700 })
      );
      decoration.position.set(0, 5.2, 19.3);
      museumGroup.add(decoration);

      scene.add(museumGroup);
      window.museumGroup = museumGroup;

      // MÃœZENÄ°N Ä°Ã‡Ä° (BaÅŸlangÄ±Ã§ta gÃ¶rÃ¼nmez, kapÄ± aÃ§Ä±ldÄ±ÄŸÄ±nda aktif)
      window.insideMuseum = false;
      window.museumInterior = new THREE.Group();
      window.museumInterior.visible = false;

      // Walls
      const wallMaterial = new THREE.MeshStandardMaterial({
        color: 0xfff0f5,
        roughness: 0.8
      });

      // MÃœZENÄ°N Ä°Ã‡Ä° - Duvarlar (gÃ¶rÃ¼nmez baÅŸlar)
      const interiorFloor = new THREE.Mesh(
        new THREE.PlaneGeometry(26, 36),
        new THREE.MeshStandardMaterial({ color: 0xf5e6e8, roughness: 0.3 })
      );
      interiorFloor.rotation.x = -Math.PI / 2;
      interiorFloor.receiveShadow = true;
      interiorFloor.position.y = 0.01;
      window.museumInterior.add(interiorFloor);

      const leftWall = new THREE.Mesh(new THREE.BoxGeometry(0.3, 6, 36), wallMaterial);
      leftWall.position.set(-13, 3, 0);
      leftWall.receiveShadow = true;
      leftWall.castShadow = true;
      window.museumInterior.add(leftWall);

      const rightWall = new THREE.Mesh(new THREE.BoxGeometry(0.3, 6, 36), wallMaterial);
      rightWall.position.set(13, 3, 0);
      rightWall.receiveShadow = true;
      rightWall.castShadow = true;
      window.museumInterior.add(rightWall);

      const backWall = new THREE.Mesh(new THREE.BoxGeometry(26, 6, 0.3), wallMaterial);
      backWall.position.set(0, 3, -18);
      backWall.receiveShadow = true;
      window.museumInterior.add(backWall);

      const interiorCeiling = new THREE.Mesh(
        new THREE.PlaneGeometry(26, 36),
        wallMaterial
      );
      interiorCeiling.rotation.x = Math.PI / 2;
      interiorCeiling.position.y = 6;
      interiorCeiling.receiveShadow = true;
      window.museumInterior.add(interiorCeiling);

      // Ä°Ã§ aydÄ±nlatma (BEYAZ IÅIK - renkleri bozmaz)
      const interiorAmbient = new THREE.AmbientLight(0xffffff, 0.7); // Beyaz
      window.museumInterior.add(interiorAmbient);

      const interiorSpot1 = new THREE.SpotLight(0xffffff, 0.8, 20, Math.PI / 6); // Beyaz
      interiorSpot1.position.set(-8, 5, 0);
      interiorSpot1.castShadow = true;
      window.museumInterior.add(interiorSpot1);

      const interiorSpot2 = new THREE.SpotLight(0xffffff, 0.8, 20, Math.PI / 6); // Beyaz
      interiorSpot2.position.set(8, 5, 0);
      interiorSpot2.castShadow = true;
      window.museumInterior.add(interiorSpot2);

      scene.add(window.museumInterior);

      // Photo frames
      createPhotoFrames();

      // Hidden messages
      createMessages();

      // Floating hearts
      createFloatingHearts();

      // Characters
      createCharacters();

      // Controls
      setupControls();

      // Start animation
      animate();
    }

    function createPhotoFrames() {
      const framePositions = [
        // Left wall
        { x: -14.5, y: 2.5, z: -15, rot: [0, Math.PI / 2, 0] },
        { x: -14.5, y: 2.5, z: -10, rot: [0, Math.PI / 2, 0] },
        { x: -14.5, y: 2.5, z: -5, rot: [0, Math.PI / 2, 0] },
        { x: -14.5, y: 2.5, z: 0, rot: [0, Math.PI / 2, 0] },
        { x: -14.5, y: 2.5, z: 5, rot: [0, Math.PI / 2, 0] },
        { x: -14.5, y: 4, z: -12, rot: [0, Math.PI / 2, 0] },
        { x: -14.5, y: 4, z: -7, rot: [0, Math.PI / 2, 0] },
        { x: -14.5, y: 4, z: -2, rot: [0, Math.PI / 2, 0] },
        { x: -14.5, y: 4, z: 3, rot: [0, Math.PI / 2, 0] },
        { x: -14.5, y: 4, z: 8, rot: [0, Math.PI / 2, 0] },
        // Right wall
        { x: 14.5, y: 2.5, z: -15, rot: [0, -Math.PI / 2, 0] },
        { x: 14.5, y: 2.5, z: -10, rot: [0, -Math.PI / 2, 0] },
        { x: 14.5, y: 2.5, z: -5, rot: [0, -Math.PI / 2, 0] },
        { x: 14.5, y: 2.5, z: 0, rot: [0, -Math.PI / 2, 0] },
        { x: 14.5, y: 2.5, z: 5, rot: [0, -Math.PI / 2, 0] },
        { x: 14.5, y: 4, z: -12, rot: [0, -Math.PI / 2, 0] },
        { x: 14.5, y: 4, z: -7, rot: [0, -Math.PI / 2, 0] },
        { x: 14.5, y: 4, z: -2, rot: [0, -Math.PI / 2, 0] },
        { x: 14.5, y: 4, z: 3, rot: [0, -Math.PI / 2, 0] },
        { x: 14.5, y: 4, z: 8, rot: [0, -Math.PI / 2, 0] }
      ];

      framePositions.forEach((pos, index) => {
        // Frame
        const frameGeo = new THREE.BoxGeometry(1.2, 1.6, 0.1);
        const frameMat = new THREE.MeshStandardMaterial({
          color: 0x8b4513,
          roughness: 0.5,
          metalness: 0.3
        });
        const frame = new THREE.Mesh(frameGeo, frameMat);
        frame.position.set(pos.x, pos.y, pos.z);
        frame.rotation.set(...pos.rot);
        frame.castShadow = true;
        scene.add(frame);

        // Photo
        const photoGeo = new THREE.PlaneGeometry(1, 1.4);
        const photoMat = new THREE.MeshStandardMaterial({
          color: new THREE.Color().setHSL(Math.random(), 0.5, 0.7),
          emissive: new THREE.Color().setHSL(Math.random(), 0.3, 0.2)
        });
        const photo = new THREE.Mesh(photoGeo, photoMat);
        photo.position.set(
          pos.x + (pos.rot[1] === Math.PI / 2 ? -0.06 : pos.rot[1] === -Math.PI / 2 ? 0.06 : 0),
          pos.y,
          pos.z
        );
        photo.rotation.set(...pos.rot);
        photo.userData = { type: 'photo', index: index + 1 };
        scene.add(photo);
        photoFrames.push(photo);

        // Heart above frame
        const heartShape = new THREE.Shape();
        const x = 0, y = 0;
        heartShape.moveTo(x, y);
        heartShape.bezierCurveTo(x, y - 0.1, x - 0.1, x - 0.15, x - 0.15, y - 0.15);
        heartShape.bezierCurveTo(x - 0.2, y - 0.15, x - 0.2, y - 0.05, x - 0.2, y);
        heartShape.bezierCurveTo(x - 0.2, y + 0.05, x - 0.15, y + 0.1, x, y + 0.2);
        heartShape.bezierCurveTo(x + 0.15, y + 0.1, x + 0.2, y + 0.05, x + 0.2, y);
        heartShape.bezierCurveTo(x + 0.2, y - 0.05, x + 0.2, y - 0.15, x + 0.15, y - 0.15);
        heartShape.bezierCurveTo(x + 0.1, y - 0.15, x, y - 0.1, x, y);

        const heartGeo = new THREE.ShapeGeometry(heartShape);
        const heartMat = new THREE.MeshStandardMaterial({
          color: 0xff1493,
          emissive: 0xff69b4,
          emissiveIntensity: 0.5
        });
        const heart = new THREE.Mesh(heartGeo, heartMat);
        heart.position.set(pos.x, pos.y + 1, pos.z);
        heart.rotation.set(...pos.rot);
        scene.add(heart);
      });
    }

    function createMessages() {
      const messageData = [
        { x: -10, z: -15, text: "Seninle geÃ§irdiÄŸim her an, hayatÄ±mÄ±n en gÃ¼zel anÄ± â¤ï¸" },
        { x: 10, z: -10, text: "Ä°lk buluÅŸmamÄ±zÄ± hatÄ±rlÄ±yor musun? Kalbim hÃ¢lÃ¢ aynÄ± hÄ±zla atÄ±yor ğŸ’•" },
        { x: -5, z: -5, text: "GÃ¼lÃ¼ÅŸÃ¼n benim en sevdiÄŸim ses ğŸŒ¹" },
        { x: 5, z: 0, text: "Seninle her gÃ¼n Sevgililer GÃ¼nÃ¼ ğŸ’" },
        { x: 0, z: 5, text: "Seni seviyorum, bugÃ¼n ve her zaman ğŸ’–" }
      ];

      messageData.forEach((msgData, index) => {
        const envelopeGeo = new THREE.BoxGeometry(0.3, 0.2, 0.15);
        const envelopeMat = new THREE.MeshStandardMaterial({
          color: 0xffb6c1,
          emissive: 0xff69b4,
          emissiveIntensity: 0.3
        });
        const envelope = new THREE.Mesh(envelopeGeo, envelopeMat);
        envelope.position.set(msgData.x, 0.15, msgData.z);
        envelope.castShadow = true;
        envelope.userData = { 
          type: 'message', 
          text: msgData.text, 
          index,
          baseY: 0.15
        };
        scene.add(envelope);
        messages.push(envelope);
      });
    }

    function createFloatingHearts() {
      for (let i = 0; i < 15; i++) {
        const heartShape = new THREE.Shape();
        const x = 0, y = 0;
        heartShape.moveTo(x, y);
        heartShape.bezierCurveTo(x, y - 0.05, x - 0.05, y - 0.08, x - 0.08, y - 0.08);
        heartShape.bezierCurveTo(x - 0.1, y - 0.08, x - 0.1, y - 0.03, x - 0.1, y);
        heartShape.bezierCurveTo(x - 0.1, y + 0.03, x - 0.08, y + 0.05, x, y + 0.1);
        heartShape.bezierCurveTo(x + 0.08, y + 0.05, x + 0.1, y + 0.03, x + 0.1, y);
        heartShape.bezierCurveTo(x + 0.1, y - 0.03, x + 0.1, y - 0.08, x + 0.08, y - 0.08);
        heartShape.bezierCurveTo(x + 0.05, y - 0.08, x, y - 0.05, x, y);

        const heartGeo = new THREE.ShapeGeometry(heartShape);
        const heartMat = new THREE.MeshStandardMaterial({
          color: 0xff1493,
          emissive: 0xff69b4,
          emissiveIntensity: 0.8,
          transparent: true,
          opacity: 0.6
        });
        const heart = new THREE.Mesh(heartGeo, heartMat);
        heart.position.set(
          Math.random() * 20 - 10,
          Math.random() * 5 + 1,
          Math.random() * 30 - 15
        );
        heart.rotation.y = Math.random() * Math.PI;
        heart.userData = { floatOffset: Math.random() * Math.PI * 2 };
        scene.add(heart);
      }
    }


    // FBX KARAKTER YÃœKLEME - TÃœM ANÄ°MASYONLARLA
    function loadFBXCharacter(parentGroup, isPlayer, isBatuhan) {
      const loader = new THREE.FBXLoader();
      
      // Dosya prefix'ini belirle (m = Merve, b = Batuhan)
      const prefix = isBatuhan ? 'b' : 'm';
      const charName = isBatuhan ? 'Batuhan' : 'Merve';
      
      // YÃœKLEME EKRANI - DosyalarÄ± ekle
      if (isPlayer) {
        loadingManager.addItem(`${charName} - YÃ¼rÃ¼me`);
        loadingManager.addItem(`${charName} - KoÅŸma`);
        loadingManager.addItem(`${charName} - Bekle`);
        loadingManager.addItem(`${charName} - Dans 1`);
        loadingManager.addItem(`${charName} - Dans 2`);
        loadingManager.addItem(`${charName} - Dans 3`);
        loadingManager.addItem(`${charName} - Dans 4`);
      }
      
      // Ä°lk olarak yÃ¼rÃ¼me animasyonlu karakteri yÃ¼kle
      loader.load(`/${prefix}Walk.fbx`, 
        function(fbxModel) {
          console.log(`âœ… ${prefix}Walk.fbx yÃ¼klendi!`);
          if (isPlayer) loadingManager.completeItem(`${charName} - YÃ¼rÃ¼me`);
          fbxModel.scale.set(0.01, 0.01, 0.01);
          fbxModel.position.y = 0;
          
          fbxModel.traverse((child) => {
            if (child.isMesh) {
              child.castShadow = true;
              child.receiveShadow = true;
            }
            
            // Root bone'u bul ve kilitle
            if (child.isBone && (child.name.toLowerCase().includes('hips') || 
                                  child.name.toLowerCase().includes('root') ||
                                  child.parent === fbxModel)) {
              console.log('ğŸ¦´ Root bone bulundu:', child.name);
              child.userData.isRootBone = true;
            }
          });
          
          // Bounding box ile zemine oturt
          const bbox = new THREE.Box3().setFromObject(fbxModel);
          const yOffset = -bbox.min.y; // Ayaklar y=0'da olsun
          fbxModel.position.y = yOffset;
          console.log('ğŸ“ Y offset:', yOffset.toFixed(3), '| BBox min:', bbox.min.y.toFixed(3), 'max:', bbox.max.y.toFixed(3));
          fbxModel.userData.yOffset = yOffset; // Sonra kullanmak iÃ§in sakla
          
          // Animation mixer oluÅŸtur
          const animMixer = new THREE.AnimationMixer(fbxModel);
          
          // Root motion track'lerini filtrele (X/Z pozisyon hareketi yok)
          // Y pozisyonu yOffset ile sabitlenecek
          
          // YÃœRÃœME animasyonunu sakla
          let walkAction, runAction, danceAction, idleAction;
          if (fbxModel.animations && fbxModel.animations.length > 0) {
            // ROOT MOTION TRACK'Ä°NÄ° KALDIR!
            const walkClip = fbxModel.animations[0];
            walkClip.tracks = walkClip.tracks.filter(track => {
              // Position track'lerini filtrele (sadece rotation ve scale kalsÄ±n)
              return !track.name.includes('.position');
            });
            
            walkAction = animMixer.clipAction(walkClip);
            walkAction.setLoop(THREE.LoopRepeat); // SÃ¼rekli tekrarla
            walkAction.time = 0.3; // T-pose frame'ini atla
            walkAction.setEffectiveWeight(0); // Gizli baÅŸlat
            walkAction.enabled = true;
            walkAction.play(); // HEMEN baÅŸlat
            console.log('ğŸ¬ Walk - Root motion temizlendi + baÅŸlatÄ±ldÄ± (weight=0)');
          }
          
          // Mixer'Ä± global deÄŸiÅŸkene ata
          if (isPlayer) {
            mixer = animMixer;
            playerGroup.userData.walkAction = walkAction;
          } else {
            partnerMixer = animMixer;
            partnerGroup.userData.walkAction = walkAction;
          }
          
          // KOÅMA animasyonunu yÃ¼kle
          loader.load(`/${prefix}Run.fbx`,
            function(runFbx) {
              console.log(`âœ… ${prefix}Run.fbx yÃ¼klendi!`);
              if (isPlayer) loadingManager.completeItem(`${charName} - KoÅŸma`);
              if (runFbx.animations && runFbx.animations.length > 0) {
                // ROOT MOTION TRACK'Ä°NÄ° KALDIR!
                const runClip = runFbx.animations[0];
                runClip.tracks = runClip.tracks.filter(track => {
                  return !track.name.includes('.position');
                });
                
                runAction = animMixer.clipAction(runClip);
                runAction.setLoop(THREE.LoopRepeat);
                runAction.time = 0.25; // T-pose frame'ini atla
                runAction.setEffectiveWeight(0); // Gizli baÅŸlat
                runAction.enabled = true;
                runAction.play(); // HEMEN baÅŸlat
                console.log('ğŸƒ Run - Root motion temizlendi + baÅŸlatÄ±ldÄ± (weight=0)');
                
                if (isPlayer) {
                  playerGroup.userData.runAction = runAction;
                } else {
                  partnerGroup.userData.runAction = runAction;
                }
              }
            },
            undefined,
            function(error) {
              console.error(`âŒ ${prefix}Run.fbx YÃœKLEME HATASI!`, error);
              alert(`âŒ HATA: ${prefix}Run.fbx dosyasÄ± bulunamadÄ±!\n\nDosya: public/${prefix}Run.fbx`);
            }
          );
          
          // DANS ANÄ°MASYONLARI - 4 FARKLI DANS
          let danceAction1, danceAction2, danceAction3, danceAction4;
          
          // Dans 1
          loader.load(`/${prefix}Dance1.fbx`,
            function(danceFbx) {
              console.log(`âœ… ${prefix}Dance1.fbx yÃ¼klendi!`);
              if (isPlayer) loadingManager.completeItem(`${charName} - Dans 1`);
              if (danceFbx.animations && danceFbx.animations.length > 0) {
                const danceClip = danceFbx.animations[0];
                danceClip.tracks = danceClip.tracks.filter(track => {
                  // TÃ¼m position track'lerini kaldÄ±r (yÃ¼kselme sorunu)
                  if (track.name.includes('.position')) return false;
                  return true;
                });
                

                
                danceAction1 = animMixer.clipAction(danceClip);
                danceAction1.setLoop(THREE.LoopRepeat);
                danceAction1.time = 0.15; // T-pose frame'ini atla
                danceAction1.setEffectiveWeight(0); // Gizli baÅŸlat
                danceAction1.enabled = true;
                danceAction1.play(); // HEMEN baÅŸlat
                console.log('ğŸ’ƒ Dans 1 - Root motion temizlendi + baÅŸlatÄ±ldÄ± (weight=0)');
                
                if (isPlayer) {
                  playerGroup.userData.danceAction1 = danceAction1;
                } else {
                  partnerGroup.userData.danceAction1 = danceAction1;
                }
              }
            },
            undefined,
            function(error) {
              console.warn(`âš ï¸ ${prefix}Dance1.fbx bulunamadÄ±`);
            }
          );
          
          // Dans 2
          loader.load(`/${prefix}Dance2.fbx`,
            function(danceFbx) {
              console.log(`âœ… ${prefix}Dance2.fbx yÃ¼klendi!`);
              if (isPlayer) loadingManager.completeItem(`${charName} - Dans 2`);
              if (danceFbx.animations && danceFbx.animations.length > 0) {
                const danceClip = danceFbx.animations[0];
                danceClip.tracks = danceClip.tracks.filter(track => {
                  // TÃ¼m position track'lerini kaldÄ±r (yÃ¼kselme sorunu)
                  if (track.name.includes('.position')) return false;
                  return true;
                });
                

                
                danceAction2 = animMixer.clipAction(danceClip);
                danceAction2.setLoop(THREE.LoopRepeat);
                danceAction2.time = 0.15; // T-pose frame'ini atla
                danceAction2.setEffectiveWeight(0); // Gizli baÅŸlat
                danceAction2.enabled = true;
                danceAction2.play(); // HEMEN baÅŸlat
                console.log('ğŸ’ƒ Dans 2 - Root motion temizlendi + baÅŸlatÄ±ldÄ± (weight=0)');
                
                if (isPlayer) {
                  playerGroup.userData.danceAction2 = danceAction2;
                } else {
                  partnerGroup.userData.danceAction2 = danceAction2;
                }
              }
            },
            undefined,
            function(error) {
              console.warn(`âš ï¸ ${prefix}Dance2.fbx bulunamadÄ±`);
            }
          );
          
          // Dans 3
          loader.load(`/${prefix}Dance3.fbx`,
            function(danceFbx) {
              console.log(`âœ… ${prefix}Dance3.fbx yÃ¼klendi!`);
              if (isPlayer) loadingManager.completeItem(`${charName} - Dans 3`);
              if (danceFbx.animations && danceFbx.animations.length > 0) {
                const danceClip = danceFbx.animations[0];
                danceClip.tracks = danceClip.tracks.filter(track => {
                  // TÃ¼m position track'lerini kaldÄ±r (yÃ¼kselme sorunu)
                  if (track.name.includes('.position')) return false;
                  return true;
                });
                

                
                danceAction3 = animMixer.clipAction(danceClip);
                danceAction3.setLoop(THREE.LoopRepeat);
                danceAction3.time = 0.15; // T-pose frame'ini atla
                danceAction3.setEffectiveWeight(0); // Gizli baÅŸlat
                danceAction3.enabled = true;
                danceAction3.play(); // HEMEN baÅŸlat
                console.log('ğŸ’ƒ Dans 3 - Root motion temizlendi + baÅŸlatÄ±ldÄ± (weight=0)');
                
                if (isPlayer) {
                  playerGroup.userData.danceAction3 = danceAction3;
                } else {
                  partnerGroup.userData.danceAction3 = danceAction3;
                }
              }
            },
            undefined,
            function(error) {
              console.warn(`âš ï¸ ${prefix}Dance3.fbx bulunamadÄ±`);
            }
          );
          
          // Dans 4
          loader.load(`/${prefix}Dance4.fbx`,
            function(danceFbx) {
              console.log(`âœ… ${prefix}Dance4.fbx yÃ¼klendi!`);
              if (isPlayer) loadingManager.completeItem(`${charName} - Dans 4`);
              if (danceFbx.animations && danceFbx.animations.length > 0) {
                const danceClip = danceFbx.animations[0];
                danceClip.tracks = danceClip.tracks.filter(track => {
                  // TÃ¼m position track'lerini kaldÄ±r (yÃ¼kselme sorunu)
                  if (track.name.includes('.position')) return false;
                  return true;
                });
                

                
                danceAction4 = animMixer.clipAction(danceClip);
                danceAction4.setLoop(THREE.LoopRepeat);
                danceAction4.time = 0.15; // T-pose frame'ini atla
                danceAction4.setEffectiveWeight(0); // Gizli baÅŸlat
                danceAction4.enabled = true;
                danceAction4.play(); // HEMEN baÅŸlat
                console.log('ğŸ’ƒ Dans 4 - Root motion temizlendi + baÅŸlatÄ±ldÄ± (weight=0)');
                
                if (isPlayer) {
                  playerGroup.userData.danceAction4 = danceAction4;
                } else {
                  partnerGroup.userData.danceAction4 = danceAction4;
                }
              }
            },
            undefined,
            function(error) {
              console.warn(`âš ï¸ ${prefix}Dance4.fbx bulunamadÄ±`);
            }
          );
          
          // ESKI danceAction referansÄ± iÃ§in (geriye uyumluluk)
          if (isPlayer) {
            playerGroup.userData.danceAction = danceAction1; // Dans 1 default
          } else {
            partnerGroup.userData.danceAction = danceAction1;
          }
          
          // IDLE animasyonunu yÃ¼kle (OPSÄ°YONEL)
          loader.load(`/${prefix}Idle.fbx`,
            function(idleFbx) {
              console.log(`âœ… ${prefix}Idle.fbx yÃ¼klendi!`);
              if (isPlayer) loadingManager.completeItem(`${charName} - Bekle`);
              if (idleFbx.animations && idleFbx.animations.length > 0) {
                // ROOT MOTION TRACK'Ä°NÄ° KALDIR!
                const idleClip = idleFbx.animations[0];
                idleClip.tracks = idleClip.tracks.filter(track => {
                  return !track.name.includes('.position');
                });
                
                idleAction = animMixer.clipAction(idleClip);
                idleAction.setLoop(THREE.LoopRepeat);
                idleAction.play(); // Direkt baÅŸlat, fade yok!
                idleAction.setEffectiveWeight(1); // Full weight
                console.log('ğŸ§˜ Idle animasyonu - Root motion temizlendi');
                
                currentAnimation = 'idle'; // BaÅŸlangÄ±Ã§ animasyonu idle
                if (isPlayer) {
                  playerGroup.userData.idleAction = idleAction;
                } else {
                  partnerGroup.userData.idleAction = idleAction;
                }
              }
              
              // BaÅŸlangÄ±Ã§ deÄŸerlerini gÃ¶ster
              console.log('âš™ï¸ BAÅLANGIÃ‡ HIZ AYARLARI:');
              console.log('ğŸ¬ Walk anim:', walkAnimSpeed, '| Hareket:', walkMoveSpeed);
              console.log('ğŸƒ Run anim:', runAnimSpeed, '| Hareket:', runMoveSpeed);
              console.log('ğŸ’¡ Animasyon sistemi hazÄ±r!');
              
              // DÄ°ÄER ANÄ°MASYONLARI HAZIRLA - userData'dan Ã§ek!
              // 2 saniye bekle - tÃ¼m danslar yÃ¼klensin
              setTimeout(() => {
                const walkAct = isPlayer ? playerGroup.userData.walkAction : partnerGroup.userData.walkAction;
                const runAct = isPlayer ? playerGroup.userData.runAction : partnerGroup.userData.runAction;
                
                // 4 Dans action'larÄ±
                const danceAct1 = isPlayer ? playerGroup.userData.danceAction1 : partnerGroup.userData.danceAction1;
                const danceAct2 = isPlayer ? playerGroup.userData.danceAction2 : partnerGroup.userData.danceAction2;
                const danceAct3 = isPlayer ? playerGroup.userData.danceAction3 : partnerGroup.userData.danceAction3;
                const danceAct4 = isPlayer ? playerGroup.userData.danceAction4 : partnerGroup.userData.danceAction4;
                
                console.log('ğŸ¬ Animasyon baÅŸlatma kontrolÃ¼:');
                console.log('  Walk:', walkAct ? 'VAR' : 'YOK');
                console.log('  Run:', runAct ? 'VAR' : 'YOK');
                console.log('  Dans 1:', danceAct1 ? 'VAR' : 'YOK');
                console.log('  Dans 2:', danceAct2 ? 'VAR' : 'YOK');
                console.log('  Dans 3:', danceAct3 ? 'VAR' : 'YOK');
                console.log('  Dans 4:', danceAct4 ? 'VAR' : 'YOK');
                
                if (walkAct) {
                  walkAct.time = 0.3; // T-pose frame'ini atla!
                  walkAct.setEffectiveWeight(0); // Gizli
                  walkAct.enabled = true;
                  walkAct.play(); // BaÅŸlat ama gÃ¶rÃ¼nmez
                  console.log('âœ… Walk baÅŸlatÄ±ldÄ± (weight=0, time=0.3)');
                } else {
                  console.error('âŒ walkAction bulunamadÄ±!');
                }
                
                if (runAct) {
                  runAct.time = 0.2; // T-pose frame'ini atla!
                  runAct.setEffectiveWeight(0);
                  runAct.enabled = true;
                  runAct.play();
                  console.log('âœ… Run baÅŸlatÄ±ldÄ± (weight=0, time=0.2)');
                } else {
                  console.error('âŒ runAction bulunamadÄ±!');
                }
                
                // 4 DansÄ± baÅŸlat (hepsi gizli)
                if (danceAct1) {
                  danceAct1.time = 0.1;
                  danceAct1.setEffectiveWeight(0);
                  danceAct1.enabled = true;
                  danceAct1.play();
                  console.log('âœ… Dans 1 baÅŸlatÄ±ldÄ± (weight=0)');
                } else {
                  console.warn('âš ï¸ Dans 1 bulunamadÄ±');
                }
                
                if (danceAct2) {
                  danceAct2.time = 0.1;
                  danceAct2.setEffectiveWeight(0);
                  danceAct2.enabled = true;
                  danceAct2.play();
                  console.log('âœ… Dans 2 baÅŸlatÄ±ldÄ± (weight=0)');
                } else {
                  console.warn('âš ï¸ Dans 2 bulunamadÄ±');
                }
                
                if (danceAct3) {
                  danceAct3.time = 0.1;
                  danceAct3.setEffectiveWeight(0);
                  danceAct3.enabled = true;
                  danceAct3.play();
                  console.log('âœ… Dans 3 baÅŸlatÄ±ldÄ± (weight=0)');
                } else {
                  console.warn('âš ï¸ Dans 3 bulunamadÄ±');
                }
                
                if (danceAct4) {
                  danceAct4.time = 0.1;
                  danceAct4.setEffectiveWeight(0);
                  danceAct4.enabled = true;
                  danceAct4.play();
                  console.log('âœ… Dans 4 baÅŸlatÄ±ldÄ± (weight=0)');
                } else {
                  console.warn('âš ï¸ Dans 4 bulunamadÄ±');
                }
                
                console.log('ğŸ‰ TÃœM ANÄ°MASYONLAR BAÅLATILDI!');
              }, 2000); // 2 saniye bekle
              
              // Idle zaten Ã§alÄ±ÅŸÄ±yor ve gÃ¶rÃ¼nÃ¼r (weight=1)
            },
            undefined,
            function(error) {
              console.warn(`âš ï¸ ${prefix}Idle.fbx bulunamadÄ± (opsiyonel)`);
              console.log('ğŸ’¡ Idle animasyonu olmadan da Ã§alÄ±ÅŸabilir');
            }
          );
          
          // Ä°sim etiketi
          const canvas = document.createElement('canvas');
          canvas.width = 256;
          canvas.height = 64;
          const ctx = canvas.getContext('2d');
          ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
          ctx.fillRect(0, 0, 256, 64);
          ctx.fillStyle = '#ff1493';
          ctx.font = 'bold 32px Arial';
          ctx.textAlign = 'center';
          ctx.fillText('Merve', 128, 42);
          
          const nameTexture = new THREE.CanvasTexture(canvas);
          const nameSprite = new THREE.Sprite(new THREE.SpriteMaterial({ map: nameTexture }));
          nameSprite.position.y = 2;
          nameSprite.scale.set(0.8, 0.2, 1);
          fbxModel.add(nameSprite);
          
          parentGroup.add(fbxModel);
          parentGroup.userData.fbxModel = fbxModel;
        },
        function(xhr) {
          console.log((xhr.loaded / xhr.total * 100) + '% yÃ¼klendi');
        },
        function(error) {
          console.error('âŒ mWalk.fbx YÃœKLEME HATASI!');
          console.error('Hata:', error);
          console.error('âš ï¸ KONTROL ET:');
          console.error('  1. Dosya public/mWalk.fbx konumunda mÄ±?');
          console.error('  2. Dosya adÄ± tam olarak "mWalk.fbx" mi? (kÃ¼Ã§Ã¼k m, bÃ¼yÃ¼k W)');
          console.error('  3. Sunucu Ã§alÄ±ÅŸÄ±yor mu? (npm start)');
          alert('âŒ HATA: mWalk.fbx dosyasÄ± bulunamadÄ±!\n\nDosyanÄ±n public/ klasÃ¶rÃ¼nde olduÄŸundan emin olun.\nDosya adÄ±: mWalk.fbx');
        }
      );
    }

    function createCharacters() {
      // Determine which character is which
      const playerIsBatuhan = selectedCharacter === 'batuhan';
      
      // Player character
      playerGroup = new THREE.Group();
      
      // MERVE Ä°SE FBX YÃœKLE (KadÄ±n)
      if (!playerIsBatuhan) {
        loadFBXCharacter(playerGroup, true, false); // false = Merve
      }
      // BATUHAN Ä°SE FBX YÃœKLE (Erkek)
      else {
        loadFBXCharacter(playerGroup, true, true); // true = Batuhan
      }

      playerGroup.position.set(0, 0, 30); // DIÅARIDA BAÅLA
      scene.add(playerGroup);

      // PARTNER CHARACTER
      partnerGroup = new THREE.Group();
      const partnerIsBatuhan = !playerIsBatuhan;
      
      // PARTNER MERVE Ä°SE FBX YÃœKLE (KadÄ±n)
      if (!partnerIsBatuhan) {
        loadFBXCharacter(partnerGroup, false, false); // false = Merve
      }
      // PARTNER BATUHAN Ä°SE FBX YÃœKLE (Erkek)
      else {
        loadFBXCharacter(partnerGroup, false, true); // true = Batuhan
      }

      partnerGroup.position.set(3, 0, 30); // DIÅARIDA BAÅLA
      partnerGroup.visible = partnerConnected;
      scene.add(partnerGroup);
    }

    function setupControls() {
      window.addEventListener('keydown', (e) => {
        keys[e.key.toLowerCase()] = true;
      });

      window.addEventListener('keyup', (e) => {
        keys[e.key.toLowerCase()] = false;
      });

      window.addEventListener('mousemove', (e) => {
        if (document.pointerLockElement === renderer.domElement) {
          yaw -= e.movementX * 0.002;
          pitch += e.movementY * 0.002; // Fare aÅŸaÄŸÄ± = kamera aÅŸaÄŸÄ±
          
          // Limit pitch
          pitch = Math.max(-Math.PI / 3, Math.min(Math.PI / 3, pitch));
        } else {
          mouseX = (e.clientX / window.innerWidth) * 2 - 1;
          mouseY = (e.clientY / window.innerHeight) * 2 - 1;
          yaw = -mouseX * Math.PI * 0.5;
          pitch = -mouseY * 0.3;
        }
      });

      // Pointer lock for better camera control
      renderer.domElement.addEventListener('click', () => {
        renderer.domElement.requestPointerLock();
      });

      document.addEventListener('pointerlockchange', () => {
        if (!document.pointerLockElement) {
          // Pointer lock exited
        }
      });

      window.addEventListener('click', (e) => {
        const mouse = new THREE.Vector2();
        mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
        mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;

        const raycaster = new THREE.Raycaster();
        raycaster.setFromCamera(mouse, camera);
        const intersects = raycaster.intersectObjects(photoFrames);

        if (intersects.length > 0) {
          const photo = intersects[0].object;
          showPhoto(photo.userData.index);
        }

        // Close popups
        if (e.target.classList.contains('message-popup') || e.target.classList.contains('photo-popup')) {
          document.getElementById('message-popup').classList.remove('show');
          document.getElementById('photo-popup').classList.remove('show');
        }
      });

      window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      });
    }

    function showPhoto(index) {
      const colors = ['#ff69b4', '#ffb6c1', '#ffc0cb', '#ff1493', '#db7093'];
      const color1 = colors[index % colors.length];
      const color2 = colors[(index + 1) % colors.length];
      
      const photoFrame = document.getElementById('photo-frame');
      photoFrame.style.background = `linear-gradient(135deg, ${color1}, ${color2})`;
      
      document.getElementById('photo-number').textContent = index;
      document.getElementById('photo-popup').classList.add('show');
    }

    let time = 0;
    let walkCycle = 0;
    let currentAnimation = null; // Åu an oynatÄ±lan animasyon
    let isDancingToggle = false; // Dans toggle durumu
    let lastQKeyState = false; // Q tuÅŸunun Ã¶nceki durumu
    
    // ANÄ°MASYON HIZ AYARLARI - SABÄ°T DEÄERLER
    let walkAnimSpeed = 1.14;   // YÃ¼rÃ¼me animasyon hÄ±zÄ±
    let runAnimSpeed = 1.28;    // KoÅŸma animasyon hÄ±zÄ±
    let walkMoveSpeed = 0.016;  // YÃ¼rÃ¼me hareket hÄ±zÄ±
    let runMoveSpeed = 0.073;   // KoÅŸma hareket hÄ±zÄ±
    let lastSpeedAdjust = 0;    // Son ayarlama zamanÄ±
    
    function animate() {
      requestAnimationFrame(animate);
      time += 16;
      walkCycle += 0.1;

      // FBX ANÄ°MASYON GÃœNCELLEMESÄ°
      const delta = clock.getDelta();
      if (mixer) mixer.update(delta);
      if (partnerMixer) partnerMixer.update(delta);
      
      // ROOT MOTION TAMAMEN DEVRE DIÅI - FBX model yOffset ile zeminde
      if (playerGroup.userData.fbxModel) {
        const fbxModel = playerGroup.userData.fbxModel;
        const yOff = fbxModel.userData.yOffset || 0;
        fbxModel.position.set(0, yOff, 0); // yOffset ile zemine oturt
        fbxModel.rotation.y = 0;
        
        fbxModel.traverse((child) => {
          if (child.userData.isRootBone) {
            child.position.x = 0;
            child.position.z = 0;
            child.position.y = 0;
          }
        });
      }
      if (partnerGroup && partnerGroup.userData.fbxModel) {
        const fbxModel = partnerGroup.userData.fbxModel;
        const yOff = fbxModel.userData.yOffset || 0;
        fbxModel.position.set(0, yOff, 0); // yOffset ile zemine oturt
        fbxModel.rotation.y = 0;
        
        fbxModel.traverse((child) => {
          if (child.userData.isRootBone) {
            child.position.x = 0;
            child.position.z = 0;
            child.position.y = 0;
          }
        });
      }

      
      // Player movement - KAMERA YÃ–NÃœNE GÃ–RE
      const isMoving = keys['w'] || keys['s'] || keys['a'] || keys['d'];
      const isRunning = keys['shift']; // SHIFT = KOÅMA
      
      // Q TUÅU - DANS MENÃœSÃœ AÃ‡
      const qKeyPressed = keys['q'];
      if (qKeyPressed && !lastQKeyState) {
        // Q tuÅŸuna basÄ±ldÄ± - dans menÃ¼sÃ¼nÃ¼ aÃ§
        document.getElementById('dance-menu').style.display = 'flex';
        // Pointer lock'u kaldÄ±r (menÃ¼de fare kullanabilsin)
        if (document.pointerLockElement) {
          document.exitPointerLock();
        }
        console.log('ğŸ’ƒ Dans menÃ¼sÃ¼ aÃ§Ä±ldÄ±');
      }
      lastQKeyState = qKeyPressed;
      
      // FBX ANÄ°MASYON KONTROLÃœ (Her iki karakter iÃ§in)
      if (playerGroup.userData.walkAction && playerGroup.userData.runAction) {
        const walkAction = playerGroup.userData.walkAction;
        const runAction = playerGroup.userData.runAction;
        const danceAction = playerGroup.userData.danceAction; // Eski - geriye uyumluluk
        const idleAction = playerGroup.userData.idleAction; // Opsiyonel
        
        // 4 Dans action'larÄ±
        const danceAction1 = playerGroup.userData.danceAction1;
        const danceAction2 = playerGroup.userData.danceAction2;
        const danceAction3 = playerGroup.userData.danceAction3;
        const danceAction4 = playerGroup.userData.danceAction4;
        
        // TÃ¼m temel animasyonlar yÃ¼klendiyse devam et
        if (walkAction && runAction) {
        
        // Mevcut oynatÄ±lan animasyonun hÄ±zÄ±nÄ± gÃ¼ncelle (runtime ayarlar iÃ§in)
        if (walkAction && walkAction.enabled && walkAction.isRunning()) {
          walkAction.setEffectiveTimeScale(walkAnimSpeed);
        }
        if (runAction && runAction.enabled && runAction.isRunning()) {
          runAction.setEffectiveTimeScale(runAnimSpeed);
        }
        
        // Hangi animasyon oynatÄ±lmalÄ±?
        let targetAnimation = null;
        
        if (selectedDance > 0) {
          // Dans seÃ§ilmiÅŸ (1-4)
          targetAnimation = `dance${selectedDance}`;
          // Dans ederken hem fbxModel hem playerGroup Y'sini sÄ±fÄ±rla
          const fbxM = playerGroup.userData.fbxModel;
          if (fbxM) fbxM.position.y = fbxM.userData.yOffset || 0;
          playerGroup.position.y = 0; // Yerin altÄ±na girmeyi Ã¶nle!
        } else if (isMoving && isRunning) {
          targetAnimation = 'run';
        } else if (isMoving) {
          targetAnimation = 'walk';
        } else if (idleAction) {
          targetAnimation = 'idle';
        }
        
        // EN BASÄ°T SÄ°STEM - Sadece weight deÄŸiÅŸtir!
        if (currentAnimation !== targetAnimation && targetAnimation) {
          console.log('ğŸ¬ GeÃ§iÅŸ:', currentAnimation, 'â†’', targetAnimation);
          
          // TÃ¼m animasyonlarÄ±n weight'ini 0 yap (gizle)
          if (walkAction) walkAction.setEffectiveWeight(0);
          if (runAction) runAction.setEffectiveWeight(0);
          if (idleAction) idleAction.setEffectiveWeight(0);
          
          // 4 Dans weight'lerini 0 yap
          if (danceAction1) danceAction1.setEffectiveWeight(0);
          if (danceAction2) danceAction2.setEffectiveWeight(0);
          if (danceAction3) danceAction3.setEffectiveWeight(0);
          if (danceAction4) danceAction4.setEffectiveWeight(0);
          
          // Hedef animasyonu gÃ¶ster (weight=1)
          if (targetAnimation === 'walk' && walkAction) {
            walkAction.setEffectiveWeight(1);
            walkAction.setEffectiveTimeScale(walkAnimSpeed);
            console.log('âœ… Walk gÃ¶rÃ¼nÃ¼r');
          } else if (targetAnimation === 'run' && runAction) {
            runAction.setEffectiveWeight(1);
            runAction.setEffectiveTimeScale(runAnimSpeed);
            console.log('âœ… Run gÃ¶rÃ¼nÃ¼r');
          } else if (targetAnimation === 'dance1' && danceAction1) {
            danceAction1.setEffectiveWeight(1);
            console.log('âœ… Dans 1 gÃ¶rÃ¼nÃ¼r');
          } else if (targetAnimation === 'dance2' && danceAction2) {
            danceAction2.setEffectiveWeight(1);
            console.log('âœ… Dans 2 gÃ¶rÃ¼nÃ¼r');
          } else if (targetAnimation === 'dance3' && danceAction3) {
            danceAction3.setEffectiveWeight(1);
            console.log('âœ… Dans 3 gÃ¶rÃ¼nÃ¼r');
          } else if (targetAnimation === 'dance4' && danceAction4) {
            danceAction4.setEffectiveWeight(1);
            console.log('âœ… Dans 4 gÃ¶rÃ¼nÃ¼r');
          } else if (targetAnimation === 'idle' && idleAction) {
            idleAction.setEffectiveWeight(1);
            console.log('âœ… Idle gÃ¶rÃ¼nÃ¼r');
          }
          
          currentAnimation = targetAnimation;
        }
        } // Animasyonlar yÃ¼klÃ¼ kontrolÃ¼ sonu
      }
      
      if (isMoving) {
        // HAREKET HIZI (Ayarlanabilir deÄŸerler)
        const currentSpeed = isRunning ? runMoveSpeed : walkMoveSpeed;
        
        // Kamera yÃ¶nÃ¼ne gÃ¶re hareket
        const forward = new THREE.Vector3();
        camera.getWorldDirection(forward);
        forward.y = 0;
        forward.normalize();
        
        const right = new THREE.Vector3();
        right.crossVectors(forward, new THREE.Vector3(0, 1, 0));
        
        if (keys['w']) {
          playerGroup.position.x += forward.x * currentSpeed;
          playerGroup.position.z += forward.z * currentSpeed;
        }
        if (keys['s']) {
          playerGroup.position.x -= forward.x * currentSpeed;
          playerGroup.position.z -= forward.z * currentSpeed;
        }
        if (keys['a']) {
          playerGroup.position.x -= right.x * currentSpeed;
          playerGroup.position.z -= right.z * currentSpeed;
        }
        if (keys['d']) {
          playerGroup.position.x += right.x * currentSpeed;
          playerGroup.position.z += right.z * currentSpeed;
        }
        
        // Karakter hareket yÃ¶nÃ¼ne dÃ¶nsÃ¼n
        const moveAngle = Math.atan2(forward.x, forward.z);
        playerGroup.rotation.y = moveAngle;
      }
      
      // ZIPLAMA
      if (keys[' '] && playerGroup.userData.onGround) {
        playerGroup.userData.velocityY = 0.15;
        playerGroup.userData.onGround = false;
      }
      
      // MÃœZÄ°K KONTROL (M tuÅŸu)
      if (keys['m'] && !window.musicToggleCooldown) {
        const music = document.getElementById('background-music');
        if (music.paused) {
          music.play().catch(e => console.log('MÃ¼zik Ã§alÄ±namadÄ±:', e));
          console.log('ğŸµ MÃ¼zik baÅŸlatÄ±ldÄ±');
        } else {
          music.pause();
          console.log('ğŸ”‡ MÃ¼zik durduruldu');
        }
        window.musicToggleCooldown = true;
        setTimeout(() => {
          window.musicToggleCooldown = false;
        }, 500);
      }
      
      // YerÃ§ekimi
      if (!playerGroup.userData.velocityY) playerGroup.userData.velocityY = 0;
      if (!playerGroup.userData.onGround) {
        playerGroup.userData.velocityY -= 0.008;
        playerGroup.position.y += playerGroup.userData.velocityY;
        
        if (playerGroup.position.y <= 0) {
          playerGroup.position.y = 0;
          playerGroup.userData.velocityY = 0;
          playerGroup.userData.onGround = true;
        }
      } else {
        playerGroup.userData.onGround = true;
      }

      // Boundaries - DÄ±ÅŸ ortam iÃ§in geniÅŸ
      if (!window.insideMuseum) {
        playerGroup.position.x = Math.max(-50, Math.min(50, playerGroup.position.x));
        playerGroup.position.z = Math.max(-50, Math.min(50, playerGroup.position.z));
      } else {
        // MÃ¼ze iÃ§i
        playerGroup.position.x = Math.max(-12, Math.min(12, playerGroup.position.x));
        playerGroup.position.z = Math.max(-17, Math.min(17, playerGroup.position.z));
      }

      // GEOMETRÄ°K KARAKTER ANÄ°MASYONLARI (Sadece Batuhan iÃ§in)
      // FBX karakterlerde (Merve) bu animasyonlar kullanÄ±lmaz
      if (playerGroup.leftArm && playerGroup.rightArm && !playerGroup.userData.fbxModel) {
        // Bu Batuhan (geometrik karakter)
        if (isMoving) {
          // YÃœRÃœME ANÄ°MASYONU
          playerGroup.leftArm.rotation.x = Math.sin(walkCycle) * 0.5;
          playerGroup.leftArm.rotation.z = 0;
          playerGroup.rightArm.rotation.x = Math.sin(walkCycle + Math.PI) * 0.5;
          playerGroup.rightArm.rotation.z = 0;
          
          // BACAK ANÄ°MASYONU
          if (playerGroup.leftLeg && playerGroup.rightLeg) {
            playerGroup.leftLeg.rotation.x = Math.sin(walkCycle) * 0.4;
            playerGroup.rightLeg.rotation.x = Math.sin(walkCycle + Math.PI) * 0.4;
          }
        } else {
          // DurduÄŸunda normal pozisyon
          playerGroup.leftArm.rotation.x = 0;
          playerGroup.leftArm.rotation.y = 0;
          playerGroup.leftArm.rotation.z = 0;
          playerGroup.rightArm.rotation.x = 0;
          playerGroup.rightArm.rotation.y = 0;
          playerGroup.rightArm.rotation.z = 0;
          
          if (playerGroup.leftLeg && playerGroup.rightLeg) {
            playerGroup.leftLeg.rotation.x = 0;
            playerGroup.rightLeg.rotation.x = 0;
          }
        }
      }

      // Third-person camera - SABÄ°T TAKÄ°P
      const cameraDistance = 3.5; // Daha yakÄ±n
      const cameraHeight = 2.5;
      
      camera.position.x = playerGroup.position.x - Math.sin(yaw) * cameraDistance * Math.cos(pitch);
      camera.position.y = playerGroup.position.y + cameraHeight + Math.sin(pitch) * 2;
      camera.position.z = playerGroup.position.z - Math.cos(yaw) * cameraDistance * Math.cos(pitch);
      
      // Camera look at player
      camera.lookAt(playerGroup.position.x, playerGroup.position.y + 0.8, playerGroup.position.z);

      // Send position AND animation state to server
      socket.emit('update_position', {
        position: {
          x: playerGroup.position.x,
          y: playerGroup.position.y,
          z: playerGroup.position.z
        },
        rotation: playerGroup.rotation.y,
        animation: currentAnimation, // Åu anki animasyon
        danceNumber: selectedDance // SeÃ§ili dans (0 = yok, 1-4 = dans)
      });

      // Animate messages
      messages.forEach((msg, i) => {
        msg.position.y = msg.userData.baseY + Math.sin(time * 0.002 + i) * 0.1;
        msg.rotation.y += 0.01;
      });

      // Check near message
      nearMessage = null;
      messages.forEach((msg) => {
        const dist = playerGroup.position.distanceTo(msg.position);
        if (dist < 1.5) nearMessage = msg.userData;
      });

      // KAPI ETKÄ°LEÅÄ°MÄ°
      let nearDoor = false;
      if (window.museumDoor && !window.insideMuseum) {
        const doorPos = new THREE.Vector3(0, 0, 19);
        const distToDoor = playerGroup.position.distanceTo(doorPos);
        
        if (distToDoor < 3) {
          nearDoor = true;
          if (keys['e']) {
            // Pointer lock'u kapat
            if (document.pointerLockElement) {
              document.exitPointerLock();
            }
            
            document.getElementById('password-popup').style.display = 'flex';
            setTimeout(() => {
              document.getElementById('password-input').focus();
            }, 100);
          }
        }
      }

      if (nearMessage) {
        document.getElementById('message-indicator').classList.add('show');
        if (keys['e']) {
          document.getElementById('message-text').textContent = nearMessage.text;
          document.getElementById('message-popup').classList.add('show');
        }
      } else if (nearDoor) {
        document.getElementById('message-indicator').textContent = 'ğŸ” E tuÅŸuna bas - MÃ¼zeye Gir';
        document.getElementById('message-indicator').classList.add('show');
      } else {
        document.getElementById('message-indicator').classList.remove('show');
        document.getElementById('message-indicator').textContent = 'ğŸ’Œ E tuÅŸuna bas ve mesajÄ± oku!';
      }

      // Animate floating hearts
      scene.children.forEach((child) => {
        if (child.userData.floatOffset !== undefined) {
          child.position.y += Math.sin(time * 0.001 + child.userData.floatOffset) * 0.002;
          child.rotation.y += 0.01;
        }
      });

      // KELEBEK ANÄ°MASYONLARI
      if (window.butterflies) {
        window.butterflies.forEach((butterfly, i) => {
          const data = butterfly.userData;
          data.path += data.speed;
          
          // SinÃ¼s dalgasÄ± ile uÃ§
          butterfly.position.x += Math.cos(data.path) * 0.05;
          butterfly.position.z += Math.sin(data.path) * 0.05;
          butterfly.position.y = 1.5 + Math.sin(data.path * 3) * 0.5;
          
          // Kanat Ã§Ä±rpma
          if (butterfly.children[0] && butterfly.children[1]) {
            const wingAngle = Math.sin(time * data.wingSpeed * 0.001) * 0.5;
            butterfly.children[0].rotation.y = -wingAngle;
            butterfly.children[1].rotation.y = wingAngle;
          }
          
          // YÃ¶nlendir
          butterfly.rotation.y = data.path;
          
          // SÄ±nÄ±rlar iÃ§inde tut
          if (Math.abs(butterfly.position.x) > 50) butterfly.position.x *= -0.9;
          if (Math.abs(butterfly.position.z) > 50) butterfly.position.z *= -0.9;
        });
      }

      // KUÅ ANÄ°MASYONLARI
      if (window.birds) {
        window.birds.forEach((bird) => {
          const data = bird.userData;
          data.angle += data.speed * 0.01;
          
          // Dairesel uÃ§uÅŸ
          bird.position.x = Math.cos(data.angle) * data.radius;
          bird.position.z = Math.sin(data.angle) * data.radius;
          bird.position.y = 15 + Math.sin(data.angle * 3) * 3;
          
          // YÃ¶nlendir
          bird.rotation.y = data.angle + Math.PI / 2;
        });
      }

      renderer.render(scene, camera);
    }

    // Event Listeners - DOM yÃ¼klendikten sonra
    document.addEventListener('DOMContentLoaded', () => {
      console.log('âœ… DOM yÃ¼klendi, event listener\'lar ekleniyor...');
      
      // Menu butonlarÄ±
      const createBtn = document.getElementById('create-room-btn');
      const joinBtn = document.getElementById('join-room-btn');
      const submitBtn = document.getElementById('join-submit-btn');
      
      if (createBtn) {
        createBtn.addEventListener('click', createRoom);
        console.log('âœ… Create button listener eklendi');
      }
      
      if (joinBtn) {
        joinBtn.addEventListener('click', showJoinInput);
        console.log('âœ… Join button listener eklendi');
      }
      
      if (submitBtn) {
        submitBtn.addEventListener('click', joinRoom);
        console.log('âœ… Submit button listener eklendi');
      }
      
      // Enter tuÅŸu ile oda kodunu gÃ¶nder
      const roomInput = document.getElementById('room-code-input');
      if (roomInput) {
        roomInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') joinRoom();
        });
      }
      
      // Karakter seÃ§imi
      const batuhanBtn = document.getElementById('select-batuhan');
      const merveBtn = document.getElementById('select-merve');
      
      if (batuhanBtn) {
        batuhanBtn.addEventListener('click', () => selectCharacter('batuhan'));
        console.log('âœ… Batuhan button listener eklendi');
      }
      
      if (merveBtn) {
        merveBtn.addEventListener('click', () => selectCharacter('merve'));
        console.log('âœ… Merve button listener eklendi');
      }
    });
  </script>
</body>
</html>
