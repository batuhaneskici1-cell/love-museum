<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AÅŸkÄ±mÄ±zÄ±n MÃ¼zesi ğŸ’• - Multiplayer</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=Crimson+Text:ital@0;1&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fflate@0.7.4/umd/index.js"></script>
  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/js/loaders/FBXLoader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Playfair Display', serif;
      overflow: hidden;
      background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 50%, #ffecd2 100%);
    }

    #menu-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: linear-gradient(135deg, rgba(255, 105, 180, 0.95), rgba(255, 182, 193, 0.95));
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      backdrop-filter: blur(10px);
    }

    #menu-screen.hidden {
      display: none;
    }

    .menu-title {
      font-size: 72px;
      font-weight: 900;
      color: white;
      text-shadow: 4px 4px 20px rgba(0, 0, 0, 0.3);
      margin-bottom: 20px;
      animation: float 3s ease-in-out infinite;
    }

    .menu-subtitle {
      font-size: 28px;
      color: rgba(255, 255, 255, 0.9);
      margin-bottom: 60px;
      font-style: italic;
    }

    .menu-buttons {
      display: flex;
      gap: 30px;
      margin-bottom: 40px;
    }

    .menu-btn {
      padding: 20px 50px;
      font-size: 24px;
      font-family: 'Playfair Display', serif;
      font-weight: 700;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }

    .menu-btn:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
    }

    .btn-create {
      background: linear-gradient(135deg, #ff1493, #ff69b4);
      color: white;
    }

    .btn-join {
      background: white;
      color: #ff1493;
    }

    .room-input-container {
      display: none;
      margin-top: 20px;
    }

    .room-input-container.active {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
    }

    .room-code-input {
      padding: 15px 30px;
      font-size: 32px;
      font-family: 'Courier New', monospace;
      font-weight: bold;
      text-align: center;
      border: 4px solid white;
      border-radius: 15px;
      background: rgba(255, 255, 255, 0.9);
      color: #ff1493;
      letter-spacing: 5px;
      text-transform: uppercase;
      width: 300px;
    }

    .room-code-display {
      background: white;
      padding: 30px 50px;
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }

    .room-code-display h3 {
      color: #ff1493;
      font-size: 24px;
      margin-bottom: 15px;
    }

    .room-code {
      font-size: 56px;
      font-family: 'Courier New', monospace;
      font-weight: bold;
      color: #ff1493;
      letter-spacing: 8px;
      margin-bottom: 15px;
    }

    .waiting-text {
      font-size: 18px;
      color: #666;
      font-style: italic;
    }

    .error-message {
      background: rgba(255, 50, 50, 0.9);
      color: white;
      padding: 15px 30px;
      border-radius: 10px;
      font-size: 18px;
      margin-top: 20px;
      display: none;
    }

    .error-message.show {
      display: block;
      animation: shake 0.5s;
    }

    #game-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      display: none;
    }

    #game-container.active {
      display: block;
    }

    .hud {
      position: absolute;
      top: 16px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 105, 180, 0.82);
      padding: 8px 22px;
      border-radius: 30px;
      text-align: center;
      color: white;
      box-shadow: 0 4px 15px rgba(255, 105, 180, 0.35);
      backdrop-filter: blur(8px);
      z-index: 100;
      white-space: nowrap;
    }

    .hud h1 {
      margin: 0;
      font-size: 16px;
      font-weight: 700;
      letter-spacing: 0.5px;
    }

    .hud p {
      margin: 0;
      font-size: 11px;
      opacity: 0.9;
    }

    .controls {
      position: absolute;
      bottom: 20px;
      left: 20px;
      background: rgba(0, 0, 0, 0.55);
      padding: 10px 14px;
      border-radius: 12px;
      max-width: 190px;
      z-index: 100;
      backdrop-filter: blur(6px);
    }

    .controls h3 {
      margin: 0 0 6px 0;
      color: #ff9ec8;
      font-size: 12px;
      letter-spacing: 0.5px;
    }

    .controls p {
      margin: 2px 0;
      color: rgba(255,255,255,0.85);
      font-size: 11px;
      font-family: monospace;
    }

    .message-indicator {
      position: absolute;
      bottom: 30px;
      right: 30px;
      background: rgba(255, 105, 180, 0.95);
      padding: 15px 25px;
      border-radius: 15px;
      color: white;
      font-size: 18px;
      font-weight: bold;
      box-shadow: 0 5px 20px rgba(255, 105, 180, 0.5);
      display: none;
      z-index: 100;
    }

    .message-indicator.show {
      display: block;
      animation: pulse 2s infinite;
    }

    .message-popup {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      cursor: pointer;
    }

    .message-popup.show {
      display: flex;
      animation: fadeIn 0.3s ease-out;
    }

    .message-content {
      background: linear-gradient(135deg, #ff69b4, #ffb6c1);
      padding: 50px;
      border-radius: 30px;
      max-width: 600px;
      text-align: center;
      box-shadow: 0 20px 60px rgba(255, 105, 180, 0.6);
    }

    .message-content .icon {
      font-size: 60px;
      margin-bottom: 20px;
    }

    .message-content p {
      font-size: 28px;
      color: white;
      margin: 0;
      line-height: 1.6;
      font-style: italic;
    }

    .message-content .close-hint {
      font-size: 16px;
      color: rgba(255, 255, 255, 0.8);
      margin-top: 30px;
    }

    .photo-popup {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      cursor: pointer;
    }

    .photo-popup.show {
      display: flex;
    }

    .photo-content {
      background: white;
      padding: 30px;
      border-radius: 20px;
      max-width: 80vw;
      max-height: 80vh;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
    }

    .photo-frame {
      width: 600px;
      height: 400px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 10px;
      font-size: 24px;
      color: white;
      font-weight: bold;
      flex-direction: column;
    }

    .photo-frame .hint {
      font-size: 14px;
      margin-top: 10px;
      opacity: 0.8;
    }

    .partner-status {
      position: absolute;
      top: 120px;
      right: 30px;
      background: rgba(255, 255, 255, 0.95);
      padding: 15px 25px;
      border-radius: 15px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
      z-index: 100;
    }

    .partner-status h4 {
      margin: 0 0 10px 0;
      color: #ff1493;
      font-size: 16px;
    }

    .partner-status .status {
      color: #666;
      font-size: 14px;
    }

    .partner-status .connected {
      color: #00cc00;
    }

    .partner-status .waiting {
      color: #ff9900;
    }

    .character-card:hover > div {
      transform: scale(1.05);
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-20px); }
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-10px); }
      75% { transform: translateX(10px); }
    }
  </style>
</head>
<body>
  <!-- YÃœKLEME EKRANI - ROMANTÄ°K -->
  <div id="loading-screen" style="
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 50%, #ffc3a0 100%);
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    font-family: 'Arial', sans-serif;
    color: white;
    overflow: hidden;
  ">
    <!-- Kalpler animasyonu -->
    <div style="position: absolute; width: 100%; height: 100%; overflow: hidden; opacity: 0.3;">
      <div class="heart" style="position: absolute; left: 10%; animation: float 6s infinite; animation-delay: 0s;">ğŸ’•</div>
      <div class="heart" style="position: absolute; left: 20%; animation: float 7s infinite; animation-delay: 1s;">â¤ï¸</div>
      <div class="heart" style="position: absolute; left: 30%; animation: float 5s infinite; animation-delay: 2s;">ğŸ’–</div>
      <div class="heart" style="position: absolute; left: 40%; animation: float 8s infinite; animation-delay: 0.5s;">ğŸ’—</div>
      <div class="heart" style="position: absolute; left: 50%; animation: float 6s infinite; animation-delay: 1.5s;">ğŸ’“</div>
      <div class="heart" style="position: absolute; left: 60%; animation: float 7s infinite; animation-delay: 2.5s;">ğŸ’</div>
      <div class="heart" style="position: absolute; left: 70%; animation: float 5s infinite; animation-delay: 3s;">ğŸ’</div>
      <div class="heart" style="position: absolute; left: 80%; animation: float 6s infinite; animation-delay: 1s;">ğŸ’Ÿ</div>
      <div class="heart" style="position: absolute; left: 90%; animation: float 7s infinite; animation-delay: 2s;">â£ï¸</div>
    </div>
    
    <!-- Ana iÃ§erik -->
    <div style="position: relative; z-index: 1; text-align: center;">
      <h1 style="
        font-size: 48px;
        margin-bottom: 30px;
        text-shadow: 2px 2px 10px rgba(0,0,0,0.2);
        animation: pulse 2s infinite;
      ">ğŸ’• AÅŸkÄ±mÄ±zÄ±n MÃ¼zesi ğŸ’•</h1>
      
      <div id="loading-messages" style="
        font-size: 24px;
        margin: 40px 0;
        min-height: 80px;
        text-shadow: 1px 1px 5px rgba(0,0,0,0.2);
        animation: fadeIn 1s;
      ">
        Seni dÃ¼ÅŸÃ¼nÃ¼yorum... ğŸ’­
      </div>
      
      <!-- YÃ¼kleme barÄ± -->
      <div style="
        width: 400px;
        height: 30px;
        background: rgba(255,255,255,0.3);
        border-radius: 15px;
        overflow: hidden;
        margin: 30px auto;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      ">
        <div id="loading-bar" style="
          width: 0%;
          height: 100%;
          background: linear-gradient(90deg, #ff6b9d, #fec5bb);
          border-radius: 15px;
          transition: width 0.3s;
          box-shadow: 0 0 20px rgba(255,107,157,0.5);
        "></div>
      </div>
      
      <div id="loading-percentage" style="
        font-size: 20px;
        margin-top: 15px;
        font-weight: bold;
      ">0%</div>
      
      <!-- YÃ¼klenen ÅŸeyler - GÄ°ZLÄ° -->
      <div id="loading-items" style="display:none;"></div>
    </div>
    
    <style>
      @keyframes float {
        0%, 100% { transform: translateY(100vh) scale(1); opacity: 0; }
        10% { opacity: 1; }
        90% { opacity: 1; }
        100% { transform: translateY(-100px) scale(1.5); opacity: 0; }
      }
      
      @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
      }
      
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
      }
      
      .heart {
        font-size: 40px;
      }
    </style>
  </div>
  
  <!-- Menu Screen -->
  <!-- Menu Screen - GÃœZELLEÅTÄ°RÄ°LMÄ°Å -->
  <div id="menu-screen" style="
    position: fixed;
    width: 100vw;
    height: 100vh;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    overflow: hidden;
  ">
    <!-- UÃ§an kalpler arka plan -->
    <div style="position: absolute; width: 100%; height: 100%; overflow: hidden; opacity: 0.15;">
      <div class="heart-bg" style="position: absolute; left: 5%; animation: floatSlow 15s infinite; animation-delay: 0s;">ğŸ’•</div>
      <div class="heart-bg" style="position: absolute; left: 15%; animation: floatSlow 18s infinite; animation-delay: 3s;">â¤ï¸</div>
      <div class="heart-bg" style="position: absolute; left: 25%; animation: floatSlow 20s infinite; animation-delay: 6s;">ğŸ’–</div>
      <div class="heart-bg" style="position: absolute; left: 35%; animation: floatSlow 17s infinite; animation-delay: 2s;">ğŸ’—</div>
      <div class="heart-bg" style="position: absolute; left: 45%; animation: floatSlow 19s infinite; animation-delay: 5s;">ğŸ’“</div>
      <div class="heart-bg" style="position: absolute; left: 55%; animation: floatSlow 16s infinite; animation-delay: 8s;">ğŸ’</div>
      <div class="heart-bg" style="position: absolute; left: 65%; animation: floatSlow 21s infinite; animation-delay: 4s;">ğŸ’</div>
      <div class="heart-bg" style="position: absolute; left: 75%; animation: floatSlow 18s infinite; animation-delay: 7s;">ğŸ’Ÿ</div>
      <div class="heart-bg" style="position: absolute; left: 85%; animation: floatSlow 22s infinite; animation-delay: 1s;">â£ï¸</div>
      <div class="heart-bg" style="position: absolute; left: 95%; animation: floatSlow 19s infinite; animation-delay: 9s;">ğŸ’˜</div>
    </div>
    
    <style>
      @keyframes floatSlow {
        0% { transform: translateY(100vh) scale(0.8) rotate(0deg); opacity: 0; }
        5% { opacity: 1; }
        95% { opacity: 1; }
        100% { transform: translateY(-20vh) scale(1.5) rotate(360deg); opacity: 0; }
      }
      
      .heart-bg {
        font-size: 60px;
      }
      
      @keyframes glow {
        0%, 100% { box-shadow: 0 0 20px rgba(255, 255, 255, 0.5), 0 0 40px rgba(255, 105, 180, 0.3); }
        50% { box-shadow: 0 0 40px rgba(255, 255, 255, 0.8), 0 0 80px rgba(255, 105, 180, 0.5); }
      }
      
      @keyframes titlePulse {
        0%, 100% { transform: scale(1); text-shadow: 0 0 20px rgba(255,255,255,0.5); }
        50% { transform: scale(1.05); text-shadow: 0 0 40px rgba(255,255,255,0.8); }
      }
    </style>
    
    <!-- Ana iÃ§erik -->
    <div style="position: relative; z-index: 1; text-align: center; background: rgba(255,255,255,0.1); padding: 60px 80px; border-radius: 30px; backdrop-filter: blur(10px); box-shadow: 0 8px 32px rgba(0,0,0,0.2);">
      <h1 style="
        font-size: 64px;
        margin-bottom: 20px;
        color: white;
        text-shadow: 2px 2px 20px rgba(0,0,0,0.3);
        animation: titlePulse 3s infinite;
        font-family: 'Arial Black', sans-serif;
        letter-spacing: 2px;
      ">ğŸ’• AÅŸkÄ±mÄ±zÄ±n MÃ¼zesi ğŸ’•</h1>
      
      <p style="color: rgba(255,255,255,0.95); font-size: 22px; margin-bottom: 50px; text-shadow: 1px 1px 10px rgba(0,0,0,0.2);">
        Sevgililer GÃ¼nÃ¼'mÃ¼ze Ã–zel ğŸ’–
      </p>
    
      <div style="display: flex; gap: 30px; justify-content: center; margin-bottom: 30px;">
        <button id="create-room-btn" style="
          padding: 20px 50px;
          font-size: 24px;
          background: linear-gradient(135deg, #ff6b9d, #c44569);
          color: white;
          border: none;
          border-radius: 50px;
          cursor: pointer;
          transition: all 0.3s;
          font-weight: bold;
          box-shadow: 0 10px 30px rgba(255, 107, 157, 0.4);
          animation: glow 2s infinite;
        " onmouseover="this.style.transform='scale(1.1) translateY(-5px)'" onmouseout="this.style.transform='scale(1)'">
          ğŸ  Oda OluÅŸtur
        </button>
        <button id="join-room-btn" style="
          padding: 20px 50px;
          font-size: 24px;
          background: linear-gradient(135deg, #667eea, #764ba2);
          color: white;
          border: none;
          border-radius: 50px;
          cursor: pointer;
          transition: all 0.3s;
          font-weight: bold;
          box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        " onmouseover="this.style.transform='scale(1.1) translateY(-5px)'" onmouseout="this.style.transform='scale(1)'">
          ğŸšª Odaya KatÄ±l
        </button>
      </div>

      <div id="join-input" style="display: none; margin-top: 30px;">
        <input type="text" id="room-code-input" placeholder="ODA KODU GÄ°R" maxlength="6" style="
          padding: 20px 30px;
          font-size: 28px;
          border: none;
          border-radius: 50px;
          text-align: center;
          background: rgba(255,255,255,0.95);
          color: #667eea;
          font-weight: bold;
          letter-spacing: 8px;
          box-shadow: 0 5px 20px rgba(0,0,0,0.2);
          width: 300px;
          margin-bottom: 20px;
        ">
        <br>
        <button id="join-submit-btn" style="
          padding: 15px 60px;
          font-size: 22px;
          background: linear-gradient(135deg, #667eea, #764ba2);
          color: white;
          border: none;
          border-radius: 50px;
          cursor: pointer;
          transition: all 0.3s;
          font-weight: bold;
          box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        " onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
          âœ¨ KatÄ±l
        </button>
      </div>

      <div id="room-display" style="display: none; margin-top: 30px;">
        <h3 style="color: white; font-size: 28px; margin-bottom: 15px; text-shadow: 1px 1px 10px rgba(0,0,0,0.2);">
          ğŸ‰ Oda Kodun:
        </h3>
        <div id="room-code-text" style="
          font-size: 48px;
          font-weight: bold;
          color: #FFD700;
          background: rgba(0,0,0,0.3);
          padding: 20px 40px;
          border-radius: 20px;
          letter-spacing: 12px;
          text-shadow: 2px 2px 15px rgba(0,0,0,0.5);
          box-shadow: 0 5px 25px rgba(255, 215, 0, 0.3);
          margin-bottom: 20px;
        "></div>
        <p style="color: rgba(255,255,255,0.95); font-size: 20px; text-shadow: 1px 1px 10px rgba(0,0,0,0.2); animation: titlePulse 2s infinite;">
          ğŸ’– Sevgilinin katÄ±lmasÄ±nÄ± bekliyorsun... ğŸ’–
        </p>
      </div>

      <div id="error-msg" style="
        margin-top: 20px;
        padding: 15px 30px;
        background: rgba(255, 59, 48, 0.9);
        color: white;
        border-radius: 15px;
        font-size: 18px;
        display: none;
        box-shadow: 0 5px 20px rgba(255, 59, 48, 0.4);
      "></div>
    </div>
  </div>

  <!-- Character Selection Screen - GÃœZELLEÅTÄ°RÄ°LMÄ°Å -->
  <div id="character-screen" style="
    position: fixed;
    width: 100vw;
    height: 100vh;
    background: linear-gradient(135deg, #a8edea 0%, #fed6e3 50%, #ffd1ff 100%);
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    overflow: hidden;
  ">
    <!-- YÄ±ldÄ±zlar arka plan -->
    <div style="position: absolute; width: 100%; height: 100%; overflow: hidden; opacity: 0.2;">
      <div style="position: absolute; left: 10%; top: 10%; font-size: 40px; animation: twinkle 3s infinite;">â­</div>
      <div style="position: absolute; left: 80%; top: 15%; font-size: 30px; animation: twinkle 4s infinite; animation-delay: 1s;">âœ¨</div>
      <div style="position: absolute; left: 20%; top: 80%; font-size: 35px; animation: twinkle 3.5s infinite; animation-delay: 2s;">ğŸŒŸ</div>
      <div style="position: absolute; left: 70%; top: 75%; font-size: 25px; animation: twinkle 5s infinite; animation-delay: 0.5s;">ğŸ’«</div>
      <div style="position: absolute; left: 50%; top: 5%; font-size: 45px; animation: twinkle 4.5s infinite; animation-delay: 1.5s;">â­</div>
      <div style="position: absolute; left: 90%; top: 50%; font-size: 30px; animation: twinkle 3s infinite; animation-delay: 2.5s;">âœ¨</div>
    </div>
    
    <style>
      @keyframes twinkle {
        0%, 100% { opacity: 0.3; transform: scale(1); }
        50% { opacity: 1; transform: scale(1.3); }
      }
      
      @keyframes float3d {
        0%, 100% { transform: translateY(0px) rotateY(0deg); }
        50% { transform: translateY(-20px) rotateY(10deg); }
      }
      
      .character-card {
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        cursor: pointer;
      }
      
      .character-card:hover {
        transform: scale(1.15) translateY(-15px) rotateY(5deg);
        filter: brightness(1.2);
      }
      
      .character-card:active {
        transform: scale(1.05);
      }
    </style>
    
    <!-- Ana iÃ§erik -->
    <div style="position: relative; z-index: 1; text-align: center;">
      <h1 style="
        font-size: 56px;
        margin-bottom: 30px;
        color: white;
        text-shadow: 3px 3px 20px rgba(0,0,0,0.3);
        animation: titlePulse 2.5s infinite;
        font-family: 'Arial Black', sans-serif;
      ">âœ¨ Karakterini SeÃ§ âœ¨</h1>
      
      <p style="color: rgba(255,255,255,0.95); font-size: 24px; margin-bottom: 60px; text-shadow: 1px 1px 10px rgba(0,0,0,0.2);">
        Kim olarak aÅŸk mÃ¼zemizi keÅŸfedeceksin? ğŸ’•
      </p>
    
      <div style="display: flex; gap: 80px; justify-content: center; align-items: center;">
        <!-- Batuhan Character -->
        <div class="character-card" id="select-batuhan">
          <div style="
            width: 280px;
            height: 380px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 20px 60px rgba(102, 126, 234, 0.5);
            border: 5px solid rgba(255,255,255,0.3);
            position: relative;
            overflow: hidden;
            animation: float3d 4s ease-in-out infinite;
          ">
            <!-- Parlama efekti -->
            <div style="
              position: absolute;
              top: -50%;
              left: -50%;
              width: 200%;
              height: 200%;
              background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
              animation: shine 3s infinite;
            "></div>
            
            <div style="font-size: 140px; margin-bottom: 20px; filter: drop-shadow(0 10px 20px rgba(0,0,0,0.3)); animation: float3d 3s ease-in-out infinite;">ğŸ§‘</div>
            <h2 style="color: white; font-size: 42px; margin: 0; text-shadow: 2px 2px 15px rgba(0,0,0,0.4); font-family: 'Arial Black', sans-serif;">Batuhan</h2>
            <p style="color: rgba(255,255,255,0.9); font-size: 20px; margin-top: 15px; text-shadow: 1px 1px 10px rgba(0,0,0,0.3);">ğŸ–¤ Siyah SaÃ§</p>
            <div style="margin-top: 20px; background: rgba(255,255,255,0.2); padding: 10px 25px; border-radius: 20px;">
              <span style="color: white; font-size: 16px;">ğŸ‘” Erkek Karakteri</span>
            </div>
          </div>
        </div>

        <!-- Merve Character -->
        <div class="character-card" id="select-merve">
          <div style="
            width: 280px;
            height: 380px;
            background: linear-gradient(135deg, #ff6b9d 0%, #c44569 100%);
            border-radius: 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 20px 60px rgba(255, 107, 157, 0.5);
            border: 5px solid rgba(255,255,255,0.3);
            position: relative;
            overflow: hidden;
            animation: float3d 4s ease-in-out infinite;
            animation-delay: 0.5s;
          ">
            <!-- Parlama efekti -->
            <div style="
              position: absolute;
              top: -50%;
              left: -50%;
              width: 200%;
              height: 200%;
              background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
              animation: shine 3s infinite;
              animation-delay: 0.5s;
            "></div>
            
            <div style="font-size: 140px; margin-bottom: 20px; filter: drop-shadow(0 10px 20px rgba(0,0,0,0.3)); animation: float3d 3s ease-in-out infinite; animation-delay: 0.5s;">ğŸ‘§</div>
            <h2 style="color: white; font-size: 42px; margin: 0; text-shadow: 2px 2px 15px rgba(0,0,0,0.4); font-family: 'Arial Black', sans-serif;">Merve</h2>
            <p style="color: rgba(255,255,255,0.9); font-size: 20px; margin-top: 15px; text-shadow: 1px 1px 10px rgba(0,0,0,0.3);">ğŸ¤ Kahverengi SaÃ§</p>
            <div style="margin-top: 20px; background: rgba(255,255,255,0.2); padding: 10px 25px; border-radius: 20px;">
              <span style="color: white; font-size: 16px;">ğŸ‘— KadÄ±n Karakteri</span>
            </div>
          </div>
        </div>
      </div>

      <p style="
        color: white;
        font-size: 22px;
        margin-top: 70px;
        text-align: center;
        text-shadow: 2px 2px 15px rgba(0,0,0,0.3);
        background: rgba(255,255,255,0.15);
        padding: 20px 40px;
        border-radius: 25px;
        backdrop-filter: blur(10px);
        display: inline-block;
      ">
        ğŸ’ Karakterini seÃ§ ve birlikte aÅŸk mÃ¼zemizi keÅŸfedelim! ğŸ’
      </p>
    </div>
    
    <style>
      @keyframes shine {
        0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
        100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
      }
    </style>
  </div>

  <!-- Game Container -->
  <div id="game-container">
    <div class="hud">
      <h1>AÅŸkÄ±mÄ±zÄ±n MÃ¼zesi â¤ï¸</h1>
      <p>Mutlu Sevgililer GÃ¼nÃ¼, CanÄ±m! ğŸ’•</p>
    </div>

    <!-- Speed Adjustment HUD -->
    <div class="controls">
      <h3>Kontroller ğŸ®</h3>
      <p><strong>W A S D</strong> - Hareket Et</p>
      <p><strong>SHIFT</strong> - KoÅŸ ğŸƒâ€â™€ï¸</p>
      <p><strong>Fare</strong> - Kamera DÃ¶ndÃ¼r (Ekrana tÄ±kla)</p>
      <p><strong>SPACE</strong> - ZÄ±pla</p>
      <p><strong>Q</strong> - Dans SeÃ§ ğŸ’ƒ</p>
      <p><strong>E</strong> - MesajÄ± Oku / KapÄ±ya Gir</p>
      <p><strong>M</strong> - MÃ¼zik AÃ§/Kapat ğŸµ</p>
      <p><strong>TÄ±kla</strong> - FotoÄŸrafa YakÄ±ndan Bak</p>
      <p><strong>ESC</strong> - Fareyi Serbest BÄ±rak</p>
    </div>

    <!-- Background Music -->
    <audio id="background-music" loop>
      <source src="music/piano.mp3" type="audio/mpeg">
    </audio>

    <div class="partner-status">
      <h4>Partner Durumu:</h4>
      <p class="status waiting" id="partner-status">Bekleniyor...</p>
    </div>

    <div class="message-indicator" id="message-indicator">
      ğŸ’Œ E tuÅŸuna bas ve mesajÄ± oku!
    </div>

    <div class="message-popup" id="message-popup">
      <div class="message-content">
        <div class="icon">ğŸ’•</div>
        <p id="message-text"></p>
        <p class="close-hint">(Kapatmak iÃ§in tÄ±kla)</p>
      </div>
    </div>

    <div class="photo-popup" id="photo-popup">
      <div class="photo-content">
        <div class="photo-frame" id="photo-frame">
          <div>ğŸ“· FotoÄŸraf #<span id="photo-number"></span></div>
          <div class="hint">(Kendi fotoÄŸrafÄ±nÄ± buraya ekleyebilirsin)</div>
        </div>
        <p style="text-align: center; margin-top: 20px; color: #666; font-size: 14px;">
          Kapatmak iÃ§in tÄ±kla
        </p>
      </div>
    </div>

    <!-- Password Popup for Museum Door -->
    <div id="password-popup" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.8); z-index: 2000; align-items: center; justify-content: center;">
      <div style="background: linear-gradient(135deg, #ff69b4, #ffb6c1); padding: 50px; border-radius: 30px; max-width: 600px; text-align: center; box-shadow: 0 20px 60px rgba(255, 105, 180, 0.6);">
        <div style="font-size: 60px; margin-bottom: 20px;">ğŸ”</div>
        <h2 style="color: white; font-size: 32px; margin: 0 0 30px 0;">MÃ¼ze GiriÅŸi</h2>
        <p style="color: white; font-size: 24px; margin-bottom: 30px;">KocanÄ±n adÄ± ne?</p>
        <input type="text" id="password-input" placeholder="Cevap..." style="padding: 15px 30px; font-size: 24px; border: 3px solid white; border-radius: 15px; width: 80%; text-align: center; margin-bottom: 20px;" onkeypress="if(event.key==='Enter') checkPassword()">
        <div style="display: flex; gap: 20px; justify-content: center; margin-top: 20px;">
          <button onclick="checkPassword()" style="padding: 15px 40px; font-size: 20px; background: white; color: #ff1493; border: none; border-radius: 50px; cursor: pointer; font-weight: bold;">GiriÅŸ Yap</button>
          <button onclick="closePasswordPopup()" style="padding: 15px 40px; font-size: 20px; background: rgba(255,255,255,0.3); color: white; border: none; border-radius: 50px; cursor: pointer; font-weight: bold;">Ä°ptal</button>
        </div>
        <p id="password-error" style="color: #ffeeee; margin-top: 20px; font-size: 18px; display: none;"></p>
      </div>
    </div>

    <!-- DANS SEÃ‡Ä°M MENÃœSÃœ -->
    <div id="dance-menu" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.8); z-index: 2000; align-items: center; justify-content: center;">
      <div style="background: linear-gradient(135deg, rgba(255, 105, 180, 0.98), rgba(255, 182, 193, 0.98)); padding: 40px; border-radius: 25px; box-shadow: 0 10px 40px rgba(0,0,0,0.4); backdrop-filter: blur(10px);">
        <h2 style="color: white; text-align: center; margin-bottom: 25px; font-size: 36px; text-shadow: 2px 2px 4px rgba(0,0,0,0.2);">ğŸ’ƒ Dans SeÃ§ ğŸ•º</h2>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
          <button onclick="selectDance(1)" style="padding: 25px; font-size: 22px; background: white; border: 3px solid #ff69b4; border-radius: 15px; cursor: pointer; transition: all 0.3s; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.2);" onmouseover="this.style.background='#ff69b4'; this.style.color='white'; this.style.transform='scale(1.05)';" onmouseout="this.style.background='white'; this.style.color='black'; this.style.transform='scale(1)';">
            ğŸµ Dans 1
          </button>
          <button onclick="selectDance(2)" style="padding: 25px; font-size: 22px; background: white; border: 3px solid #ff69b4; border-radius: 15px; cursor: pointer; transition: all 0.3s; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.2);" onmouseover="this.style.background='#ff69b4'; this.style.color='white'; this.style.transform='scale(1.05)';" onmouseout="this.style.background='white'; this.style.color='black'; this.style.transform='scale(1)';">
            ğŸ’ƒ Dans 2
          </button>
          <button onclick="selectDance(3)" style="padding: 25px; font-size: 22px; background: white; border: 3px solid #ff69b4; border-radius: 15px; cursor: pointer; transition: all 0.3s; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.2);" onmouseover="this.style.background='#ff69b4'; this.style.color='white'; this.style.transform='scale(1.05)';" onmouseout="this.style.background='white'; this.style.color='black'; this.style.transform='scale(1)';">
            ğŸ•º Dans 3
          </button>
          <button onclick="selectDance(4)" style="padding: 25px; font-size: 22px; background: white; border: 3px solid #ff69b4; border-radius: 15px; cursor: pointer; transition: all 0.3s; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.2);" onmouseover="this.style.background='#ff69b4'; this.style.color='white'; this.style.transform='scale(1.05)';" onmouseout="this.style.background='white'; this.style.color='black'; this.style.transform='scale(1)';">
            ğŸ‰ Dans 4
          </button>
        </div>
        <button onclick="closeDanceMenu()" style="padding: 18px; width: 100%; font-size: 20px; background: rgba(255,255,255,0.3); border: 2px solid white; border-radius: 12px; color: white; cursor: pointer; font-weight: bold; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.5)';" onmouseout="this.style.background='rgba(255,255,255,0.3)';">
          âŒ Ä°ptal
        </button>
      </div>
    </div>
  </div>

  <script>
    // YÃœKLEME EKRANI KONTROLCÃœSÃœ
    const loadingManager = {
      total: 0,
      loaded: 0,
      messages: [
        "Kalbine baÄŸlanÄ±lÄ±yorâ€¦ LÃ¼tfen bekleyin ğŸ’˜",
        "Birlikte sonsuz level'a geÃ§iliyorâ€¦",
        "SarÄ±lma DLC'si yÃ¼kleniyorâ€¦",
        "Sana aÅŸÄ±rÄ± dÃ¼ÅŸme hatasÄ± algÄ±landÄ±! (Ã§Ã¶zÃ¼m aranmÄ±yor)",
        "AÅŸk XP'si kazanÄ±lÄ±yorâ€¦",
        "KÄ±skanma modu kapatÄ±ldÄ±. (belki ğŸ˜)",
        "GÃ¼lÃ¼ÅŸÃ¼n sisteme entegre edildi âœ”",
        "Seni sevmek varsayÄ±lan ayar olarak seÃ§ildi âœ”",
        "Sevgi barÄ± fullendi â¤ï¸",
        "Seni gÃ¶rÃ¼nce sistem Ä±sÄ±nÄ±yorâ€¦",
        "Sana bakÄ±nca utangaÃ§lÄ±k modu aÃ§Ä±lÄ±yorâ€¦",
        "Kalp Ã§arpÄ±ntÄ±sÄ± gÃ¼ncellemesi indiriliyorâ€¦"
      ],
      currentMessageIndex: 0,
      
      init() {
        this.updateMessage();
        setInterval(() => this.updateMessage(), 4000); // Her 4 saniyede bir mesaj deÄŸiÅŸtir
      },
      
      updateMessage() {
        const msgElement = document.getElementById('loading-messages');
        if (msgElement) {
          msgElement.style.animation = 'none';
          setTimeout(() => {
            msgElement.textContent = this.messages[this.currentMessageIndex];
            msgElement.style.animation = 'fadeIn 1s';
            this.currentMessageIndex = (this.currentMessageIndex + 1) % this.messages.length;
          }, 50);
        }
      },
      
      addItem(name) {
        this.total++;
        const itemsElement = document.getElementById('loading-items');
        if (itemsElement) {
          const item = document.createElement('div');
          item.id = `loading-item-${this.total}`;
          item.textContent = `â³ ${name}...`;
          item.style.opacity = '0';
          item.style.transition = 'opacity 0.5s';
          itemsElement.appendChild(item);
          setTimeout(() => item.style.opacity = '1', 10);
        }
      },
      
      completeItem(name) {
        this.loaded++;
        const percentage = Math.round((this.loaded / this.total) * 100);
        // GerÃ§ek yÃ¼kleme sahte ilerlemeden bÃ¼yÃ¼kse gÃ¼ncelle
        const displayPercent = Math.max(percentage, Math.round(this._fakeProgress || 0));
        
        // Update bar
        const bar = document.getElementById('loading-bar');
        if (bar) bar.style.width = displayPercent + '%';
        
        // Update percentage
        const perc = document.getElementById('loading-percentage');
        if (perc) perc.textContent = displayPercent + '%';
        
        // Mark item complete
        const itemsElement = document.getElementById('loading-items');
        if (itemsElement) {
          const items = itemsElement.children;
          for (let item of items) {
            if (item.textContent.includes(name)) {
              item.textContent = `âœ… ${name}`;
              item.style.color = '#4ade80';
            }
          }
        }
        
        // TÃ¼mÃ¼ yÃ¼klendiyse ekranÄ± kapat
        if (this.loaded >= this.total && this.total > 0) {
          if (this._fakeInterval) clearInterval(this._fakeInterval);
          setTimeout(() => this.hide(), 500);
        }
      },
      
      show() {
        const screen = document.getElementById('loading-screen');
        if (screen) {
          screen.style.display = 'flex';
          screen.style.opacity = '1';
        }
        
        // Sahte Ã¶n ilerleme: 0% â†’ 40% (dosyalar yÃ¼klenene kadar oyalar)
        this._fakeProgress = 0;
        this._fakeInterval = setInterval(() => {
          if (this._fakeProgress < 40) {
            this._fakeProgress += 0.15; // Ã‡ok yavaÅŸ ilerle
            const realPercent = this.total > 0 ? Math.round((this.loaded / this.total) * 100) : 0;
            if (realPercent < this._fakeProgress) {
              const bar = document.getElementById('loading-bar');
              if (bar) bar.style.width = this._fakeProgress + '%';
              const perc = document.getElementById('loading-percentage');
              if (perc) perc.textContent = Math.round(this._fakeProgress) + '%';
            }
          } else {
            clearInterval(this._fakeInterval);
          }
        }, 120); // 120ms Ã— ~267 adÄ±m = ~32 saniyede %40'a ulaÅŸÄ±r
      },
      
      hide() {
        const screen = document.getElementById('loading-screen');
        if (screen) {
          screen.style.transition = 'opacity 1s';
          screen.style.opacity = '0';
          setTimeout(() => {
            screen.style.display = 'none';
          }, 1000);
        }
      }
    };
    
    // YÃ¼kleme ekranÄ±nÄ± baÅŸlat
    loadingManager.init();
    
    // Socket.io connection
    const socket = io();
    
    let scene, camera, renderer;
    let playerGroup, partnerGroup;
    let mixer, partnerMixer;
    let clock = new THREE.Clock();
    let keys = {};
    let mouseX = 0;
    let mouseY = 0;
    let yaw = 0;
    let pitch = 0.3; // Kamera aÃ§Ä±sÄ± (yukarÄ±/aÅŸaÄŸÄ±)
    let isHost = false;
    let roomCode = '';
    let partnerConnected = false;
    let photoFrames = [];
    let messages = [];
    let nearMessage = null;
    let selectedCharacter = null;
    let pendingAction = null; // 'create' or 'join'
    let selectedDance = 0; // 0 = dans yok, 1-4 = dans numarasÄ±
    let currentDanceAction = null; // Åu an Ã§alan dans animasyonu

    let moveSpeed = 0.1; // YÃ¼rÃ¼me hÄ±zÄ±

    // Socket events
    socket.on('room_created', (data) => {
      roomCode = data.roomCode;
      isHost = data.isHost;
      document.getElementById('room-code-text').textContent = roomCode;
      document.getElementById('room-display').style.display = 'block';
    });

    socket.on('room_joined', (data) => {
      roomCode = data.roomCode;
      isHost = data.isHost;
      partnerConnected = true;
      
      // Partner status gÃ¼ncelle (misafir odaya girince host zaten orada)
      const statusEl = document.getElementById('partner-status');
      if (statusEl) {
        statusEl.textContent = 'BaÄŸlandÄ± ğŸ’‘';
        statusEl.classList.remove('waiting');
        statusEl.classList.add('connected');
      }
      
      // Menu ekranÄ±nÄ± gizle, karakter seÃ§im ekranÄ±nÄ± gÃ¶ster
      document.getElementById('menu-screen').style.display = 'none';
      document.getElementById('character-screen').style.display = 'flex';
    });

    socket.on('partner_joined', () => {
      partnerConnected = true;
      console.log('ğŸ’‘ Partner katÄ±ldÄ±!');
      
      // Partner status gÃ¼ncelle
      const statusEl = document.getElementById('partner-status');
      if (statusEl) {
        statusEl.textContent = 'BaÄŸlandÄ± ğŸ’‘';
        statusEl.classList.remove('waiting');
        statusEl.classList.add('connected');
      }
      
      // Make partner visible immediately
      if (partnerGroup) {
        partnerGroup.visible = true;
      }
      
      // If we're waiting, show character selection
      if (!selectedCharacter) {
        document.getElementById('menu-screen').style.display = 'none';
        document.getElementById('character-screen').style.display = 'flex';
      }
    });

    socket.on('partner_moved', (data) => {
      if (partnerGroup) {
        partnerGroup.position.set(data.position.x, data.position.y, data.position.z);
        partnerGroup.rotation.y = data.rotation;
        
        // ANÄ°MASYON SENKRONÄ°ZASYONU
        if (data.animation && partnerGroup.userData) {
          const partnerWalk = partnerGroup.userData.walkAction;
          const partnerRun = partnerGroup.userData.runAction;
          const partnerIdle = partnerGroup.userData.idleAction;
          const partnerDance1 = partnerGroup.userData.danceAction1;
          const partnerDance2 = partnerGroup.userData.danceAction2;
          const partnerDance3 = partnerGroup.userData.danceAction3;
          const partnerDance4 = partnerGroup.userData.danceAction4;
          
          // TÃ¼m animasyonlarÄ± gizle
          if (partnerWalk) partnerWalk.setEffectiveWeight(0);
          if (partnerRun) partnerRun.setEffectiveWeight(0);
          if (partnerIdle) partnerIdle.setEffectiveWeight(0);
          if (partnerDance1) partnerDance1.setEffectiveWeight(0);
          if (partnerDance2) partnerDance2.setEffectiveWeight(0);
          if (partnerDance3) partnerDance3.setEffectiveWeight(0);
          if (partnerDance4) partnerDance4.setEffectiveWeight(0);
          
          // Ä°lgili animasyonu gÃ¶ster
          if (data.animation === 'walk' && partnerWalk) {
            partnerWalk.setEffectiveWeight(1);
          } else if (data.animation === 'run' && partnerRun) {
            partnerRun.setEffectiveWeight(1);
          } else if (data.animation === 'idle' && partnerIdle) {
            partnerIdle.setEffectiveWeight(1);
          } else if (data.animation === 'dance1' && partnerDance1) {
            partnerDance1.setEffectiveWeight(1);
          } else if (data.animation === 'dance2' && partnerDance2) {
            partnerDance2.setEffectiveWeight(1);
          } else if (data.animation === 'dance3' && partnerDance3) {
            partnerDance3.setEffectiveWeight(1);
          } else if (data.animation === 'dance4' && partnerDance4) {
            partnerDance4.setEffectiveWeight(1);
          }
          
          if (data.animation && data.animation.startsWith('dance')) {
            const partnerFbx = partnerGroup.userData.fbxModel;
            if (partnerFbx) { partnerFbx.position.x = 0; partnerFbx.position.z = 0; }
          }
        }
        
        // Make sure partner is visible
        if (!partnerGroup.visible && partnerConnected) {
          partnerGroup.visible = true;
        }
      }
    });

    socket.on('partner_disconnected', () => {
      partnerConnected = false;
      document.getElementById('partner-status').textContent = 'AyrÄ±ldÄ± ğŸ’”';
      document.getElementById('partner-status').classList.remove('connected');
      document.getElementById('partner-status').classList.add('waiting');
      if (partnerGroup) {
        partnerGroup.visible = false;
      }
    });

    socket.on('error', (data) => {
      showError(data.message);
    });

    // Menu functions
    function createRoom() {
      console.log('ğŸ  Oda oluÅŸturuluyor...');
      pendingAction = 'create';
      socket.emit('create_room');
    }

    function showJoinInput() {
      console.log('ğŸšª KatÄ±lma ekranÄ± aÃ§Ä±lÄ±yor...');
      document.getElementById('join-input').style.display = 'block';
      document.getElementById('room-code-input').focus();
    }

    function joinRoom() {
      const code = document.getElementById('room-code-input').value.toUpperCase();
      console.log('ğŸ”‘ Odaya katÄ±lmaya Ã§alÄ±ÅŸÄ±yor:', code);
      if (code.length === 6) {
        pendingAction = 'join';
        socket.emit('join_room', code);
      } else {
        showError('GeÃ§ersiz oda kodu!');
      }
    }

    function selectCharacter(character) {
      console.log('ğŸ‘¤ Karakter seÃ§ildi:', character);
      selectedCharacter = character;
      startGame();
    }

    function showError(message) {
      const errorEl = document.getElementById('error-msg');
      errorEl.textContent = message;
      errorEl.style.display = 'block';
      setTimeout(() => {
        errorEl.style.display = 'none';
      }, 3000);
    }

    function checkPassword() {
      const input = document.getElementById('password-input').value.toLowerCase().trim();
      const errorEl = document.getElementById('password-error');
      
      if (input === 'batuhan') {
        // DoÄŸru ÅŸifre!
        closePasswordPopup();
        enterMuseum();
      } else {
        // YanlÄ±ÅŸ ÅŸifre
        errorEl.textContent = 'âŒ YanlÄ±ÅŸ cevap! Tekrar dene.';
        errorEl.style.display = 'block';
        document.getElementById('password-input').value = '';
        setTimeout(() => {
          errorEl.style.display = 'none';
        }, 2000);
      }
    }

    function closePasswordPopup() {
      document.getElementById('password-popup').style.display = 'none';
      document.getElementById('password-input').value = '';
      document.getElementById('password-error').style.display = 'none';
      window.popupOpen = false;
      if (renderer && renderer.domElement) {
        setTimeout(() => renderer.domElement.requestPointerLock(), 100);
      }
    }

    // Global fonksiyonlar - HTML onclick iÃ§in
    window.checkPassword = checkPassword;
    window.closePasswordPopup = closePasswordPopup;
    
    // DANS SEÃ‡Ä°M FONKSÄ°YONLARI
    window.selectDance = function(danceNumber) {
      selectedDance = danceNumber;
      document.getElementById('dance-menu').style.display = 'none';
      console.log('ğŸ’ƒ Dans seÃ§ildi:', danceNumber);
      
      // Pointer lock'u geri al
      if (document.pointerLockElement === null && renderer && renderer.domElement) {
        renderer.domElement.requestPointerLock();
      }
    };
    
    window.closeDanceMenu = function() {
      selectedDance = 0; // Dans kapalÄ±
      document.getElementById('dance-menu').style.display = 'none';
      console.log('âŒ Dans iptal edildi');
      
      // Pointer lock'u geri al
      if (document.pointerLockElement === null && renderer && renderer.domElement) {
        renderer.domElement.requestPointerLock();
      }
    };

    function enterMuseum() {
      window.insideMuseum = true;
      // KAPIYA DOKUNMA - Her zaman fiziksel olarak kilitli kalÄ±r
      // window.museumDoor.userData.locked = false; // BU SATIR KALDIRILD!
      window.museumInterior.visible = true;
      
      // DÄ±ÅŸ dÃ¼nyayÄ± tamamen gizle
      scene.children.forEach(child => {
        if (child !== window.museumInterior && child !== playerGroup && child !== partnerGroup) {
          child.visible = false;
        }
      });
      
      scene.background = new THREE.Color(0xfff0e8);
      scene.fog = null;
      
      // Karakteri iÃ§eriye Ä±ÅŸÄ±nla - kapÄ±dan biraz iÃ§eride
      playerGroup.position.set(0, 0, 14);
      yaw = Math.PI; // Ä°Ã§eriye baksÄ±n
      
      window.popupOpen = false;
      setTimeout(() => {
        if (renderer && renderer.domElement) renderer.domElement.requestPointerLock();
      }, 200);
      
      console.log('MÃ¼zeye hoÅŸ geldiniz!');
    }
    
    function exitMuseum() {
      window.insideMuseum = false;
      window.museumInterior.visible = false;
      
      // DÄ±ÅŸ dÃ¼nyayÄ± geri gÃ¶ster
      scene.children.forEach(child => {
        if (child !== window.museumInterior) {
          child.visible = true;
        }
      });
      
      // GÃ¶kyÃ¼zÃ¼ rengini geri al
      scene.background = null;
      scene.fog = new THREE.FogExp2(0xaad4f0, 0.006);
      
      // Karakteri dÄ±ÅŸarÄ±ya Ä±ÅŸÄ±nla - mÃ¼ze kapÄ±sÄ± Ã¶nÃ¼ne
      playerGroup.position.set(0, 0, 24);
      yaw = 0; // DÄ±ÅŸarÄ±ya baksÄ±n
      
      window.eKeyUsed = false;
      setTimeout(() => {
        if (renderer && renderer.domElement) renderer.domElement.requestPointerLock();
      }, 200);
      
      console.log('MÃ¼zeden Ã§Ä±kÄ±ldÄ±!');
    }
    
    window.exitMuseum = exitMuseum;

    function startGame() {
      if (!selectedCharacter) return;
      
      // MenÃ¼ ve karakter ekranlarÄ±nÄ± gizle
      document.getElementById('menu-screen').style.display = 'none';
      document.getElementById('character-screen').style.display = 'none';
      
      // YÃœKLEME EKRANINI GÃ–STER
      loadingManager.show();
      
      // KÄ±sa bir sÃ¼re sonra yÃ¼klemeyi baÅŸlat (ekran gÃ¶rÃ¼nsÃ¼n diye)
      setTimeout(() => {
        const gameContainer = document.getElementById('game-container');
        gameContainer.style.display = 'block';
        initThreeJS();
      }, 100);
      
      // MÃ¼ziÄŸi baÅŸlatmayÄ± dene (kullanÄ±cÄ± etkileÅŸimi sonrasÄ±)
      setTimeout(() => {
        const music = document.getElementById('background-music');
        music.volume = 0.3; // Ses seviyesi %30
        music.play().catch(e => {
          console.log('MÃ¼zik baÅŸlatÄ±lamadÄ±. M tuÅŸuna basarak baÅŸlatabilirsiniz.');
        });
      }, 500);
    }

    // Three.js setup
    function initThreeJS() {
      const container = document.getElementById('game-container');
      
      scene = new THREE.Scene();
      
      // GÃœZEL SKYBOX - AltÄ±n saatli yumuÅŸak gÃ¶kyÃ¼zÃ¼
      const skyGeo = new THREE.SphereGeometry(500, 32, 15);
      const skyMat = new THREE.ShaderMaterial({
        uniforms: {
          topColor:    { value: new THREE.Color(0x4488ff) },
          midColor:    { value: new THREE.Color(0x88ccff) },
          bottomColor: { value: new THREE.Color(0xffd6a0) },
          offset: { value: 33 },
          exponent: { value: 0.5 }
        },
        vertexShader: `
          varying vec3 vWorldPosition;
          void main() {
            vec4 worldPosition = modelMatrix * vec4(position, 1.0);
            vWorldPosition = worldPosition.xyz;
            gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
          }
        `,
        fragmentShader: `
          uniform vec3 topColor;
          uniform vec3 midColor;
          uniform vec3 bottomColor;
          uniform float offset;
          uniform float exponent;
          varying vec3 vWorldPosition;
          void main() {
            float h = normalize(vWorldPosition + offset).y;
            vec3 col = h > 0.1 ? mix(midColor, topColor, pow(max(h-0.1, 0.0)*1.11, exponent)) 
                               : mix(bottomColor, midColor, max(h + 0.1, 0.0) * 10.0);
            gl_FragColor = vec4(col, 1.0);
          }
        `,
        side: THREE.BackSide
      });
      const sky = new THREE.Mesh(skyGeo, skyMat);
      scene.add(sky);
      
      scene.fog = new THREE.FogExp2(0xaad4f0, 0.006); // Hafif sis efekti

      camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
      camera.position.set(0, 2, 15); // DÄ±ÅŸarÄ±da baÅŸla

      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.shadowMap.enabled = true;
      renderer.shadowMap.type = THREE.PCFSoftShadowMap;
      container.appendChild(renderer.domElement);

      // Lighting - GÃœNEÅ IÅIÄI (daha yumuÅŸak)
      const ambientLight = new THREE.AmbientLight(0xffffff, 0.6); // Biraz daha parlak
      scene.add(ambientLight);

      const sunLight = new THREE.DirectionalLight(0xffffff, 1.0); // Daha az yoÄŸun, beyaz Ä±ÅŸÄ±k
      sunLight.position.set(30, 50, 30);
      sunLight.castShadow = true;
      sunLight.shadow.mapSize.width = 4096;
      sunLight.shadow.mapSize.height = 4096;
      sunLight.shadow.camera.left = -60;
      sunLight.shadow.camera.right = 60;
      sunLight.shadow.camera.top = 60;
      sunLight.shadow.camera.bottom = -60;
      sunLight.shadow.camera.far = 200;
      scene.add(sunLight);

      // ZENGÄ°N Ã‡Ä°MEN ZEMÄ°N - Ã§ok katmanlÄ±
      const groundGeo = new THREE.PlaneGeometry(300, 300, 30, 30);
      // Hafif renk varyasyonu iÃ§in vertex colors
      const groundMat = new THREE.MeshStandardMaterial({ 
        color: 0x4a7c2a,
        roughness: 0.85,
        metalness: 0.0
      });
      const ground = new THREE.Mesh(groundGeo, groundMat);
      ground.rotation.x = -Math.PI / 2;
      ground.receiveShadow = true;
      scene.add(ground);
      
      // Zemin renk katmanlarÄ± (yol izleri gibi)
      const darkPatch = new THREE.MeshStandardMaterial({ color: 0x3d6820, roughness: 0.9 });
      const lightPatch = new THREE.MeshStandardMaterial({ color: 0x5d8f35, roughness: 0.8 });
      // Rastgele zemin lekeleri
      for (let i = 0; i < 40; i++) {
        const w = 4 + Math.random() * 12;
        const h = 3 + Math.random() * 9;
        const patch = new THREE.Mesh(new THREE.PlaneGeometry(w, h), i%2===0 ? darkPatch : lightPatch);
        patch.rotation.x = -Math.PI/2;
        const angle = Math.random() * Math.PI;
        const dist = 15 + Math.random() * 60;
        patch.position.set(Math.cos(angle)*dist, 0.005, Math.sin(angle)*dist);
        patch.rotation.z = Math.random() * Math.PI;
        scene.add(patch);
      }

      // ========================================
      // ğŸŒ¿ KENNEY NATURE KIT - TASARLI DÃœNYA
      // ========================================
      const gltfLoader = new THREE.GLTFLoader();
      
      function placeModel(name, x, y, z, scale, rotY) {
        gltfLoader.load(`/models/${name}.glb`,
          function(gltf) {
            const obj = gltf.scene;
            obj.position.set(x, y, z);
            obj.scale.setScalar(scale || 1);
            obj.rotation.y = rotY || 0;
            obj.traverse(c => { if (c.isMesh) { c.castShadow = true; c.receiveShadow = true; } });
            scene.add(obj);
          }, undefined, () => {}
        );
      }
      
      function scatterModels(names, count, xRange, zRange, minScale, maxScale) {
        for (let i = 0; i < count; i++) {
          const name = names[Math.floor(Math.random() * names.length)];
          let x = (Math.random() - 0.5) * xRange;
          let z = (Math.random() - 0.5) * zRange;
          if (Math.abs(x) < 24 && z > -40 && z < 14) x += x > 0 ? 28 : -28;
          const s = minScale + Math.random() * (maxScale - minScale);
          placeModel(name, x, 0, z, s, Math.random() * Math.PI * 2);
        }
      }

      // â”€â”€ AÄAÃ‡LAR â”€â”€
      const oakTrees = ['tree_oak', 'tree_detailed', 'tree_default'];
      const pineTrees = ['tree_pineRoundA', 'tree_pineRoundB', 'tree_pineTallA'];
      const smallTrees = ['tree_simple', 'tree_small', 'tree_fat', 'tree_tall'];
      const allTrees = [...oakTrees, ...pineTrees];
      
      for (let i = 0; i < 18; i++) {
        const name = allTrees[Math.floor(Math.random() * allTrees.length)];
        placeModel(name, 50 + Math.random() * 14, 0, -70 + i * 8, 1.2 + Math.random() * 0.8, Math.random() * Math.PI * 2);
      }
      for (let i = 0; i < 18; i++) {
        const name = oakTrees[Math.floor(Math.random() * oakTrees.length)];
        placeModel(name, -46 - Math.random() * 12, 0, -70 + i * 8, 1.0 + Math.random() * 1.0, Math.random() * Math.PI * 2);
      }
      for (let i = 0; i < 14; i++) {
        const name = allTrees[Math.floor(Math.random() * allTrees.length)];
        placeModel(name, -52 + i * 8, 0, -65 - Math.random() * 10, 1.3 + Math.random() * 0.7, Math.random() * Math.PI * 2);
      }
      for (let i = 0; i < 10; i++) {
        const name = smallTrees[Math.floor(Math.random() * smallTrees.length)];
        const x = -40 + i * 9;
        if (Math.abs(x) > 18) placeModel(name, x, 0, 52 + Math.random() * 14, 0.8 + Math.random() * 0.6, Math.random() * Math.PI * 2);
      }
      scatterModels(smallTrees, 12, 30, 50, 0.7, 1.2);

      // â”€â”€ Ã‡Ä°Ã‡EKLER - Bol ve renkli â”€â”€
      const flowers = ['flower_purpleA','flower_purpleB','flower_purpleC','flower_redA','flower_redB','flower_redC','flower_yellowA','flower_yellowB','flower_yellowC'];
      scatterModels(flowers, 120, 85, 110, 0.8, 1.6); // Daha fazla Ã§iÃ§ek
      // MÃ¼ze yolu boyunca Ã§iÃ§ek ÅŸeridi (yeni konumlar - sÃ¼tunlarÄ±n dÄ±ÅŸÄ±)
      for (let z = 15; z <= 58; z += 1.8) {
        placeModel(flowers[Math.floor(Math.random() * flowers.length)], -5.5 + Math.random()*1.2 - 6, 0, z, 1.1, Math.random()*Math.PI);
        placeModel(flowers[Math.floor(Math.random() * flowers.length)],  5.5 - Math.random()*1.2 + 6, 0, z, 1.1, Math.random()*Math.PI);
      }
      // Nehir kenarÄ± Ã§iÃ§ek ÅŸeridi
      for (let z = -55; z <= 55; z += 2.5) {
        placeModel(flowers[Math.floor(Math.random()*flowers.length)], 27+Math.random()*2, 0, z+Math.random()*2, 1.0, Math.random()*Math.PI);
      }
      // Kamp etrafÄ± yoÄŸun Ã§iÃ§ekler (gÃ¼zel alan)
      scatterModels(flowers, 25, 15, 15, 1.0, 1.5); // -30 bÃ¶lgesi

      // â”€â”€ Ã‡IMEN VE Ã‡ALILAR - daha yoÄŸun â”€â”€
      scatterModels(['grass','grass_large','grass_leafs','grass_leafsLarge'], 100, 95, 120, 0.6, 1.4);
      scatterModels(['plant_bush','plant_bushDetailed','plant_bushLarge','plant_bushSmall'], 50, 85, 95, 0.7, 1.5);

      // â”€â”€ KAYALAR â”€â”€
      for (let z = -55; z <= 55; z += 8) {
        placeModel(['rock_smallA','rock_smallB','stone_smallA','stone_smallB'][Math.floor(Math.random()*4)], 30 + Math.random()*3, 0, z + Math.random()*4, 0.8 + Math.random()*0.5, Math.random()*Math.PI*2);
      }
      scatterModels(['rock_largeA','rock_largeB','rock_largeC','rock_largeD'], 8, 90, 100, 0.8, 1.5);
      scatterModels(['rock_tallA','rock_tallB','rock_tallE'], 6, 90, 100, 0.7, 1.2);
      scatterModels(['rock_smallA','rock_smallC','stone_smallA','stone_smallD'], 20, 80, 90, 0.5, 1.0);

      // â”€â”€ MANTARLAR â”€â”€
      const mushrooms = ['mushroom_redGroup','mushroom_tanGroup','mushroom_red','mushroom_tan'];
      for (let i = 0; i < 8; i++) placeModel(mushrooms[Math.floor(Math.random()*mushrooms.length)], -38-Math.random()*8, 0, -40+i*12, 0.8+Math.random()*0.5, Math.random()*Math.PI*2);
      for (let i = 0; i < 6; i++) placeModel(mushrooms[Math.floor(Math.random()*mushrooms.length)], 50+Math.random()*8, 0, -30+i*14, 0.7+Math.random()*0.4, Math.random()*Math.PI*2);

      // â”€â”€ KÃœTÃœKLER â”€â”€
      scatterModels(['stump_roundDetailed','stump_squareDetailed','stump_old'], 10, 80, 90, 0.7, 1.1);
      scatterModels(['log','log_large','log_stack'], 8, 70, 80, 0.8, 1.2);

      // â”€â”€ NEHÄ°R (tile tabanlÄ±) â”€â”€
      for (let z = -60; z <= 60; z += 4) placeModel('ground_riverStraight', 33, 0, z, 2.0, 0);
      for (let i = 0; i < 8; i++) placeModel(i%2===0?'lily_large':'lily_small', 33+(Math.random()-0.5)*4, 0.05, -50+i*14, 0.8, Math.random()*Math.PI*2);

      // â”€â”€ KÃ–PRÃœ â”€â”€
      placeModel('bridge_wood', 33, 0, 0, 2.0, 0);

      // â”€â”€ TAÅLI YOL (MÃ¼ze dÄ±ÅŸÄ± yakÄ±n Ã§evre - kaldÄ±rÄ±ldÄ±, yeni giriÅŸ tasarÄ±mÄ± iÃ§inde) â”€â”€
      // MÃ¼zeden uzakta kalan bÃ¶lÃ¼m yolu
      for (let z = 40; z <= 55; z += 4) placeModel('ground_pathStraight', 0, 0, z, 2.0, 0);

      // â”€â”€ MÃœZENÄ°N Ã–NÃœ: HEYKELLÄ° GÄ°RÄ°Å â”€â”€
      // BÃ¼yÃ¼k giriÅŸ sÃ¼tunlarÄ± - yol baÅŸÄ±nda (daha geri)
      for (const [sx,sz] of [[-12,44],[12,44],[-12,52],[12,52]]) {
        placeModel('statue_column', sx, 0, sz, 1.8, 0);
      }
      // Obelisk'ler - yol giriÅŸi anÄ±tsal kapÄ±sÄ±
      placeModel('statue_obelisk', -10, 0, 58, 1.8, 0);
      placeModel('statue_obelisk',  10, 0, 58, 1.8, 0);
      // Statue ring (dekoratif)
      placeModel('statue_ring', 0, 0, 56, 1.2, 0);
      placeModel('statue_block', -16, 0, 48, 1.2, 0.4);
      placeModel('statue_block',  16, 0, 48, 1.2, -0.4);

      // â”€â”€ Ã‡Ä°T (MÃ¼ze bahÃ§esi etrafÄ± - daha geniÅŸ) â”€â”€
      for (let x = -22; x <= -5; x += 2.5) placeModel('fence_simple', x, 0, 42, 1.1, 0);
      for (let x =   5; x <=  22; x += 2.5) placeModel('fence_simple', x, 0, 42, 1.1, 0);
      for (let z = -22; z <= 42; z += 2.5) {
        placeModel('fence_simple', -23, 0, z, 1.1, Math.PI/2);
        placeModel('fence_simple',  23, 0, z, 1.1, Math.PI/2);
      }
      placeModel('fence_gate', 0, 0, 42, 1.2, 0);
      // BahÃ§e kÃ¶ÅŸe direkleri
      for (const [gx,gz] of [[-23,42],[23,42],[-23,-22],[23,-22]]) {
        placeModel('statue_column', gx, 0, gz, 0.9, 0);
      }

      // â”€â”€ KAMP ATEÅÄ° (romantik alan) â”€â”€
      placeModel('campfire_stones', -30, 0, 25, 1.6, 0);
      placeModel('log_large', -28, 0, 25, 1.0, Math.PI*0.1);
      placeModel('log_large', -32, 0, 25, 1.0, Math.PI*0.9);
      placeModel('stump_roundDetailed', -30, 0, 23, 0.9, 0);
      placeModel('stump_roundDetailed', -30, 0, 27, 0.9, 0);
      placeModel('stump_roundDetailed', -28, 0, 27, 0.8, 0.5);
      // Kamp etrafÄ± Ã§iÃ§ek Ã§emberi
      for (let i = 0; i < 12; i++) {
        const a = (i/12)*Math.PI*2;
        placeModel(flowers[Math.floor(Math.random()*flowers.length)], -30+Math.cos(a)*6, 0, 25+Math.sin(a)*6, 1.0, a);
      }
      // Kamp yanÄ±nda Ã§adÄ±r
      placeModel('tent_detailedOpen', -38, 0, 28, 1.2, Math.PI*0.8);

      // â”€â”€ KÃ–PRÃœ BAÅI KAYALARI â”€â”€
      placeModel('rock_largeA', 29, 0, -4, 0.9, 0.3);
      placeModel('rock_largeB', 29, 0,  4, 0.8, 1.1);
      placeModel('stone_largeA', 37, 0, -4, 0.9, 0.5);
      placeModel('stone_largeB', 37, 0,  4, 0.8, 1.2);
      // KÃ¶prÃ¼ yanÄ± fenerler (stump ile temsil)
      placeModel('stump_squareDetailed', 30, 0, -2, 0.7, 0);
      placeModel('stump_squareDetailed', 30, 0,  2, 0.7, 0);
      placeModel('stump_squareDetailed', 36, 0, -2, 0.7, 0);
      placeModel('stump_squareDetailed', 36, 0,  2, 0.7, 0);
      
      // â”€â”€ SAÄ TARAF: PÄ°KNÄ°K ALANI â”€â”€
      placeModel('log_stack', 22, 0, 30, 1.1, 0.2);
      placeModel('log_stack', 25, 0, 35, 1.0, 1.0);
      placeModel('campfire_logs', 23, 0, 33, 1.2, 0);
      for (let i = 0; i < 8; i++) {
        placeModel(flowers[Math.floor(Math.random()*flowers.length)], 18+Math.random()*10, 0, 26+Math.random()*12, 1.0, Math.random()*Math.PI*2);
      }
      
      // â”€â”€ HAVUZ (geometrik - nehir kenarÄ±) â”€â”€
      placeModel('platform_stone', 22, 0, -15, 1.5, 0);
      placeModel('pot_large', 20, 0, -13, 1.2, 0);
      placeModel('pot_large', 24, 0, -13, 1.2, Math.PI*0.5);
      placeModel('lily_large', 22, 0, -15, 1.0, 0);
      placeModel('lily_small', 20, 0, -16, 0.9, Math.random()*Math.PI);

      // â”€â”€ UZAK DAÄLAR - gerÃ§ekÃ§i katmanlÄ± â”€â”€
      const mountainColors = [0x5a7040, 0x4a6030, 0x6a8050, 0x3d5228];
      for (let i = 0; i < 16; i++) {
        const h = 22 + Math.random()*18;
        const r = 20 + Math.random()*16;
        const sides = 5 + Math.floor(Math.random()*3);
        const col = mountainColors[i%4];
        const mountain = new THREE.Mesh(
          new THREE.ConeGeometry(r, h, sides),
          new THREE.MeshStandardMaterial({color:col, flatShading:true, roughness:0.9})
        );
        const angle = (i/16)*Math.PI*2 + Math.random()*0.4;
        const dist = 110 + Math.random()*30;
        mountain.position.set(Math.cos(angle)*dist, h/2-5, Math.sin(angle)*dist);
        scene.add(mountain);
        // Kar tepesi
        const snowR = r * 0.28;
        const snowH = h * 0.22;
        const snow = new THREE.Mesh(
          new THREE.ConeGeometry(snowR, snowH, sides),
          new THREE.MeshStandardMaterial({color:0xf5f5f5, roughness:0.4})
        );
        snow.position.copy(mountain.position);
        snow.position.y += h/2 - snowH*0.3;
        scene.add(snow);
        // DaÄŸ Ã¶nÃ¼ sis efekti (yoÄŸun aÄŸaÃ§)
        if (dist < 130 && Math.random() > 0.5) {
          for (let t = 0; t < 4; t++) {
            const treeNames = ['tree_pineRoundA','tree_pineTallA','tree_cone','tree_blocks'];
            const tn = treeNames[Math.floor(Math.random()*treeNames.length)];
            const tx = mountain.position.x + (Math.random()-0.5)*r*0.8;
            const tz = mountain.position.z + (Math.random()-0.5)*r*0.8;
            placeModel(tn, tx, 0, tz, 1.0+Math.random()*0.8, Math.random()*Math.PI*2);
          }
        }
      }

      // â”€â”€ GÃœNEÅ â”€â”€
      const sunSphere = new THREE.Mesh(
        new THREE.SphereGeometry(4, 16, 16),
        new THREE.MeshBasicMaterial({ color: 0xfffacd })
      );
      sunSphere.position.set(80, 90, -120);
      scene.add(sunSphere);
      // GÃ¼neÅŸ etrafÄ± halo
      const halo = new THREE.Mesh(
        new THREE.SphereGeometry(6, 16, 16),
        new THREE.MeshBasicMaterial({ color: 0xfff0a0, transparent: true, opacity: 0.25 })
      );
      halo.position.copy(sunSphere.position);
      scene.add(halo);
      
      // â”€â”€ BULUTLAR - BÃ¼yÃ¼k ve katmanlÄ± â”€â”€
      for (let i = 0; i < 20; i++) {
        const cloud = new THREE.Group();
        const cloudCount = 5 + Math.floor(Math.random() * 5);
        for (let j = 0; j < cloudCount; j++) {
          const r = 2.5 + Math.random() * 3.5;
          const s = new THREE.Mesh(
            new THREE.SphereGeometry(r, 8, 6),
            new THREE.MeshBasicMaterial({ color: 0xffffff, transparent: true, opacity: 0.82 })
          );
          s.position.set(
            (Math.random() - 0.5) * 14,
            (Math.random() - 0.5) * 4,
            (Math.random() - 0.5) * 8
          );
          cloud.add(s);
        }
        cloud.position.set(
          Math.random() * 220 - 110,
          28 + Math.random() * 25,
          Math.random() * 220 - 110
        );
        cloud.scale.set(1.0 + Math.random() * 0.8, 0.7, 1.0 + Math.random() * 0.5);
        scene.add(cloud);
      }

      // â”€â”€ KELEBEKLER â”€â”€
      window.butterflies = [];
      for (let i = 0; i < 12; i++) {
        const bg = new THREE.Group();
        const wMat = new THREE.MeshBasicMaterial({color: new THREE.Color().setHSL(Math.random(),0.8,0.65), side:THREE.DoubleSide});
        const lw = new THREE.Mesh(new THREE.CircleGeometry(0.15,6), wMat); lw.position.x=-0.1; bg.add(lw);
        const rw = new THREE.Mesh(new THREE.CircleGeometry(0.15,6), wMat); rw.position.x= 0.1; bg.add(rw);
        bg.position.set(Math.random()*50-25, 1.5+Math.random()*2, Math.random()*50-25);
        bg.userData = {speed:0.02+Math.random()*0.03, wingSpeed:5+Math.random()*5, path:Math.random()*Math.PI*2};
        scene.add(bg); window.butterflies.push(bg);
      }

      // â”€â”€ KUÅLAR â”€â”€
      window.birds = [];
      for (let i = 0; i < 8; i++) {
        const bg = new THREE.Group();
        const body = new THREE.Mesh(new THREE.ConeGeometry(0.1,0.3,4), new THREE.MeshBasicMaterial({color:0x444444}));
        body.rotation.x = Math.PI/2; bg.add(body);
        bg.position.set(Math.random()*100-50, 12+Math.random()*15, Math.random()*100-50);
        bg.userData = {speed:0.05+Math.random()*0.05, angle:Math.random()*Math.PI*2, radius:30+Math.random()*20};
        scene.add(bg); window.birds.push(bg);
      }


      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // MÃœZE BÄ°NASI - GERÃ‡EKÃ‡Ä° NEOKLASÄ°K YAPI
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      const museumGroup = new THREE.Group();
      const mWallMat  = new THREE.MeshStandardMaterial({ color: 0xf0e8d8, roughness: 0.55 });
      const mTrimMat  = new THREE.MeshStandardMaterial({ color: 0xddd0b0, roughness: 0.5 });
      const mRoofMat  = new THREE.MeshStandardMaterial({ color: 0x6b4c2a, roughness: 0.7 });
      const mDoorMat  = new THREE.MeshStandardMaterial({ color: 0x2e1a0a, roughness: 0.6 });
      const mDFMat    = new THREE.MeshStandardMaterial({ color: 0x4a3020, roughness: 0.5 });
      const mGoldMat  = new THREE.MeshStandardMaterial({ color: 0xffd700, metalness: 0.9, roughness: 0.1 });
      const mGlassMat = new THREE.MeshBasicMaterial({ color: 0xa8d8ea, transparent: true, opacity: 0.55 });
      const mWinFMat  = new THREE.MeshStandardMaterial({ color: 0x4a3020, roughness: 0.5 });

      // â”€â”€ ANA GÃ–VDE â”€â”€
      const mBody = new THREE.Mesh(new THREE.BoxGeometry(28, 8, 40), mWallMat);
      mBody.position.set(0, 4, 0); mBody.castShadow = true; mBody.receiveShadow = true;
      museumGroup.add(mBody);

      // Alt taban basamaklarÄ± (3 kademeli)
      [[32,0.8,44],[30.5,0.5,42.5],[29.5,0.35,41.5]].forEach(([w,h,d], i) => {
        const step = new THREE.Mesh(new THREE.BoxGeometry(w,h,d), mTrimMat);
        step.position.set(0, h/2 + i*0.05, 0); step.receiveShadow = true;
        museumGroup.add(step);
      });

      // Ãœst korniz
      const corn1 = new THREE.Mesh(new THREE.BoxGeometry(29.5, 0.6, 41.5), mTrimMat);
      corn1.position.set(0, 8.35, 0); museumGroup.add(corn1);
      const corn2 = new THREE.Mesh(new THREE.BoxGeometry(29, 0.35, 41), mTrimMat);
      corn2.position.set(0, 8.7, 0); museumGroup.add(corn2);

      // â”€â”€ Ã‡ATI (Ã¼Ã§gen pediment) â”€â”€
      const pedGeo = new THREE.CylinderGeometry(0.1, 18, 5, 4);
      const pediment = new THREE.Mesh(pedGeo, mRoofMat);
      pediment.position.set(0, 12, 0); pediment.rotation.y = Math.PI/4;
      pediment.castShadow = true; museumGroup.add(pediment);
      // Ã‡atÄ± tepe topu (altÄ±n)
      const ridgeSphere = new THREE.Mesh(new THREE.SphereGeometry(0.55,10,10), mGoldMat);
      ridgeSphere.position.set(0, 14.7, 0); museumGroup.add(ridgeSphere);
      // Ã‡atÄ± kÃ¶ÅŸe sÃ¼sleri
      [[-13,8.7,20],[13,8.7,20],[-13,8.7,-20],[13,8.7,-20]].forEach(([x,y,z]) => {
        const acro = new THREE.Mesh(new THREE.ConeGeometry(0.3,1.2,8), mGoldMat);
        acro.position.set(x,y,z); museumGroup.add(acro);
      });

      // â”€â”€ SÃœTUNLAR (8 adet - Ã¶n ve arka cephede) â”€â”€
      const colMat = new THREE.MeshStandardMaterial({ color: 0xf5eedd, roughness: 0.5 });
      const colXs = [-10,-6.5,-3,0,3,6.5,10]; // 7 Ã¶n sÃ¼tun
      for (const cx of colXs) {
        const col = new THREE.Mesh(new THREE.CylinderGeometry(0.38,0.46,9,16), colMat);
        col.position.set(cx, 4.5, 20.5); col.castShadow = true; museumGroup.add(col);
        // BaÅŸlÄ±k
        const cap = new THREE.Mesh(new THREE.BoxGeometry(1.1,0.5,1.1), mTrimMat);
        cap.position.set(cx, 9.05, 20.5); museumGroup.add(cap);
        // Taban
        const base = new THREE.Mesh(new THREE.BoxGeometry(1.1,0.4,1.1), mTrimMat);
        base.position.set(cx, 0.8, 20.5); museumGroup.add(base);
      }
      // SÃ¼tun Ã¼stÃ¼ kiriÅŸ
      const entab = new THREE.Mesh(new THREE.BoxGeometry(23,1.1,1.2), mTrimMat);
      entab.position.set(0, 9.55, 20.5); museumGroup.add(entab);
      // Arka 4 kÃ¶ÅŸe sÃ¼tun
      for (const cx of [-12,12]) {
        const col = new THREE.Mesh(new THREE.CylinderGeometry(0.36,0.44,9,14), colMat);
        col.position.set(cx, 4.5, -20.5); col.castShadow = true; museumGroup.add(col);
      }

      // â”€â”€ PENCERELER (yanlarda 4Ã—2) â”€â”€
      const winZs = [-13, -4, 5, 14];
      for (const wz of winZs) {
        for (const side of [-1,1]) {
          const wx = side * 14.15;
          const win = new THREE.Mesh(new THREE.PlaneGeometry(2.2, 3.2), mGlassMat);
          win.position.set(wx, 4.5, wz);
          win.rotation.y = side * Math.PI/2; museumGroup.add(win);
          // Ã‡erÃ§eve yatay
          for (const wy of [2.85, 6.15]) {
            const bar = new THREE.Mesh(new THREE.BoxGeometry(0.15,0.15,2.6), mWinFMat);
            bar.position.set(wx + side*0.07, wy, wz); museumGroup.add(bar);
          }
          // Ã‡erÃ§eve dikey
          for (const dz of [wz-1.2, wz+1.2]) {
            const bar = new THREE.Mesh(new THREE.BoxGeometry(0.15,3.5,0.12), mWinFMat);
            bar.position.set(wx + side*0.07, 4.5, dz); museumGroup.add(bar);
          }
          // Orta yatay
          const mid = new THREE.Mesh(new THREE.BoxGeometry(0.1,0.12,2.6), mWinFMat);
          mid.position.set(wx + side*0.07, 4.5, wz); museumGroup.add(mid);
        }
      }

      // â”€â”€ ANA KAPI â”€â”€
      // KapÄ± Ã§erÃ§evesi
      const dfOuter = new THREE.Mesh(new THREE.BoxGeometry(6.5,7.2,0.45), mDFMat);
      dfOuter.position.set(0, 3.5, 20.3); museumGroup.add(dfOuter);
      // Sol kapÄ±
      const doorL = new THREE.Mesh(new THREE.BoxGeometry(3,6.5,0.22), mDoorMat);
      doorL.position.set(-1.55, 3.3, 20.5);
      doorL.castShadow = true;
      doorL.userData = { type: 'museum_door', locked: true };
      museumGroup.add(doorL); window.museumDoor = doorL;
      // SaÄŸ kapÄ±
      const doorR2 = new THREE.Mesh(new THREE.BoxGeometry(3,6.5,0.22), mDoorMat);
      doorR2.position.set(1.55, 3.3, 20.5); doorR2.castShadow = true; museumGroup.add(doorR2);
      // KapÄ± paneller (dekoratif Ã§erÃ§eveler)
      for (const [dx,dz] of [[-1.55,20.52],[1.55,20.52]]) {
        for (const dy of [1.5, 3.3, 5.1]) {
          const pan = new THREE.Mesh(new THREE.BoxGeometry(2.5,1.4,0.08), new THREE.MeshStandardMaterial({color:0x3d2205}));
          pan.position.set(dx, dy, dz); museumGroup.add(pan);
        }
      }
      // KapÄ± kollarÄ±
      for (const sx of [-0.4, 0.4]) {
        const kn = new THREE.Mesh(new THREE.TorusGeometry(0.1,0.035,8,14), mGoldMat);
        kn.position.set(sx, 3.3, 20.62); kn.rotation.y = Math.PI/2; museumGroup.add(kn);
      }
      // Ãœst Ä±ÅŸÄ±k penceresi (fanlight)
      const fan = new THREE.Mesh(new THREE.CircleGeometry(1.6,14), mGlassMat);
      fan.position.set(0, 7.1, 20.52); fan.rotation.y = Math.PI/2; museumGroup.add(fan);
      const fanRim = new THREE.Mesh(new THREE.TorusGeometry(1.6,0.1,8,14), mDFMat);
      fanRim.position.set(0, 7.1, 20.52); fanRim.rotation.y = Math.PI/2; museumGroup.add(fanRim);
      // KapÄ± alÄ±n levhasÄ±
      const plaqC = document.createElement('canvas');
      plaqC.width = 1024; plaqC.height = 220;
      const plaqX = plaqC.getContext('2d');
      const plaqG = plaqX.createLinearGradient(0,0,1024,0);
      plaqG.addColorStop(0,'#3d2205'); plaqG.addColorStop(0.5,'#5a3510'); plaqG.addColorStop(1,'#3d2205');
      plaqX.fillStyle = plaqG; plaqX.fillRect(0,0,1024,220);
      plaqX.strokeStyle='#FFD700'; plaqX.lineWidth=8; plaqX.strokeRect(8,8,1008,204);
      plaqX.fillStyle='#FFD700'; plaqX.font='bold 70px serif'; plaqX.textAlign='center';
      plaqX.fillText('ğŸ’• AÅŸkÄ±mÄ±zÄ±n MÃ¼zesi ğŸ’•', 512, 135);
      const plaqTex = new THREE.CanvasTexture(plaqC);
      const plaq = new THREE.Mesh(new THREE.PlaneGeometry(11,2.4), new THREE.MeshBasicMaterial({map:plaqTex}));
      plaq.position.set(0, 8.8, 20.55); plaq.rotation.y = Math.PI; museumGroup.add(plaq);

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸŒº MUHTEÅEM GÄ°RÄ°Å TASARIMI - "OHAAA" EFEKTÄ°
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      
      // --- MERMER TAÅLI YOL (kÄ±rmÄ±zÄ± halÄ± yerine) ---
      const marbleMat = new THREE.MeshStandardMaterial({ color: 0xf5f0e8, roughness: 0.2, metalness: 0.05 });
      const marble2Mat = new THREE.MeshStandardMaterial({ color: 0xe8e0d0, roughness: 0.25, metalness: 0.05 });
      const goldTrimMat = new THREE.MeshStandardMaterial({ color: 0xd4af37, metalness: 0.8, roughness: 0.15 });
      
      // Ana mermer yol - mÃ¼ze kapÄ±sÄ±ndan spawnlara kadar
      for (let z = 14; z <= 38; z += 2) {
        for (let x = -3; x <= 3; x += 2) {
          const tile = new THREE.Mesh(new THREE.BoxGeometry(1.95, 0.08, 1.95),
            (Math.floor(z/2) + Math.floor((x+3)/2)) % 2 === 0 ? marbleMat : marble2Mat);
          tile.position.set(x, 0.04, z);
          tile.receiveShadow = true;
          museumGroup.add(tile);
        }
      }
      // AltÄ±n bordÃ¼r - yol kenarlarÄ±
      for (let z = 14; z <= 38; z += 0.5) {
        [-3.15, 3.15].forEach(bx => {
          const border = new THREE.Mesh(new THREE.BoxGeometry(0.12, 0.12, 0.48), goldTrimMat);
          border.position.set(bx, 0.06, z);
          museumGroup.add(border);
        });
      }
      
      // --- ANIT SÃœTUN AVENUSU (2 sÄ±ra bÃ¼yÃ¼k sÃ¼tun) ---
      const avenueColMat = new THREE.MeshStandardMaterial({ color: 0xf2ece0, roughness: 0.4 });
      const avenueColPositions = [
        [-8, 22], [8, 22],
        [-8, 30], [8, 30],
        [-8, 38], [8, 38],
      ];
      avenueColPositions.forEach(([cx, cz]) => {
        // SÃ¼tun gÃ¶vdesi
        const col = new THREE.Mesh(new THREE.CylinderGeometry(0.3, 0.38, 5.5, 14), avenueColMat);
        col.position.set(cx, 2.75, cz);
        col.castShadow = true;
        museumGroup.add(col);
        // Taban
        const base = new THREE.Mesh(new THREE.BoxGeometry(1.0, 0.5, 1.0), mTrimMat);
        base.position.set(cx, 0.25, cz);
        museumGroup.add(base);
        // BaÅŸlÄ±k
        const cap = new THREE.Mesh(new THREE.BoxGeometry(0.9, 0.4, 0.9), mTrimMat);
        cap.position.set(cx, 5.7, cz);
        museumGroup.add(cap);
        // AltÄ±n top sÃ¼sÃ¼
        const sphere = new THREE.Mesh(new THREE.SphereGeometry(0.22, 10, 10), mGoldMat);
        sphere.position.set(cx, 6.15, cz);
        museumGroup.add(sphere);
      });
      
      // --- Ã‡Ä°Ã‡EK TARHASI: SÃ¼tunlar arasÄ± ---
      // Her sÃ¼tun Ã§iftinin yanÄ±na flower bed
      [[- 11, 22], [11, 22], [-11, 30], [11, 30], [-11, 38], [11, 38]].forEach(([fx, fz]) => {
        // KÃ¼Ã§Ã¼k Ã§iÃ§ek tarhÄ± (geometrik)
        const bedMat = new THREE.MeshStandardMaterial({ color: 0x3a5c1a, roughness: 0.9 });
        const bed = new THREE.Mesh(new THREE.BoxGeometry(2.5, 0.15, 2.5), bedMat);
        bed.position.set(fx, 0.07, fz);
        bed.receiveShadow = true;
        museumGroup.add(bed);
        // Ã‡iÃ§ek renkleri (geometrik toplar)
        const flowerColors = [0xff69b4, 0xff1493, 0xffd700, 0xff6347, 0xda70d6, 0xff4500];
        for (let i = 0; i < 9; i++) {
          const fc = flowerColors[Math.floor(Math.random() * flowerColors.length)];
          const stem = new THREE.Mesh(new THREE.CylinderGeometry(0.025, 0.025, 0.35, 5),
            new THREE.MeshStandardMaterial({ color: 0x2d5a1b }));
          stem.position.set(fx + (Math.random()-0.5)*2, 0.25, fz + (Math.random()-0.5)*2);
          museumGroup.add(stem);
          const bloom = new THREE.Mesh(new THREE.SphereGeometry(0.1, 7, 7),
            new THREE.MeshStandardMaterial({ color: fc, roughness: 0.4 }));
          bloom.position.copy(stem.position);
          bloom.position.y += 0.22;
          museumGroup.add(bloom);
        }
      });
      
      // --- FÄ°SKÄ°YE / HAVUZ (giriÅŸ yolu baÅŸÄ±nda) ---
      const fountainBaseMat = new THREE.MeshStandardMaterial({ color: 0xe0d8c8, roughness: 0.3 });
      const waterMat = new THREE.MeshStandardMaterial({ color: 0x4fc3f7, transparent: true, opacity: 0.75, roughness: 0.1, metalness: 0.2 });
      
      // SaÄŸ taraf fiskiye havuzu
      [[-14, 32], [14, 32]].forEach(([fx, fz]) => {
        const fBase = new THREE.Mesh(new THREE.CylinderGeometry(1.4, 1.6, 0.4, 16), fountainBaseMat);
        fBase.position.set(fx, 0.2, fz);
        fBase.castShadow = true;
        museumGroup.add(fBase);
        const fWater = new THREE.Mesh(new THREE.CylinderGeometry(1.2, 1.2, 0.15, 16), waterMat);
        fWater.position.set(fx, 0.47, fz);
        museumGroup.add(fWater);
        const fPillar = new THREE.Mesh(new THREE.CylinderGeometry(0.12, 0.15, 1.2, 10), fountainBaseMat);
        fPillar.position.set(fx, 0.8, fz);
        museumGroup.add(fPillar);
        const fTop = new THREE.Mesh(new THREE.SphereGeometry(0.3, 10, 10), waterMat);
        fTop.position.set(fx, 1.55, fz);
        museumGroup.add(fTop);
        // Su damlacÄ±klarÄ±
        for (let a = 0; a < 6; a++) {
          const angle = (a / 6) * Math.PI * 2;
          const drop = new THREE.Mesh(new THREE.SphereGeometry(0.06, 6, 6),
            new THREE.MeshStandardMaterial({ color: 0x81d4fa, transparent: true, opacity: 0.6 }));
          drop.position.set(fx + Math.cos(angle)*0.5, 1.1, fz + Math.sin(angle)*0.5);
          museumGroup.add(drop);
        }
      });
      
      // --- BÃœYÃœK Ã‡Ä°Ã‡EK SAKSILER (kapÄ± yanlarÄ±) ---
      [[-5.5, 21.5], [5.5, 21.5]].forEach(([px2, pz2]) => {
        const potMat = new THREE.MeshStandardMaterial({ color: 0xc8a87a, roughness: 0.6 });
        const pot = new THREE.Mesh(new THREE.CylinderGeometry(0.45, 0.3, 0.9, 10), potMat);
        pot.position.set(px2, 0.45, pz2);
        pot.castShadow = true;
        museumGroup.add(pot);
        // Ä°Ã§inde Ã§iÃ§ek
        const soilMat = new THREE.MeshStandardMaterial({ color: 0x5c3d1e, roughness: 0.95 });
        const soil = new THREE.Mesh(new THREE.CylinderGeometry(0.42, 0.42, 0.1, 10), soilMat);
        soil.position.set(px2, 0.85, pz2);
        museumGroup.add(soil);
        const pColors = [0xff69b4, 0xff1493, 0xffd700];
        for (let i = 0; i < 5; i++) {
          const ps = new THREE.Mesh(new THREE.CylinderGeometry(0.02, 0.02, 0.5, 5),
            new THREE.MeshStandardMaterial({ color: 0x2d5a1b }));
          ps.position.set(px2 + (Math.random()-0.5)*0.5, 1.1, pz2 + (Math.random()-0.5)*0.5);
          museumGroup.add(ps);
          const pb = new THREE.Mesh(new THREE.SphereGeometry(0.09, 7, 7),
            new THREE.MeshStandardMaterial({ color: pColors[i % pColors.length] }));
          pb.position.copy(ps.position); pb.position.y += 0.3;
          museumGroup.add(pb);
        }
      });
      
      // --- Ã‡EVRE Ã‡ITI ve TOPIARY (budanmÄ±ÅŸ aÄŸaÃ§) ---
      const hedgeMat = new THREE.MeshStandardMaterial({ color: 0x2d6e1f, roughness: 0.85 });
      // Yol kenarÄ± Ã§itler (daha dÃ¼zgÃ¼n)
      for (let z = 18; z <= 40; z += 1) {
        [-4.8, 4.8].forEach(hx => {
          const hb = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.65, 0.95), hedgeMat);
          hb.position.set(hx, 0.32, z);
          museumGroup.add(hb);
        });
      }
      // Topiary kÃ¼releri - yol giriÅŸinde
      [[-6.5, 40], [6.5, 40], [-6.5, 15], [6.5, 15]].forEach(([tx, tz]) => {
        const ts = new THREE.Mesh(new THREE.SphereGeometry(0.65, 10, 10), hedgeMat);
        ts.position.set(tx, 0.65, tz);
        ts.castShadow = true;
        museumGroup.add(ts);
        const tp = new THREE.Mesh(new THREE.CylinderGeometry(0.1, 0.12, 0.6, 8),
          new THREE.MeshStandardMaterial({ color: 0x5c3d1e }));
        tp.position.set(tx, 0.3, tz);
        museumGroup.add(tp);
      });
      
      // AydÄ±nlatma - giriÅŸ lambalar (sÃ¼tunlar arasÄ±nda)
      [[0, 4.0, 25], [0, 4.0, 32]].forEach(([lx, ly, lz]) => {
        const lampLight = new THREE.PointLight(0xfff8dc, 0.6, 18);
        lampLight.position.set(lx, ly, lz);
        museumGroup.add(lampLight);
      });
      // SÃ¼tun Ã¼stleri Ä±ÅŸÄ±k
      avenueColPositions.forEach(([cx, cz]) => {
        const cl = new THREE.PointLight(0xfff5e0, 0.3, 8);
        cl.position.set(cx, 5.5, cz);
        museumGroup.add(cl);
      });

      scene.add(museumGroup);
      window.museumGroup = museumGroup;

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // MÃœZEÄ°Ã‡Ä° - TAM KAPALI, GERÃ‡EKÃ‡Ä°
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      window.insideMuseum = false;
      window.museumInterior = new THREE.Group();
      window.museumInterior.visible = false;

      const iWallMat = new THREE.MeshStandardMaterial({ color: 0xfdf5ee, roughness: 0.7 });
      const iFloorMat = new THREE.MeshStandardMaterial({ color: 0xe8d5c0, roughness: 0.4 });
      const iTrimMat = new THREE.MeshStandardMaterial({ color: 0xd4b896, roughness: 0.5 });
      const iDoorMat = new THREE.MeshStandardMaterial({ color: 0x3d2010, roughness: 0.6 });
      const iGoldMat = new THREE.MeshStandardMaterial({ color: 0xffd700, metalness: 0.9, roughness: 0.1 });

      // â”€â”€ ZEMIN (Ã§ini desenli) â”€â”€
      const iFloor = new THREE.Mesh(new THREE.PlaneGeometry(26, 36), iFloorMat);
      iFloor.rotation.x = -Math.PI/2; iFloor.position.y = 0.01;
      iFloor.receiveShadow = true; window.museumInterior.add(iFloor);
      // Ã‡ini desen
      const tileMat0 = new THREE.MeshStandardMaterial({color:0xfff5ee,roughness:0.3});
      const tileMat1 = new THREE.MeshStandardMaterial({color:0xe8d0c0,roughness:0.3});
      for (let tx = -12; tx <= 12; tx += 4) {
        for (let tz = -16; tz <= 16; tz += 4) {
          const tile = new THREE.Mesh(new THREE.PlaneGeometry(3.85,3.85), (Math.abs(tx+tz)/4)%2===0?tileMat0:tileMat1);
          tile.rotation.x=-Math.PI/2; tile.position.set(tx,0.02,tz); tile.receiveShadow=true;
          window.museumInterior.add(tile);
        }
      }

      // â”€â”€ SOL DUVAR â”€â”€
      const iLeftWall = new THREE.Mesh(new THREE.BoxGeometry(0.4, 7, 36), iWallMat);
      iLeftWall.position.set(-13, 3.5, 0); iLeftWall.receiveShadow=true; iLeftWall.castShadow=true;
      window.museumInterior.add(iLeftWall);

      // â”€â”€ SAÄ DUVAR â”€â”€
      const iRightWall = new THREE.Mesh(new THREE.BoxGeometry(0.4, 7, 36), iWallMat);
      iRightWall.position.set(13, 3.5, 0); iRightWall.receiveShadow=true; iRightWall.castShadow=true;
      window.museumInterior.add(iRightWall);

      // â”€â”€ ARKA DUVAR â”€â”€
      const iBackWall = new THREE.Mesh(new THREE.BoxGeometry(26.4, 7, 0.4), iWallMat);
      iBackWall.position.set(0, 3.5, -18); iBackWall.receiveShadow=true;
      window.museumInterior.add(iBackWall);

      // â”€â”€ Ã–N DUVAR (kapÄ± boÅŸluÄŸu var) â”€â”€
      // Sol panel
      const iFrontL = new THREE.Mesh(new THREE.BoxGeometry(10.5, 7, 0.4), iWallMat);
      iFrontL.position.set(-7.8, 3.5, 18); window.museumInterior.add(iFrontL);
      // SaÄŸ panel
      const iFrontR = new THREE.Mesh(new THREE.BoxGeometry(10.5, 7, 0.4), iWallMat);
      iFrontR.position.set(7.8, 3.5, 18); window.museumInterior.add(iFrontR);
      // Ãœst panel (kapÄ± Ã¼stÃ¼)
      const iFrontTop = new THREE.Mesh(new THREE.BoxGeometry(26.4, 2.5, 0.4), iWallMat);
      iFrontTop.position.set(0, 5.75, 18); window.museumInterior.add(iFrontTop);

      // â”€â”€ Ä°Ã‡ KAPI â”€â”€
      const iDoorFrameM = new THREE.Mesh(new THREE.BoxGeometry(6.4,5.5,0.45), iDoorMat);
      iDoorFrameM.position.set(0,2.7,18.02); window.museumInterior.add(iDoorFrameM);
      const iDoorL = new THREE.Mesh(new THREE.BoxGeometry(2.85,5.1,0.2), new THREE.MeshStandardMaterial({color:0x4a2c0a}));
      iDoorL.position.set(-1.5,2.55,18.15); window.museumInterior.add(iDoorL);
      const iDoorRt = new THREE.Mesh(new THREE.BoxGeometry(2.85,5.1,0.2), new THREE.MeshStandardMaterial({color:0x4a2c0a}));
      iDoorRt.position.set(1.5,2.55,18.15); window.museumInterior.add(iDoorRt);
      // KapÄ± kollarÄ±
      for (const s of [-0.35,0.35]) {
        const kh = new THREE.Mesh(new THREE.TorusGeometry(0.09,0.03,8,12), iGoldMat);
        kh.position.set(s,2.55,18.27); kh.rotation.y=Math.PI/2; window.museumInterior.add(kh);
      }

      // â”€â”€ TAVAN â”€â”€
      const iCeil = new THREE.Mesh(new THREE.PlaneGeometry(26,36), iWallMat);
      iCeil.rotation.x=Math.PI/2; iCeil.position.y=7; window.museumInterior.add(iCeil);
      // Tavan Ã§erÃ§eve Ã§izgileri
      for (const z of [-12,-4,4,12]) {
        const beam = new THREE.Mesh(new THREE.BoxGeometry(26,0.25,0.25), iTrimMat);
        beam.position.set(0,6.85,z); window.museumInterior.add(beam);
      }
      for (const x of [-8,0,8]) {
        const beam = new THREE.Mesh(new THREE.BoxGeometry(0.25,0.25,36), iTrimMat);
        beam.position.set(x,6.85,0); window.museumInterior.add(beam);
      }

      // â”€â”€ DUVAR SÃœSÃœ (alt bordÃ¼r) â”€â”€
      const mold = new THREE.MeshStandardMaterial({color:0xc8a882,roughness:0.5});
      [-13.18,13.18].forEach(x=>{
        const m = new THREE.Mesh(new THREE.BoxGeometry(0.18,0.3,36),mold);
        m.position.set(x,1.15,0); window.museumInterior.add(m);
      });
      const moldF = new THREE.Mesh(new THREE.BoxGeometry(26.4,0.3,0.18),mold);
      moldF.position.set(0,1.15,-18.18); window.museumInterior.add(moldF);

      // â”€â”€ TAVAN LAMBALARI â”€â”€
      const lampMat = new THREE.MeshBasicMaterial({color:0xfffde7});
      const lampPositions = [[-8,6.9,-10],[0,6.9,-10],[8,6.9,-10],[-8,6.9,2],[0,6.9,2],[8,6.9,2],[-8,6.9,12],[0,6.9,12],[8,6.9,12]];
      lampPositions.forEach(([lx,ly,lz])=>{
        const lamp = new THREE.Mesh(new THREE.SphereGeometry(0.22,8,8), lampMat);
        lamp.position.set(lx,ly,lz); window.museumInterior.add(lamp);
        const ring = new THREE.Mesh(new THREE.TorusGeometry(0.3,0.05,6,12), iTrimMat);
        ring.position.set(lx,6.85,lz); ring.rotation.x=Math.PI/2; window.museumInterior.add(ring);
        const pt = new THREE.PointLight(0xfffde7, 0.45, 10);
        pt.position.set(lx,6.5,lz); window.museumInterior.add(pt);
      });

      // â”€â”€ GENEL AYDINLATMA â”€â”€
      const iAmb = new THREE.AmbientLight(0xffffff, 0.75);
      window.museumInterior.add(iAmb);

      scene.add(window.museumInterior);

      // Photo frames
      createPhotoFrames();

      // Hidden messages
      createMessages();

      // Floating hearts
      createFloatingHearts();

      // Characters
      createCharacters();

      // Controls
      setupControls();

      // Start animation
      animate();
    }

    function createPhotoFrames() {
      const framePositions = [
        // Left wall
        { x: -14.5, y: 2.5, z: -15, rot: [0, Math.PI / 2, 0] },
        { x: -14.5, y: 2.5, z: -10, rot: [0, Math.PI / 2, 0] },
        { x: -14.5, y: 2.5, z: -5, rot: [0, Math.PI / 2, 0] },
        { x: -14.5, y: 2.5, z: 0, rot: [0, Math.PI / 2, 0] },
        { x: -14.5, y: 2.5, z: 5, rot: [0, Math.PI / 2, 0] },
        { x: -14.5, y: 4, z: -12, rot: [0, Math.PI / 2, 0] },
        { x: -14.5, y: 4, z: -7, rot: [0, Math.PI / 2, 0] },
        { x: -14.5, y: 4, z: -2, rot: [0, Math.PI / 2, 0] },
        { x: -14.5, y: 4, z: 3, rot: [0, Math.PI / 2, 0] },
        { x: -14.5, y: 4, z: 8, rot: [0, Math.PI / 2, 0] },
        // Right wall
        { x: 14.5, y: 2.5, z: -15, rot: [0, -Math.PI / 2, 0] },
        { x: 14.5, y: 2.5, z: -10, rot: [0, -Math.PI / 2, 0] },
        { x: 14.5, y: 2.5, z: -5, rot: [0, -Math.PI / 2, 0] },
        { x: 14.5, y: 2.5, z: 0, rot: [0, -Math.PI / 2, 0] },
        { x: 14.5, y: 2.5, z: 5, rot: [0, -Math.PI / 2, 0] },
        { x: 14.5, y: 4, z: -12, rot: [0, -Math.PI / 2, 0] },
        { x: 14.5, y: 4, z: -7, rot: [0, -Math.PI / 2, 0] },
        { x: 14.5, y: 4, z: -2, rot: [0, -Math.PI / 2, 0] },
        { x: 14.5, y: 4, z: 3, rot: [0, -Math.PI / 2, 0] },
        { x: 14.5, y: 4, z: 8, rot: [0, -Math.PI / 2, 0] }
      ];

      framePositions.forEach((pos, index) => {
        // Frame
        const frameGeo = new THREE.BoxGeometry(1.2, 1.6, 0.1);
        const frameMat = new THREE.MeshStandardMaterial({
          color: 0x8b4513,
          roughness: 0.5,
          metalness: 0.3
        });
        const frame = new THREE.Mesh(frameGeo, frameMat);
        frame.position.set(pos.x, pos.y, pos.z);
        frame.rotation.set(...pos.rot);
        frame.castShadow = true;
        scene.add(frame);

        // Photo
        const photoGeo = new THREE.PlaneGeometry(1, 1.4);
        const photoMat = new THREE.MeshStandardMaterial({
          color: new THREE.Color().setHSL(Math.random(), 0.5, 0.7),
          emissive: new THREE.Color().setHSL(Math.random(), 0.3, 0.2)
        });
        const photo = new THREE.Mesh(photoGeo, photoMat);
        photo.position.set(
          pos.x + (pos.rot[1] === Math.PI / 2 ? -0.06 : pos.rot[1] === -Math.PI / 2 ? 0.06 : 0),
          pos.y,
          pos.z
        );
        photo.rotation.set(...pos.rot);
        photo.userData = { type: 'photo', index: index + 1 };
        scene.add(photo);
        photoFrames.push(photo);

        // Heart above frame
        const heartShape = new THREE.Shape();
        const x = 0, y = 0;
        heartShape.moveTo(x, y);
        heartShape.bezierCurveTo(x, y - 0.1, x - 0.1, x - 0.15, x - 0.15, y - 0.15);
        heartShape.bezierCurveTo(x - 0.2, y - 0.15, x - 0.2, y - 0.05, x - 0.2, y);
        heartShape.bezierCurveTo(x - 0.2, y + 0.05, x - 0.15, y + 0.1, x, y + 0.2);
        heartShape.bezierCurveTo(x + 0.15, y + 0.1, x + 0.2, y + 0.05, x + 0.2, y);
        heartShape.bezierCurveTo(x + 0.2, y - 0.05, x + 0.2, y - 0.15, x + 0.15, y - 0.15);
        heartShape.bezierCurveTo(x + 0.1, y - 0.15, x, y - 0.1, x, y);

        const heartGeo = new THREE.ShapeGeometry(heartShape);
        const heartMat = new THREE.MeshStandardMaterial({
          color: 0xff1493,
          emissive: 0xff69b4,
          emissiveIntensity: 0.5
        });
        const heart = new THREE.Mesh(heartGeo, heartMat);
        heart.position.set(pos.x, pos.y + 1, pos.z);
        heart.rotation.set(...pos.rot);
        scene.add(heart);
      });
    }

    function createMessages() {
      const messageData = [
        { x: -10, z: -15, text: "Seninle geÃ§irdiÄŸim her an, hayatÄ±mÄ±n en gÃ¼zel anÄ± â¤ï¸" },
        { x: 10, z: -10, text: "Ä°lk buluÅŸmamÄ±zÄ± hatÄ±rlÄ±yor musun? Kalbim hÃ¢lÃ¢ aynÄ± hÄ±zla atÄ±yor ğŸ’•" },
        { x: -5, z: -5, text: "GÃ¼lÃ¼ÅŸÃ¼n benim en sevdiÄŸim ses ğŸŒ¹" },
        { x: 5, z: 0, text: "Seninle her gÃ¼n Sevgililer GÃ¼nÃ¼ ğŸ’" },
        { x: 0, z: 5, text: "Seni seviyorum, bugÃ¼n ve her zaman ğŸ’–" }
      ];

      messageData.forEach((msgData, index) => {
        const envelopeGeo = new THREE.BoxGeometry(0.3, 0.2, 0.15);
        const envelopeMat = new THREE.MeshStandardMaterial({
          color: 0xffb6c1,
          emissive: 0xff69b4,
          emissiveIntensity: 0.3
        });
        const envelope = new THREE.Mesh(envelopeGeo, envelopeMat);
        envelope.position.set(msgData.x, 0.15, msgData.z);
        envelope.castShadow = true;
        envelope.userData = { 
          type: 'message', 
          text: msgData.text, 
          index,
          baseY: 0.15
        };
        scene.add(envelope);
        messages.push(envelope);
      });
    }

    function createFloatingHearts() {
      for (let i = 0; i < 15; i++) {
        const heartShape = new THREE.Shape();
        const x = 0, y = 0;
        heartShape.moveTo(x, y);
        heartShape.bezierCurveTo(x, y - 0.05, x - 0.05, y - 0.08, x - 0.08, y - 0.08);
        heartShape.bezierCurveTo(x - 0.1, y - 0.08, x - 0.1, y - 0.03, x - 0.1, y);
        heartShape.bezierCurveTo(x - 0.1, y + 0.03, x - 0.08, y + 0.05, x, y + 0.1);
        heartShape.bezierCurveTo(x + 0.08, y + 0.05, x + 0.1, y + 0.03, x + 0.1, y);
        heartShape.bezierCurveTo(x + 0.1, y - 0.03, x + 0.1, y - 0.08, x + 0.08, y - 0.08);
        heartShape.bezierCurveTo(x + 0.05, y - 0.08, x, y - 0.05, x, y);

        const heartGeo = new THREE.ShapeGeometry(heartShape);
        const heartMat = new THREE.MeshStandardMaterial({
          color: 0xff1493,
          emissive: 0xff69b4,
          emissiveIntensity: 0.8,
          transparent: true,
          opacity: 0.6
        });
        const heart = new THREE.Mesh(heartGeo, heartMat);
        heart.position.set(
          Math.random() * 20 - 10,
          Math.random() * 5 + 1,
          Math.random() * 30 - 15
        );
        heart.rotation.y = Math.random() * Math.PI;
        heart.userData = { floatOffset: Math.random() * Math.PI * 2 };
        scene.add(heart);
      }
    }


    // FBX KARAKTER YÃœKLEME - TÃœM ANÄ°MASYONLARLA
    function loadFBXCharacter(parentGroup, isPlayer, isBatuhan) {
      const loader = new THREE.FBXLoader();
      
      // Dosya prefix'ini belirle (m = Merve, b = Batuhan)
      const prefix = isBatuhan ? 'b' : 'm';
      const charName = isBatuhan ? 'Batuhan' : 'Merve';
      
      // YÃœKLEME EKRANI - DosyalarÄ± ekle
      if (isPlayer) {
        loadingManager.addItem(`${charName} - YÃ¼rÃ¼me`);
        loadingManager.addItem(`${charName} - KoÅŸma`);
        loadingManager.addItem(`${charName} - Bekle`);
        loadingManager.addItem(`${charName} - Dans 1`);
        loadingManager.addItem(`${charName} - Dans 2`);
        loadingManager.addItem(`${charName} - Dans 3`);
        loadingManager.addItem(`${charName} - Dans 4`);
      }
      
      // Ä°lk olarak yÃ¼rÃ¼me animasyonlu karakteri yÃ¼kle
      loader.load(`/${prefix}Walk.fbx`, 
        function(fbxModel) {
          console.log(`âœ… ${prefix}Walk.fbx yÃ¼klendi!`);
          if (isPlayer) loadingManager.completeItem(`${charName} - YÃ¼rÃ¼me`);
          fbxModel.scale.set(0.01, 0.01, 0.01);
          fbxModel.position.set(0, 0, 0);
          fbxModel.userData.yOffset = 0;
          
          fbxModel.traverse((child) => {
            if (child.isMesh) {
              child.castShadow = true;
              child.receiveShadow = true;
            }
            
            // Root bone'u bul ve kilitle
            if (child.isBone && (child.name.toLowerCase().includes('hips') || 
                                  child.name.toLowerCase().includes('root') ||
                                  child.parent === fbxModel)) {
              console.log('ğŸ¦´ Root bone bulundu:', child.name);
              child.userData.isRootBone = true;
            }
          });
          
          // Animation mixer oluÅŸtur
          const animMixer = new THREE.AnimationMixer(fbxModel);
          
          // Root motion track'lerini filtrele (X/Z pozisyon hareketi yok)
          // Y pozisyonu yOffset ile sabitlenecek
          
          // YÃœRÃœME animasyonunu sakla
          let walkAction, runAction, danceAction, idleAction;
          if (fbxModel.animations && fbxModel.animations.length > 0) {
            // ROOT MOTION TRACK'Ä°NÄ° KALDIR!
            const walkClip = fbxModel.animations[0];
            walkClip.tracks = walkClip.tracks.filter(track => {
              // Position track'lerini filtrele (sadece rotation ve scale kalsÄ±n)
              return !track.name.includes('.position');
            });
            
            walkAction = animMixer.clipAction(walkClip);
            walkAction.setLoop(THREE.LoopRepeat); // SÃ¼rekli tekrarla
            walkAction.time = 0.3; // T-pose frame'ini atla
            walkAction.setEffectiveWeight(0); // Gizli baÅŸlat
            walkAction.enabled = true;
            walkAction.play(); // HEMEN baÅŸlat
            console.log('ğŸ¬ Walk - Root motion temizlendi + baÅŸlatÄ±ldÄ± (weight=0)');
          }
          
          // Mixer'Ä± global deÄŸiÅŸkene ata
          if (isPlayer) {
            mixer = animMixer;
            playerGroup.userData.walkAction = walkAction;
          } else {
            partnerMixer = animMixer;
            partnerGroup.userData.walkAction = walkAction;
          }
          
          // KOÅMA animasyonunu yÃ¼kle
          loader.load(`/${prefix}Run.fbx`,
            function(runFbx) {
              console.log(`âœ… ${prefix}Run.fbx yÃ¼klendi!`);
              if (isPlayer) loadingManager.completeItem(`${charName} - KoÅŸma`);
              if (runFbx.animations && runFbx.animations.length > 0) {
                // ROOT MOTION TRACK'Ä°NÄ° KALDIR!
                const runClip = runFbx.animations[0];
                runClip.tracks = runClip.tracks.filter(track => {
                  return !track.name.includes('.position');
                });
                
                runAction = animMixer.clipAction(runClip);
                runAction.setLoop(THREE.LoopRepeat);
                runAction.time = 0.25; // T-pose frame'ini atla
                runAction.setEffectiveWeight(0); // Gizli baÅŸlat
                runAction.enabled = true;
                runAction.play(); // HEMEN baÅŸlat
                console.log('ğŸƒ Run - Root motion temizlendi + baÅŸlatÄ±ldÄ± (weight=0)');
                
                if (isPlayer) {
                  playerGroup.userData.runAction = runAction;
                } else {
                  partnerGroup.userData.runAction = runAction;
                }
              }
            },
            undefined,
            function(error) {
              console.error(`âŒ ${prefix}Run.fbx YÃœKLEME HATASI!`, error);
              alert(`âŒ HATA: ${prefix}Run.fbx dosyasÄ± bulunamadÄ±!\n\nDosya: public/${prefix}Run.fbx`);
            }
          );
          
          // DANS ANÄ°MASYONLARI - 4 FARKLI DANS
          let danceAction1, danceAction2, danceAction3, danceAction4;
          
          // Dans 1
          loader.load(`/${prefix}Dance1.fbx`,
            function(danceFbx) {
              console.log(`âœ… ${prefix}Dance1.fbx yÃ¼klendi!`);
              if (isPlayer) loadingManager.completeItem(`${charName} - Dans 1`);
              if (danceFbx.animations && danceFbx.animations.length > 0) {
                const danceClip = danceFbx.animations[0];
                danceClip.tracks = danceClip.tracks.filter(track => {
                  // TÃ¼m position track'lerini kaldÄ±r (yÃ¼kselme sorunu)
                  if (track.name.includes('.position')) return false;
                  return true;
                });
                

                
                danceAction1 = animMixer.clipAction(danceClip);
                danceAction1.setLoop(THREE.LoopRepeat);
                danceAction1.time = 0.15; // T-pose frame'ini atla
                danceAction1.setEffectiveWeight(0); // Gizli baÅŸlat
                danceAction1.enabled = true;
                danceAction1.play(); // HEMEN baÅŸlat
                console.log('ğŸ’ƒ Dans 1 - Root motion temizlendi + baÅŸlatÄ±ldÄ± (weight=0)');
                
                if (isPlayer) {
                  playerGroup.userData.danceAction1 = danceAction1;
                } else {
                  partnerGroup.userData.danceAction1 = danceAction1;
                }
              }
            },
            undefined,
            function(error) {
              console.warn(`âš ï¸ ${prefix}Dance1.fbx bulunamadÄ±`);
            }
          );
          
          // Dans 2
          loader.load(`/${prefix}Dance2.fbx`,
            function(danceFbx) {
              console.log(`âœ… ${prefix}Dance2.fbx yÃ¼klendi!`);
              if (isPlayer) loadingManager.completeItem(`${charName} - Dans 2`);
              if (danceFbx.animations && danceFbx.animations.length > 0) {
                const danceClip = danceFbx.animations[0];
                danceClip.tracks = danceClip.tracks.filter(track => {
                  // TÃ¼m position track'lerini kaldÄ±r (yÃ¼kselme sorunu)
                  if (track.name.includes('.position')) return false;
                  return true;
                });
                

                
                danceAction2 = animMixer.clipAction(danceClip);
                danceAction2.setLoop(THREE.LoopRepeat);
                danceAction2.time = 0.15; // T-pose frame'ini atla
                danceAction2.setEffectiveWeight(0); // Gizli baÅŸlat
                danceAction2.enabled = true;
                danceAction2.play(); // HEMEN baÅŸlat
                console.log('ğŸ’ƒ Dans 2 - Root motion temizlendi + baÅŸlatÄ±ldÄ± (weight=0)');
                
                if (isPlayer) {
                  playerGroup.userData.danceAction2 = danceAction2;
                } else {
                  partnerGroup.userData.danceAction2 = danceAction2;
                }
              }
            },
            undefined,
            function(error) {
              console.warn(`âš ï¸ ${prefix}Dance2.fbx bulunamadÄ±`);
            }
          );
          
          // Dans 3
          loader.load(`/${prefix}Dance3.fbx`,
            function(danceFbx) {
              console.log(`âœ… ${prefix}Dance3.fbx yÃ¼klendi!`);
              if (isPlayer) loadingManager.completeItem(`${charName} - Dans 3`);
              if (danceFbx.animations && danceFbx.animations.length > 0) {
                const danceClip = danceFbx.animations[0];
                danceClip.tracks = danceClip.tracks.filter(track => {
                  // TÃ¼m position track'lerini kaldÄ±r (yÃ¼kselme sorunu)
                  if (track.name.includes('.position')) return false;
                  return true;
                });
                

                
                danceAction3 = animMixer.clipAction(danceClip);
                danceAction3.setLoop(THREE.LoopRepeat);
                danceAction3.time = 0.15; // T-pose frame'ini atla
                danceAction3.setEffectiveWeight(0); // Gizli baÅŸlat
                danceAction3.enabled = true;
                danceAction3.play(); // HEMEN baÅŸlat
                console.log('ğŸ’ƒ Dans 3 - Root motion temizlendi + baÅŸlatÄ±ldÄ± (weight=0)');
                
                if (isPlayer) {
                  playerGroup.userData.danceAction3 = danceAction3;
                } else {
                  partnerGroup.userData.danceAction3 = danceAction3;
                }
              }
            },
            undefined,
            function(error) {
              console.warn(`âš ï¸ ${prefix}Dance3.fbx bulunamadÄ±`);
            }
          );
          
          // Dans 4
          loader.load(`/${prefix}Dance4.fbx`,
            function(danceFbx) {
              console.log(`âœ… ${prefix}Dance4.fbx yÃ¼klendi!`);
              if (isPlayer) loadingManager.completeItem(`${charName} - Dans 4`);
              if (danceFbx.animations && danceFbx.animations.length > 0) {
                const danceClip = danceFbx.animations[0];
                danceClip.tracks = danceClip.tracks.filter(track => {
                  // TÃ¼m position track'lerini kaldÄ±r (yÃ¼kselme sorunu)
                  if (track.name.includes('.position')) return false;
                  return true;
                });
                

                
                danceAction4 = animMixer.clipAction(danceClip);
                danceAction4.setLoop(THREE.LoopRepeat);
                danceAction4.time = 0.15; // T-pose frame'ini atla
                danceAction4.setEffectiveWeight(0); // Gizli baÅŸlat
                danceAction4.enabled = true;
                danceAction4.play(); // HEMEN baÅŸlat
                console.log('ğŸ’ƒ Dans 4 - Root motion temizlendi + baÅŸlatÄ±ldÄ± (weight=0)');
                
                if (isPlayer) {
                  playerGroup.userData.danceAction4 = danceAction4;
                } else {
                  partnerGroup.userData.danceAction4 = danceAction4;
                }
              }
            },
            undefined,
            function(error) {
              console.warn(`âš ï¸ ${prefix}Dance4.fbx bulunamadÄ±`);
            }
          );
          
          // ESKI danceAction referansÄ± iÃ§in (geriye uyumluluk)
          if (isPlayer) {
            playerGroup.userData.danceAction = danceAction1; // Dans 1 default
          } else {
            partnerGroup.userData.danceAction = danceAction1;
          }
          
          // IDLE animasyonunu yÃ¼kle (OPSÄ°YONEL)
          loader.load(`/${prefix}Idle.fbx`,
            function(idleFbx) {
              console.log(`âœ… ${prefix}Idle.fbx yÃ¼klendi!`);
              if (isPlayer) loadingManager.completeItem(`${charName} - Bekle`);
              if (idleFbx.animations && idleFbx.animations.length > 0) {
                // ROOT MOTION TRACK'Ä°NÄ° KALDIR!
                const idleClip = idleFbx.animations[0];
                idleClip.tracks = idleClip.tracks.filter(track => {
                  return !track.name.includes('.position');
                });
                
                idleAction = animMixer.clipAction(idleClip);
                idleAction.setLoop(THREE.LoopRepeat);
                idleAction.play(); // Direkt baÅŸlat, fade yok!
                idleAction.setEffectiveWeight(1); // Full weight
                console.log('ğŸ§˜ Idle animasyonu - Root motion temizlendi');
                
                currentAnimation = 'idle'; // BaÅŸlangÄ±Ã§ animasyonu idle
                if (isPlayer) {
                  playerGroup.userData.idleAction = idleAction;
                } else {
                  partnerGroup.userData.idleAction = idleAction;
                }
              }
              
              // BaÅŸlangÄ±Ã§ deÄŸerlerini gÃ¶ster
              console.log('âš™ï¸ BAÅLANGIÃ‡ HIZ AYARLARI:');
              console.log('ğŸ¬ Walk anim:', walkAnimSpeed, '| Hareket:', walkMoveSpeed);
              console.log('ğŸƒ Run anim:', runAnimSpeed, '| Hareket:', runMoveSpeed);
              console.log('ğŸ’¡ Animasyon sistemi hazÄ±r!');
              
              // DÄ°ÄER ANÄ°MASYONLARI HAZIRLA - userData'dan Ã§ek!
              // 2 saniye bekle - tÃ¼m danslar yÃ¼klensin
              setTimeout(() => {
                const walkAct = isPlayer ? playerGroup.userData.walkAction : partnerGroup.userData.walkAction;
                const runAct = isPlayer ? playerGroup.userData.runAction : partnerGroup.userData.runAction;
                
                // 4 Dans action'larÄ±
                const danceAct1 = isPlayer ? playerGroup.userData.danceAction1 : partnerGroup.userData.danceAction1;
                const danceAct2 = isPlayer ? playerGroup.userData.danceAction2 : partnerGroup.userData.danceAction2;
                const danceAct3 = isPlayer ? playerGroup.userData.danceAction3 : partnerGroup.userData.danceAction3;
                const danceAct4 = isPlayer ? playerGroup.userData.danceAction4 : partnerGroup.userData.danceAction4;
                
                console.log('ğŸ¬ Animasyon baÅŸlatma kontrolÃ¼:');
                console.log('  Walk:', walkAct ? 'VAR' : 'YOK');
                console.log('  Run:', runAct ? 'VAR' : 'YOK');
                console.log('  Dans 1:', danceAct1 ? 'VAR' : 'YOK');
                console.log('  Dans 2:', danceAct2 ? 'VAR' : 'YOK');
                console.log('  Dans 3:', danceAct3 ? 'VAR' : 'YOK');
                console.log('  Dans 4:', danceAct4 ? 'VAR' : 'YOK');
                
                if (walkAct) {
                  walkAct.time = 0.3; // T-pose frame'ini atla!
                  walkAct.setEffectiveWeight(0); // Gizli
                  walkAct.enabled = true;
                  walkAct.play(); // BaÅŸlat ama gÃ¶rÃ¼nmez
                  console.log('âœ… Walk baÅŸlatÄ±ldÄ± (weight=0, time=0.3)');
                } else {
                  console.error('âŒ walkAction bulunamadÄ±!');
                }
                
                if (runAct) {
                  runAct.time = 0.2; // T-pose frame'ini atla!
                  runAct.setEffectiveWeight(0);
                  runAct.enabled = true;
                  runAct.play();
                  console.log('âœ… Run baÅŸlatÄ±ldÄ± (weight=0, time=0.2)');
                } else {
                  console.error('âŒ runAction bulunamadÄ±!');
                }
                
                // 4 DansÄ± baÅŸlat (hepsi gizli)
                if (danceAct1) {
                  danceAct1.time = 0.1;
                  danceAct1.setEffectiveWeight(0);
                  danceAct1.enabled = true;
                  danceAct1.play();
                  console.log('âœ… Dans 1 baÅŸlatÄ±ldÄ± (weight=0)');
                } else {
                  console.warn('âš ï¸ Dans 1 bulunamadÄ±');
                }
                
                if (danceAct2) {
                  danceAct2.time = 0.1;
                  danceAct2.setEffectiveWeight(0);
                  danceAct2.enabled = true;
                  danceAct2.play();
                  console.log('âœ… Dans 2 baÅŸlatÄ±ldÄ± (weight=0)');
                } else {
                  console.warn('âš ï¸ Dans 2 bulunamadÄ±');
                }
                
                if (danceAct3) {
                  danceAct3.time = 0.1;
                  danceAct3.setEffectiveWeight(0);
                  danceAct3.enabled = true;
                  danceAct3.play();
                  console.log('âœ… Dans 3 baÅŸlatÄ±ldÄ± (weight=0)');
                } else {
                  console.warn('âš ï¸ Dans 3 bulunamadÄ±');
                }
                
                if (danceAct4) {
                  danceAct4.time = 0.1;
                  danceAct4.setEffectiveWeight(0);
                  danceAct4.enabled = true;
                  danceAct4.play();
                  console.log('âœ… Dans 4 baÅŸlatÄ±ldÄ± (weight=0)');
                } else {
                  console.warn('âš ï¸ Dans 4 bulunamadÄ±');
                }
                
                console.log('ğŸ‰ TÃœM ANÄ°MASYONLAR BAÅLATILDI!');
              }, 2000); // 2 saniye bekle
              
              // Idle zaten Ã§alÄ±ÅŸÄ±yor ve gÃ¶rÃ¼nÃ¼r (weight=1)
            },
            undefined,
            function(error) {
              console.warn(`âš ï¸ ${prefix}Idle.fbx bulunamadÄ± (opsiyonel)`);
              console.log('ğŸ’¡ Idle animasyonu olmadan da Ã§alÄ±ÅŸabilir');
            }
          );
          
          // Ä°sim etiketi
          const canvas = document.createElement('canvas');
          canvas.width = 256;
          canvas.height = 64;
          const ctx = canvas.getContext('2d');
          ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
          ctx.fillRect(0, 0, 256, 64);
          ctx.fillStyle = '#ff1493';
          ctx.font = 'bold 32px Arial';
          ctx.textAlign = 'center';
          ctx.fillText('Merve', 128, 42);
          
          const nameTexture = new THREE.CanvasTexture(canvas);
          const nameSprite = new THREE.Sprite(new THREE.SpriteMaterial({ map: nameTexture }));
          nameSprite.position.y = 2;
          nameSprite.scale.set(0.8, 0.2, 1);
          fbxModel.add(nameSprite);
          
          // Ã–nce gruba ekle
          parentGroup.add(fbxModel);
          parentGroup.userData.fbxModel = fbxModel;
          
          console.log('âœ… FBX modeli gruba eklendi, animasyonlar Y yÃ¼ksekliÄŸini ayarlayacak');
        },
        function(xhr) {
          console.log((xhr.loaded / xhr.total * 100) + '% yÃ¼klendi');
        },
        function(error) {
          console.error('âŒ mWalk.fbx YÃœKLEME HATASI!');
          console.error('Hata:', error);
          console.error('âš ï¸ KONTROL ET:');
          console.error('  1. Dosya public/mWalk.fbx konumunda mÄ±?');
          console.error('  2. Dosya adÄ± tam olarak "mWalk.fbx" mi? (kÃ¼Ã§Ã¼k m, bÃ¼yÃ¼k W)');
          console.error('  3. Sunucu Ã§alÄ±ÅŸÄ±yor mu? (npm start)');
          alert('âŒ HATA: mWalk.fbx dosyasÄ± bulunamadÄ±!\n\nDosyanÄ±n public/ klasÃ¶rÃ¼nde olduÄŸundan emin olun.\nDosya adÄ±: mWalk.fbx');
        }
      );
    }

    function createCharacters() {
      // Determine which character is which
      const playerIsBatuhan = selectedCharacter === 'batuhan';
      
      // Player character
      playerGroup = new THREE.Group();
      
      // MERVE Ä°SE FBX YÃœKLE (KadÄ±n)
      if (!playerIsBatuhan) {
        loadFBXCharacter(playerGroup, true, false); // false = Merve
      }
      // BATUHAN Ä°SE FBX YÃœKLE (Erkek)
      else {
        loadFBXCharacter(playerGroup, true, true); // true = Batuhan
      }

      playerGroup.position.set(0, 0, 55); // AVENU GÄ°RÄ°ÅÄ°NDE BAÅLA - OHAAA MOOMENTÄ°!
      scene.add(playerGroup);

      // PARTNER CHARACTER
      partnerGroup = new THREE.Group();
      const partnerIsBatuhan = !playerIsBatuhan;
      
      // PARTNER MERVE Ä°SE FBX YÃœKLE (KadÄ±n)
      if (!partnerIsBatuhan) {
        loadFBXCharacter(partnerGroup, false, false); // false = Merve
      }
      // PARTNER BATUHAN Ä°SE FBX YÃœKLE (Erkek)
      else {
        loadFBXCharacter(partnerGroup, false, true); // true = Batuhan
      }

      partnerGroup.position.set(3, 0, 55); // DIÅARIDA BAÅLA
      partnerGroup.visible = partnerConnected;
      scene.add(partnerGroup);
    }

    function setupControls() {
      window.addEventListener('keydown', (e) => {
        keys[e.key.toLowerCase()] = true;
      });

      window.addEventListener('keyup', (e) => {
        keys[e.key.toLowerCase()] = false;
        if (e.key.toLowerCase() === 'e') window.eKeyUsed = false;
      });

      window.addEventListener('mousemove', (e) => {
        if (window.popupOpen) return; // Popup aÃ§Ä±kken kamera dÃ¶nmesin
        if (document.pointerLockElement === renderer.domElement) {
          yaw -= e.movementX * 0.002;
          pitch += e.movementY * 0.002;
          pitch = Math.max(-Math.PI / 3, Math.min(Math.PI / 3, pitch));
        } else {
          mouseX = (e.clientX / window.innerWidth) * 2 - 1;
          mouseY = (e.clientY / window.innerHeight) * 2 - 1;
          yaw = -mouseX * Math.PI * 0.5;
          pitch = -mouseY * 0.3;
        }
      });

      // Pointer lock for better camera control
      renderer.domElement.addEventListener('click', () => {
        renderer.domElement.requestPointerLock();
      });

      document.addEventListener('pointerlockchange', () => {
        if (!document.pointerLockElement) {
          // Pointer lock exited
        }
      });

      window.addEventListener('click', (e) => {
        const mouse = new THREE.Vector2();
        mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
        mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;

        const raycaster = new THREE.Raycaster();
        raycaster.setFromCamera(mouse, camera);
        const intersects = raycaster.intersectObjects(photoFrames);

        if (intersects.length > 0) {
          const photo = intersects[0].object;
          showPhoto(photo.userData.index);
        }

        // Close popups
        if (e.target.classList.contains('message-popup') || e.target.classList.contains('photo-popup')) {
          document.getElementById('message-popup').classList.remove('show');
          document.getElementById('photo-popup').classList.remove('show');
        }
      });

      window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      });
    }

    function showPhoto(index) {
      const colors = ['#ff69b4', '#ffb6c1', '#ffc0cb', '#ff1493', '#db7093'];
      const color1 = colors[index % colors.length];
      const color2 = colors[(index + 1) % colors.length];
      
      const photoFrame = document.getElementById('photo-frame');
      photoFrame.style.background = `linear-gradient(135deg, ${color1}, ${color2})`;
      
      document.getElementById('photo-number').textContent = index;
      document.getElementById('photo-popup').classList.add('show');
    }

    let time = 0;
    let walkCycle = 0;
    let currentAnimation = null; // Åu an oynatÄ±lan animasyon
    let isDancingToggle = false; // Dans toggle durumu
    let lastQKeyState = false; // Q tuÅŸunun Ã¶nceki durumu
    
    // ANÄ°MASYON HIZ AYARLARI - SABÄ°T DEÄERLER
    let walkAnimSpeed = 1.14;   // YÃ¼rÃ¼me animasyon hÄ±zÄ±
    let runAnimSpeed = 1.28;    // KoÅŸma animasyon hÄ±zÄ±
    let walkMoveSpeed = 0.016;  // YÃ¼rÃ¼me hareket hÄ±zÄ±
    let runMoveSpeed = 0.073;   // KoÅŸma hareket hÄ±zÄ±
    let lastSpeedAdjust = 0;    // Son ayarlama zamanÄ±
    
    function animate() {
      requestAnimationFrame(animate);
      time += 16;
      walkCycle += 0.1;

      // FBX ANÄ°MASYON GÃœNCELLEMESÄ°
      const delta = clock.getDelta();
      if (mixer) mixer.update(delta);
      if (partnerMixer) partnerMixer.update(delta);
      
      // ROOT MOTION: Sadece X ve Z sÄ±fÄ±rla, Y'ye ASLA dokunma!
      // Y'yi sÄ±fÄ±rlarsak kalÃ§a yere iner, ayaklar yeraltÄ±na girer!
      if (playerGroup.userData.fbxModel) {
        const fbxModel = playerGroup.userData.fbxModel;
        fbxModel.position.x = 0;
        fbxModel.position.z = 0;
        // fbxModel.position.y â†’ DOKUNMA! Animasyon doÄŸal yÃ¼ksekliÄŸi ayarlar
        
        fbxModel.traverse((child) => {
          if (child.userData.isRootBone) {
            child.position.x = 0; // Sadece X sÄ±fÄ±rla (yan kayma yok)
            child.position.z = 0; // Sadece Z sÄ±fÄ±rla (ileri kayma yok)
            // child.position.y â†’ DOKUNMA! KalÃ§anÄ±n doÄŸal yÃ¼ksekliÄŸi korunsun
          }
        });
      }
      if (partnerGroup && partnerGroup.userData.fbxModel) {
        const fbxModel = partnerGroup.userData.fbxModel;
        fbxModel.position.x = 0;
        fbxModel.position.z = 0;
        
        fbxModel.traverse((child) => {
          if (child.userData.isRootBone) {
            child.position.x = 0;
            child.position.z = 0;
            // child.position.y â†’ DOKUNMA!
          }
        });
      }

      
      // Player movement - KAMERA YÃ–NÃœNE GÃ–RE
      const isMoving = keys['w'] || keys['s'] || keys['a'] || keys['d'];
      const isRunning = keys['shift']; // SHIFT = KOÅMA
      
      // Q TUÅU - DANS MENÃœSÃœ AÃ‡
      const qKeyPressed = keys['q'];
      if (qKeyPressed && !lastQKeyState) {
        // Q tuÅŸuna basÄ±ldÄ± - dans menÃ¼sÃ¼nÃ¼ aÃ§
        document.getElementById('dance-menu').style.display = 'flex';
        // Pointer lock'u kaldÄ±r (menÃ¼de fare kullanabilsin)
        if (document.pointerLockElement) {
          document.exitPointerLock();
        }
        console.log('ğŸ’ƒ Dans menÃ¼sÃ¼ aÃ§Ä±ldÄ±');
      }
      lastQKeyState = qKeyPressed;
      
      // FBX ANÄ°MASYON KONTROLÃœ (Her iki karakter iÃ§in)
      if (playerGroup.userData.walkAction && playerGroup.userData.runAction) {
        const walkAction = playerGroup.userData.walkAction;
        const runAction = playerGroup.userData.runAction;
        const danceAction = playerGroup.userData.danceAction; // Eski - geriye uyumluluk
        const idleAction = playerGroup.userData.idleAction; // Opsiyonel
        
        // 4 Dans action'larÄ±
        const danceAction1 = playerGroup.userData.danceAction1;
        const danceAction2 = playerGroup.userData.danceAction2;
        const danceAction3 = playerGroup.userData.danceAction3;
        const danceAction4 = playerGroup.userData.danceAction4;
        
        // TÃ¼m temel animasyonlar yÃ¼klendiyse devam et
        if (walkAction && runAction) {
        
        // Mevcut oynatÄ±lan animasyonun hÄ±zÄ±nÄ± gÃ¼ncelle (runtime ayarlar iÃ§in)
        if (walkAction && walkAction.enabled && walkAction.isRunning()) {
          walkAction.setEffectiveTimeScale(walkAnimSpeed);
        }
        if (runAction && runAction.enabled && runAction.isRunning()) {
          runAction.setEffectiveTimeScale(runAnimSpeed);
        }
        
        // Hangi animasyon oynatÄ±lmalÄ±?
        let targetAnimation = null;
        
        if (selectedDance > 0) {
          // Dans seÃ§ilmiÅŸ (1-4)
          targetAnimation = `dance${selectedDance}`;
          // Dans ederken sadece X/Z sÄ±fÄ±rla, Y doÄŸal kalsÄ±n
          const fbxM = playerGroup.userData.fbxModel;
          if (fbxM) { fbxM.position.x = 0; fbxM.position.z = 0; }
          // playerGroup.position.y â†’ dokunma
        } else if (isMoving && isRunning) {
          targetAnimation = 'run';
        } else if (isMoving) {
          targetAnimation = 'walk';
        } else if (idleAction) {
          targetAnimation = 'idle';
        }
        
        // EN BASÄ°T SÄ°STEM - Sadece weight deÄŸiÅŸtir!
        if (currentAnimation !== targetAnimation && targetAnimation) {
          console.log('ğŸ¬ GeÃ§iÅŸ:', currentAnimation, 'â†’', targetAnimation);
          
          // TÃ¼m animasyonlarÄ±n weight'ini 0 yap (gizle)
          if (walkAction) walkAction.setEffectiveWeight(0);
          if (runAction) runAction.setEffectiveWeight(0);
          if (idleAction) idleAction.setEffectiveWeight(0);
          
          // 4 Dans weight'lerini 0 yap
          if (danceAction1) danceAction1.setEffectiveWeight(0);
          if (danceAction2) danceAction2.setEffectiveWeight(0);
          if (danceAction3) danceAction3.setEffectiveWeight(0);
          if (danceAction4) danceAction4.setEffectiveWeight(0);
          
          // Hedef animasyonu gÃ¶ster (weight=1)
          if (targetAnimation === 'walk' && walkAction) {
            walkAction.setEffectiveWeight(1);
            walkAction.setEffectiveTimeScale(walkAnimSpeed);
            console.log('âœ… Walk gÃ¶rÃ¼nÃ¼r');
          } else if (targetAnimation === 'run' && runAction) {
            runAction.setEffectiveWeight(1);
            runAction.setEffectiveTimeScale(runAnimSpeed);
            console.log('âœ… Run gÃ¶rÃ¼nÃ¼r');
          } else if (targetAnimation === 'dance1' && danceAction1) {
            danceAction1.setEffectiveWeight(1);
            console.log('âœ… Dans 1 gÃ¶rÃ¼nÃ¼r');
          } else if (targetAnimation === 'dance2' && danceAction2) {
            danceAction2.setEffectiveWeight(1);
            console.log('âœ… Dans 2 gÃ¶rÃ¼nÃ¼r');
          } else if (targetAnimation === 'dance3' && danceAction3) {
            danceAction3.setEffectiveWeight(1);
            console.log('âœ… Dans 3 gÃ¶rÃ¼nÃ¼r');
          } else if (targetAnimation === 'dance4' && danceAction4) {
            danceAction4.setEffectiveWeight(1);
            console.log('âœ… Dans 4 gÃ¶rÃ¼nÃ¼r');
          } else if (targetAnimation === 'idle' && idleAction) {
            idleAction.setEffectiveWeight(1);
            console.log('âœ… Idle gÃ¶rÃ¼nÃ¼r');
          }
          
          currentAnimation = targetAnimation;
        }
        } // Animasyonlar yÃ¼klÃ¼ kontrolÃ¼ sonu
      }
      
      if (isMoving) {
        // HAREKET HIZI (Ayarlanabilir deÄŸerler)
        const currentSpeed = isRunning ? runMoveSpeed : walkMoveSpeed;
        
        // Kamera yÃ¶nÃ¼ne gÃ¶re hareket
        const forward = new THREE.Vector3();
        camera.getWorldDirection(forward);
        forward.y = 0;
        forward.normalize();
        
        const right = new THREE.Vector3();
        right.crossVectors(forward, new THREE.Vector3(0, 1, 0));
        
        if (keys['w']) {
          playerGroup.position.x += forward.x * currentSpeed;
          playerGroup.position.z += forward.z * currentSpeed;
        }
        if (keys['s']) {
          playerGroup.position.x -= forward.x * currentSpeed;
          playerGroup.position.z -= forward.z * currentSpeed;
        }
        if (keys['a']) {
          playerGroup.position.x -= right.x * currentSpeed;
          playerGroup.position.z -= right.z * currentSpeed;
        }
        if (keys['d']) {
          playerGroup.position.x += right.x * currentSpeed;
          playerGroup.position.z += right.z * currentSpeed;
        }
        
        // Karakter hareket yÃ¶nÃ¼ne dÃ¶nsÃ¼n
        const moveAngle = Math.atan2(forward.x, forward.z);
        playerGroup.rotation.y = moveAngle;
      }
      
      // ZIPLAMA
      if (keys[' '] && playerGroup.userData.onGround) {
        playerGroup.userData.velocityY = 0.15;
        playerGroup.userData.onGround = false;
      }
      
      // MÃœZÄ°K KONTROL (M tuÅŸu)
      if (keys['m'] && !window.musicToggleCooldown) {
        const music = document.getElementById('background-music');
        if (music.paused) {
          music.play().catch(e => console.log('MÃ¼zik Ã§alÄ±namadÄ±:', e));
          console.log('ğŸµ MÃ¼zik baÅŸlatÄ±ldÄ±');
        } else {
          music.pause();
          console.log('ğŸ”‡ MÃ¼zik durduruldu');
        }
        window.musicToggleCooldown = true;
        setTimeout(() => {
          window.musicToggleCooldown = false;
        }, 500);
      }
      
      // YerÃ§ekimi
      if (!playerGroup.userData.velocityY) playerGroup.userData.velocityY = 0;
      if (!playerGroup.userData.onGround) {
        playerGroup.userData.velocityY -= 0.008;
        playerGroup.position.y += playerGroup.userData.velocityY;
        
        if (playerGroup.position.y <= 0) {
          playerGroup.position.y = 0;
          playerGroup.userData.velocityY = 0;
          playerGroup.userData.onGround = true;
        }
      } else {
        playerGroup.userData.onGround = true;
      }

      // â”€â”€ MÃœZEÄ°Ã‡Ä° SINIRLAR â”€â”€
      if (window.insideMuseum) {
        playerGroup.position.x = Math.max(-12.5, Math.min(12.5, playerGroup.position.x));
        playerGroup.position.z = Math.max(-17.5, Math.min(17.5, playerGroup.position.z));
      } else {
        // â”€â”€ DIÅ SINIRLAR â”€â”€
        playerGroup.position.x = Math.max(-50, Math.min(50, playerGroup.position.x));
        playerGroup.position.z = Math.max(-50, Math.min(50, playerGroup.position.z));
        
        const px = playerGroup.position.x;
        const pz = playerGroup.position.z;
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // MÃœZE BÄ°NASI - TAMAMEN KAPALI (fiziksel giriÅŸ/Ã§Ä±kÄ±ÅŸ YASAK)
        // Sadece teleport ile giriÅŸ/Ã§Ä±kÄ±ÅŸ yapÄ±labilir (E tuÅŸu + ÅŸifre)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        if (!window.insideMuseum) {
          // DIÅARIDA: MÃ¼ze binasÄ±na fiziksel giriÅŸ tamamen engel
          // Ã–n cephe duvarÄ± - hiÃ§ geÃ§ilemez
          if (px > -14.5 && px < 14.5 && pz > 19.0 && pz < 22.0) {
            playerGroup.position.z = 19.0;
          }
          // Yan duvarlar (dÄ±ÅŸarÄ±dan yan giriÅŸ engeli)
          if (pz > -21 && pz < 21) {
            if (px > 13.5 && px < 16) playerGroup.position.x = 13.5;
            if (px < -13.5 && px > -16) playerGroup.position.x = -13.5;
          }
        } else {
          // Ä°Ã‡ERÄ°DE: Ä°Ã§ mÃ¼ze duvarlarÄ± (insanlar geÃ§emesin)
          // Ã–n duvar - kapÄ±dan bile yÃ¼rÃ¼yerek Ã§Ä±kÄ±lamaz
          if (pz > 17.5 && pz < 20) playerGroup.position.z = 17.5;
          // Arka duvar
          if (pz < -17.5) playerGroup.position.z = -17.5;
          // Yan duvarlar
          if (px > 12.5) playerGroup.position.x = 12.5;
          if (px < -12.5) playerGroup.position.x = -12.5;
        }
        
        // Nehir geÃ§ilmesin
        if (px > 29 && px < 40 && pz > -65 && pz < 65) {
          playerGroup.position.x = px < 34.5 ? 29 : 40;
        }
        
        // Ã‡it
        if (pz > 12.5 && pz < 15.5 && Math.abs(px) < 23 && Math.abs(px) > 4) {
          playerGroup.position.z = pz < 14 ? 12.5 : 15.5;
        }
        if (pz > -38 && pz < 14 && px > 22 && px < 24.5) playerGroup.position.x = 22;
        if (pz > -38 && pz < 14 && px < -22 && px > -24.5) playerGroup.position.x = -22;
      }

      // GEOMETRÄ°K KARAKTER ANÄ°MASYONLARI (Sadece Batuhan iÃ§in)
      // FBX karakterlerde (Merve) bu animasyonlar kullanÄ±lmaz
      if (playerGroup.leftArm && playerGroup.rightArm && !playerGroup.userData.fbxModel) {
        // Bu Batuhan (geometrik karakter)
        if (isMoving) {
          // YÃœRÃœME ANÄ°MASYONU
          playerGroup.leftArm.rotation.x = Math.sin(walkCycle) * 0.5;
          playerGroup.leftArm.rotation.z = 0;
          playerGroup.rightArm.rotation.x = Math.sin(walkCycle + Math.PI) * 0.5;
          playerGroup.rightArm.rotation.z = 0;
          
          // BACAK ANÄ°MASYONU
          if (playerGroup.leftLeg && playerGroup.rightLeg) {
            playerGroup.leftLeg.rotation.x = Math.sin(walkCycle) * 0.4;
            playerGroup.rightLeg.rotation.x = Math.sin(walkCycle + Math.PI) * 0.4;
          }
        } else {
          // DurduÄŸunda normal pozisyon
          playerGroup.leftArm.rotation.x = 0;
          playerGroup.leftArm.rotation.y = 0;
          playerGroup.leftArm.rotation.z = 0;
          playerGroup.rightArm.rotation.x = 0;
          playerGroup.rightArm.rotation.y = 0;
          playerGroup.rightArm.rotation.z = 0;
          
          if (playerGroup.leftLeg && playerGroup.rightLeg) {
            playerGroup.leftLeg.rotation.x = 0;
            playerGroup.rightLeg.rotation.x = 0;
          }
        }
      }

      // Third-person camera - SABÄ°T TAKÄ°P
      const cameraDistance = 3.5; // Daha yakÄ±n
      const cameraHeight = 2.5;
      
      camera.position.x = playerGroup.position.x - Math.sin(yaw) * cameraDistance * Math.cos(pitch);
      camera.position.y = playerGroup.position.y + cameraHeight + Math.sin(pitch) * 2;
      camera.position.z = playerGroup.position.z - Math.cos(yaw) * cameraDistance * Math.cos(pitch);
      
      // Camera look at player
      camera.lookAt(playerGroup.position.x, playerGroup.position.y + 0.8, playerGroup.position.z);

      // Send position AND animation state to server
      socket.emit('update_position', {
        position: {
          x: playerGroup.position.x,
          y: playerGroup.position.y,
          z: playerGroup.position.z
        },
        rotation: playerGroup.rotation.y,
        animation: currentAnimation, // Åu anki animasyon
        danceNumber: selectedDance // SeÃ§ili dans (0 = yok, 1-4 = dans)
      });

      // Animate messages
      messages.forEach((msg, i) => {
        msg.position.y = msg.userData.baseY + Math.sin(time * 0.002 + i) * 0.1;
        msg.rotation.y += 0.01;
      });

      // Check near message
      nearMessage = null;
      messages.forEach((msg) => {
        const dist = playerGroup.position.distanceTo(msg.position);
        if (dist < 1.5) nearMessage = msg.userData;
      });

      // KAPI ETKÄ°LEÅÄ°MÄ°
      let nearDoor = false;
      
      if (!window.insideMuseum) {
        // DIÅARIDA: KapÄ±ya yakÄ±n mÄ±? (E tuÅŸu ile ÅŸifre giriÅŸi)
        const doorPos = new THREE.Vector3(0, 0, 21);
        const distToDoor = playerGroup.position.distanceTo(doorPos);
        
        if (distToDoor < 4) {
          nearDoor = true;
          if (keys['e'] && !window.eKeyUsed) {
            window.eKeyUsed = true;
            window.popupOpen = true;
            if (document.pointerLockElement) document.exitPointerLock();
            document.getElementById('password-popup').style.display = 'flex';
            setTimeout(() => document.getElementById('password-input').focus(), 100);
          }
        }
      } else {
        // Ä°Ã‡ERÄ°DE: Ã‡Ä±kÄ±ÅŸ kapÄ±sÄ±na yakÄ±n mÄ±? (E tuÅŸu ile Ã§Ä±kÄ±ÅŸ)
        const exitDoorPos = new THREE.Vector3(0, 0, 16);
        const distToExit = playerGroup.position.distanceTo(exitDoorPos);
        
        if (distToExit < 3.5) {
          nearDoor = true;
          if (keys['e'] && !window.eKeyUsed) {
            window.eKeyUsed = true;
            exitMuseum();
          }
        }
      }

      if (nearMessage) {
        document.getElementById('message-indicator').classList.add('show');
        if (keys['e']) {
          document.getElementById('message-text').textContent = nearMessage.text;
          document.getElementById('message-popup').classList.add('show');
        }
      } else if (nearDoor) {
        if (window.insideMuseum) {
          document.getElementById('message-indicator').textContent = 'ğŸšª E tuÅŸuna bas - MÃ¼zeden Ã‡Ä±k';
        } else {
          document.getElementById('message-indicator').textContent = 'ğŸ” E tuÅŸuna bas - MÃ¼zeye Gir';
        }
        document.getElementById('message-indicator').classList.add('show');
      } else {
        document.getElementById('message-indicator').classList.remove('show');
        document.getElementById('message-indicator').textContent = 'ğŸ’Œ E tuÅŸuna bas ve mesajÄ± oku!';
      }

      // Animate floating hearts
      scene.children.forEach((child) => {
        if (child.userData.floatOffset !== undefined) {
          child.position.y += Math.sin(time * 0.001 + child.userData.floatOffset) * 0.002;
          child.rotation.y += 0.01;
        }
      });

      // KELEBEK ANÄ°MASYONLARI
      if (window.butterflies) {
        window.butterflies.forEach((butterfly, i) => {
          const data = butterfly.userData;
          data.path += data.speed;
          
          // SinÃ¼s dalgasÄ± ile uÃ§
          butterfly.position.x += Math.cos(data.path) * 0.05;
          butterfly.position.z += Math.sin(data.path) * 0.05;
          butterfly.position.y = 1.5 + Math.sin(data.path * 3) * 0.5;
          
          // Kanat Ã§Ä±rpma
          if (butterfly.children[0] && butterfly.children[1]) {
            const wingAngle = Math.sin(time * data.wingSpeed * 0.001) * 0.5;
            butterfly.children[0].rotation.y = -wingAngle;
            butterfly.children[1].rotation.y = wingAngle;
          }
          
          // YÃ¶nlendir
          butterfly.rotation.y = data.path;
          
          // SÄ±nÄ±rlar iÃ§inde tut
          if (Math.abs(butterfly.position.x) > 50) butterfly.position.x *= -0.9;
          if (Math.abs(butterfly.position.z) > 50) butterfly.position.z *= -0.9;
        });
      }

      // KUÅ ANÄ°MASYONLARI
      if (window.birds) {
        window.birds.forEach((bird) => {
          const data = bird.userData;
          data.angle += data.speed * 0.01;
          
          // Dairesel uÃ§uÅŸ
          bird.position.x = Math.cos(data.angle) * data.radius;
          bird.position.z = Math.sin(data.angle) * data.radius;
          bird.position.y = 15 + Math.sin(data.angle * 3) * 3;
          
          // YÃ¶nlendir
          bird.rotation.y = data.angle + Math.PI / 2;
        });
      }

      renderer.render(scene, camera);
    }

    // Event Listeners - DOM yÃ¼klendikten sonra
    document.addEventListener('DOMContentLoaded', () => {
      console.log('âœ… DOM yÃ¼klendi, event listener\'lar ekleniyor...');
      
      // Menu butonlarÄ±
      const createBtn = document.getElementById('create-room-btn');
      const joinBtn = document.getElementById('join-room-btn');
      const submitBtn = document.getElementById('join-submit-btn');
      
      if (createBtn) {
        createBtn.addEventListener('click', createRoom);
        console.log('âœ… Create button listener eklendi');
      }
      
      if (joinBtn) {
        joinBtn.addEventListener('click', showJoinInput);
        console.log('âœ… Join button listener eklendi');
      }
      
      if (submitBtn) {
        submitBtn.addEventListener('click', joinRoom);
        console.log('âœ… Submit button listener eklendi');
      }
      
      // Enter tuÅŸu ile oda kodunu gÃ¶nder
      const roomInput = document.getElementById('room-code-input');
      if (roomInput) {
        roomInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') joinRoom();
        });
      }
      
      // Karakter seÃ§imi
      const batuhanBtn = document.getElementById('select-batuhan');
      const merveBtn = document.getElementById('select-merve');
      
      if (batuhanBtn) {
        batuhanBtn.addEventListener('click', () => selectCharacter('batuhan'));
        console.log('âœ… Batuhan button listener eklendi');
      }
      
      if (merveBtn) {
        merveBtn.addEventListener('click', () => selectCharacter('merve'));
        console.log('âœ… Merve button listener eklendi');
      }
    });
  </script>
</body>
</html>
